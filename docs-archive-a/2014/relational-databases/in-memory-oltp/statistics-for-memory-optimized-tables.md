---
title: Statistiche per tabelle con ottimizzazione per la memoria | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e644766d-1d1c-43d7-83ff-8ccfe4f3af9f
author: rothja
ms.author: jroth
ms.openlocfilehash: 0ae09d76c2642e23c56afcdd5ae4e1e468ef5883
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87724675"
---
# <a name="statistics-for-memory-optimized-tables"></a><span data-ttu-id="e55f2-102">Statistiche per tabelle con ottimizzazione per la memoria</span><span class="sxs-lookup"><span data-stu-id="e55f2-102">Statistics for Memory-Optimized Tables</span></span>
  <span data-ttu-id="e55f2-103">In Query Optimizer vengono utilizzate le statistiche sulle colonne per creare piani di query che consentono di migliorare le prestazioni di esecuzione delle query.</span><span class="sxs-lookup"><span data-stu-id="e55f2-103">The query optimizer uses statistics about columns to create query plans that improve query performance.</span></span> <span data-ttu-id="e55f2-104">Le statistiche vengono raccolte dalle tabelle del database e archiviate nei metadati del database.</span><span class="sxs-lookup"><span data-stu-id="e55f2-104">Statistics are collected from the tables in the database and stored in the database metadata.</span></span>  
  
 <span data-ttu-id="e55f2-105">Le statistiche vengono create automaticamente, ma possono essere create anche manualmente.</span><span class="sxs-lookup"><span data-stu-id="e55f2-105">Statistics are created automatically, but can also be created manually.</span></span> <span data-ttu-id="e55f2-106">Ad esempio, le statistiche vengono create automaticamente per le colonne chiave dell'indice alla creazione dell'indice.</span><span class="sxs-lookup"><span data-stu-id="e55f2-106">For example, statistics are created automatically for index key columns when the index is created.</span></span> <span data-ttu-id="e55f2-107">Per altre informazioni sulla creazione di statistiche, vedere [Statistiche](../statistics/statistics.md).</span><span class="sxs-lookup"><span data-stu-id="e55f2-107">For more information about creating statistics see [Statistics](../statistics/statistics.md).</span></span>  
  
 <span data-ttu-id="e55f2-108">I dati della tabella in genere cambiano nel corso del tempo quando le righe vengono inserite, aggiornate ed eliminate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-108">Table data typically changes over time as rows are inserted, updated, and deleted.</span></span> <span data-ttu-id="e55f2-109">Ciò significa che le statistiche devono essere periodicamente aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-109">This means statistics need to be updated periodically.</span></span> <span data-ttu-id="e55f2-110">Per impostazione predefinita, le statistiche sulle tabelle basate su disco vengono aggiornate automaticamente quando l'utilità di ottimizzazione determina che potrebbero non essere aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-110">By default, statistics on disk-based tables are updated automatically when the optimizer determines they might be out of date.</span></span>  
  
 <span data-ttu-id="e55f2-111">Le statistiche sulle tabelle ottimizzate per la memoria non vengono aggiornate per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="e55f2-111">Statistics on memory-optimized tables are not updated by default.</span></span> <span data-ttu-id="e55f2-112">È necessario quindi aggiornarle manualmente.</span><span class="sxs-lookup"><span data-stu-id="e55f2-112">Instead, you need to update them manually.</span></span> <span data-ttu-id="e55f2-113">Utilizzare [update statistics &#40;&#41;Transact-SQL](/sql/t-sql/statements/update-statistics-transact-sql) per singole colonne, indici o tabelle.</span><span class="sxs-lookup"><span data-stu-id="e55f2-113">Use [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) for individual columns, indexes, or tables.</span></span> <span data-ttu-id="e55f2-114">Utilizzare [sp_updatestats &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) per aggiornare le statistiche per tutte le tabelle utente e interne del database.</span><span class="sxs-lookup"><span data-stu-id="e55f2-114">Use [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) to update statistics for all user and internal tables in the database.</span></span>  
  
 <span data-ttu-id="e55f2-115">Quando si utilizza [create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) o [UPDATE STATISTICS &#40;transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), è necessario specificare `NORECOMPUTE` per disabilitare l'aggiornamento automatico delle statistiche per le tabelle ottimizzate per la memoria.</span><span class="sxs-lookup"><span data-stu-id="e55f2-115">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify `NORECOMPUTE` to disable automatic statistics update for memory-optimized tables.</span></span> <span data-ttu-id="e55f2-116">Per le tabelle basate su disco, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) aggiorna le statistiche solo se la tabella è stata modificata dopo l'ultimo [sp_updatestats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e55f2-116">For disk based tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) only updates statistics if the table has been modified since the last [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span> <span data-ttu-id="e55f2-117">Per le tabelle ottimizzate per la memoria, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) genera sempre Statistiche aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-117">For memory-optimized tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) always generates updated statistics.</span></span> <span data-ttu-id="e55f2-118">[sp_updatestats &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) è un'opzione ottimale per le tabelle ottimizzate per la memoria. in caso contrario, è necessario stabilire quali tabelle presentano modifiche significative, in modo da poter aggiornare le statistiche singolarmente.</span><span class="sxs-lookup"><span data-stu-id="e55f2-118">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) is a good option for memory-optimized tables; otherwise you need to know which tables have significant changes so you can update statistics individually.</span></span>  
  
 <span data-ttu-id="e55f2-119">Le statistiche possono essere generate eseguendo il campionamento dei dati oppure un'analisi completa.</span><span class="sxs-lookup"><span data-stu-id="e55f2-119">Statistics can either be generated by either sampling the data or performing a full scan.</span></span> <span data-ttu-id="e55f2-120">Le statistiche campionate utilizzano solo un campione di dati della tabella per stimare la distribuzione dei dati.</span><span class="sxs-lookup"><span data-stu-id="e55f2-120">Sampled statistics only use a sample of the table data to estimate the data distribution.</span></span> <span data-ttu-id="e55f2-121">Le statistiche fullscan eseguono l'analisi dell'intera tabella per determinare la distribuzione dei dati.</span><span class="sxs-lookup"><span data-stu-id="e55f2-121">Fullscan statistics scan the entire table to determine the data distribution.</span></span> <span data-ttu-id="e55f2-122">Le statistiche fullscan sono in genere più accurate, ma richiedono tempi di calcolo più lunghi.</span><span class="sxs-lookup"><span data-stu-id="e55f2-122">Fullscan statistics are usually more accurate but take longer to compute.</span></span> <span data-ttu-id="e55f2-123">Le statistiche campionate possono essere raccolte più velocemente.</span><span class="sxs-lookup"><span data-stu-id="e55f2-123">Sampled statistics can be collected faster.</span></span>  
  
 <span data-ttu-id="e55f2-124">Le tabelle basate su disco utilizzano per impostazione predefinita le statistiche campionate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-124">Disk-based tables use sampled statistics by default.</span></span> <span data-ttu-id="e55f2-125">Le tabelle con ottimizzazione per la memoria supportano solo statistiche fullscan.</span><span class="sxs-lookup"><span data-stu-id="e55f2-125">Memory-optimized tables only support fullscan statistics.</span></span> <span data-ttu-id="e55f2-126">Quando si usa [create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) o [UPDATE STATISTICS &#40;transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), è necessario specificare l' `FULLSCAN` opzione per le tabelle ottimizzate per la memoria.</span><span class="sxs-lookup"><span data-stu-id="e55f2-126">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify the `FULLSCAN` option for memory-optimized tables.</span></span>  
  
 <span data-ttu-id="e55f2-127">Considerazioni aggiuntive per le statistiche delle tabelle ottimizzate per la memoria:</span><span class="sxs-lookup"><span data-stu-id="e55f2-127">Additional considerations for statistics on memory-optimized tables:</span></span>  
  
-   <span data-ttu-id="e55f2-128">Gli indici delle tabelle ottimizzate per la memoria vengono creati con la tabella.</span><span class="sxs-lookup"><span data-stu-id="e55f2-128">Indexes on memory-optimized tables are created with the table.</span></span> <span data-ttu-id="e55f2-129">Le statistiche delle colonne chiave dell'indice vengono create quando la tabella è vuota.</span><span class="sxs-lookup"><span data-stu-id="e55f2-129">The statistics on the index key columns are created when the table is empty.</span></span> <span data-ttu-id="e55f2-130">Pertanto, queste statistiche devono essere aggiornate dopo che i dati vengono caricati nella tabella.</span><span class="sxs-lookup"><span data-stu-id="e55f2-130">Therefore, these statistics need to be updated after data is loaded into the table.</span></span>  
  
-   <span data-ttu-id="e55f2-131">Per le stored procedure compilate in modo nativo, i piani di esecuzione delle query nella procedura vengono ottimizzati quando la procedura viene compilata.</span><span class="sxs-lookup"><span data-stu-id="e55f2-131">For natively compiled stored procedures, execution plans for queries in the procedure are optimized when the procedure is compiled.</span></span> <span data-ttu-id="e55f2-132">Questa operazione viene eseguita solo quando la procedura viene creata e il server viene riavviato, non quando le statistiche vengono aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-132">This happens only when the procedure is created and when the server restarts, not when statistics are updated.</span></span> <span data-ttu-id="e55f2-133">Pertanto, le tabelle devono contenere un set rappresentativo di dati e le statistiche devono essere aggiornate prima che le procedure vengano create.</span><span class="sxs-lookup"><span data-stu-id="e55f2-133">Therefore, the tables need to contain a representative set of data and statistics need to be up-to-date before the procedures are created.</span></span> <span data-ttu-id="e55f2-134">Le stored procedure compilate in modo nativo vengono ricompilate se il database viene portato offline e poi online o se il server viene riavviato.</span><span class="sxs-lookup"><span data-stu-id="e55f2-134">(Natively compiled stored procedures are recompiled if the database is taken offline and brought back online, or if there is a server restart.)</span></span>  
  
## <a name="guidelines-for-statistics-when-deploying-memory-optimized-tables"></a><span data-ttu-id="e55f2-135">Linee guida per le statistiche durante la distribuzione delle tabelle con ottimizzazione per la memoria</span><span class="sxs-lookup"><span data-stu-id="e55f2-135">Guidelines for Statistics When Deploying Memory-Optimized Tables</span></span>  
 <span data-ttu-id="e55f2-136">Per garantire che le statistiche in Query Optimizer risultino aggiornate durante la creazione dei piani di query, distribuire le tabelle ottimizzate per la memoria utilizzando i seguenti cinque passaggi:</span><span class="sxs-lookup"><span data-stu-id="e55f2-136">To ensure that the query optimizer has up-to-date statistics when creating query plans, deploy memory-optimized tables using these five steps:</span></span>  
  
1.  <span data-ttu-id="e55f2-137">Creare tabelle e indici.</span><span class="sxs-lookup"><span data-stu-id="e55f2-137">Create tables and indexes.</span></span> <span data-ttu-id="e55f2-138">Gli indici sono specificati inline nelle istruzioni `CREATE TABLE`.</span><span class="sxs-lookup"><span data-stu-id="e55f2-138">Indexes are specified inline in the `CREATE TABLE` statements.</span></span>  
  
2.  <span data-ttu-id="e55f2-139">Caricare i dati nelle tabelle.</span><span class="sxs-lookup"><span data-stu-id="e55f2-139">Load data into the tables.</span></span>  
  
3.  <span data-ttu-id="e55f2-140">Aggiornare le statistiche delle tabelle.</span><span class="sxs-lookup"><span data-stu-id="e55f2-140">Update statistics on the tables.</span></span>  
  
4.  <span data-ttu-id="e55f2-141">Creare stored procedure che accedono alle tabelle.</span><span class="sxs-lookup"><span data-stu-id="e55f2-141">Create stored procedures that access the tables.</span></span>  
  
5.  <span data-ttu-id="e55f2-142">Eseguire il carico di lavoro che può contenere una combinazione di stored procedure [!INCLUDE[tsql](../../../includes/tsql-md.md)] compilate in modo nativo e interpretate nonché i batch ad hoc.</span><span class="sxs-lookup"><span data-stu-id="e55f2-142">Run the workload, which can contain a mix of natively compiled and interpreted [!INCLUDE[tsql](../../../includes/tsql-md.md)] stored procedures, as well as ad hoc batches.</span></span>  
  
 <span data-ttu-id="e55f2-143">La creazione delle stored procedure compilate in modo nativo dopo il caricamento dei dati e l'aggiornamento delle statistiche garantisce la presenza delle statistiche disponibili per le tabelle ottimizzate per la memoria in Query Optimizer.</span><span class="sxs-lookup"><span data-stu-id="e55f2-143">Creating natively compiled stored procedures after you load the data and update the statistics ensures that the optimizer has statistics available for the memory-optimized tables.</span></span> <span data-ttu-id="e55f2-144">In questo modo si ottengono piani di query efficienti quando la procedura viene compilata.</span><span class="sxs-lookup"><span data-stu-id="e55f2-144">This will ensure efficient query plans when the procedure is compiled.</span></span>  
  
## <a name="guidelines-for-maintaining-statistics-on-memory-optimized-tables"></a><span data-ttu-id="e55f2-145">Linee guida per la gestione delle statistiche delle tabelle con ottimizzazione per la memoria</span><span class="sxs-lookup"><span data-stu-id="e55f2-145">Guidelines for Maintaining Statistics on Memory-Optimized Tables</span></span>  
 <span data-ttu-id="e55f2-146">Per mantenere le statistiche aggiornate, aggiornare regolarmente le statistiche delle tabelle ottimizzate per la memoria.</span><span class="sxs-lookup"><span data-stu-id="e55f2-146">To keep statistics up-to-date, regularly update the statistics on memory-optimized tables.</span></span>  
  
 <span data-ttu-id="e55f2-147">Se i dati vengono modificati di frequente, è necessario aggiornare spesso le statistiche.</span><span class="sxs-lookup"><span data-stu-id="e55f2-147">If data changes frequently, you should update statistics frequently.</span></span> <span data-ttu-id="e55f2-148">Ad esempio, aggiornare le statistiche delle tabelle dopo un aggiornamento batch.</span><span class="sxs-lookup"><span data-stu-id="e55f2-148">For example, update table statistics after a batch update.</span></span> <span data-ttu-id="e55f2-149">Dopo l'aggiornamento delle statistiche, eliminare e ricreare le stored procedure compilate in modo nativo perché possano utilizzare le statistiche aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e55f2-149">After you update statistics, drop and recreate natively compiled stored procedures so they can benefit from the updated statistics.</span></span>  
  
 <span data-ttu-id="e55f2-150">.</span><span class="sxs-lookup"><span data-stu-id="e55f2-150">.</span></span>  
  
 <span data-ttu-id="e55f2-151">Non aggiornare le statistiche durante i picchi di carico di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e55f2-151">Do not update statistics during peak workload.</span></span>  
  
 <span data-ttu-id="e55f2-152">Per aggiornare le statistiche:</span><span class="sxs-lookup"><span data-stu-id="e55f2-152">To update statistics:</span></span>  
  
-   <span data-ttu-id="e55f2-153">Utilizzare [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] per [creare un piano di manutenzione](../maintenance-plans/create-a-maintenance-plan.md) con un' [attività Aggiorna statistica](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span><span class="sxs-lookup"><span data-stu-id="e55f2-153">Use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] to [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) with an [Update Statistic Task](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span></span>  
  
-   <span data-ttu-id="e55f2-154">In alternativa, aggiornare le statistiche tramite uno script [!INCLUDE[tsql](../../../includes/tsql-md.md)], come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="e55f2-154">Or, update statistics through a [!INCLUDE[tsql](../../../includes/tsql-md.md)] script, as discussed below.</span></span>  
  
 <span data-ttu-id="e55f2-155">Per aggiornare le statistiche per una singola tabella ottimizzata per la memoria (*schema*.</span><span class="sxs-lookup"><span data-stu-id="e55f2-155">To update the statistics for a single memory-optimized table (*myschema*.</span></span> <span data-ttu-id="e55f2-156">*MyTable*) eseguire lo script seguente:</span><span class="sxs-lookup"><span data-stu-id="e55f2-156">*Mytable*), run the following script:</span></span>  
  
```  
UPDATE STATISTICS myschema.Mytable WITH FULLSCAN, NORECOMPUTE  
```  
  
 <span data-ttu-id="e55f2-157">Per aggiornare le statistiche per tutte le tabelle ottimizzate per la memoria nel database corrente, eseguire lo script seguente:</span><span class="sxs-lookup"><span data-stu-id="e55f2-157">To update statistics for all memory-optimized tables in the current database, run the following script:</span></span>  
  
```sql  
DECLARE @sql NVARCHAR(MAX) = N''  
  
SELECT @sql += N'  
   UPDATE STATISTICS ' + quotename(schema_name(schema_id)) + N'.' + quotename(name) + N' WITH FULLSCAN, NORECOMPUTE'  
FROM sys.tables WHERE is_memory_optimized=1  
  
EXEC sp_executesql @sql  
```  
  
 <span data-ttu-id="e55f2-158">Per aggiornare le statistiche per tutte le tabelle del database, eseguire [sp_updatestats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e55f2-158">To update statistics for all tables in the database, run [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="e55f2-159">Nell'esempio seguente viene indicato quando è stato effettuato l'ultimo aggiornamento delle statistiche sulle tabelle ottimizzate per la memoria.</span><span class="sxs-lookup"><span data-stu-id="e55f2-159">The following sample reports when the statistics on memory-optimized tables were last updated.</span></span> <span data-ttu-id="e55f2-160">Queste informazioni sono utili per stabilire se è necessario aggiornare le statistiche.</span><span class="sxs-lookup"><span data-stu-id="e55f2-160">This information can help you decide if you need to update the statistics.</span></span>  
  
```sql  
select t.object_id, t.name, sp.last_updated as 'stats_last_updated'  
from sys.tables t join sys.stats s on t.object_id=s.object_id cross apply sys.dm_db_stats_properties(t.object_id, s.stats_id) sp  
where t.is_memory_optimized=1  
```  
  
## <a name="see-also"></a><span data-ttu-id="e55f2-161">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="e55f2-161">See Also</span></span>  
 [<span data-ttu-id="e55f2-162">Tabelle ottimizzate per la memoria</span><span class="sxs-lookup"><span data-stu-id="e55f2-162">Memory-Optimized Tables</span></span>](memory-optimized-tables.md)  
  
  
