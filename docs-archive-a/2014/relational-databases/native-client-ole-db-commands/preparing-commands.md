---
title: Preparazione dei comandi | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87713156"
---
# <a name="preparing-commands"></a><span data-ttu-id="1828e-102">Preparazione dei comandi</span><span class="sxs-lookup"><span data-stu-id="1828e-102">Preparing Commands</span></span>
  <span data-ttu-id="1828e-103">Il provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client supporta la funzione di preparazione dei comandi per l'esecuzione multipla ottimizzata di un solo comando. La preparazione dei comandi genera tuttavia overhead e per un consumer non esiste la necessità di preparare un comando per eseguirlo più volte.</span><span class="sxs-lookup"><span data-stu-id="1828e-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="1828e-104">In genere, un comando deve essere preparato se verrà eseguito più di tre volte.</span><span class="sxs-lookup"><span data-stu-id="1828e-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="1828e-105">Per motivi relativi alle prestazioni, la preparazione dei comandi viene rinviata fino all'esecuzione del comando.</span><span class="sxs-lookup"><span data-stu-id="1828e-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="1828e-106">Questo è il comportamento predefinito.</span><span class="sxs-lookup"><span data-stu-id="1828e-106">This is the default behavior.</span></span> <span data-ttu-id="1828e-107">Eventuali errori nel comando da preparare verranno rilevati solo dopo l'esecuzione del comando o dell'operazione di metaproprietà.</span><span class="sxs-lookup"><span data-stu-id="1828e-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="1828e-108">L'impostazione della proprietà di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] SSPROP_DEFERPREPARE su FALSE può determinare la disattivazione del comportamento predefinito.</span><span class="sxs-lookup"><span data-stu-id="1828e-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="1828e-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], quando un comando viene eseguito direttamente (senza preparazione iniziale), viene creato un piano di esecuzione che viene memorizzato nella cache.</span><span class="sxs-lookup"><span data-stu-id="1828e-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="1828e-110">Se l'istruzione SQL viene eseguita nuovamente, in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] è disponibile un algoritmo efficiente che consente di mettere in corrispondenza la nuova istruzione con il piano di esecuzione esistente nella cache e di riutilizzare il piano di esecuzione per l'istruzione in questione.</span><span class="sxs-lookup"><span data-stu-id="1828e-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="1828e-111">Per i comandi preparati [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fornisce supporto nativo per la preparazione e l'esecuzione delle relative istruzioni.</span><span class="sxs-lookup"><span data-stu-id="1828e-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="1828e-112">Quando si prepara un'istruzione, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] consente di creare un piano di esecuzione, di memorizzarlo nella cache e di restituire al provider un handle al piano di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="1828e-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="1828e-113">Il provider quindi utilizza l'handle per eseguire ripetutamente l'istruzione.</span><span class="sxs-lookup"><span data-stu-id="1828e-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="1828e-114">Non vengono create stored procedure.</span><span class="sxs-lookup"><span data-stu-id="1828e-114">No stored procedures are created.</span></span> <span data-ttu-id="1828e-115">Poiché l'handle identifica direttamente il piano di esecuzione per un'istruzione SQL, anziché mettere in corrispondenza l'istruzione al piano di esecuzione nella cache (come nel caso dell'esecuzione diretta), è più efficiente preparare un'istruzione piuttosto che eseguirla direttamente, se è noto che l'istruzione verrà eseguita più volte.</span><span class="sxs-lookup"><span data-stu-id="1828e-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="1828e-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] le istruzioni preparate non possono essere utilizzate per creare oggetti temporanei e non possono fare riferimento a stored procedure di sistema che creano oggetti temporanei, ad esempio tabelle temporanee.</span><span class="sxs-lookup"><span data-stu-id="1828e-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="1828e-117">Tali procedure devono essere eseguite in modo diretto.</span><span class="sxs-lookup"><span data-stu-id="1828e-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="1828e-118">Alcuni comandi non devono essere mai preparati,</span><span class="sxs-lookup"><span data-stu-id="1828e-118">Some commands should never be prepared.</span></span> <span data-ttu-id="1828e-119">ad esempio quelli che specificano l'esecuzione di stored procedure o includono testo non valido per la creazione di stored procedure di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="1828e-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="1828e-120">Se viene creata una stored procedure temporanea, il provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client la esegue, restituendo i risultati come se fosse stata eseguita l'istruzione stessa.</span><span class="sxs-lookup"><span data-stu-id="1828e-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="1828e-121">La creazione di stored procedure temporanee viene controllata dalla proprietà di inizializzazione specifica del provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client denominata SSPROP_INIT_USEPROCFORPREP.</span><span class="sxs-lookup"><span data-stu-id="1828e-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="1828e-122">Se il valore della proprietà è SSPROPVAL_USEPROCFORPREP_ON o SSPROPVAL_USEPROCFORPREP_ON_DROP, il provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client tenta di creare una stored procedure quando viene preparato un comando.</span><span class="sxs-lookup"><span data-stu-id="1828e-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="1828e-123">La creazione della stored procedure riesce se l'utente dell'applicazione dispone di autorizzazioni sufficienti per [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="1828e-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="1828e-124">Per i consumer che si disconnettono raramente, la creazione di stored procedure temporanee può richiedere risorse significative di **tempdb**, ovvero il database di sistema di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] nel quale vengono creati gli oggetti temporanei.</span><span class="sxs-lookup"><span data-stu-id="1828e-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="1828e-125">Quando il valore di SSPROP_INIT_USEPROCFORPREP è SSPROPVAL_USEPROCFORPREP_ ON, le stored procedure temporanee create dal provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client vengono eliminate solo quando la sessione che ha creato il comando perde la connessione all'istanza di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="1828e-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="1828e-126">Se la connessione in oggetto è quella predefinita, creata al momento dell'inizializzazione dell'origine dati, la stored procedure temporanea viene eliminata solo quando l'origine dati diventa non inizializzata.</span><span class="sxs-lookup"><span data-stu-id="1828e-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="1828e-127">Quando il valore di SSPROP_INIT_USEPROCFORPREP è SSPROPVAL_USEPROCFORPREP_ON_DROP, le stored procedure temporanee del provider OLE DB di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client vengono eliminate quando si verifica una delle situazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="1828e-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="1828e-128">Il consumer usa **ICommandText::SetCommandText** per indicare un nuovo comando.</span><span class="sxs-lookup"><span data-stu-id="1828e-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="1828e-129">Il consumer usa **ICommandPrepare::Unprepare** per indicare che il testo del comando non è più necessario.</span><span class="sxs-lookup"><span data-stu-id="1828e-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="1828e-130">Il consumer rilascia tutti i riferimenti all'oggetto comando utilizzando la stored procedure temporanea.</span><span class="sxs-lookup"><span data-stu-id="1828e-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="1828e-131">Un oggetto comando include al massimo una stored procedure temporanea in **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="1828e-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="1828e-132">Le stored procedure temporanee esistenti rappresentano il testo del comando corrente di un oggetto comando specifico.</span><span class="sxs-lookup"><span data-stu-id="1828e-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1828e-133">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="1828e-133">See Also</span></span>  
 [<span data-ttu-id="1828e-134">Comandi</span><span class="sxs-lookup"><span data-stu-id="1828e-134">Commands</span></span>](commands.md)  
  
  
