---
title: Amministrare e monitorare Change Data Capture (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], monitoring
- change data capture [SQL Server], administering
- change data capture [SQL Server], jobs
ms.assetid: 23bda497-67b2-4e7b-8e4d-f1f9a2236685
author: rothja
ms.author: jroth
ms.openlocfilehash: 8d97929ead145d1b0de1a1f83becb15ade397683
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87630393"
---
# <a name="administer-and-monitor-change-data-capture-sql-server"></a><span data-ttu-id="12785-102">Amministrare e monitorare Change Data Capture (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="12785-102">Administer and Monitor Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="12785-103">In questo argomento viene descritto come amministrare ed eseguire il monitoraggio dell'acquisizione dati delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-103">This topic describes how to administer and monitor change data capture.</span></span>  
  
##  <a name="capture-job"></a><a name="Capture"></a> <span data-ttu-id="12785-104">Processo di acquisizione</span><span class="sxs-lookup"><span data-stu-id="12785-104">Capture Job</span></span>  
 <span data-ttu-id="12785-105">Il processo di acquisizione viene avviato tramite l'esecuzione della stored procedure senza parametri `sp_MScdc_capture_job`.</span><span class="sxs-lookup"><span data-stu-id="12785-105">The capture job is initiated by running the parameterless stored procedure `sp_MScdc_capture_job`.</span></span> <span data-ttu-id="12785-106">Questa stored procedure estrae prima i valori configurati per *maxtrans*, *maxscans*, *continuous*e *pollinginterval* necessari per il processo di acquisizione da msdb.dbo.cdc_jobs.</span><span class="sxs-lookup"><span data-stu-id="12785-106">This stored procedure starts by extracting the configured values for *maxtrans*, *maxscans*, *continuous*, and *pollinginterval* for the capture job from msdb.dbo.cdc_jobs.</span></span> <span data-ttu-id="12785-107">Tali valori configurati vengono quindi passati come parametri alla stored procedure `sp_cdc_scan`,</span><span class="sxs-lookup"><span data-stu-id="12785-107">These configured values are then passed as parameters to the stored procedure `sp_cdc_scan`.</span></span> <span data-ttu-id="12785-108">utilizzata per richiamare `sp_replcmds` per l'esecuzione dell'analisi del log.</span><span class="sxs-lookup"><span data-stu-id="12785-108">This is used to invoke `sp_replcmds` to perform the log scan.</span></span>  
  
### <a name="capture-job-parameters"></a><span data-ttu-id="12785-109">Parametri del processo di acquisizione</span><span class="sxs-lookup"><span data-stu-id="12785-109">Capture Job Parameters</span></span>  
 <span data-ttu-id="12785-110">Per acquisire familiarità con il comportamento del processo di acquisizione, è necessario comprendere il modo in cui i parametri configurabili vengono utilizzati dalla stored procedure `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="12785-110">To understand capture job behavior, you must understand how the configurable parameters are used by `sp_cdc_scan`.</span></span>  
  
#### <a name="maxtrans-parameter"></a><span data-ttu-id="12785-111">Parametro maxtrans</span><span class="sxs-lookup"><span data-stu-id="12785-111">maxtrans Parameter</span></span>  
 <span data-ttu-id="12785-112">Il parametro *maxtrans* specifica il numero massimo di transazioni che possono essere elaborate in un singolo ciclo di analisi del log.</span><span class="sxs-lookup"><span data-stu-id="12785-112">The *maxtrans* parameter specifies the maximum number of transactions that can be processed in a single scan cycle of the log.</span></span> <span data-ttu-id="12785-113">Se durante l'analisi il numero di transazioni da elaborare raggiunge tale limite, nell'analisi corrente non viene inclusa alcuna transazione aggiuntiva.</span><span class="sxs-lookup"><span data-stu-id="12785-113">If, during the scan, the number of transactions to be processed reaches this limit, no additional transactions are included in the current scan.</span></span> <span data-ttu-id="12785-114">Al termine di un ciclo di analisi, il numero di transazioni elaborate sarà sempre minore o uguale a *maxtrans*.</span><span class="sxs-lookup"><span data-stu-id="12785-114">After a scan cycle is complete, the number of transactions that were processed will always be less than or equal to *maxtrans*.</span></span>  
  
#### <a name="maxscans-parameter"></a><span data-ttu-id="12785-115">Parametro maxscans</span><span class="sxs-lookup"><span data-stu-id="12785-115">maxscans Parameter</span></span>  
 <span data-ttu-id="12785-116">Il parametro *maxscans* specifica il numero massimo di tentativi di cicli di analisi per svuotare il log prima dell’uscita (parametro continuous = 0) o dell'esecuzione di un'istruzione WAITFOR (parametro continuous = 1).</span><span class="sxs-lookup"><span data-stu-id="12785-116">The *maxscans* parameter specifies the maximum number of scan cycles that are attempted to drain the log before either returning (continuous = 0) or executing a waitfor (continuous = 1).</span></span>  
  
#### <a name="continuous-parameter"></a><span data-ttu-id="12785-117">Parametro continuous</span><span class="sxs-lookup"><span data-stu-id="12785-117">continuous Parameter</span></span>  
 <span data-ttu-id="12785-118">Il parametro *continuo* controlla se `sp_cdc_scan` cede il controllo in dopo lo svuotamento del log o l'esecuzione del numero massimo di cicli di analisi (modalità di esecuzione singola).</span><span class="sxs-lookup"><span data-stu-id="12785-118">The *continuous* parameter controls whether `sp_cdc_scan` relinquishes control in after either draining the log or executing the maximum number of scan cycles (one shot mode).</span></span> <span data-ttu-id="12785-119">Il parametro determina inoltre se l'esecuzione di `sp_cdc_scan` debba continuare fino a quando non viene arrestata in modo esplicito (modalità continua).</span><span class="sxs-lookup"><span data-stu-id="12785-119">It also controles whether `sp_cdc_scan` continues to run until explicitly stopped (continuous mode).</span></span>  
  
##### <a name="one-shot-mode"></a><span data-ttu-id="12785-120">Modalità di esecuzione singola</span><span class="sxs-lookup"><span data-stu-id="12785-120">One Shot Mode</span></span>  
 <span data-ttu-id="12785-121">In modalità a colpo singolo, il processo di acquisizione richiede `sp_cdc_scan` di eseguire fino a *maxtrans* analisi per provare a svuotare il log e restituire.</span><span class="sxs-lookup"><span data-stu-id="12785-121">In one shot mode, the capture job requests `sp_cdc_scan` to perform up to *maxtrans* scans to try to drain the log and return.</span></span> <span data-ttu-id="12785-122">Qualsiasi transazione aggiuntiva rispetto al parametro *maxtrans* presente nel log verrà elaborata nelle analisi successive.</span><span class="sxs-lookup"><span data-stu-id="12785-122">Any transactions in addition to *maxtrans* that are present in the log will be processed in later scans.</span></span>  
  
 <span data-ttu-id="12785-123">La modalità di esecuzione singola viene utilizzata in test controllati, in cui è noto il volume di transazioni da elaborare e in cui la chiusura automatica del processo al suo completamento costituisce un aspetto vantaggioso.</span><span class="sxs-lookup"><span data-stu-id="12785-123">One shot mode is used in controlled tests, where the volume of transactions to be processed is known, and there are advantages to the fact that the job closes automatically on when it is finished.</span></span> <span data-ttu-id="12785-124">L'utilizzo della modalità di esecuzione singola non è consigliabile in un ambiente di produzione,</span><span class="sxs-lookup"><span data-stu-id="12785-124">One shot mode is not recommended for production use.</span></span> <span data-ttu-id="12785-125">in quanto t si basa sulla pianificazione del processo per gestire la frequenza di esecuzione del ciclo di analisi.</span><span class="sxs-lookup"><span data-stu-id="12785-125">This is because t relies on the job schedule to manage how frequently the scan cycle is run.</span></span>  
  
 <span data-ttu-id="12785-126">In caso di esecuzione in modalità di esecuzione singola, è possibile calcolare un limite superiore per la velocità effettiva del processo di acquisizione, espressa in transazioni al secondo, utilizzando il calcolo seguente:</span><span class="sxs-lookup"><span data-stu-id="12785-126">When running in one shot mode, you can compute an upper bound on expected throughput of the capture job, expressed in transactions per second by using the following computation:</span></span>  
  
 `(maxtrans * maxscans) / number of seconds between scans`  
  
 <span data-ttu-id="12785-127">Anche se il tempo necessario per eseguire l'analisi del log e popolare le tabelle delle modifiche non differisce notevolmente da 0, la velocità effettiva media del processo non può superare il valore ottenuto dividendo per il numero di secondi che separano le elaborazioni del log il prodotto del numero massimo di transazioni consentite per una singola analisi per il numero massimo di analisi consentite.</span><span class="sxs-lookup"><span data-stu-id="12785-127">Even if the time that is required to scan the log and populate the change tables were not significantly different from 0, the average throughput of the job could not exceed the value obtained by dividing the maximum allowed transactions for a single scan multiplied by the maximum allowed scans by the number of seconds separating log processing.</span></span>  
  
 <span data-ttu-id="12785-128">Se è necessario utilizzare la modalità di esecuzione singola per regolare l'analisi del log, il numero di secondi tra le elaborazioni del log deve essere determinato dalla pianificazione del processo.</span><span class="sxs-lookup"><span data-stu-id="12785-128">If one shot mode were to be used to regulate log scanning, the number of seconds between log processing would have to be governed by the job schedule.</span></span> <span data-ttu-id="12785-129">Se si desidera ottenere questo tipo di comportamento, l'esecuzione del processo di acquisizione in modalità continua rappresenta un metodo migliore per gestire la ripianificazione dell'analisi del log.</span><span class="sxs-lookup"><span data-stu-id="12785-129">When this kind of behavior is desired, running the capture job in continuous mode is a better way to manage rescheduling the log scan.</span></span>  
  
##### <a name="continuous-mode-and-the-polling-interval"></a><span data-ttu-id="12785-130">Modalità continua e intervallo di polling</span><span class="sxs-lookup"><span data-stu-id="12785-130">Continuous Mode and the Polling Interval</span></span>  
 <span data-ttu-id="12785-131">In modalità continua il processo di acquisizione richiede l'esecuzione continua di `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="12785-131">In continuous mode, the capture job requests that `sp_cdc_scan` run continuously.</span></span> <span data-ttu-id="12785-132">In questo modo, la stored procedure può gestire il proprio ciclo di attesa fornendo non solo i valori per maxtrans e maxscans ma anche un valore per il numero di secondi tra le elaborazioni del log (intervallo di polling).</span><span class="sxs-lookup"><span data-stu-id="12785-132">This lets the stored procedure manage its own wait loop by providing not only for maxtrans and maxscans but also a value for the number of seconds between log processing (the polling interval).</span></span> <span data-ttu-id="12785-133">Poiché viene eseguito in questa modalità, il processo di acquisizione rimane attivo, eseguendo un'istruzione `WAITFOR` tra le analisi del log.</span><span class="sxs-lookup"><span data-stu-id="12785-133">Running in this mode, the capture job remains active, executing a `WAITFOR` between log scanning.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12785-134">Quando il valore dell'intervallo di polling è maggiore di 0, il limite superiore relativo alla velocità effettiva per il processo ricorrente in modalità di esecuzione singola viene applicato anche all'operazione del processo in modalità continua.</span><span class="sxs-lookup"><span data-stu-id="12785-134">When the value of the polling interval is greater than 0, the same upper limit on throughput for the recurring one shot job also applies to the job operation in continuous mode.</span></span> <span data-ttu-id="12785-135">Di conseguenza, la divisione di (*maxtrans* \* *maxscans*) per un intervallo di polling diverso da zero comporterà l'applicazione di un limite superiore per il numero medio di transazioni che possono essere elaborate dal processo di acquisizione.</span><span class="sxs-lookup"><span data-stu-id="12785-135">That is, (*maxtrans* \* *maxscans*) divided by a nonzero polling interval will put an upper bound on the average number of transactions that can be processed by the capture job.</span></span>  
  
### <a name="capture-job-customization"></a><span data-ttu-id="12785-136">Personalizzazione del processo di acquisizione</span><span class="sxs-lookup"><span data-stu-id="12785-136">Capture Job Customization</span></span>  
 <span data-ttu-id="12785-137">Per il processo di acquisizione è possibile applicare logica aggiuntiva per determinare se una nuova analisi debba iniziare immediatamente o se venga imposta una sospensione prima di avviare una nuova analisi anziché basarsi su un intervallo di polling fisso.</span><span class="sxs-lookup"><span data-stu-id="12785-137">For the capture job, you can apply additional logic to determine whether a new scan begins immediately or whether a sleep is imposed before it starts a new scan instead of rely on a fixed polling interval.</span></span> <span data-ttu-id="12785-138">La scelta può essere basata solo sull'ora del giorno, applicando eventualmente sospensioni prolungate durante i periodi di attività massima, e prevedere anche il passaggio a un intervallo di polling pari a zero alla fine del giorno quando è importante completare l'elaborazione giornaliera e preparare le esecuzioni notturne.</span><span class="sxs-lookup"><span data-stu-id="12785-138">The choice could be based merely on time of the day, perhaps enforcing very long sleeps during peak activity times, and even moving to a polling interval of 0 at close of day when it is important to complete the days processing and prepare for nightly runs.</span></span> <span data-ttu-id="12785-139">Può inoltre essere necessario monitorare lo stato del processo di acquisizione per determinare il momento in cui tutte le transazioni di cui è stato eseguito il commit entro mezzanotte sono state sottoposte ad analisi e inserite nelle tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-139">Capture process progress could also be monitored to determine when all transactions committed by mid-night had been scanned and deposited in change tables.</span></span> <span data-ttu-id="12785-140">Ciò consente il completamento del processo di acquisizione, che verrà riavviato in base a una pianificazione giornaliera.</span><span class="sxs-lookup"><span data-stu-id="12785-140">This lets the capture job end, to be restarted by a scheduled daily restart.</span></span> <span data-ttu-id="12785-141">Sostituendo la chiamata di `sp_cdc_scan` da parte del passaggio del processo recapitato con una chiamata a un wrapper scritto dall'utente per `sp_cdc_scan`, è possibile ottenere un comportamento notevolmente personalizzato con un minimo sforzo aggiuntivo.</span><span class="sxs-lookup"><span data-stu-id="12785-141">By replacing the delivered job step calling `sp_cdc_scan` with a call to a user written wrapper for `sp_cdc_scan`, highly customized behavior can be obtained with little additional effort.</span></span>  
  
##  <a name="cleanup-job"></a><a name="Cleanup"></a> <span data-ttu-id="12785-142">Processo di pulizia</span><span class="sxs-lookup"><span data-stu-id="12785-142">Cleanup Job</span></span>  
 <span data-ttu-id="12785-143">In questa sezione vengono fornite informazioni sul funzionamento del processo di pulizia di Change Data Capture.</span><span class="sxs-lookup"><span data-stu-id="12785-143">This section provides information about how the change data capture cleanup job works.</span></span>  
  
### <a name="structure-of-the-cleanup-job"></a><span data-ttu-id="12785-144">Struttura del processo di pulizia</span><span class="sxs-lookup"><span data-stu-id="12785-144">Structure of the Cleanup Job</span></span>  
 <span data-ttu-id="12785-145">Change Data Capture utilizza una strategia di pulizia basata su memorizzazione per gestire le dimensioni delle tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-145">Change data capture uses a retention based cleanup strategy to manage change table size.</span></span> <span data-ttu-id="12785-146">Il meccanismo di pulizia è costituito da un processo [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] di [!INCLUDE[tsql](../../includes/tsql-md.md)] Agent creato durante l'abilitazione della prima tabella di database.</span><span class="sxs-lookup"><span data-stu-id="12785-146">The cleanup mechanism consists of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] job that is created when the first database table is enabled.</span></span> <span data-ttu-id="12785-147">Un singolo processo di pulizia gestisce la pulizia per tutte le tabelle delle modifiche del database e applica lo stesso valore di memorizzazione a tutte le istanze di acquisizione definite.</span><span class="sxs-lookup"><span data-stu-id="12785-147">A single cleanup job handles cleanup for all database change tables and applies the same retention value to all defined capture instances.</span></span>  
  
 <span data-ttu-id="12785-148">Il processo di pulizia viene avviato tramite l'esecuzione della stored procedure `sp_MScdc_cleanup_job` senza parametri.</span><span class="sxs-lookup"><span data-stu-id="12785-148">The cleanup job is initiated by running the parameterless stored procedure `sp_MScdc_cleanup_job`.</span></span> <span data-ttu-id="12785-149">Questa stored procedure estrae innanzitutto i valori di memorizzazione e soglia configurati per il processo di pulizia da `msdb.dbo.cdc_jobs`.</span><span class="sxs-lookup"><span data-stu-id="12785-149">This stored procedure starts by extracting the configured retention and threshold values for the cleanup job from `msdb.dbo.cdc_jobs`.</span></span> <span data-ttu-id="12785-150">Il valore di memorizzazione viene utilizzato per calcolare un nuovo limite minimo per le tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-150">The retention value is used to compute a new low watermark for the change tables.</span></span> <span data-ttu-id="12785-151">Il numero di minuti specificato viene sottratto dal valore di *tran_end_time* massimo della `cdc.lsn_time_mapping` tabella per ottenere il nuovo contrassegno inferiore espresso come valore DateTime.</span><span class="sxs-lookup"><span data-stu-id="12785-151">The specified number of minutes is subtracted from the maximum *tran_end_time* value from the `cdc.lsn_time_mapping` table to obtain the new low water mark expressed as a datetime value.</span></span> <span data-ttu-id="12785-152">Viene quindi utilizzata la tabella CDC.lsn_time_mapping per convertire questo valore datetime in un valore `lsn` corrispondente.</span><span class="sxs-lookup"><span data-stu-id="12785-152">The CDC.lsn_time_mapping table is then used to convert this datetime value to a corresponding `lsn` value.</span></span> <span data-ttu-id="12785-153">Se più voci della tabella condividono la stessa ora di esecuzione del commit, come nuovo limite minimo viene scelto il valore `lsn` corrispondente alla voce associata al valore `lsn` minore.</span><span class="sxs-lookup"><span data-stu-id="12785-153">If the same commit time is shared by multiple entries in the table, the `lsn` that corresponds to the entry that has the smallest `lsn` is chosen as the new low watermark.</span></span> <span data-ttu-id="12785-154">Il valore `lsn` viene passato a `sp_cdc_cleanup_change_tables` per rimuovere le voci dalle tabelle delle modifiche del database.</span><span class="sxs-lookup"><span data-stu-id="12785-154">This `lsn` value is passed to `sp_cdc_cleanup_change_tables` to remove change table entries from the database change tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12785-155">L'utilizzo dell'ora di esecuzione del commit della transazione recente come base per il calcolo del nuovo limite minimo offre il vantaggio di poter mantenere le modifiche nelle tabelle delle modifiche per il tempo specificato.</span><span class="sxs-lookup"><span data-stu-id="12785-155">The advantage of using the commit time of the recent transaction as the base for computing the new low watermark is that it lets the changes remain in change tables for the specified time.</span></span> <span data-ttu-id="12785-156">Questa situazione si verifica anche quando è in esecuzione il processo di acquisizione sottostante.</span><span class="sxs-lookup"><span data-stu-id="12785-156">This happens even when the capture process is running behind.</span></span> <span data-ttu-id="12785-157">Tutte le voci associate alla stessa ora del commit del limite minimo corrente continuano a essere rappresentate all'interno delle tabelle delle modifiche scegliendo il valore `lsn` minore associato all'ora del commit condivisa per il limite minimo effettivo.</span><span class="sxs-lookup"><span data-stu-id="12785-157">All entries that have the same commit time as the current low watermark continue to be represented within the change tables by choosing the smallest `lsn` that has the shared commit time for the actual low watermark.</span></span>  
  
 <span data-ttu-id="12785-158">Quando viene eseguita una pulizia, il limite minimo per tutte le istanze di acquisizione viene inizialmente aggiornato in una singola transazione.</span><span class="sxs-lookup"><span data-stu-id="12785-158">When a cleanup is performed, the low watermark for all capture instances is initially updated in a single transaction.</span></span> <span data-ttu-id="12785-159">Viene quindi effettuato il tentativo di rimozione delle voci obsolete dalle tabelle delle modifiche e dalla tabella cdc.lsn_time_mapping.</span><span class="sxs-lookup"><span data-stu-id="12785-159">It then tries to remove obsolete entries from the change tables and the cdc.lsn_time_mapping table.</span></span> <span data-ttu-id="12785-160">Il valore soglia configurabile limita il numero di voci eliminate in ogni singola istruzione.</span><span class="sxs-lookup"><span data-stu-id="12785-160">The configurable threshold value limits how many entries are deleted in any single statement.</span></span> <span data-ttu-id="12785-161">La mancata esecuzione dell'eliminazione in una singola tabella non impedirà il tentativo di eliminazione nelle altre.</span><span class="sxs-lookup"><span data-stu-id="12785-161">Failure to perform the delete on any individual table will not prevent the operation from being attempted on the remaining tables.</span></span>  
  
### <a name="cleanup-job-customization"></a><span data-ttu-id="12785-162">Personalizzazione del processo di pulizia</span><span class="sxs-lookup"><span data-stu-id="12785-162">Cleanup Job Customization</span></span>  
 <span data-ttu-id="12785-163">Per il processo di pulizia, la possibilità di personalizzazione consiste nella strategia utilizzata per determinare le voci delle tabelle delle modifiche da ignorare.</span><span class="sxs-lookup"><span data-stu-id="12785-163">For the cleanup job, the possibility for customization is in the strategy used to determine which change table entries are to be discarded.</span></span> <span data-ttu-id="12785-164">L'unica strategia supportata nel processo di pulizia è basata sul tempo.</span><span class="sxs-lookup"><span data-stu-id="12785-164">The only supported strategy in the delivered cleanup job is a time-based one.</span></span> <span data-ttu-id="12785-165">In questa situazione, il nuovo limite minimo viene calcolato sottraendo il periodo di memorizzazione consentito dall'ora di esecuzione del commit dell'ultima transazione elaborata.</span><span class="sxs-lookup"><span data-stu-id="12785-165">In that situation, the new low watermark is computed by subtracting the allowed retention period from the commit time of the last transaction processed.</span></span> <span data-ttu-id="12785-166">Poiché le procedure di pulizia sottostanti sono basate su `lsn` anziché sul tempo, è possibile usare qualsiasi strategia per determinare il valore `lsn` minimo da mantenere nelle tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-166">Because the underlying cleanup procedures are based on `lsn` instead of time, any number of strategies can be used to determine the smallest `lsn` to keep in the change tables.</span></span> <span data-ttu-id="12785-167">Solo alcuni di questi valori sono rigorosamente basati sul tempo.</span><span class="sxs-lookup"><span data-stu-id="12785-167">Only some of these are strictly time-based.</span></span> <span data-ttu-id="12785-168">È possibile, ad esempio, utilizzare le informazioni sui client come valida alternativa in caso di mancata esecuzione dei processi a valle che richiedono l'accesso alle tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-168">Knowledge about the clients, for example, could be used to provide a failsafe if downstream processes that require access to the change tables cannot run.</span></span> <span data-ttu-id="12785-169">Benché la strategia predefinita applichi lo stesso valore `lsn` per pulire tutte le tabelle delle modifiche dei database è inoltre possibile chiamare la procedura di pulizia sottostante anche per eseguire la pulizia a livello di istanza di acquisizione.</span><span class="sxs-lookup"><span data-stu-id="12785-169">Also, although the default strategy applies the same `lsn` to clean up all the databases' change tables, the underlying cleanup procedure, can also be called to clean up at the capture instance level.</span></span>  
  
##  <a name="monitor-the-change-data-capture-process"></a><a name="Monitor"></a> <span data-ttu-id="12785-170">Monitoraggio del processo Change Data Capture</span><span class="sxs-lookup"><span data-stu-id="12785-170">Monitor the Change Data Capture Process</span></span>  
 <span data-ttu-id="12785-171">Il monitoraggio del processo Change Data Capture consente di determinare se le modifiche vengono scritte correttamente e con una latenza ragionevole nelle tabelle delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-171">Monitoring the change data capture process lets you determine if changes are being written correctly and with a reasonable latency to the change tables.</span></span> <span data-ttu-id="12785-172">L'esecuzione il monitoraggio può consentire anche di identificare gli errori che si potrebbero verificare.</span><span class="sxs-lookup"><span data-stu-id="12785-172">Monitoring can also help you to identify any errors that might occur.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="12785-173">sono incluse due DMV per monitorare Change Data Capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) e [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span><span class="sxs-lookup"><span data-stu-id="12785-173">includes two dynamic management views to help you monitor change data capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) and [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span></span>  
  
### <a name="identify-sessions-with-empty-result-sets"></a><span data-ttu-id="12785-174">Identificazione di sessioni con set di risultati vuoti</span><span class="sxs-lookup"><span data-stu-id="12785-174">Identify Sessions with Empty Result Sets</span></span>  
 <span data-ttu-id="12785-175">Ogni riga in sys.dm_cdc_log_scan_sessions rappresenta una sessione di analisi del log, ad eccezione della riga con ID 0.</span><span class="sxs-lookup"><span data-stu-id="12785-175">Every row in sys.dm_cdc_log_scan_sessions represents a log scan session (except the row with an ID of 0).</span></span> <span data-ttu-id="12785-176">Una sessione di analisi del log è equivalente a un'esecuzione di [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12785-176">A log scan session is equivalent to one execution of [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span></span> <span data-ttu-id="12785-177">Durante una sessione, l'analisi può restituire modifiche o un risultato vuoto.</span><span class="sxs-lookup"><span data-stu-id="12785-177">During a session, the scan can either return changes or return an empty result.</span></span> <span data-ttu-id="12785-178">Se il set di risultati è vuoto, la colonna empty_scan_count in sys.dm_cdc_log_scan_sessions è impostata su 1.</span><span class="sxs-lookup"><span data-stu-id="12785-178">If the result set is empty, the empty_scan_count column in sys.dm_cdc_log_scan_sessions is set to 1.</span></span> <span data-ttu-id="12785-179">Se si ottengono set di risultati vuoti consecutivi, ad esempio nel caso in cui il processo di acquisizione viene eseguito in modo continuo, il valore di empty_scan_count nell'ultima riga esistente viene incrementato.</span><span class="sxs-lookup"><span data-stu-id="12785-179">If there are consecutive empty result sets, such as if the capture job is running continuously, the empty_scan_count in the last existing row is incremented.</span></span> <span data-ttu-id="12785-180">Se ad esempio sys.dm_cdc_log_scan_sessions contiene già 10 righe per analisi che hanno restituito modifiche e in una riga sono presenti cinque risultati vuoti, la vista contiene 11 righe.</span><span class="sxs-lookup"><span data-stu-id="12785-180">For example, if sys.dm_cdc_log_scan_sessions already contains 10 rows for scans that returned changes and there are five empty results in a row, the view contains 11 rows.</span></span> <span data-ttu-id="12785-181">L'ultima riga presenta il valore 5 nella colonna empty_scan_count.</span><span class="sxs-lookup"><span data-stu-id="12785-181">The last row has a value of 5 in the empty_scan_count column.</span></span> <span data-ttu-id="12785-182">Per determinare le sessioni per cui l'analisi è risultata vuota, eseguire la query seguente:</span><span class="sxs-lookup"><span data-stu-id="12785-182">To determine sessions that had an empty scan, run the following query:</span></span>  
  
```sql
SELECT * from sys.dm_cdc_log_scan_sessions where empty_scan_count <> 0
```
  
### <a name="determine-latency"></a><span data-ttu-id="12785-183">Determinazione della latenza</span><span class="sxs-lookup"><span data-stu-id="12785-183">Determine Latency</span></span>  
 <span data-ttu-id="12785-184">La vista a gestione dinamica sys.dm_cdc_log_scan_sessions include una colonna in cui viene registrata la latenza per ogni sessione di acquisizione.</span><span class="sxs-lookup"><span data-stu-id="12785-184">The sys.dm_cdc_log_scan_sessions management view includes a column that records the latency for each capture session.</span></span> <span data-ttu-id="12785-185">Con il termine latenza si definisce il tempo che trascorre tra una transazione, il cui commit viene eseguito in una tabella di origine e l'ultima transazione acquisita, il cui commit viene eseguito nella tabella delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="12785-185">Latency is defined as the elapsed time between a transaction being committed on a source table and the last captured transaction being committed on the change table.</span></span> <span data-ttu-id="12785-186">La colonna della latenza viene popolata solo per le sessioni attive.</span><span class="sxs-lookup"><span data-stu-id="12785-186">The latency column is populated only for active sessions.</span></span> <span data-ttu-id="12785-187">Per le sessioni con un valore maggiore di 0 nella colonna empty_scan_count, la colonna della latenza è impostata su 0.</span><span class="sxs-lookup"><span data-stu-id="12785-187">For sessions with a value greater than 0 in the empty_scan_count column, the latency column is set to 0.</span></span> <span data-ttu-id="12785-188">La query seguente restituisce la latenza media per le sessioni più recenti:</span><span class="sxs-lookup"><span data-stu-id="12785-188">The following query returns the average latency for the most recent sessions:</span></span>  
  
```sql
SELECT latency FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
 <span data-ttu-id="12785-189">È possibile utilizzare i dati della latenza da determinare la velocità con la quale il processo di acquisizione elabora le transazioni.</span><span class="sxs-lookup"><span data-stu-id="12785-189">You can use latency data to determine how fast or slow the capture process is processing transactions.</span></span> <span data-ttu-id="12785-190">Questi dati dimostrano tutta la loro utilità quando il processo di acquisizione viene eseguito in modo continuo.</span><span class="sxs-lookup"><span data-stu-id="12785-190">This data is most useful when the capture process is running continuously.</span></span> <span data-ttu-id="12785-191">Se il processo di acquisizione viene eseguito in base a una pianificazione, la latenza può aumentare a causa del tempo che trascorre tra le transazioni di cui viene eseguito il commit nella tabella di origine, con il processo di acquisizione che continua a essere eseguito in base alla pianificazione.</span><span class="sxs-lookup"><span data-stu-id="12785-191">If the capture process is running on a schedule, latency can be high because of the lag between transactions being committed on the source table and the capture process running at its scheduled time.</span></span>  
  
 <span data-ttu-id="12785-192">Un altro importante indicatore di prestazioni del processo di acquisizione è la velocità effettiva.</span><span class="sxs-lookup"><span data-stu-id="12785-192">Another important measure of capture process efficiency is throughput.</span></span> <span data-ttu-id="12785-193">Si tratta del numero medio di comandi al secondo elaborati durante ogni sessione.</span><span class="sxs-lookup"><span data-stu-id="12785-193">This is the average number of commands per second that are processed during each session.</span></span> <span data-ttu-id="12785-194">Per determinare la velocità effettiva di una sessione, dividere il valore presente nella colonna command_count per il valore presente nella colonna della durata.</span><span class="sxs-lookup"><span data-stu-id="12785-194">To determine the throughput of a session, divide the value in the command_count column by the value in the duration column.</span></span> <span data-ttu-id="12785-195">La query seguente restituisce la velocità effettiva media per le sessioni più recenti:</span><span class="sxs-lookup"><span data-stu-id="12785-195">The following query returns the average throughput for the most recent sessions:</span></span>  
  
```sql
SELECT command_count/duration AS [Throughput] FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
### <a name="use-data-collector-to-collect-sampling-data"></a><span data-ttu-id="12785-196">Utilizzo dell'agente di raccolta dati per raccogliere dati di campionamento</span><span class="sxs-lookup"><span data-stu-id="12785-196">Use Data Collector to Collect Sampling Data</span></span>  
 <span data-ttu-id="12785-197">L'agente di raccolta dati disponibile in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] consente di raccogliere snapshot di dati da qualsiasi tabella o DMV e compilare un data warehouse contenente dati relativi alle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="12785-197">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data collector lets you collect snapshots of data from any table or dynamic management view and build a performance data warehouse.</span></span> <span data-ttu-id="12785-198">Quando Change Data Capture è abilitato in un database, è possibile raccogliere snapshot delle viste sys.dm_cdc_log_scan_sessions e sys.dm_cdc_errors a intervalli regolari per poterli analizzare.</span><span class="sxs-lookup"><span data-stu-id="12785-198">When change data capture is enabled on a database, it is useful to take snapshots of the sys.dm_cdc_log_scan_sessions view and the sys.dm_cdc_errors view at regular intervals for later analysis.</span></span> <span data-ttu-id="12785-199">Nella procedura seguente viene impostato un agente di raccolta dati per raccogliere dati di campionamento dalla vista a gestione dinamica sys.dm_cdc_log_scan_sessions.</span><span class="sxs-lookup"><span data-stu-id="12785-199">The following procedure sets up a data collector for collecting sample data from the sys.dm_cdc_log_scan_sessions management view.</span></span>  
  
 <span data-ttu-id="12785-200">**Configurazione della raccolta dati**</span><span class="sxs-lookup"><span data-stu-id="12785-200">**Configuring Data Collection**</span></span>  
  
1.  <span data-ttu-id="12785-201">Abilitare l'agente di raccolta dati e configurare un data warehouse di gestione.</span><span class="sxs-lookup"><span data-stu-id="12785-201">Enable data collector and configure a management data warehouse.</span></span> <span data-ttu-id="12785-202">Per altre informazioni, vedere [Gestire raccolta dati](../data-collection/data-collection.md).</span><span class="sxs-lookup"><span data-stu-id="12785-202">For more information, see [Manage Data Collection](../data-collection/data-collection.md).</span></span>  
  
2.  <span data-ttu-id="12785-203">Eseguire il codice seguente per creare un agente di raccolta personalizzato per Change Data Capture.</span><span class="sxs-lookup"><span data-stu-id="12785-203">Execute the following code to create a custom collector for change data capture.</span></span>  
  
    ```sql  
    USE msdb;  
  
    DECLARE @schedule_uid uniqueidentifier;  
  
    -- Collect and upload data every 5 minutes  
    SELECT @schedule_uid = (  
    SELECT schedule_uid from sysschedules_localserver_view   
    WHERE name = N'CollectorSchedule_Every_5min')  
  
    DECLARE @collection_set_id int;  
  
    EXEC dbo.sp_syscollector_create_collection_set  
    @name = N' CDC Performance Data Collector',  
    @schedule_uid = @schedule_uid,          
    @collection_mode = 0,                   
    @days_until_expiration = 30,                
    @description = N'This collection set collects CDC metadata',  
    @collection_set_id = @collection_set_id output;  
  
    -- Create a collection item using statistics from   
    -- the change data capture dynamic management view.  
    DECLARE @parameters xml;  
    DECLARE @collection_item_id int;  
  
    SELECT @parameters = CONVERT(xml,   
        N'<TSQLQueryCollector>  
            <Query>  
              <Value>SELECT * FROM sys.dm_cdc_log_scan_sessions</Value>  
              <OutputTable>cdc_log_scan_data</OutputTable>  
            </Query>  
          </TSQLQueryCollector>');  
  
    EXEC dbo.sp_syscollector_create_collection_item  
    @collection_set_id = @collection_set_id,  
    @collector_type_uid = N'302E93D1-3424-4BE7-AA8E-84813ECF2419',  
    @name = ' CDC Performance Data Collector',  
    @frequency = 5,   
    @parameters = @parameters,  
    @collection_item_id = @collection_item_id output;  
  
    GO  
    ```  
  
3.  <span data-ttu-id="12785-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]espandere **Gestione**, quindi espandere **Raccolta dati**.</span><span class="sxs-lookup"><span data-stu-id="12785-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expand **Management**, and then expand **Data Collection**.</span></span> <span data-ttu-id="12785-205">Fare clic con il pulsante destro del mouse su **CDC Performance Data Collector**, quindi fare clic su **Avvia set di raccolta dati**.</span><span class="sxs-lookup"><span data-stu-id="12785-205">Right click **CDC Performance Data Collector**, and then click **Start Data Collection Set**.</span></span>  
  
4.  <span data-ttu-id="12785-206">Nel data warehouse configurato nel passaggio 1 trovare la tabella custom_snapshots.cdc_log_scan_data.</span><span class="sxs-lookup"><span data-stu-id="12785-206">In the data warehouse you configured in step 1, locate the table custom_snapshots.cdc_log_scan_data.</span></span> <span data-ttu-id="12785-207">In questa tabella viene fornito uno snapshot cronologico di dati dalle sessioni di analisi del log.</span><span class="sxs-lookup"><span data-stu-id="12785-207">This table provides a historical snapshot of data from log scan sessions.</span></span> <span data-ttu-id="12785-208">Questi dati possono essere utilizzati per analizzare nel corso del tempo latenza, velocità effettiva e altri indicatori di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="12785-208">This data can be used to analyze latency, throughput, and other performance measures over time.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="12785-209">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="12785-209">See Also</span></span>  
 <span data-ttu-id="12785-210">[Tenere traccia delle modifiche ai dati &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="12785-210">[Track Data Changes &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="12785-211">[Informazioni su Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="12785-211">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="12785-212">[Abilitare e disabilitare Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="12785-212">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="12785-213">Usare i dati delle modifiche &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="12785-213">Work with Change Data &#40;SQL Server&#41;</span></span>](work-with-change-data-sql-server.md)  
  
  
