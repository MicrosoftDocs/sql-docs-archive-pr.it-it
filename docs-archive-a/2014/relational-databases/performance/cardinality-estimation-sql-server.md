---
title: Stima della cardinalità (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87637828"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="31c93-102">Stima della cardinalità (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="31c93-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="31c93-103">La logica di stima della cardinalità, denominata strumento di stima della cardinalità, è stata riprogettata in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] per migliorare la qualità dei piani di query e, di conseguenza, per ottimizzare le prestazioni delle query.</span><span class="sxs-lookup"><span data-stu-id="31c93-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="31c93-104">Nel nuovo strumento di stima della cardinalità sono incorporati presupposti e algoritmi maggiormente adatti ai i carichi di lavoro di data warehouse e alle soluzioni OLTP più recenti.</span><span class="sxs-lookup"><span data-stu-id="31c93-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="31c93-105">Lo strumento è basato sulla ricerca approfondita della stima della cardinalità sui carichi di lavoro più recenti e sulle conoscenze relative al miglioramento della stima della cardinalità di SQL Server acquisite nel corso degli ultimi 15 anni.</span><span class="sxs-lookup"><span data-stu-id="31c93-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="31c93-106">I commenti e i suggerimenti dei clienti indicano che sebbene la maggior parte delle query registrerà un miglioramento o rimarrà invariata a seguito della modifica, una percentuale minima potrebbe registrare una regressione rispetto allo strumento di stima della cardinalità precedente.</span><span class="sxs-lookup"><span data-stu-id="31c93-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="31c93-107">Le stime della cardinalità sono una stima del numero di righe nel risultato della query.</span><span class="sxs-lookup"><span data-stu-id="31c93-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="31c93-108">Query Optimizer usa queste stime per scegliere un piano per l'esecuzione della query.</span><span class="sxs-lookup"><span data-stu-id="31c93-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="31c93-109">La qualità del piano di query influisce direttamente sul miglioramento delle prestazioni della query.</span><span class="sxs-lookup"><span data-stu-id="31c93-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="31c93-110">Indicazioni per il test e l'ottimizzazione delle prestazioni</span><span class="sxs-lookup"><span data-stu-id="31c93-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="31c93-111">Il nuovo strumento di stima della cardinalità è abilitato per tutti i nuovi database creati in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span><span class="sxs-lookup"><span data-stu-id="31c93-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="31c93-112">Tuttavia, l'aggiornamento a [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] non abilita il nuovo strumento di stima della cardinalità sui database esistenti.</span><span class="sxs-lookup"><span data-stu-id="31c93-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="31c93-113">Per garantire le prestazioni ottimali per le query, fare riferimento alle indicazioni riportate di seguito per testare il carico di lavoro con il nuovo strumento di stima della cardinalità prima di abilitarlo nel sistema di produzione.</span><span class="sxs-lookup"><span data-stu-id="31c93-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="31c93-114">Aggiornare tutti i database esistenti per l'uso del nuovo strumento di stima della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="31c93-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="31c93-115">A tale scopo, usare [ALTER DATABASE Compatibility level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) per impostare il livello di compatibilità del database su 120.</span><span class="sxs-lookup"><span data-stu-id="31c93-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="31c93-116">Eseguire il carico di lavoro di prova con il nuovo strumento di stima della cardinalità e quindi risolvere gli eventuali nuovi problemi relativi alle prestazioni adottando le attuali procedure per la risoluzione dei problemi.</span><span class="sxs-lookup"><span data-stu-id="31c93-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="31c93-117">Quando il carico di lavoro è in esecuzione con il nuovo strumento di stima della cardinalità (con livello di compatibilità del database impostato su 120 in SQL Server 2014) e le prestazioni di una query specifica registrano una regressione, è possibile eseguire la query con il flag di traccia 9481 per usare la versione dello strumento di stima della cardinalità usato in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] e versioni precedenti.</span><span class="sxs-lookup"><span data-stu-id="31c93-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="31c93-118">Per eseguire una query con un flag di traccia, vedere l'articolo della Knowledge Base relativo all' [abilitazione del comportamento di SQL Server Query Optimizer con effetto sul piano che può essere controllato da flag di traccia diversi al livello della query specifica](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="31c93-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="31c93-119">Se non è possibile modificare contemporaneamente tutti i database per usare il nuovo strumento di stima della cardinalità, è possibile usare lo strumento di stima della cardinalità precedente per tutti i database usando il [livello di compatibilità ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) per impostare il livello di compatibilità del database su 110.</span><span class="sxs-lookup"><span data-stu-id="31c93-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="31c93-120">Se il carico di lavoro è in esecuzione con il livello di compatibilità del database impostato su 110 e si vuole verificare o eseguire una query specifica con il nuovo strumento di stima della cardinalità, è possibile eseguire la query con il flag di traccia 2312 per usare la versione di tale strumento inclusa in SQL Server 2014.</span><span class="sxs-lookup"><span data-stu-id="31c93-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="31c93-121">Per eseguire una query con un flag di traccia, vedere l'articolo della Knowledge Base relativo all' [abilitazione del comportamento di SQL Server Query Optimizer con effetto sul piano che può essere controllato da flag di traccia diversi al livello della query specifica](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="31c93-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="31c93-122">Nuovi XEvent</span><span class="sxs-lookup"><span data-stu-id="31c93-122">New XEvents</span></span>  
 <span data-ttu-id="31c93-123">Sono disponibili due nuovi XEvent query_optimizer_estimate_cardinality per supportare i nuovi piani di query.</span><span class="sxs-lookup"><span data-stu-id="31c93-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="31c93-124">*query_optimizer_estimate_cardinality* si verifica quando Query Optimizer stima la cardinalità in un'espressione relazionale.</span><span class="sxs-lookup"><span data-stu-id="31c93-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="31c93-125">*query_optimizer_force_both_cardinality_estimation*_behaviors si verifica quando entrambi i flag di traccia 2312 e 9481 sono abilitati e tentano di forzare contemporaneamente sia il comportamento precedente della stima della cardinalità sia quello nuovo.</span><span class="sxs-lookup"><span data-stu-id="31c93-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="31c93-126">Esempi</span><span class="sxs-lookup"><span data-stu-id="31c93-126">Examples</span></span>  
 <span data-ttu-id="31c93-127">Negli esempi seguenti sono illustrate alcune delle modifiche introdotte nelle nuove stime della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="31c93-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="31c93-128">Il codice per la stima della cardinalità è stato riscritto.</span><span class="sxs-lookup"><span data-stu-id="31c93-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="31c93-129">La logica è complessa e non è possibile fornire un elenco completo di tutte le modifiche.</span><span class="sxs-lookup"><span data-stu-id="31c93-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="31c93-130">Questi esempi sono forniti a titolo di informazioni concettuali.</span><span class="sxs-lookup"><span data-stu-id="31c93-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="31c93-131">All'utente non è richiesta alcuna modifica rispetto alla modalità di progettazione di database e query.</span><span class="sxs-lookup"><span data-stu-id="31c93-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="31c93-132">Esempio A. Le nuove stime della cardinalità usano una cardinalità media per i dati in ordine crescente aggiunti di recente.</span><span class="sxs-lookup"><span data-stu-id="31c93-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="31c93-133">Questo esempio illustra come il nuovo strumento di stima della cardinalità può migliorare le stime della cardinalità per i dati in ordine crescente che superano il valore massimo nella tabella durante l'aggiornamento delle statistiche più recente.</span><span class="sxs-lookup"><span data-stu-id="31c93-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="31c93-134">In questo esempio, le nuove righe vengono aggiunte alla tabella Sales ogni giorno, la query richiede le vendite eseguite in data 19/12/2013 e l'ultimo aggiornamento delle statistiche è stato effettuato in data 18/12/2013.</span><span class="sxs-lookup"><span data-stu-id="31c93-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="31c93-135">Lo strumento di stima della cardinalità precedente presuppone che i valori relativi al 19/12/2013 non esistano poiché la data supera la data massima e le statistiche non sono state aggiornate per includere i valori del 19/12/2013.</span><span class="sxs-lookup"><span data-stu-id="31c93-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="31c93-136">Questa situazione, nota come problema della chiave crescente, si verificherà se si caricano dati durante il giorno e quindi si eseguono query sui dati prima che le statistiche vengano aggiornate.</span><span class="sxs-lookup"><span data-stu-id="31c93-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="31c93-137">Questo comportamento è stato modificato.</span><span class="sxs-lookup"><span data-stu-id="31c93-137">This behavior has changed.</span></span> <span data-ttu-id="31c93-138">Ora, anche se le statistiche non sono state aggiornate per i dati crescenti più recenti aggiunti dall'ultimo aggiornamento delle statistiche, il nuovo strumento di stima della cardinalità presuppone che i valori esistano e usa la cardinalità media per ogni valore nella colonna come stima della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="31c93-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="31c93-139">Esempio B. Le nuove stime della cardinalità presuppongono che i predicati filtrati nella stessa tabella presentino una correlazione.</span><span class="sxs-lookup"><span data-stu-id="31c93-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="31c93-140">Per questo esempio, si supponga che nella tabella Cars siano presenti 1000 righe, che in Make siano presenti 200 corrispondenze per "Honda", che in Model siano presenti 50 corrispondenze per "Civic" e che tutte le Civic siano Honda.</span><span class="sxs-lookup"><span data-stu-id="31c93-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="31c93-141">Di conseguenza, il 20% dei valori nella colonna Make sono "Honda", il 5% dei valori nella colonna del modello sono "Civic" e il numero effettivo di Honda Civic è 50.</span><span class="sxs-lookup"><span data-stu-id="31c93-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="31c93-142">Le stime della cardinalità precedenti presuppongono che i valori nelle colonne Make e Model siano indipendenti gli uni dagli altri.</span><span class="sxs-lookup"><span data-stu-id="31c93-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="31c93-143">Il Query Optimizer precedente stima che ci sono 10 Honda Civics (05 \* 0,20 \* 1000 righe = 10 righe).</span><span class="sxs-lookup"><span data-stu-id="31c93-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="31c93-144">Questo comportamento è stato modificato.</span><span class="sxs-lookup"><span data-stu-id="31c93-144">This behavior has changed.</span></span> <span data-ttu-id="31c93-145">Ora, le nuove stime della cardinalità presuppongono che le colonne Make e Model presentino una *certa* correlazione.</span><span class="sxs-lookup"><span data-stu-id="31c93-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="31c93-146">Query Optimizer stima una cardinalità più elevata mediante l'aggiunta di un componente esponenziale all'equazione di stima.</span><span class="sxs-lookup"><span data-stu-id="31c93-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="31c93-147">Il Query Optimizer ora stima che 22,36 righe (0,05 \* SQRT (. 20) \* 1000 righe = 22,36 righe) corrispondano al predicato.</span><span class="sxs-lookup"><span data-stu-id="31c93-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="31c93-148">Per questo scenario e per la distribuzione di dati specifica, 22,36 righe è un risultato più vicino alle 50 righe che saranno restituite dalla query.</span><span class="sxs-lookup"><span data-stu-id="31c93-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="31c93-149">Si noti che la nuova logica di stima della cardinalità ordina le selettività del predicato e aumenta l'esponente.</span><span class="sxs-lookup"><span data-stu-id="31c93-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="31c93-150">Se, ad esempio, il predicato selettività era 0,05, 0,20 e 0,25, la stima della cardinalità sarebbe (. 05 \* SQRT (20) \* sqrt (sqrt (. 25))).</span><span class="sxs-lookup"><span data-stu-id="31c93-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="31c93-151">Esempio C. Le nuove stime della cardinalità presuppongono che i predicati filtrati in tabelle diverse siano indipendenti.</span><span class="sxs-lookup"><span data-stu-id="31c93-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="31c93-152">Per questo esempio, lo strumento di stima della cardinalità precedente presuppone che i filtri s.type e r.date del predicato siano correlati.</span><span class="sxs-lookup"><span data-stu-id="31c93-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="31c93-153">Tuttavia, i risultati di prova sui carichi di lavoro più recenti mostrano che i filtri del predicato sulle colonne in tabelle diverse non sono in genere correlati tra loro.</span><span class="sxs-lookup"><span data-stu-id="31c93-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="31c93-154">Questo comportamento è stato modificato.</span><span class="sxs-lookup"><span data-stu-id="31c93-154">This behavior has changed.</span></span> <span data-ttu-id="31c93-155">Ora, la nuova logica di stima della cardinalità presuppone che s.type non sia correlato a r.date.</span><span class="sxs-lookup"><span data-stu-id="31c93-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="31c93-156">In pratica, si presuppone che i giocattoli siano restituiti ogni giorno e non solo in un giorno specifico.</span><span class="sxs-lookup"><span data-stu-id="31c93-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="31c93-157">In questo caso, le nuove stime della cardinalità restituiranno un numero inferiore rispetto alle stime della cardinalità precedenti.</span><span class="sxs-lookup"><span data-stu-id="31c93-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="31c93-158">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="31c93-158">See Also</span></span>  
 [<span data-ttu-id="31c93-159">Monitoraggio e ottimizzazione delle prestazioni</span><span class="sxs-lookup"><span data-stu-id="31c93-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
