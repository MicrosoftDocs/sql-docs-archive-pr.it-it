---
title: Pubblicazione dell'esecuzione delle stored procedure nella replica transazionale | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publishing [SQL Server replication], stored procedure execution
- articles [SQL Server replication], stored procedures and
- transactional replication, publishing stored procedure execution
ms.assetid: f4686f6f-c224-4f07-a7cb-92f4dd483158
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0fb5c40db46772cabcb5d1df19e03aced749e1c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87722687"
---
# <a name="publishing-stored-procedure-execution-in-transactional-replication"></a><span data-ttu-id="8a2d0-102">Pubblicazione dell'esecuzione delle stored procedure nella replica transazionale</span><span class="sxs-lookup"><span data-stu-id="8a2d0-102">Publishing Stored Procedure Execution in Transactional Replication</span></span>
  <span data-ttu-id="8a2d0-103">Se una o più stored procedure vengono eseguite nel server di pubblicazione e influiscono su tabelle pubblicate, è possibile includerle nella pubblicazione sotto forma di articoli di esecuzione delle stored procedure.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-103">If you have one or more stored procedures that execute at the Publisher and affect published tables, consider including those stored procedures in your publication as stored procedure execution articles.</span></span> <span data-ttu-id="8a2d0-104">La definizione della procedura, ovvero l'istruzione CREATE PROCEDURE, viene replicata nel Sottoscrittore durante l'inizializzazione della sottoscrizione. Quando la procedura viene eseguita nel server di pubblicazione, la replica esegue la procedura corrispondente nel Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-104">The definition of the procedure (the CREATE PROCEDURE statement) is replicated to the Subscriber when the subscription is initialized; when the procedure is executed at the Publisher, replication executes the corresponding procedure at the Subscriber.</span></span> <span data-ttu-id="8a2d0-105">Ciò può migliorare sensibilmente le prestazioni, ad esempio nel caso di operazioni batch di grandi dimensioni, poiché viene replicata solo l'esecuzione della procedura senza necessità di replicare le singole modifiche di ogni riga.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-105">This can provide significantly better performance for cases where large batch operations are performed, because only the procedure execution is replicated, bypassing the need to replicate the individual changes for each row.</span></span> <span data-ttu-id="8a2d0-106">Si supponga, ad esempio, di creare la stored procedure seguente nel database di pubblicazione:</span><span class="sxs-lookup"><span data-stu-id="8a2d0-106">For example, assume you create the following stored procedure in the publication database:</span></span>  
  
```  
CREATE PROC give_raise AS  
UPDATE EMPLOYEES SET salary = salary * 1.10  
```  
  
 <span data-ttu-id="8a2d0-107">La stored procedure assegna a ognuno dei 10.000 dipendenti della società un aumento di stipendio del 10%.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-107">This procedure gives each of the 10,000 employees in your company a 10 percent pay increase.</span></span> <span data-ttu-id="8a2d0-108">Quando si esegue la stored procedure nel server di pubblicazione, viene aggiornato lo stipendio di ogni dipendente.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-108">When you execute this stored procedure at the Publisher, it updates the salary for each employee.</span></span> <span data-ttu-id="8a2d0-109">Senza la replica dell'esecuzione della stored procedure, l'aggiornamento verrebbe inviato ai Sottoscrittori sotto forma di transazione multipla di grandi dimensioni:</span><span class="sxs-lookup"><span data-stu-id="8a2d0-109">Without the replication of stored procedure execution, the update would be sent to Subscribers as a large, multi-step transaction:</span></span>  
  
```  
BEGIN TRAN  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 1'  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 2'  
```  
  
 <span data-ttu-id="8a2d0-110">La stessa riga di codice viene eseguita per ognuno dei 10.000 dipendenti.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-110">And this repeats for 10,000 updates.</span></span>  
  
 <span data-ttu-id="8a2d0-111">Tramite la replica dell'esecuzione della stored procedure, viene inviato solo il comando di esecuzione della stored procedure nel Sottoscrittore, anziché scrivere tutti gli aggiornamenti nel database di distribuzione e inviarli in rete al Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-111">With the replication of stored procedure execution, replication sends only the command to execute the stored procedure at the Subscriber, rather than writing all the updates to the distribution database and then sending them over the network to the Subscriber:</span></span>  
  
```  
EXEC give_raise  
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="8a2d0-112">La replica delle stored procedure non è adatta a tutte le applicazioni.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-112">Stored procedure replication is not appropriate for all applications.</span></span> <span data-ttu-id="8a2d0-113">Se in seguito all'applicazione di un filtro orizzontale a un articolo il server di pubblicazione include set di righe diversi rispetto al Sottoscrittore, l'esecuzione della stessa stored procedure nei due server restituisce risultati diversi.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-113">If an article is filtered horizontally, so that there are different sets of rows at the Publisher than at the Subscriber, executing the same stored procedure at both returns different results.</span></span> <span data-ttu-id="8a2d0-114">In modo analogo, se un aggiornamento è basato su una sottoquery di un'altra tabella non replicata, l'esecuzione della stessa stored procedure nel server di pubblicazione e nel Sottoscrittore restituisce risultati diversi.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-114">Similarly, if an update is based on a subquery of another, nonreplicated table, executing the same stored procedure at both the Publisher and Subscriber returns different results.</span></span>  
  
 <span data-ttu-id="8a2d0-115">**Per pubblicare l'esecuzione di una stored procedure**</span><span class="sxs-lookup"><span data-stu-id="8a2d0-115">**To publish the execution of a stored procedure**</span></span>  
  
-   <span data-ttu-id="8a2d0-116">SQL Server Management Studio: [Pubblicare l'esecuzione di una stored procedure in una pubblicazione transazionale &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="8a2d0-116">SQL Server Management Studio: [Publish the Execution of a Stored Procedure in a Transactional Publication &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="8a2d0-117">Programmazione Transact-SQL della replica: eseguire [sp_addarticle &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) e specificare un valore ' serializable proc exec ' (consigliato) o ' proc exec ' per il parametro **@type** .</span><span class="sxs-lookup"><span data-stu-id="8a2d0-117">Replication Transact-SQL Programming: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) and specify a value of 'serializable proc exec' (recommended) or 'proc exec' for the parameter **@type**.</span></span> <span data-ttu-id="8a2d0-118">Per altre informazioni sulla definizione degli articoli, vedere [Definire un articolo](../publish/define-an-article.md).</span><span class="sxs-lookup"><span data-stu-id="8a2d0-118">For more information about defining articles, see [Define an Article](../publish/define-an-article.md).</span></span>  
  
## <a name="modifying-the-procedure-at-the-subscriber"></a><span data-ttu-id="8a2d0-119">Modifica della procedura nel Sottoscrittore</span><span class="sxs-lookup"><span data-stu-id="8a2d0-119">Modifying the Procedure at the Subscriber</span></span>  
 <span data-ttu-id="8a2d0-120">Per impostazione predefinita, la definizione della stored procedure nel server di pubblicazione viene distribuita in ogni Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-120">By default, the stored procedure definition at the Publisher is propagated to each Subscriber.</span></span> <span data-ttu-id="8a2d0-121">È comunque possibile modificare la stored procedure anche nel Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-121">However, you can also modify the stored procedure at the Subscriber.</span></span> <span data-ttu-id="8a2d0-122">Ciò risulta utile se nel Sottoscrittore si desidera eseguire logica diversa da quella eseguita nel server di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-122">This is useful if you want different logic to be executed at the Publisher and Subscriber.</span></span> <span data-ttu-id="8a2d0-123">Si supponga, ad esempio, che la stored procedure **sp_big_delete**nel server di pubblicazione svolga due funzioni, ovvero elimini 1.000.000 di righe dalla tabella replicata **big_table1** e aggiorni la tabella non replicata **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-123">For example, consider **sp_big_delete**, a stored procedure at the Publisher that has two functions: it deletes 1,000,000 rows from the replicated table **big_table1** and updates the nonreplicated table **big_table2**.</span></span> <span data-ttu-id="8a2d0-124">In questo caso, per ridurre la quantità di risorse di rete utilizzate, è necessario distribuire l'eliminazione del milione di righe come stored procedure pubblicando **sp_big_delete**.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-124">To reduce the demand on network resources, you should propagate the 1 million row delete as a stored procedure by publishing **sp_big_delete**.</span></span> <span data-ttu-id="8a2d0-125">Nel Sottoscrittore è possibile modificare **sp_big_delete** in modo che esegua l'eliminazione delle righe, ma non l'aggiornamento successivo di **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-125">At the Subscriber, you can modify **sp_big_delete** to delete only the 1 million rows and not perform the subsequent update to **big_table2**.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="8a2d0-126">Per impostazione predefinita tutte le modifiche apportate nel server di pubblicazione utilizzando ALTER PROCEDURE vengono distribuite nel Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-126">By default, any changes made using ALTER PROCEDURE at the Publisher are propagated to the Subscriber.</span></span> <span data-ttu-id="8a2d0-127">Per impedire questa operazione, disabilitare la distribuzione delle modifiche dello schema prima di eseguire ALTER PROCEDURE.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-127">To prevent this, disable the propagation of schema changes before executing ALTER PROCEDURE.</span></span> <span data-ttu-id="8a2d0-128">Per informazioni sulle modifiche dello schema, vedere [Apportare modifiche allo schema nei database di pubblicazione](../publish/make-schema-changes-on-publication-databases.md).</span><span class="sxs-lookup"><span data-stu-id="8a2d0-128">For information about schema changes, see [Make Schema Changes on Publication Databases](../publish/make-schema-changes-on-publication-databases.md).</span></span>  
  
## <a name="types-of-stored-procedure-execution-articles"></a><span data-ttu-id="8a2d0-129">Tipi di articoli di esecuzione delle stored procedure</span><span class="sxs-lookup"><span data-stu-id="8a2d0-129">Types of Stored Procedure Execution Articles</span></span>  
 <span data-ttu-id="8a2d0-130">L'esecuzione di una stored procedure può essere pubblicata in due modi diversi, ovvero sotto forma di articolo di esecuzione delle procedure serializzabili e sotto forma di articolo di esecuzione delle procedure.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-130">There are two different ways in which the execution of a stored procedure can be published: serializable procedure execution article and procedure execution article.</span></span>  
  
-   <span data-ttu-id="8a2d0-131">È consigliabile utilizzare l'opzione serializzabile poiché esegue la replica dell'esecuzione della procedura solo se la procedura viene eseguita nel contesto di una transazione serializzabile.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-131">The serializable option is recommended because it replicates the procedure execution only if the procedure is executed within the context of a serializable transaction.</span></span> <span data-ttu-id="8a2d0-132">Se viene eseguita in un contesto diverso, le modifiche ai dati delle tabelle pubblicate vengono replicate come una serie di istruzioni DML.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-132">If the stored procedure is executed from outside a serializable transaction, changes to data in published tables are replicated as a series of DML statements.</span></span> <span data-ttu-id="8a2d0-133">In questo modo i dati nel Sottoscrittore risultano sempre consistenti con i dati nel server di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-133">This behavior contributes to making data at the Subscriber consistent with data at the Publisher.</span></span> <span data-ttu-id="8a2d0-134">Questo risulta particolarmente utile per le operazioni batch, ad esempio operazioni di pulizia dei riferimenti molto estese.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-134">This is especially useful for batch operations, such as large cleanup operations.</span></span>  
  
-   <span data-ttu-id="8a2d0-135">Con l'opzione di esecuzione della procedura, è possibile che l'esecuzione sia stata replicata in tutti i Sottoscrittori, indipendentemente dal fatto che le singole istruzioni nella stored procedure abbiano avuto o meno esito positivo.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-135">With the procedure execution option, it is possible that execution could be replicated to all Subscribers regardless of whether individual statements in the stored procedure were successful.</span></span> <span data-ttu-id="8a2d0-136">Inoltre, poiché le modifiche ai dati apportate dalla stored procedure possono essere presenti in più transazioni, i dati nei Sottoscrittori potrebbero essere incoerenti con i dati nel server di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-136">Furthermore, because changes made to data by the stored procedure can occur within multiple transactions, data at the Subscribers might not be consistent with data at the Publisher.</span></span> <span data-ttu-id="8a2d0-137">Per risolvere questi problemi, è necessario che i Sottoscrittori siano di sola lettura e che si utilizzi un livello di isolamento maggiore di Read Uncommitted.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-137">To address these issues, it is required that Subscribers are read-only and that you use an isolation level greater than read uncommitted.</span></span> <span data-ttu-id="8a2d0-138">Se si utilizza Read Uncommitted, le modifiche ai dati nelle tabelle pubblicate vengono replicate come una serie di istruzioni DML.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-138">If you use read uncommitted, changes to data in published tables are replicated as a series of DML statements.</span></span>  
  
 <span data-ttu-id="8a2d0-139">Nell'esempio seguente viene illustrato il motivo per cui è consigliabile impostare la replica delle procedure sotto forma di articoli di procedure serializzabili.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-139">The following example illustrates why it is recommended that you set up replication of procedures as serializable procedure articles.</span></span>  
  
```  
BEGIN TRANSACTION T1  
SELECT @var = max(col1) FROM tableA  
UPDATE tableA SET col2 = <value>   
   WHERE col1 = @var   
  
BEGIN TRANSACTION T2  
INSERT tableA VALUES <values>  
COMMIT TRANSACTION T2  
```  
  
 <span data-ttu-id="8a2d0-140">Nell'esempio precedente si presuppone che l'istruzione SELECT della transazione T1 venga eseguita prima dell'istruzione INSERT della transazione T2.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-140">In the previous example, it is assumed that the SELECT in transaction T1 happens before the INSERT in transaction T2.</span></span>  
  
 <span data-ttu-id="8a2d0-141">Se la procedura non viene eseguita nell'ambito di una transazione serializzabile, ad esempio con il livello di isolamento impostato su SERIALIZABLE, la transazione T2 potrà inserire una nuova riga nell'intervallo dell'istruzione SELECT della transazione T1. Inoltre il commit della transazione T2 verrà eseguito prima di quello della transazione T1.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-141">If the procedure is not executed within a serializable transaction (with isolation level set to SERIALIZABLE), transaction T2 will be allowed to insert a new row within the range of the SELECT statement in T1 and it will commit before T1.</span></span> <span data-ttu-id="8a2d0-142">Questo significa infine che T2 verrà applicata nel Sottoscrittore prima di T1.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-142">This also means that it will be applied at the Subscriber before T1.</span></span> <span data-ttu-id="8a2d0-143">Quando T1 viene applicata nel Sottoscrittore, è possibile che l'istruzione SELECT restituisca un valore diverso di quello presente nel server di pubblicazione e che si ottenga un risultato diverso dall'istruzione UPDATE.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-143">When T1 is applied at the Subscriber, the SELECT can potentially return a different value than at the Publisher and can result in a different outcome from the UPDATE.</span></span>  
  
 <span data-ttu-id="8a2d0-144">Se la procedura viene eseguita nell'ambito di una transazione serializzabile, la transazione T2 non potrà eseguire inserimenti nell'intervallo dell'istruzione SELECT di T2,</span><span class="sxs-lookup"><span data-stu-id="8a2d0-144">If the procedure is executed within a serializable transaction, transaction T2 will not be allowed to insert within the range covered by the SELECT statement in T2.</span></span> <span data-ttu-id="8a2d0-145">ma rimarrà bloccata fino al commit di T1 in modo da garantire gli stessi risultati nel Sottoscrittore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-145">It will be blocked until T1 commits ensuring the same results at the Subscriber.</span></span>  
  
 <span data-ttu-id="8a2d0-146">I blocchi verranno mantenuti più a lungo se si esegue la procedura in una transazione serializzabile e possono comportare una riduzione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-146">Locks will be held longer when you execute the procedure within a serializable transaction and may result in reduced concurrency.</span></span>  
  
## <a name="the-xact_abort-setting"></a><span data-ttu-id="8a2d0-147">Impostazione XACT_ABORT</span><span class="sxs-lookup"><span data-stu-id="8a2d0-147">The XACT_ABORT Setting</span></span>  
 <span data-ttu-id="8a2d0-148">Durante la replica dell'esecuzione della stored procedure, l'impostazione XACT_ABORT della sessione nella quale avviene l'esecuzione della stored procedure deve essere impostata su ON.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-148">When replicating stored procedure execution, the setting for the session executing the stored procedure should specify XACT_ABORT ON.</span></span> <span data-ttu-id="8a2d0-149">Se XACT_ABORT è impostata su OFF, durante l'esecuzione della procedura nel server di pubblicazione viene generato un errore, che si ripeterà anche nel Sottoscrittore, interrompendo l'attività dell'agente di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-149">If XACT_ABORT is set to OFF, and an error occurs during execution of the procedure at the Publisher, the same error will occur at the Subscriber, causing the Distribution Agent to fail.</span></span> <span data-ttu-id="8a2d0-150">Se si imposta XACT_ABORT su ON, per tutti gli errori rilevati durante l'esecuzione nel server di pubblicazione viene eseguito il rollback dell'intera esecuzione, il che impedisce che si verifichino errori nell'agente di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-150">Specifying XACT_ABORT ON ensures that any errors encountered during execution at the Publisher cause the entire execution to be rolled back, avoiding the Distribution Agent failure.</span></span> <span data-ttu-id="8a2d0-151">Per altre informazioni sull'impostazione XACT_ABORT, vedere [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="8a2d0-151">For more information about setting XACT_ABORT, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="8a2d0-152">Se è necessario impostare XACT_ABORT su OFF, specificare il parametro **-SkipErrors** per l'agente di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-152">If you require a setting of XACT_ABORT OFF, specify the **-SkipErrors** parameter for the Distribution Agent.</span></span> <span data-ttu-id="8a2d0-153">Ciò consente all'agente di continuare ad applicare eventuali modifiche nel Sottoscrittore anche in caso di errore.</span><span class="sxs-lookup"><span data-stu-id="8a2d0-153">This allows the agent to continue applying changes at the Subscriber even if an error is encountered.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8a2d0-154">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="8a2d0-154">See Also</span></span>  
 [<span data-ttu-id="8a2d0-155">Article Options for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="8a2d0-155">Article Options for Transactional Replication</span></span>](article-options-for-transactional-replication.md)  
  
  
