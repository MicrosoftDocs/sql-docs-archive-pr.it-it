---
title: Requisiti per le aggregazioni CLR definite dall'utente | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87629436"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="77ab6-102">Requisiti per le aggregazioni CLR definite dall'utente</span><span class="sxs-lookup"><span data-stu-id="77ab6-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="77ab6-103">Un tipo in un assembly CLR (Common Language Runtime) può essere registrato come funzione di aggregazione definita dall'utente, purché implementi il contratto di aggregazione necessario.</span><span class="sxs-lookup"><span data-stu-id="77ab6-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="77ab6-104">Tale contratto è costituito dall'attributo `SqlUserDefinedAggregate` e dai metodi del contratto di aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="77ab6-105">Il contratto di aggregazione include il meccanismo per salvare lo stato intermedio dell'aggregazione e il meccanismo per accumulare nuovi valori, costituito da quattro metodi: `Init`, `Accumulate`, `Merge` e `Terminate`.</span><span class="sxs-lookup"><span data-stu-id="77ab6-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="77ab6-106">Una volta soddisfatti questi requisiti, sarà possibile sfruttare appieno le funzioni di aggregazione definite dall'utente in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="77ab6-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="77ab6-107">Nelle sezioni seguenti di questo argomento sono disponibili altre informazioni dettagliate su come creare e utilizzare aggregazioni definite dall'utente.</span><span class="sxs-lookup"><span data-stu-id="77ab6-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="77ab6-108">Per un esempio, vedere [richiamo di funzioni di aggregazione CLR definite dall'utente](clr-user-defined-aggregate-invoking-functions.md).</span><span class="sxs-lookup"><span data-stu-id="77ab6-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="77ab6-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="77ab6-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="77ab6-110">Per ulteriori informazioni, vedere [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span><span class="sxs-lookup"><span data-stu-id="77ab6-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="77ab6-111">Metodi di aggregazione</span><span class="sxs-lookup"><span data-stu-id="77ab6-111">Aggregation Methods</span></span>  
 <span data-ttu-id="77ab6-112">La classe registrata come aggregazione definita dall'utente deve supportare i metodi di istanza seguenti.</span><span class="sxs-lookup"><span data-stu-id="77ab6-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="77ab6-113">Tali metodi vengono utilizzati da Query Processor per calcolare l'aggregazione:</span><span class="sxs-lookup"><span data-stu-id="77ab6-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="77ab6-114">Metodo</span><span class="sxs-lookup"><span data-stu-id="77ab6-114">Method</span></span>|<span data-ttu-id="77ab6-115">Sintassi</span><span class="sxs-lookup"><span data-stu-id="77ab6-115">Syntax</span></span>|<span data-ttu-id="77ab6-116">Descrizione</span><span class="sxs-lookup"><span data-stu-id="77ab6-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="77ab6-117">public void Init ();</span><span class="sxs-lookup"><span data-stu-id="77ab6-117">public void Init();</span></span>|<span data-ttu-id="77ab6-118">Query Processor utilizza questo metodo per inizializzare il calcolo dell'aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="77ab6-119">Questo metodo viene richiamato una volta per ogni gruppo aggregato da Query Processor.</span><span class="sxs-lookup"><span data-stu-id="77ab6-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="77ab6-120">Query Processor può scegliere di riutilizzare la stessa istanza della classe di aggregazione per il calcolo delle aggregazioni di più gruppi.</span><span class="sxs-lookup"><span data-stu-id="77ab6-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="77ab6-121">Il metodo `Init` deve eseguire tutta la pulizia necessaria rispetto agli utilizzi precedenti dell'istanza e abilitare l'istanza per riavviare un nuovo calcolo di aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="77ab6-122">public void accumulo (valore del tipo di input [, valore del tipo di input,...]);</span><span class="sxs-lookup"><span data-stu-id="77ab6-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="77ab6-123">Uno o più parametri che rappresentano i parametri della funzione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="77ab6-124">*INPUT_TYPE* deve essere il [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo di dati gestito equivalente al [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo di dati nativo specificato da *input_sqltype* nell' `CREATE AGGREGATE` istruzione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="77ab6-125">Per ulteriori informazioni, vedere [mapping dei dati dei parametri CLR](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span><span class="sxs-lookup"><span data-stu-id="77ab6-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="77ab6-126">Per i tipi definiti dall'utente (UDT, User-Defined Type), il tipo di input coincide con il tipo definito dall'utente.</span><span class="sxs-lookup"><span data-stu-id="77ab6-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="77ab6-127">Query Processor utilizza questo metodo per accumulare i valori di aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="77ab6-128">Il metodo viene richiamato una volta per ogni valore nel gruppo aggregato.</span><span class="sxs-lookup"><span data-stu-id="77ab6-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="77ab6-129">Query Processor chiama sempre questo metodo solo dopo avere chiamato il metodo `Init` nell'istanza specificata della classe di aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="77ab6-130">L'implementazione di questo metodo deve aggiornare lo stato dell'istanza per riflettere l'accumulazione del valore dell'argomento passato.</span><span class="sxs-lookup"><span data-stu-id="77ab6-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="77ab6-131">public void Merge (valore udagg_class);</span><span class="sxs-lookup"><span data-stu-id="77ab6-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="77ab6-132">Questo metodo può essere utilizzato per unire un'altra istanza di questa classe di aggregazione all'istanza corrente.</span><span class="sxs-lookup"><span data-stu-id="77ab6-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="77ab6-133">Query Processor utilizza questo metodo per unire più calcoli parziali di un'aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="77ab6-134">public return_type terminate ();</span><span class="sxs-lookup"><span data-stu-id="77ab6-134">public return_type Terminate();</span></span>|<span data-ttu-id="77ab6-135">Questo metodo completa il calcolo di aggregazione e restituisce il risultato dell'aggregazione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="77ab6-136">Il *return_type* deve essere un [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo di dati gestito che è l'equivalente gestito di *return_sqltype* specificato nell' `CREATE AGGREGATE` istruzione.</span><span class="sxs-lookup"><span data-stu-id="77ab6-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="77ab6-137">Il *return_type* può essere anche un tipo definito dall'utente.</span><span class="sxs-lookup"><span data-stu-id="77ab6-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="77ab6-138">Parametri valutati a livello di tabella</span><span class="sxs-lookup"><span data-stu-id="77ab6-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="77ab6-139">I parametri con valori di tabella, ovvero tipi di tabella definiti dall'utente passati in una procedura o in una funzione, consentono di passare in modo efficiente più righe di dati al server.</span><span class="sxs-lookup"><span data-stu-id="77ab6-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="77ab6-140">Pur essendo caratterizzati da funzionalità simili alle matrici di parametri, i parametri con valori di tabella offrono più flessibilità e una maggiore integrazione con [!INCLUDE[tsql](../../includes/tsql-md.md)]</span><span class="sxs-lookup"><span data-stu-id="77ab6-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="77ab6-141">Consentono inoltre di ottenere prestazioni potenzialmente migliori.</span><span class="sxs-lookup"><span data-stu-id="77ab6-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="77ab6-142">I parametri con valori di tabella consentono inoltre di ridurre il numero di round trip al server.</span><span class="sxs-lookup"><span data-stu-id="77ab6-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="77ab6-143">Anziché inviare più richieste al server, ad esempio con un elenco di parametri scalari, è possibile inviare i dati al server sotto forma di parametro con valori di tabella.</span><span class="sxs-lookup"><span data-stu-id="77ab6-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="77ab6-144">Un tipo di tabella definito dall'utente non può essere passato come parametro con valori di tabella a una stored procedure gestita o a una funzione in esecuzione nel processo [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], né può essere restituito dalle stesse.</span><span class="sxs-lookup"><span data-stu-id="77ab6-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="77ab6-145">I parametri con valori di tabella, inoltre, non possono essere utilizzati nell'ambito di una connessione di contesto.</span><span class="sxs-lookup"><span data-stu-id="77ab6-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="77ab6-146">È tuttavia possibile utilizzare un parametro con valori di tabella con SqlClient in stored procedure o funzioni gestite eseguite nel processo [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], se utilizzato in una connessione diversa da una connessione di contesto.</span><span class="sxs-lookup"><span data-stu-id="77ab6-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="77ab6-147">La connessione può essere stabilita con lo stesso server che esegue la funzione o la procedura gestita.</span><span class="sxs-lookup"><span data-stu-id="77ab6-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="77ab6-148">Per altre informazioni su TVP, vedere [usare i parametri con valori di tabella &#40;motore di database&#41;](../tables/use-table-valued-parameters-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="77ab6-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="77ab6-149">Cronologia modifiche</span><span class="sxs-lookup"><span data-stu-id="77ab6-149">Change History</span></span>  
  
|<span data-ttu-id="77ab6-150">Contenuto aggiornato</span><span class="sxs-lookup"><span data-stu-id="77ab6-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="77ab6-151">Aggiornamento della descrizione del metodo `Accumulate`, che ora accetta più di un parametro.</span><span class="sxs-lookup"><span data-stu-id="77ab6-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="77ab6-152">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="77ab6-152">See Also</span></span>  
 <span data-ttu-id="77ab6-153">[Tipi CLR definiti dall'utente](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="77ab6-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="77ab6-154">Chiamata di funzioni di aggregazione CLR definite dall'utente</span><span class="sxs-lookup"><span data-stu-id="77ab6-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
