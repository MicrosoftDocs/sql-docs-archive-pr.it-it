---
title: Transazioni posticipate (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- I/O [SQL Server], database recovery
- restoring pages [SQL Server]
- deferred transactions
- modifying transaction deferred state
ms.assetid: 6fc0f9b6-d3ea-4971-9f27-d0195d1ff718
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 188a0409fbad3f12283adacafbfcb5f176650b72
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87627845"
---
# <a name="deferred-transactions-sql-server"></a><span data-ttu-id="ed14a-102">Transazioni posticipate (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="ed14a-102">Deferred Transactions (SQL Server)</span></span>
  <span data-ttu-id="ed14a-103">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise una transazione danneggiata può diventare posticipata se i dati necessari per il rollback (annullamento) sono offline durante l'avvio del database.</span><span class="sxs-lookup"><span data-stu-id="ed14a-103">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise, a corrupted transaction can become deferred if data required by rollback (undo) is offline during database startup.</span></span> <span data-ttu-id="ed14a-104">Una *transazione posticipata* è una transazione di cui non è stato eseguito il commit al termine della fase di rollforward e per la quale si è verificato un errore che ne impedisce il rollback.</span><span class="sxs-lookup"><span data-stu-id="ed14a-104">A *deferred transaction* is a transaction that is uncommitted when the roll forward phase finishes and that has encountered an error that prevents it from being rolled back.</span></span> <span data-ttu-id="ed14a-105">Non essendo possibile eseguire il rollback, la transazione viene posticipata.</span><span class="sxs-lookup"><span data-stu-id="ed14a-105">Because the transaction cannot be rolled back, it is deferred.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ed14a-106">Le transazioni danneggiate vengono posticipate solo in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span><span class="sxs-lookup"><span data-stu-id="ed14a-106">Corrupted transactions are deferred only in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span></span> <span data-ttu-id="ed14a-107">Nelle altre edizioni di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]una transazione danneggiata causa un errore di avvio.</span><span class="sxs-lookup"><span data-stu-id="ed14a-107">In other editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a corrupted transaction causes startup to fail.</span></span>  
  
 <span data-ttu-id="ed14a-108">In genere, una transazione posticipata si verifica perché durante il rollforward del database un errore di I/O ha impedito la lettura di una pagina necessaria per la transazione.</span><span class="sxs-lookup"><span data-stu-id="ed14a-108">Generally, a deferred transaction occurs because, while the database was being rolled forward, an I/O error prevented reading a page that was required by the transaction.</span></span> <span data-ttu-id="ed14a-109">Anche un errore a livello di file può tuttavia determinare transazioni posticipate.</span><span class="sxs-lookup"><span data-stu-id="ed14a-109">However, an error at the file level can also cause deferred transactions.</span></span> <span data-ttu-id="ed14a-110">Una transazione posticipata si può verificare anche quando una sequenza di ripristino parziale si arresta in un punto in cui è necessario eseguire il rollback della transazione e i dati richiesti dalla transazione sono offline.</span><span class="sxs-lookup"><span data-stu-id="ed14a-110">A deferred transaction can also occur when a partial restore sequence stops at a point at which transaction rollback is necessary and a transaction requires data that is offline.</span></span>  
  
 <span data-ttu-id="ed14a-111">Se si verifica un errore di I/O durante il rollback delle transazioni utente, verrà attivata la modalità offline per l'intero database.</span><span class="sxs-lookup"><span data-stu-id="ed14a-111">User transactions that are rolling back and hit an I/O error cause the whole database to go offline.</span></span> <span data-ttu-id="ed14a-112">Quando viene riattivata la modalità online per il database, il rollforward riacquisisce tutti i blocchi precedenti e tenta di eseguire il rollback delle transazioni di cui non è stato eseguito il commit.</span><span class="sxs-lookup"><span data-stu-id="ed14a-112">When the database is brought back online, the redo reacquires all the locks it had and tries to roll back all the uncommitted transactions.</span></span> <span data-ttu-id="ed14a-113">Tutti i dati modificati da una transazione rimangono bloccati nel modo appropriato fino a quando non è possibile eseguire il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ed14a-113">All data modified by a transaction remains appropriately locked until the transaction can roll back.</span></span> <span data-ttu-id="ed14a-114">Le transazioni di cui non è possibile eseguire il rollback rilasciano i relativi blocchi quando il problema di danneggiamento viene risolto e il database viene riavviato oppure, dopo un ripristino online, quando le transazioni posticipate vengono risolte mentre il database rimane online.</span><span class="sxs-lookup"><span data-stu-id="ed14a-114">Transactions that cannot be rolled back will give up their locks when the corruption is fixed and the database restarted or, after an online restore, when the deferred transactions are resolved while the database remains online.</span></span> <span data-ttu-id="ed14a-115">Fino a quel momento, una transazione posticipata può mantenere attivi blocchi che impediscono l'esecuzione di determinate operazioni sull'intero database.</span><span class="sxs-lookup"><span data-stu-id="ed14a-115">Until that point, a deferred transaction can hold locks that prevent certain operations on the database as a whole.</span></span> <span data-ttu-id="ed14a-116">Ad esempio, se una transazione posticipata contiene un'istruzione CREATE TABLE, verrà impedito agli utenti di creare una tabella fino alla risoluzione della transazione posticipata.</span><span class="sxs-lookup"><span data-stu-id="ed14a-116">For example, if a deferred transaction contains a CREATE TABLE instruction, no user can create a table until the deferred transaction has been resolved.</span></span>  
  
 <span data-ttu-id="ed14a-117">Una transazione posticipata si può anche verificare quando un ripristino a fasi recupera un database fino a un punto in cui una o più transazioni attive influiscono su un filegroup che non è ancora stato ripristinato ed è offline.</span><span class="sxs-lookup"><span data-stu-id="ed14a-117">Deferred transaction can also occur because a piecemeal restore recovers a database to a point at which one or more active transactions are affecting a filegroup that has not yet been restored and is offline.</span></span> <span data-ttu-id="ed14a-118">Non essendo possibile eseguire il rollback, le transazioni diventano posticipate.</span><span class="sxs-lookup"><span data-stu-id="ed14a-118">Because the transactions cannot be rolled back, they become deferred.</span></span>  
  
 <span data-ttu-id="ed14a-119">Nella tabella seguente sono illustrate le azioni che determinano l'esecuzione di un recupero in un database e il risultato ottenuto nel caso si verifichi un errore di I/O.</span><span class="sxs-lookup"><span data-stu-id="ed14a-119">The following table lists the actions that cause a database to perform recovery and the outcome if an I/O problem occurs.</span></span>  
  
|<span data-ttu-id="ed14a-120">Azione</span><span class="sxs-lookup"><span data-stu-id="ed14a-120">Action</span></span>|<span data-ttu-id="ed14a-121">Risoluzione (se si verificano problemi di I/O oppure i dati necessari sono offline)</span><span class="sxs-lookup"><span data-stu-id="ed14a-121">Resolution (if I/O problems occur or required data is offline)</span></span>|  
|------------|-----------------------------------------------------------------------|  
|<span data-ttu-id="ed14a-122">Avvio del server</span><span class="sxs-lookup"><span data-stu-id="ed14a-122">Server start</span></span>|<span data-ttu-id="ed14a-123">transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-123">Deferred transaction</span></span>|  
|<span data-ttu-id="ed14a-124">Restore</span><span class="sxs-lookup"><span data-stu-id="ed14a-124">Restore</span></span>|<span data-ttu-id="ed14a-125">transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-125">Deferred transaction</span></span>|  
|<span data-ttu-id="ed14a-126">Collegamento</span><span class="sxs-lookup"><span data-stu-id="ed14a-126">Attach</span></span>|<span data-ttu-id="ed14a-127">Il collegamento ha esito negativo</span><span class="sxs-lookup"><span data-stu-id="ed14a-127">Attach fails</span></span>|  
|<span data-ttu-id="ed14a-128">Riavvio automatico</span><span class="sxs-lookup"><span data-stu-id="ed14a-128">Autorestart</span></span>|<span data-ttu-id="ed14a-129">transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-129">Deferred transaction</span></span>|  
|<span data-ttu-id="ed14a-130">Creazione di database o di snapshot del database</span><span class="sxs-lookup"><span data-stu-id="ed14a-130">Create database or database snapshot</span></span>|<span data-ttu-id="ed14a-131">La creazione ha esito negativo</span><span class="sxs-lookup"><span data-stu-id="ed14a-131">Creation fails</span></span>|  
|<span data-ttu-id="ed14a-132">Rollforward nel mirroring del database</span><span class="sxs-lookup"><span data-stu-id="ed14a-132">Redo on database mirroring</span></span>|<span data-ttu-id="ed14a-133">transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-133">Deferred transaction</span></span>|  
|<span data-ttu-id="ed14a-134">Filegroup offline</span><span class="sxs-lookup"><span data-stu-id="ed14a-134">Filegroup is offline</span></span>|<span data-ttu-id="ed14a-135">transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-135">Deferred transaction</span></span>|  
  
## <a name="moving-a-transaction-out-of-the-deferred-state"></a><span data-ttu-id="ed14a-136">Annullamento dello stato di transazione posticipata</span><span class="sxs-lookup"><span data-stu-id="ed14a-136">Moving a Transaction Out of the DEFERRED State</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="ed14a-137">Le transazioni posticipate mantengono attivo il log delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ed14a-137">Deferred transactions keep the transaction log active.</span></span> <span data-ttu-id="ed14a-138">Un file di log virtuale contenente transazioni posticipate non può essere troncato fino a quando lo stato di transazione posticipata non viene annullato.</span><span class="sxs-lookup"><span data-stu-id="ed14a-138">A virtual log file that contains any deferred transactions cannot be truncated until those transactions are moved out of the deferred state.</span></span> <span data-ttu-id="ed14a-139">Per altre informazioni sul troncamento del log, vedere [Log delle transazioni &#40;SQL Server&#41;](../logs/the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="ed14a-139">For more information about log truncation, see [The Transaction Log &#40;SQL Server&#41;](../logs/the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="ed14a-140">Per annullare lo stato di transazione posticipata, è necessario che durante l'avvio del database non si verifichino errori di I/O.</span><span class="sxs-lookup"><span data-stu-id="ed14a-140">To move the transaction out of the deferred state, the database must start cleanly without any I/O errors.</span></span> <span data-ttu-id="ed14a-141">Se sono presenti transazioni posticipate, è necessario correggere l'origine degli errori di I/O.</span><span class="sxs-lookup"><span data-stu-id="ed14a-141">If deferred transactions exist, you must fix the source of the I/O errors.</span></span> <span data-ttu-id="ed14a-142">Di seguito sono riportate le soluzioni possibili, elencate nell'ordine in cui solitamente vengono tentate:</span><span class="sxs-lookup"><span data-stu-id="ed14a-142">The available solutions, listed in the order in which they are typically tried, are as follows:</span></span>  
  
-   <span data-ttu-id="ed14a-143">Riavviare il database.</span><span class="sxs-lookup"><span data-stu-id="ed14a-143">Restart the database.</span></span> <span data-ttu-id="ed14a-144">Se il problema era temporaneo, il database verrà avviato senza transazioni posticipate.</span><span class="sxs-lookup"><span data-stu-id="ed14a-144">If the problem was transient, the database should start without deferred transactions.</span></span>  
  
-   <span data-ttu-id="ed14a-145">Se le transazioni sono state posticipate a causa di un filegroup offline, attivare di nuovo la modalità online per il filegroup.</span><span class="sxs-lookup"><span data-stu-id="ed14a-145">If the transactions were deferred because a filegroup was offline, bring the filegroup back online.</span></span>  
  
     <span data-ttu-id="ed14a-146">Per attivare di nuovo la modalità online per un filegroup, utilizzare l'istruzione [!INCLUDE[tsql](../../includes/tsql-md.md)] seguente:</span><span class="sxs-lookup"><span data-stu-id="ed14a-146">To bring an offline filegroup back online, use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
    ```  
    RESTORE DATABASE database_name FILEGROUP=<filegroup_name>  
    ```  
  
-   <span data-ttu-id="ed14a-147">Ripristinare il database.</span><span class="sxs-lookup"><span data-stu-id="ed14a-147">Restore the database.</span></span> <span data-ttu-id="ed14a-148">Dopo un ripristino online, eventuali transazioni posticipate vengono risolte.</span><span class="sxs-lookup"><span data-stu-id="ed14a-148">After an online restore, any deferred transactions are resolved.</span></span>  
  
     <span data-ttu-id="ed14a-149">In base al modello di recupero con registrazione completa o con registrazione minima delle operazioni bulk, se le transazioni posticipate sono causate da un numero ridotto di pagine danneggiate, un ripristino delle pagine online può risolvere gli errori (se supportato).</span><span class="sxs-lookup"><span data-stu-id="ed14a-149">Under the full or bulk-logged recovery model, if the deferred transactions were caused by only a few corrupted pages, an online page restore might resolve the errors (where supported).</span></span>  
  
-   <span data-ttu-id="ed14a-150">Se non è più necessario un filegroup offline che causa transazioni posticipate, è possibile renderlo inattivo.</span><span class="sxs-lookup"><span data-stu-id="ed14a-150">If you are no longer require a filegroup whose offline status is causing deferred transactions, make the offline filegroup defunct.</span></span> <span data-ttu-id="ed14a-151">Quando il filegroup in questione diventa offline, lo stato di transazione posticipata viene annullato.</span><span class="sxs-lookup"><span data-stu-id="ed14a-151">Transactions that were deferred because the filegroup was offline are moved out of the deferred state after the filegroup becomes defunct.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="ed14a-152">Un filegroup inattivo non può in alcun modo essere recuperato.</span><span class="sxs-lookup"><span data-stu-id="ed14a-152">A defunct filegroup can never be recovered.</span></span>  
  
     <span data-ttu-id="ed14a-153">Per altre informazioni, vedere [Rimuovere filegroup inattivi &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="ed14a-153">For more information, see [Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md).</span></span>  
  
-   <span data-ttu-id="ed14a-154">Se le transazioni sono state posticipate a causa di una pagina danneggiata e non è disponibile un backup valido del database, eseguire le operazioni seguenti per correggere gli errori del database:</span><span class="sxs-lookup"><span data-stu-id="ed14a-154">If transactions were deferred because of a bad page and if a good backup of the database does not exist, use the following process to repair the database:</span></span>  
  
    -   <span data-ttu-id="ed14a-155">Attivare innanzitutto la modalità di emergenza del database eseguendo l'istruzione [!INCLUDE[tsql](../../includes/tsql-md.md)] seguente:</span><span class="sxs-lookup"><span data-stu-id="ed14a-155">First put the database into emergency mode by executing the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
        ```  
        ALTER DATABASE <database_name> SET EMERGENCY  
        ```  
  
         <span data-ttu-id="ed14a-156">Per informazioni sulla modalità di emergenza, vedere [Stati del database](../databases/database-states.md).</span><span class="sxs-lookup"><span data-stu-id="ed14a-156">For information about emergency mode, see [Database States](../databases/database-states.md).</span></span>  
  
    -   <span data-ttu-id="ed14a-157">Correggere quindi gli errori del database usando l'opzione DBCC REPAIR_ALLOW_DATA_LOSS in una delle istruzioni DBCC seguenti: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql) o [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ed14a-157">Then, repair the database by using the DBCC REPAIR_ALLOW_DATA_LOSS option in one of the following DBCC statements: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql), or [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span></span>  
  
         <span data-ttu-id="ed14a-158">Quando rileva la pagina danneggiata, DBCC ne esegue la deallocazione e corregge gli eventuali errori correlati.</span><span class="sxs-lookup"><span data-stu-id="ed14a-158">When DBCC encounters the bad page, DBCC deallocates it and repairs any related errors.</span></span> <span data-ttu-id="ed14a-159">Questo approccio consente di attivare di nuovo la modalità online per il database in uno stato fisicamente consistente.</span><span class="sxs-lookup"><span data-stu-id="ed14a-159">This approach enables the database to be brought back online in a physically consistent state.</span></span> <span data-ttu-id="ed14a-160">È tuttavia possibile che vengano persi dati aggiuntivi. Utilizzare pertanto questo approccio solo se strettamente necessario.</span><span class="sxs-lookup"><span data-stu-id="ed14a-160">However, additional data might also be lost; therefore, this approach should be used as a last resort.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ed14a-161">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="ed14a-161">See Also</span></span>  
 <span data-ttu-id="ed14a-162">[Panoramica del ripristino e del recupero &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-162">[Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span></span>  
 <span data-ttu-id="ed14a-163">[Rimuovere filegroup inattivi &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-163">[Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md) </span></span>  
 <span data-ttu-id="ed14a-164">[Ripristini di file &#40;modello di recupero con registrazione completa&#41;](file-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-164">[File Restores &#40;Full Recovery Model&#41;](file-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="ed14a-165">[Ripristini di file &#40;modello di recupero con registrazione minima&#41;](file-restores-simple-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-165">[File Restores &#40;Simple Recovery Model&#41;](file-restores-simple-recovery-model.md) </span></span>  
 <span data-ttu-id="ed14a-166">[Ripristino di pagine &#40;SQL Server&#41;](restore-pages-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-166">[Restore Pages &#40;SQL Server&#41;](restore-pages-sql-server.md) </span></span>  
 <span data-ttu-id="ed14a-167">[Ripristini a fasi &#40;SQL Server&#41;](piecemeal-restores-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="ed14a-167">[Piecemeal Restores &#40;SQL Server&#41;](piecemeal-restores-sql-server.md) </span></span>  
 <span data-ttu-id="ed14a-168">[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="ed14a-168">[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql) </span></span>  
 [<span data-ttu-id="ed14a-169">RESTORE &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="ed14a-169">RESTORE &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/restore-statements-transact-sql)  
  
  
