---
title: Gestione delle dimensioni dei batch per la copia bulk | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client ODBC driver, bulk copy
- ODBC, bulk copy operations
- batches [ODBC]
- bulk copy [ODBC], batch sizes
ms.assetid: 4b24139f-788b-45a6-86dc-ae835435d737
author: rothja
ms.author: jroth
ms.openlocfilehash: 1f24ece176cbb834e4162f9e516ff23013fd256a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87635560"
---
# <a name="managing-bulk-copy-batch-sizes"></a><span data-ttu-id="cae6b-102">Gestione delle dimensioni dei batch di copia bulk</span><span class="sxs-lookup"><span data-stu-id="cae6b-102">Managing Bulk Copy Batch Sizes</span></span>
  <span data-ttu-id="cae6b-103">Lo scopo principale di un batch nelle operazioni di copia bulk è definire l'ambito di una transazione.</span><span class="sxs-lookup"><span data-stu-id="cae6b-103">The primary purpose of a batch in bulk copy operations is to define the scope of a transaction.</span></span> <span data-ttu-id="cae6b-104">Se non si impostano le dimensioni del batch, le funzioni di copia bulk considerano un'intera copia bulk come una transazione.</span><span class="sxs-lookup"><span data-stu-id="cae6b-104">If a batch size is not set, then bulk copy functions consider an entire bulk copy to be one transaction.</span></span> <span data-ttu-id="cae6b-105">Se le dimensioni del batch vengono impostate, ogni batch rappresenterà una transazione di cui verrà eseguito il commit alla fine dell'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="cae6b-105">If a batch size is set, then each batch constitutes a transaction that is committed when the batch finishes.</span></span>  
  
 <span data-ttu-id="cae6b-106">Se una copia bulk viene eseguita senza specificare le dimensioni del batch e si verifica un errore, viene eseguito il rollback dell'intera copia bulk.</span><span class="sxs-lookup"><span data-stu-id="cae6b-106">If a bulk copy is performed with no batch size specified and an error is encountered, the entire bulk copy is rolled back.</span></span> <span data-ttu-id="cae6b-107">Il recupero di una copia bulk con esecuzione prolungata può richiedere molto tempo.</span><span class="sxs-lookup"><span data-stu-id="cae6b-107">The recovery of a long-running bulk copy can take a long time.</span></span> <span data-ttu-id="cae6b-108">Quando vengono impostate le dimensioni di un batch, la copia bulk considera ogni batch come una singola transazione e ne esegue il commit.</span><span class="sxs-lookup"><span data-stu-id="cae6b-108">When a batch size is set, bulk copy considers each batch a transaction and commits each batch.</span></span> <span data-ttu-id="cae6b-109">Se si verifica un errore, è necessario eseguire il rollback solo dell'ultimo batch in attesa.</span><span class="sxs-lookup"><span data-stu-id="cae6b-109">If an error is encountered, only the last outstanding batch needs to be rolled back.</span></span>  
  
 <span data-ttu-id="cae6b-110">Le dimensioni del batch possono influire anche sull'overhead dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="cae6b-110">The batch size can also affect locking overhead.</span></span> <span data-ttu-id="cae6b-111">Quando si esegue una copia bulk [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] in, è possibile specificare l'hint TABLOCK usando [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) per acquisire un blocco di tabella anziché i blocchi di riga.</span><span class="sxs-lookup"><span data-stu-id="cae6b-111">When performing a bulk copy against [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the TABLOCK hint can be specified using [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) to acquire a table lock instead of row locks.</span></span> <span data-ttu-id="cae6b-112">Il singolo blocco di tabella può essere gestito con un overhead minimo per un'operazione di copia bulk intera.</span><span class="sxs-lookup"><span data-stu-id="cae6b-112">The single table lock can be held with minimal overhead for an entire bulk copy operation.</span></span> <span data-ttu-id="cae6b-113">Se TABLOCK non viene specificato, i blocchi vengono gestiti su righe singole e l'overhead della gestione di tutti i blocchi per la durata della copia bulk può rallentare le prestazioni.</span><span class="sxs-lookup"><span data-stu-id="cae6b-113">If TABLOCK is not specified then locks are held on individual rows and the overhead of maintaining all the locks for the duration of the bulk copy can slow performance.</span></span> <span data-ttu-id="cae6b-114">Poiché i blocchi vengono gestiti solo per la durata di una transazione, la specifica delle dimensioni del batch risolve il problema grazie alla generazione periodica di un commit che libera i blocchi attualmente gestiti.</span><span class="sxs-lookup"><span data-stu-id="cae6b-114">Because locks are only held for the length of a transaction, specifying a batch size addresses this problem by periodically generating a commit that frees the locks currently held.</span></span>  
  
 <span data-ttu-id="cae6b-115">Il numero di righe che costituiscono un batch può avere effetti significativi sulle prestazioni quando si esegue la copia bulk di un gran numero di righe.</span><span class="sxs-lookup"><span data-stu-id="cae6b-115">The number of rows making up a batch can have significant performance effects when bulk copying a large number of rows.</span></span> <span data-ttu-id="cae6b-116">I requisiti per le dimensioni del batch dipendono dal tipo di copia bulk eseguita.</span><span class="sxs-lookup"><span data-stu-id="cae6b-116">The recommendations for batch size depend on the type of bulk copy being performed.</span></span>  
  
-   <span data-ttu-id="cae6b-117">Quando si esegue la copia bulk in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], specificare l'hint di copia bulk TABLOCK e impostare le dimensioni del batch su un valore grande.</span><span class="sxs-lookup"><span data-stu-id="cae6b-117">When bulk copying to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], specify the TABLOCK bulk copy hint and set a large batch size.</span></span>  
  
-   <span data-ttu-id="cae6b-118">Quando TABLOCK non viene specificato, impostare le dimensioni del batch su un valore che non superi 1.000 righe.</span><span class="sxs-lookup"><span data-stu-id="cae6b-118">When TABLOCK is not specified, limit batch sizes to less than 1,000 rows.</span></span>  
  
 <span data-ttu-id="cae6b-119">Quando si esegue la copia bulk da un file di dati, le dimensioni del batch vengono specificate chiamando **bcp_control** con l'opzione BCPBATCH prima di chiamare [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span><span class="sxs-lookup"><span data-stu-id="cae6b-119">When bulk copying in from a data file, the batch size is specified by calling **bcp_control** with the BCPBATCH option before calling [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span></span> <span data-ttu-id="cae6b-120">Quando si esegue la copia bulk da variabili di programma usando [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) e [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), le dimensioni del batch vengono controllate chiamando [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) dopo aver chiamato [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* volte, dove *x* è il numero di righe in un batch.</span><span class="sxs-lookup"><span data-stu-id="cae6b-120">When bulk copying from program variables using [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) and [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), the batch size is controlled by calling [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) after calling [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* times, where *x* is the number of rows in a batch.</span></span>  
  
 <span data-ttu-id="cae6b-121">Oltre a specificare le dimensioni di una transazione, i batch influiscono anche sull'invio in rete delle righe al server.</span><span class="sxs-lookup"><span data-stu-id="cae6b-121">In addition to specifying the size of a transaction, batches also affect when rows are sent across the network to the server.</span></span> <span data-ttu-id="cae6b-122">Le funzioni di copia bulk normalmente memorizzano nella cache le righe da **bcp_sendrow** fino a quando non viene compilato un pacchetto di rete e quindi inviano il pacchetto completo al server.</span><span class="sxs-lookup"><span data-stu-id="cae6b-122">Bulk copy functions normally cache the rows from **bcp_sendrow** until a network packet is filled, and then send the full packet to the server.</span></span> <span data-ttu-id="cae6b-123">Quando un'applicazione chiama **bcp_batch**, tuttavia, il pacchetto corrente viene inviato al server, indipendentemente dal fatto che sia stato compilato.</span><span class="sxs-lookup"><span data-stu-id="cae6b-123">When an application calls **bcp_batch**, however, the current packet is sent to the server regardless of whether it has been filled.</span></span> <span data-ttu-id="cae6b-124">L'utilizzo di dimensioni del batch molto ridotte può rallentare le prestazioni se determina l'invio al server di più pacchetti riempiti parzialmente.</span><span class="sxs-lookup"><span data-stu-id="cae6b-124">Using a very low batch size can slow performance if it results in sending many partially filled packets to the server.</span></span> <span data-ttu-id="cae6b-125">Ad esempio, la chiamata di **bcp_batch** dopo ogni **bcp_sendrow** causa l'invio di ogni riga in un pacchetto separato e, a meno che le righe non siano di dimensioni molto elevate, spreca spazio in ogni pacchetto.</span><span class="sxs-lookup"><span data-stu-id="cae6b-125">For example, calling **bcp_batch** after every **bcp_sendrow** causes each row to be sent in a separate packet and, unless the rows are very large, wastes space in each packet.</span></span> <span data-ttu-id="cae6b-126">Le dimensioni predefinite dei pacchetti di rete per SQL Server sono pari a 4 KB, sebbene un'applicazione possa modificare le dimensioni chiamando [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) specificando l'attributo SQL_ATTR_PACKET_SIZE.</span><span class="sxs-lookup"><span data-stu-id="cae6b-126">The default size of network packets for SQL Server is 4 KB, although an application can change the size by calling [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) specifying the SQL_ATTR_PACKET_SIZE attribute.</span></span>  
  
 <span data-ttu-id="cae6b-127">Un altro effetto collaterale dei batch è che ogni batch viene considerato un set di risultati in attesa finché non viene completato con **bcp_batch**.</span><span class="sxs-lookup"><span data-stu-id="cae6b-127">Another side effect of batches is that each batch is considered an outstanding result set until it is completed with **bcp_batch**.</span></span> <span data-ttu-id="cae6b-128">Se si tenta di eseguire altre operazioni su un handle di connessione mentre un batch è in attesa, il [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] driver ODBC di Native Client genera un errore con SQLSTATE = "HY000" e una stringa del messaggio di errore:</span><span class="sxs-lookup"><span data-stu-id="cae6b-128">If any other operations are attempted on a connection handle while a batch is outstanding, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver issues an error with SQLState = "HY000" and an error message string of:</span></span>  
  
```  
"[Microsoft][SQL Server Native Client] Connection is busy with  
results for another hstmt."  
```  
  
## <a name="see-also"></a><span data-ttu-id="cae6b-129">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="cae6b-129">See Also</span></span>  
 <span data-ttu-id="cae6b-130">[Esecuzione di operazioni di copia bulk &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="cae6b-130">[Performing Bulk Copy Operations &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span></span>  
 [<span data-ttu-id="cae6b-131">Informazioni sull'importazione ed esportazione bulk di dati &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="cae6b-131">Bulk Import and Export of Data &#40;SQL Server&#41;</span></span>](../import-export/bulk-import-and-export-of-data-sql-server.md)  
  
  
