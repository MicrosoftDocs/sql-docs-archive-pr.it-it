---
title: Statistiche | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- statistical information [SQL Server], query optimization
- query performance [SQL Server], statistics
- query optimization statistics [SQL Server]
- statistical information [SQL Server], database options
- query optimization statistics [SQL Server], about query optimization statistics
- statistical information [SQL Server], guidelines
- statistical information [SQL Server]
- using statistics [SQL Server]
- statistical information [SQL Server], indexes
- index statistics [SQL Server]
- query optimizer [SQL Server], statistics
- statistics [SQL Server]
ms.assetid: b86a88ba-4f7c-4e19-9fbd-2f8bcd3be14a
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0f0950e48245bed53581d2f91b120ab9555aa562
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87636622"
---
# <a name="statistics"></a><span data-ttu-id="e18a8-102">Statistiche</span><span class="sxs-lookup"><span data-stu-id="e18a8-102">Statistics</span></span>
  <span data-ttu-id="e18a8-103">In Query Optimizer vengono utilizzate le statistiche per creare piani di query che consentono di migliorare le prestazioni di esecuzione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-103">The query optimizer uses statistics to create query plans that improve query performance.</span></span> <span data-ttu-id="e18a8-104">Per la maggior parte delle query, Query Optimizer genera già le statistiche necessarie per un piano di query di alta qualità. In alcuni casi, è necessario creare statistiche aggiuntive o modificare la progettazione delle query per ottenere risultati migliori.</span><span class="sxs-lookup"><span data-stu-id="e18a8-104">For most queries, the query optimizer already generates the necessary statistics for a high quality query plan; in a few cases, you need to create additional statistics or modify the query design for best results.</span></span> <span data-ttu-id="e18a8-105">In questo argomento vengono illustrati i concetti relativi alle statistiche e vengono fornite linee guida per un utilizzo efficace delle statistiche di ottimizzazione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-105">This topic discusses statistics concepts and provides guidelines for using query optimization statistics effectively.</span></span>  
  
##  <a name="components-and-concepts"></a><a name="DefinitionQOStatistics"></a> <span data-ttu-id="e18a8-106">Componenti e concetti</span><span class="sxs-lookup"><span data-stu-id="e18a8-106">Components and Concepts</span></span>  
 <span data-ttu-id="e18a8-107">Statistiche</span><span class="sxs-lookup"><span data-stu-id="e18a8-107">Statistics</span></span>  
 <span data-ttu-id="e18a8-108">Le statistiche di ottimizzazione delle query sono oggetti contenenti informazioni statistiche sulla distribuzione dei valori in una o più colonne di una tabella o di una vista indicizzata.</span><span class="sxs-lookup"><span data-stu-id="e18a8-108">Statistics for query optimization are objects that contain statistical information about the distribution of values in one or more columns of a table or indexed view.</span></span> <span data-ttu-id="e18a8-109">Il Query Optimizer utilizza queste statistiche per stimare la *cardinalità*o il numero di righe nel risultato della query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-109">The query optimizer uses these statistics to estimate the *cardinality*, or number of rows, in the query result.</span></span> <span data-ttu-id="e18a8-110">Queste *stime della cardinalità* consentono al Query Optimizer di creare un piano di query di alta qualità.</span><span class="sxs-lookup"><span data-stu-id="e18a8-110">These *cardinality estimates* enable the query optimizer to create a high-quality query plan.</span></span> <span data-ttu-id="e18a8-111">Query Optimizer può ad esempio utilizzare le stime della cardinalità per scegliere l'operatore Index Seek anziché l'operatore Index Scan che utilizza un numero più elevato di risorse, migliorando di conseguenza le prestazioni di esecuzione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-111">For example, the query optimizer could use cardinality estimates to choose the index seek operator instead of the more resource-intensive index scan operator, and in doing so improve query performance.</span></span>  
  
 <span data-ttu-id="e18a8-112">Ogni oggetto statistiche viene creato in un elenco di una o più colonne di tabella e include un istogramma in cui è visualizzata la distribuzione dei valori nella prima colonna.</span><span class="sxs-lookup"><span data-stu-id="e18a8-112">Each statistics object is created on a list of one or more table columns and includes a histogram displaying the distribution of values in the first column.</span></span> <span data-ttu-id="e18a8-113">Negli oggetti statistiche su più colonne sono inoltre archiviate informazioni statistiche sulla correlazione dei valori tra le colonne.</span><span class="sxs-lookup"><span data-stu-id="e18a8-113">Statistics objects on multiple columns also store statistical information about the correlation of values among the columns.</span></span> <span data-ttu-id="e18a8-114">Queste statistiche sulla correlazione o *densità*derivano dal numero di righe distinte di valori di colonna.</span><span class="sxs-lookup"><span data-stu-id="e18a8-114">These correlation statistics, or *densities*, are derived from the number of distinct rows of column values.</span></span> <span data-ttu-id="e18a8-115">Per altre informazioni sugli oggetti statistiche, vedere [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-115">For more information about statistics objects, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="e18a8-116">Statistiche filtrate</span><span class="sxs-lookup"><span data-stu-id="e18a8-116">Filtered Statistics</span></span>  
 <span data-ttu-id="e18a8-117">Le statistiche filtrate possono migliorare le prestazioni di esecuzione delle query che effettuano la selezione da subset ben definiti di dati.</span><span class="sxs-lookup"><span data-stu-id="e18a8-117">Filtered statistics can improve query performance for queries that select from well-defined subsets of data.</span></span> <span data-ttu-id="e18a8-118">Le statistiche filtrate utilizzano un predicato del filtro per selezionare il subset di dati incluso nelle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-118">Filtered statistics use a filter predicate to select the subset of data that is included in the statistics.</span></span> <span data-ttu-id="e18a8-119">Statistiche filtrate progettate correttamente possono migliorare il piano di esecuzione delle query rispetto alle statistiche di tabella completa.</span><span class="sxs-lookup"><span data-stu-id="e18a8-119">Well-designed filtered statistics can improve the query execution plan compared with full-table statistics.</span></span> <span data-ttu-id="e18a8-120">Per altre informazioni sul predicato del filtro, vedere [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-120">For more information about the filter predicate, see [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span></span> <span data-ttu-id="e18a8-121">Per altre informazioni su quando creare statistiche filtrate, vedere la sezione [Quando creare le statistiche](#UpdateStatistics) in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="e18a8-121">For more information about when to create filtered statistics, see the [When to Create Statistics](#UpdateStatistics) section in this topic.</span></span> <span data-ttu-id="e18a8-122">Per un case study, vedere l'intervento di blog sull' [uso di statistiche filtrate con le tabelle partizionate](https://go.microsoft.com/fwlink/?LinkId=178505)sul sito Web SQLCAT.</span><span class="sxs-lookup"><span data-stu-id="e18a8-122">For a case study, see the blog entry, [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505), on the SQLCAT Web site.</span></span>  
  
 <span data-ttu-id="e18a8-123">Opzioni relative alle statistiche</span><span class="sxs-lookup"><span data-stu-id="e18a8-123">Statistics Options</span></span>  
 <span data-ttu-id="e18a8-124">Sono disponibili tre opzioni che se impostate influiscono sui tempi e sulle modalità di creazione e aggiornamento delle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-124">There are three options that you can set that affect when and how statistics are created and updated.</span></span> <span data-ttu-id="e18a8-125">Queste opzioni vengono impostate solo a livello di database.</span><span class="sxs-lookup"><span data-stu-id="e18a8-125">These options are set at the database level only.</span></span>  
  
 <span data-ttu-id="e18a8-126">Opzione AUTO_CREATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="e18a8-126">AUTO_CREATE_STATISTICS Option</span></span>  
 <span data-ttu-id="e18a8-127">Quando l'opzione per la creazione automatica delle statistiche, AUTO_CREATE_STATISTICS, è impostata su ON (attivata), Query Optimizer crea le statistiche necessarie per colonne singole nel predicato di query, al fine di migliorare le stime della cardinalità per il piano di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-127">When the automatic create statistics option, AUTO_CREATE_STATISTICS, is on, the query optimizer creates statistics on individual columns in the query predicate, as necessary, to improve cardinality estimates for the query plan.</span></span> <span data-ttu-id="e18a8-128">Queste statistiche di colonna singola vengono create in colonne che ancora non dispongono di un istogramma in un oggetto statistiche esistente.</span><span class="sxs-lookup"><span data-stu-id="e18a8-128">These single-column statistics are created on columns that do not already have a histogram in an existing statistics object.</span></span> <span data-ttu-id="e18a8-129">L'opzione AUTO_CREATE_STATISTICS non determina se le statistiche vengono create per gli indici.</span><span class="sxs-lookup"><span data-stu-id="e18a8-129">The AUTO_CREATE_STATISTICS option does not determine whether statistics get created for indexes.</span></span> <span data-ttu-id="e18a8-130">Questa opzione non genera inoltre statistiche filtrate,</span><span class="sxs-lookup"><span data-stu-id="e18a8-130">This option also does not generate filtered statistics.</span></span> <span data-ttu-id="e18a8-131">ma si applica esclusivamente alle statistiche di colonna singola per la tabella completa.</span><span class="sxs-lookup"><span data-stu-id="e18a8-131">It applies strictly to single-column statistics for the full table.</span></span>  
  
 <span data-ttu-id="e18a8-132">Quando Query Optimizer crea statistiche per colonne singole in seguito all'utilizzo dell'opzione AUTO_CREATE_STATISTICS, il nome delle statistiche inizia con `_WA`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-132">When the query optimizer creates statistics as a result of using the AUTO_CREATE_STATISTICS option, the statistics name starts with `_WA`.</span></span> <span data-ttu-id="e18a8-133">Per determinare se tramite Query Optimizer vengono create statistiche per una colonna del predicato di query, è possibile utilizzare la query riportata di seguito.</span><span class="sxs-lookup"><span data-stu-id="e18a8-133">You can use the following query to determine if the query optimizer has created statistics for a query predicate column.</span></span>  
  
```  
SELECT OBJECT_NAME(s.object_id) AS object_name,  
    COL_NAME(sc.object_id, sc.column_id) AS column_name,  
    s.name AS statistics_name  
FROM sys.stats AS s JOIN sys.stats_columns AS sc  
    ON s.stats_id = sc.stats_id AND s.object_id = sc.object_id  
WHERE s.name like '_WA%'  
ORDER BY s.name;  
```  
  
 <span data-ttu-id="e18a8-134">Opzione AUTO_UPDATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="e18a8-134">AUTO_UPDATE_STATISTICS Option</span></span>  
 <span data-ttu-id="e18a8-135">Quando l'opzione per l'aggiornamento automatico delle statistiche, AUTO_UPDATE_STATISTICS, è impostata su ON, Query Optimizer determina se le statistiche potrebbero non essere aggiornate, quindi ne esegue l'aggiornamento qualora vengano utilizzate tramite una query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-135">When the automatic update statistics option, AUTO_UPDATE_STATISTICS, is on, the query optimizer determines when statistics might be out-of-date and then updates them when they are used by a query.</span></span> <span data-ttu-id="e18a8-136">Le statistiche diventano obsolete in seguito a operazioni di inserimento, aggiornamento, eliminazione o unione che modificano la distribuzione dei dati nella tabella o nella vista indicizzata.</span><span class="sxs-lookup"><span data-stu-id="e18a8-136">Statistics become out-of-date after insert, update, delete, or merge operations change the data distribution in the table or indexed view.</span></span> <span data-ttu-id="e18a8-137">Query Optimizer determina che le statistiche potrebbero non essere aggiornate contando il numero di modifiche apportate ai dati dopo l'ultimo aggiornamento delle statistiche e confrontando il numero di modifiche con una soglia</span><span class="sxs-lookup"><span data-stu-id="e18a8-137">The query optimizer determines when statistics might be out-of-date by counting the number of data modifications since the last statistics update and comparing the number of modifications to a threshold.</span></span> <span data-ttu-id="e18a8-138">basata sul numero di righe nella tabella o nella vista indicizzata.</span><span class="sxs-lookup"><span data-stu-id="e18a8-138">The threshold is based on the number of rows in the table or indexed view.</span></span>  
  
 <span data-ttu-id="e18a8-139">Query Optimizer controlla la presenza di statistiche non aggiornate prima di compilare una query e prima di eseguire un piano di query memorizzato nella cache.</span><span class="sxs-lookup"><span data-stu-id="e18a8-139">The query optimizer checks for out-of-date statistics before compiling a query and before executing a cached query plan.</span></span> <span data-ttu-id="e18a8-140">Prima di compilare una query, Query Optimizer usano le colonne, le tabelle e le viste indicizzate nel predicato di query per identificare le eventuali statistiche non aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e18a8-140">Before compiling a query, the query optimizer uses the columns, tables, and indexed views in the query predicate to determine which statistics might be out-of-date.</span></span> <span data-ttu-id="e18a8-141">Prima di eseguire un piano di query memorizzato nella cache, il [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifica che tale piano faccia riferimento alle statistiche aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e18a8-141">Before executing a cached query plan, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifies that the query plan references up-to-date statistics.</span></span>  
  
 <span data-ttu-id="e18a8-142">L'opzione AUTO_UPDATE_STATISTICS si applica a oggetti statistiche creati per indici, colonne singole nei predicati di query e statistiche create con l'istruzione [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e18a8-142">The AUTO_UPDATE_STATISTICS option applies to statistics objects created for indexes, single-columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="e18a8-143">Questa opzione si applica anche alle statistiche filtrate.</span><span class="sxs-lookup"><span data-stu-id="e18a8-143">This option also applies to filtered statistics.</span></span>  
  
 <span data-ttu-id="e18a8-144">AUTO_UPDATE_STATISTICS_ASYNC</span><span class="sxs-lookup"><span data-stu-id="e18a8-144">AUTO_UPDATE_STATISTICS_ASYNC</span></span>  
 <span data-ttu-id="e18a8-145">L'opzione relativa all'aggiornamento asincrono delle statistiche, AUTO_UPDATE_STATISTICS_ASYNC, determina se Query Optimizer utilizza gli aggiornamenti sincroni o asincroni delle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-145">The asynchronous statistics update option, AUTO_UPDATE_STATISTICS_ASYNC, determines whether the query optimizer uses synchronous or asynchronous statistics updates.</span></span> <span data-ttu-id="e18a8-146">L'opzione relativa all'aggiornamento asincrono delle statistiche è disattivata (OFF) per impostazione predefinita. Query Optimizer aggiorna pertanto le statistiche in modo sincrono.</span><span class="sxs-lookup"><span data-stu-id="e18a8-146">By default, the asynchronous statistics update option is off, and the query optimizer updates statistics synchronously.</span></span> <span data-ttu-id="e18a8-147">L'opzione AUTO_UPDATE_STATISTICS_ASYNC si applica a oggetti statistiche creati per indici, colonne singole nei predicati di query e statistiche create con l'istruzione [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e18a8-147">The AUTO_UPDATE_STATISTICS_ASYNC option applies to statistics objects created for indexes, single columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="e18a8-148">Gli aggiornamenti delle statistiche possono essere sincroni (impostazione predefinita) o asincroni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-148">Statistics updates can be either synchronous (the default) or asynchronous.</span></span> <span data-ttu-id="e18a8-149">Con gli aggiornamenti sincroni delle statistiche, le query vengono sempre compilate ed eseguite con statistiche aggiornate. Se le statistiche sono obsolete, Query Optimizer rimane in attesa di statistiche aggiornate prima di compilare ed eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-149">With synchronous statistics updates, queries always compile and execute with up-to-date statistics; When statistics are out-of-date, the query optimizer waits for updated statistics before compiling and executing the query.</span></span> <span data-ttu-id="e18a8-150">Con gli aggiornamenti asincroni delle statistiche, le query vengono compilate con le statistiche esistenti anche non sono aggiornate. È possibile che Query Optimizer scelga un piano di query non ottimale se le statistiche non sono aggiornate al momento della compilazione della query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-150">With asynchronous statistics updates, queries compile with existing statistics even if the existing statistics are out-of-date; The query optimizer could choose a suboptimal query plan if statistics are out-of-date when the query compiles.</span></span> <span data-ttu-id="e18a8-151">L'utilizzo di statistiche aggiornate offrirà vantaggi nelle query compilate dopo il completamento degli aggiornamenti asincroni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-151">Queries that compile after the asynchronous updates have completed will benefit from using the updated statistics.</span></span>  
  
 <span data-ttu-id="e18a8-152">Utilizzare le statistiche sincrone quando si eseguono operazioni che modificano la distribuzione dei dati, quali il troncamento di una tabella o l'esecuzione di un inserimento bulk di una percentuale elevata di righe.</span><span class="sxs-lookup"><span data-stu-id="e18a8-152">Consider using synchronous statistics when you perform operations that change the distribution of data, such as truncating a table or performing a bulk update of a large percentage of the rows.</span></span> <span data-ttu-id="e18a8-153">Se non si aggiornano le statistiche dopo avere completato l'operazione, l'utilizzo di statistiche sincrone garantisce che le statistiche vengano aggiornate prima di eseguire query sui dati modificati.</span><span class="sxs-lookup"><span data-stu-id="e18a8-153">If you do not update the statistics after completing the operation, using synchronous statistics will ensure statistics are up-to-date before executing queries on the changed data.</span></span>  
  
 <span data-ttu-id="e18a8-154">Utilizzare le statistiche asincrone per ottenere tempi di risposta alle query più stimabili per gli scenari seguenti:</span><span class="sxs-lookup"><span data-stu-id="e18a8-154">Consider using asynchronous statistics to achieve more predictable query response times for the following scenarios:</span></span>  
  
-   <span data-ttu-id="e18a8-155">L'applicazione esegue di frequente la stessa query, query analoghe o piani di query memorizzati nella cache analoghi.</span><span class="sxs-lookup"><span data-stu-id="e18a8-155">Your application frequently executes the same query, similar queries, or similar cached query plans.</span></span> <span data-ttu-id="e18a8-156">È possibile che gli aggiornamenti asincroni delle statistiche consentano di ottenere tempi di risposta alle query più stimabili rispetto agli aggiornamenti sincroni delle statistiche perché Query Optimizer può eseguire le query in entrata senza attendere le statistiche aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e18a8-156">Your query response times might be more predictable with asynchronous statistics updates than with synchronous statistics updates because the query optimizer can execute incoming queries without waiting for up-to-date statistics.</span></span> <span data-ttu-id="e18a8-157">Ciò evita che alcune query vengano eseguite in ritardo rispetto ad altre.</span><span class="sxs-lookup"><span data-stu-id="e18a8-157">This avoids delaying some queries and not others.</span></span>  
  
-   <span data-ttu-id="e18a8-158">Sono stati riscontrati timeout nelle richieste client causati da una o più query in attesa delle statistiche aggiornate.</span><span class="sxs-lookup"><span data-stu-id="e18a8-158">Your application has experienced client request time outs caused by one or more queries waiting for updated statistics.</span></span> <span data-ttu-id="e18a8-159">In alcuni casi, l'attesa delle statistiche sincrone può causare errori nelle applicazioni con timeout aggressivi.</span><span class="sxs-lookup"><span data-stu-id="e18a8-159">In some cases, waiting for synchronous statistics could cause applications with aggressive time outs to fail.</span></span>  
  
 <span data-ttu-id="e18a8-160">INCREMENTAL STATS</span><span class="sxs-lookup"><span data-stu-id="e18a8-160">INCREMENTAL STATS</span></span>  
 <span data-ttu-id="e18a8-161">Quando impostata su ON, le statistiche create sono di tipo per partizione.</span><span class="sxs-lookup"><span data-stu-id="e18a8-161">When ON, the statistics created are per partition statistics.</span></span> <span data-ttu-id="e18a8-162">Quando impostata su OFF, l'albero delle statistiche viene eliminato e le statistiche vengono rielaborate da [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="e18a8-162">When OFF, the statistics tree is dropped and [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] re-computes the statistics.</span></span> <span data-ttu-id="e18a8-163">Il valore predefinito è OFF.</span><span class="sxs-lookup"><span data-stu-id="e18a8-163">The default is OFF.</span></span> <span data-ttu-id="e18a8-164">Questa impostazione esegue l'override della proprietà INCREMENTAL a livello di database.</span><span class="sxs-lookup"><span data-stu-id="e18a8-164">This setting overrides the database level INCREMENTAL property.</span></span>  
  
 <span data-ttu-id="e18a8-165">Quando vengono aggiunte delle nuove partizioni a una tabella di grandi dimensioni, è necessario aggiornare le statistiche per includere le nuove partizioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-165">When new partitions are added to a large table, statistics should be updated to include the new partitions.</span></span> <span data-ttu-id="e18a8-166">Tuttavia, l'analisi dell'intera tabella (opzione FULLSCAN o SAMPLE) potrebbe richiedere diverso tempo.</span><span class="sxs-lookup"><span data-stu-id="e18a8-166">However the time required to scan the entire table (FULLSCAN or SAMPLE option) might be quite long.</span></span> <span data-ttu-id="e18a8-167">Inoltre, l'analisi dell'intera tabella non è necessaria in quanto occorrono solo le statistiche sulle nuove partizioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-167">Also, scanning the entire table isn't necessary because only the statistics on the new partitions might be needed.</span></span> <span data-ttu-id="e18a8-168">L'opzione Incrementale crea e archivia le statistiche in base alle partizioni, e quando viene eseguito un aggiornamento, permette di aggiornare solo le statistiche di quelle partizioni che richiedono nuove statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-168">The incremental option creates and stores statistics on a per partition basis, and when updated, only refreshes statistics on those partitions that need new statistics</span></span>  
  
 <span data-ttu-id="e18a8-169">Se le statistiche per partizione non sono supportate, l'opzione viene ignorata e viene generato un avviso.</span><span class="sxs-lookup"><span data-stu-id="e18a8-169">If per partition statistics are not supported the option is ignored and a warning is generated.</span></span> <span data-ttu-id="e18a8-170">Le statistiche incrementali non sono supportate per i seguenti tipi di statistiche:</span><span class="sxs-lookup"><span data-stu-id="e18a8-170">Incremental stats are not supported for following statistics types:</span></span>  
  
-   <span data-ttu-id="e18a8-171">Statistiche create con indici che non hanno il partizionamento allineato con la tabella di base.</span><span class="sxs-lookup"><span data-stu-id="e18a8-171">Statistics created with indexes that are not partition-aligned with the base table.</span></span>  
  
-   <span data-ttu-id="e18a8-172">Statistiche create per i database secondari leggibili AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="e18a8-172">Statistics created on AlwaysOn readable secondary databases.</span></span>  
  
-   <span data-ttu-id="e18a8-173">Statistiche create per i database di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="e18a8-173">Statistics created on read-only databases.</span></span>  
  
-   <span data-ttu-id="e18a8-174">Statistiche create per gli indici filtrati.</span><span class="sxs-lookup"><span data-stu-id="e18a8-174">Statistics created on filtered indexes.</span></span>  
  
-   <span data-ttu-id="e18a8-175">Statistiche create per le viste.</span><span class="sxs-lookup"><span data-stu-id="e18a8-175">Statistics created on views.</span></span>  
  
-   <span data-ttu-id="e18a8-176">Statistiche create per le tabelle interne.</span><span class="sxs-lookup"><span data-stu-id="e18a8-176">Statistics created on internal tables.</span></span>  
  
-   <span data-ttu-id="e18a8-177">Statistiche create con indici spaziali o indici XML.</span><span class="sxs-lookup"><span data-stu-id="e18a8-177">Statistics created with spatial indexes or XML indexes.</span></span>  
  
||  
|-|  
|<span data-ttu-id="e18a8-178">**Si applica a**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] tramite [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="e18a8-178">**Applies to**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] through [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>|  
  
##  <a name="when-to-create-statistics"></a><a name="CreateStatistics"></a><span data-ttu-id="e18a8-179">Quando creare le statistiche</span><span class="sxs-lookup"><span data-stu-id="e18a8-179">When to Create Statistics</span></span>  
 <span data-ttu-id="e18a8-180">Query Optimizer crea già le statistiche nelle modalità seguenti:</span><span class="sxs-lookup"><span data-stu-id="e18a8-180">The query optimizer already creates statistics in the following ways:</span></span>  
  
1.  <span data-ttu-id="e18a8-181">Query Optimizer crea statistiche per gli indici in tabelle o viste, al momento della creazione dell'indice stesso.</span><span class="sxs-lookup"><span data-stu-id="e18a8-181">The query optimizer creates statistics for indexes on tables or views when the index is created.</span></span> <span data-ttu-id="e18a8-182">Tali statistiche vengono create nelle colonne chiave dell'indice.</span><span class="sxs-lookup"><span data-stu-id="e18a8-182">These statistics are created on the key columns of the index.</span></span> <span data-ttu-id="e18a8-183">Se l'indice è filtrato, Query Optimizer crea statistiche filtrate nello stesso subset di righe specificato per l'indice filtrato.</span><span class="sxs-lookup"><span data-stu-id="e18a8-183">If the index is a filtered index, the query optimizer creates filtered statistics on the same subset of rows specified for the filtered index.</span></span> <span data-ttu-id="e18a8-184">Per altre informazioni sugli indici filtrati, vedere [Creare indici filtrati](../indexes/create-filtered-indexes.md) e [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-184">For more information about filtered indexes, see [Create Filtered Indexes](../indexes/create-filtered-indexes.md) and [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span></span>  
  
2.  <span data-ttu-id="e18a8-185">Quando AUTO_CREATE_STATISTICS è impostata su ON, Query Optimizer crea statistiche per le singole colonne nei predicati di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-185">The query optimizer creates statistics for single columns in query predicates when AUTO_CREATE_STATISTICS is on.</span></span>  
  
 <span data-ttu-id="e18a8-186">Per la maggior parte delle query, questi due metodi di creazione delle statistiche garantiscono la definizione di un piano di query di alta qualità. In alcuni casi, è possibile migliorare i piani di query creando statistiche aggiuntive con l'istruzione [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e18a8-186">For most queries, these two methods for creating statistics ensure a high-quality query plan; in a few cases, you can improve query plans by creating additional statistics with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="e18a8-187">Tali statistiche aggiuntive possono acquisire correlazioni statistiche che non vengono prese in considerazione in Query Optimizer durante la creazione di statistiche per indici o singole colonne.</span><span class="sxs-lookup"><span data-stu-id="e18a8-187">These additional statistics can capture statistical correlations that the query optimizer does not account for when it creates statistics for indexes or single columns.</span></span> <span data-ttu-id="e18a8-188">È possibile che nell'applicazione siano disponibili correlazioni statistiche aggiuntive nei dati della tabella che, se calcolate in un oggetto statistiche, possono consentire a Query Optimizer di migliorare i piani di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-188">Your application might have additional statistical correlations in the table data that, if calculated into a statistics object, could enable the query optimizer to improve query plans.</span></span> <span data-ttu-id="e18a8-189">Le statistiche filtrate per un subset di righe di dati o le statistiche multicolonna per le colonne dei predicati di query possono ad esempio migliorare il piano di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-189">For example, filtered statistics on a subset of data rows or multicolumn statistics on query predicate columns might improve the query plan.</span></span>  
  
 <span data-ttu-id="e18a8-190">Quando si creano statistiche con l'istruzione CREATE STATISTICS, si consiglia di mantenere l'opzione AUTO_CREATE_STATISTICS impostata su ON, in modo tale che Query Optimizer continui a creare regolarmente statistiche di colonna singola per le colonne dei predicati di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-190">When creating statistics with the CREATE STATISTICS statement, we recommend keeping the AUTO_CREATE_STATISTICS option on so that the query optimizer continues to routinely create single-column statistics for query predicate columns.</span></span> <span data-ttu-id="e18a8-191">Per altre informazioni sui predicati, vedere [Condizione di ricerca&#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-191">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="e18a8-192">Utilizzare l'istruzione CREATE STATISTICS per creare statistiche in una delle seguenti condizioni:</span><span class="sxs-lookup"><span data-stu-id="e18a8-192">Consider creating statistics with the CREATE STATISTICS statement when any of the following applies:</span></span>  
  
-   <span data-ttu-id="e18a8-193">In Ottimizzazione guidata [!INCLUDE[ssDE](../../../includes/ssde-md.md)] viene indicato di creare statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-193">The [!INCLUDE[ssDE](../../../includes/ssde-md.md)] Tuning Advisor suggests creating statistics.</span></span>  
  
-   <span data-ttu-id="e18a8-194">Il predicato di query contiene più colonne correlate che non si trovano ancora nello stesso indice.</span><span class="sxs-lookup"><span data-stu-id="e18a8-194">The query predicate contains multiple correlated columns that are not already in the same index.</span></span>  
  
-   <span data-ttu-id="e18a8-195">La query effettua la selezione da un subset di dati.</span><span class="sxs-lookup"><span data-stu-id="e18a8-195">The query selects from a subset of data.</span></span>  
  
-   <span data-ttu-id="e18a8-196">La query presenta statistiche mancanti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-196">The query has missing statistics.</span></span>  
  
### <a name="query-predicate-contains-multiple-correlated-columns"></a><span data-ttu-id="e18a8-197">Il predicato di query contiene più colonne correlate</span><span class="sxs-lookup"><span data-stu-id="e18a8-197">Query Predicate Contains Multiple Correlated Columns</span></span>  
 <span data-ttu-id="e18a8-198">Quando il predicato di una query contiene più colonne correlate e dipendenti tra loro, è possibile che la creazione di statistiche per più colonne consenta di migliorare il piano di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-198">When a query predicate contains multiple columns that have cross-column relationships and dependencies, statistics on the multiple columns might improve the query plan.</span></span> <span data-ttu-id="e18a8-199">Le statistiche su più colonne contengono le statistiche sulla correlazione tra colonne, denominate *densità*, le quali non sono disponili nelle statistiche di colonna singola.</span><span class="sxs-lookup"><span data-stu-id="e18a8-199">Statistics on multiple columns contain cross-column correlation statistics, called *densities*, that are not available in single-column statistics.</span></span> <span data-ttu-id="e18a8-200">Le densità possono migliorare le stime della cardinalità qualora i risultati della query dipendano da relazioni tra i dati di più colonne.</span><span class="sxs-lookup"><span data-stu-id="e18a8-200">Densities can improve cardinality estimates when query results depend on data relationships among multiple columns.</span></span>  
  
 <span data-ttu-id="e18a8-201">Se le colonne si trovano già nello stesso indice, l'oggetto statistiche multicolonna esiste già e non è necessario crearlo manualmente.</span><span class="sxs-lookup"><span data-stu-id="e18a8-201">If the columns are already in the same index, the multicolumn statistics object already exists and it is not necessary to create it manually.</span></span> <span data-ttu-id="e18a8-202">Se le colonne ancora non si trovano nello stesso indice, è possibile creare le statistiche multicolonna tramite un indice nelle colonne o l'istruzione CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="e18a8-202">If the columns are not already in the same index, you can create multicolumn statistics by creating an index on the columns or by using the CREATE STATISTICS statement.</span></span> <span data-ttu-id="e18a8-203">La gestione di un indice richiede più risorse di sistema rispetto a un oggetto statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-203">It requires more system resources to maintain an index than a statistics object.</span></span> <span data-ttu-id="e18a8-204">Se l'applicazione non richiede l'indice multicolonna, è possibile utilizzare una quantità ridotta di risorse di sistema creando l'oggetto statistiche senza creare l'indice.</span><span class="sxs-lookup"><span data-stu-id="e18a8-204">If the application does not require the multicolumn index, you can economize on system resources by creating the statistics object without creating the index.</span></span>  
  
 <span data-ttu-id="e18a8-205">Quando si creano le statistiche multicolonna, l'ordine delle colonne nella definizione dell'oggetto statistiche influisce sull'efficacia delle densità nel calcolo delle stime della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="e18a8-205">When creating multicolumn statistics, the order of the columns in the statistics object definition affects the effectiveness of densities for making cardinality estimates.</span></span> <span data-ttu-id="e18a8-206">L'oggetto statistiche archivia le densità per ciascun prefisso delle colonne chiave nella definizione dell'oggetto statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-206">The statistics object stores densities for each prefix of key columns in the statistics object definition.</span></span> <span data-ttu-id="e18a8-207">Per altre informazioni sulle densità, vedere [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-207">For more information about densities, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="e18a8-208">Per creare densità utili per le stime della cardinalità, è necessario che le colonne nel predicato di query corrispondano a uno dei prefissi delle colonne nella definizione dell'oggetto statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-208">To create densities that are useful for cardinality estimates, the columns in the query predicate must match one of the prefixes of columns in the statistics object definition.</span></span> <span data-ttu-id="e18a8-209">Di seguito viene ad esempio creato un oggetto statistiche multicolonna per le colonne `LastName`, `MiddleName`e `FirstName`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-209">For example, the following creates a multicolumn statistics object on the columns `LastName`, `MiddleName`, and `FirstName`.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
IF EXISTS (SELECT name FROM sys.stats  
    WHERE name = 'LastFirst'  
    AND object_ID = OBJECT_ID ('Person.Person'))  
DROP STATISTICS Person.Person.LastFirst;  
GO  
CREATE STATISTICS LastFirst ON Person.Person (LastName, MiddleName, FirstName);  
GO  
```  
  
 <span data-ttu-id="e18a8-210">In questo esempio, l'oggetto statistiche `LastFirst` dispone delle densità per i seguenti prefissi di colonna: (`LastName`), (`LastName, MiddleName`) e (`LastName, MiddleName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="e18a8-210">In this example, the statistics object `LastFirst` has densities for the following column prefixes: (`LastName`), (`LastName, MiddleName`), and (`LastName, MiddleName, FirstName`).</span></span> <span data-ttu-id="e18a8-211">La densità non è disponibile per (`LastName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="e18a8-211">The density is not available for (`LastName, FirstName`).</span></span> <span data-ttu-id="e18a8-212">Se la query utilizza `LastName` e `FirstName` senza utilizzare `MiddleName`, la densità non è disponibile per le stime della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="e18a8-212">If the query uses `LastName` and `FirstName` without using `MiddleName`, the density is not available for cardinality estimates.</span></span>  
  
### <a name="query-selects-from-a-subset-of-data"></a><span data-ttu-id="e18a8-213">La query effettua la selezione da un subset di dati</span><span class="sxs-lookup"><span data-stu-id="e18a8-213">Query Selects from a Subset of Data</span></span>  
 <span data-ttu-id="e18a8-214">La creazione di statistiche per indici e colonne singole in Query Optimizer implica la creazione di statistiche per i valori in tutte le righe.</span><span class="sxs-lookup"><span data-stu-id="e18a8-214">When the query optimizer creates statistics for single columns and indexes, it creates the statistics for the values in all rows.</span></span> <span data-ttu-id="e18a8-215">Quando le query effettuano la selezione da un subset di righe che dispone di una distribuzione dei dati univoca, le statistiche filtrate possono migliorare i piani di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-215">When queries select from a subset of rows, and that subset of rows has a unique data distribution, filtered statistics can improve query plans.</span></span> <span data-ttu-id="e18a8-216">È possibile creare le statistiche filtrate utilizzando l'istruzione CREATE STATISTICS con la clausola WHERE per definire l'espressione del predicato del filtro.</span><span class="sxs-lookup"><span data-stu-id="e18a8-216">You can create filtered statistics by using the CREATE STATISTICS statement with the WHERE clause to define the filter predicate expression.</span></span>  
  
 <span data-ttu-id="e18a8-217">Se ad esempio si utilizza [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], ogni prodotto nella tabella Production.Product appartiene a una delle quattro categorie della tabella Production.ProductCategory, ovvero Bikes, Components, Clothing e Accessories.</span><span class="sxs-lookup"><span data-stu-id="e18a8-217">For example, using [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], each product in the Production.Product table belongs to one of four categories in the Production.ProductCategory table: Bikes, Components, Clothing, and Accessories.</span></span> <span data-ttu-id="e18a8-218">Ogni categoria dispone di una distribuzione dei dati diversa in relazione al peso. I pesi nella categoria Bikes sono compresi tra 13,77 e 30, quelli della categoria Components sono compresi tra 2,12 e 1.050 con alcuni valori NULL e quelli delle categorie Clothing e Accessories sono tutti NULL.</span><span class="sxs-lookup"><span data-stu-id="e18a8-218">Each of the categories has a different data distribution for weight: bike weights range from 13.77 to 30.0, component weights range from 2.12 to 1050.00 with some NULL values, clothing weights are all NULL, and accessory weights are also NULL.</span></span>  
  
 <span data-ttu-id="e18a8-219">Prendendo come esempio la categoria Bikes, le statistiche filtrate per tutti i pesi consentono di fornire a Query Optimizer statistiche più accurate e di migliorare la qualità del piano di query rispetto alle statistiche di tabella completa o alle statistiche inesistenti nella colonna relativa al peso (Weight).</span><span class="sxs-lookup"><span data-stu-id="e18a8-219">Using Bikes as an example, filtered statistics on all bike weights will provide more accurate statistics to the query optimizer and can improve the query plan quality compared with full-table statistics or nonexistent statistics on the Weight column.</span></span> <span data-ttu-id="e18a8-220">La colonna Weight della categoria Bikes rappresenta un candidato valido per le statistiche filtrate. Nel caso di un numero relativamente ridotto di ricerche correlate al peso, tale colonna non è tuttavia necessariamente un candidato valido per un indice filtrato.</span><span class="sxs-lookup"><span data-stu-id="e18a8-220">The bike weight column is a good candidate for filtered statistics but not necessarily a good candidate for a filtered index if the number of weight lookups is relatively small.</span></span> <span data-ttu-id="e18a8-221">È possibile che i vantaggi derivanti dai miglioramenti alle prestazioni delle ricerche offerti da un indice filtrato siano inferiori rispetto agli svantaggi derivanti dai costi di manutenzione e archiviazione supplementari dovuti all'aggiunta di un indice filtrato al database.</span><span class="sxs-lookup"><span data-stu-id="e18a8-221">The performance gain for lookups that a filtered index provides might not outweigh the additional maintenance and storage cost for adding a filtered index to the database.</span></span>  
  
 <span data-ttu-id="e18a8-222">L'istruzione seguente crea le statistiche filtrate di `BikeWeights` per tutte le sottocategorie di Bikes.</span><span class="sxs-lookup"><span data-stu-id="e18a8-222">The following statement creates the `BikeWeights` filtered statistics on all of the subcategories for Bikes.</span></span> <span data-ttu-id="e18a8-223">L'espressione del predicato filtrata definisce le biciclette (Bikes) enumerando tutte le sottocategorie di Bikes con l'elemento `Production.ProductSubcategoryID IN (1,2,3)`di confronto.</span><span class="sxs-lookup"><span data-stu-id="e18a8-223">The filtered predicate expression defines bikes by enumerating all of the bike subcategories with the comparison `Production.ProductSubcategoryID IN (1,2,3)`.</span></span> <span data-ttu-id="e18a8-224">Il predicato non può utilizzare il nome di categoria Bikes perché viene archiviato nella tabella Production.ProductCategory e tutte le colonne nell'espressione di filtro devono trovarsi nella stessa tabella.</span><span class="sxs-lookup"><span data-stu-id="e18a8-224">The predicate cannot use the Bikes category name because it is stored in the Production.ProductCategory table, and all columns in the filter expression must be in the same table.</span></span>  
  
 [!code-sql[StatisticsDDL#FilteredStats2](../../snippets/tsql/SQL14/tsql/statisticsddl/transact-sql/filteredstats.sql#filteredstats2)]  
  
 <span data-ttu-id="e18a8-225">Query Optimizer può utilizzare le statistiche filtrate di `BikeWeights` per migliorare il piano di query per la query seguente che seleziona tutti gli elementi della categoria Bikes con peso maggiore di `25`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-225">The query optimizer can use the `BikeWeights` filtered statistics to improve the query plan for the following query that selects all of the bikes that weigh more than `25`.</span></span>  
  
```  
SELECT P.Weight AS Weight, S.Name AS BikeName  
FROM Production.Product AS P  
    JOIN Production.ProductSubcategory AS S   
    ON P.ProductSubcategoryID = S.ProductSubcategoryID  
WHERE P.ProductSubcategoryID IN (1,2,3) AND P.Weight > 25  
ORDER BY P.Weight;  
GO  
```  
  
### <a name="query-identifies-missing-statistics"></a><span data-ttu-id="e18a8-226">La query identifica le statistiche mancanti</span><span class="sxs-lookup"><span data-stu-id="e18a8-226">Query Identifies Missing Statistics</span></span>  
 <span data-ttu-id="e18a8-227">Se un errore o un altro evento impedisce la creazione di statistiche da parte di Query Optimizer, il piano di query viene creato senza utilizzare statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-227">If an error or other event prevents the query optimizer from creating statistics, the query optimizer creates the query plan without using statistics.</span></span> <span data-ttu-id="e18a8-228">Query Optimizer contrassegna le statistiche come mancanti e tenta di rigenerare le statistiche alla successiva esecuzione della query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-228">The query optimizer marks the statistics as missing and attempts to regenerate the statistics the next time the query is executed.</span></span>  
  
 <span data-ttu-id="e18a8-229">Le statistiche mancanti sono indicate come avvisi (nome della tabella in rosso) quando il piano di esecuzione di una query viene visualizzato graficamente utilizzando [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="e18a8-229">Missing statistics are indicated as warnings (table name in red text) when the execution plan of a query is graphically displayed using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="e18a8-230">Il monitoraggio della classe di eventi **Missing Column Statistics** con [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indica anche i casi in cui le statistiche risultano mancanti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-230">Additionally, monitoring the **Missing Column Statistics** event class by using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indicates when statistics are missing.</span></span> <span data-ttu-id="e18a8-231">Per altre informazioni, vedere [Categoria di eventi Errori e avvisi &#40;Motore di database&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="e18a8-231">For more information, see [Errors and Warnings Event Category &#40;Database Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span></span>  
  
 <span data-ttu-id="e18a8-232">In caso di statistiche mancanti, effettuare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="e18a8-232">If statistics are missing, perform the following steps:</span></span>  
  
-   <span data-ttu-id="e18a8-233">Verificare che AUTO_CREATE_STATISTICS e AUTO_UPDATE_STATISTICS siano impostate su ON.</span><span class="sxs-lookup"><span data-stu-id="e18a8-233">Verify that AUTO_CREATE_STATISTICS and AUTO_UPDATE_STATISTICS are on.</span></span>  
  
-   <span data-ttu-id="e18a8-234">Verificare che il database non sia di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="e18a8-234">Verify that the database is not read-only.</span></span> <span data-ttu-id="e18a8-235">Se il database è di sola lettura, Query Optimizer non è in grado di salvare le statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-235">If the database is read-only, the query optimizer cannot save statistics.</span></span>  
  
-   <span data-ttu-id="e18a8-236">Creare le statistiche mancanti mediante l'istruzione CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="e18a8-236">Create the missing statistics by using the CREATE STATISTICS statement.</span></span>  
  
 <span data-ttu-id="e18a8-237">Quando le statistiche su uno snapshot o un database di sola lettura sono mancanti o non aggiornate, il [!INCLUDE[ssDE](../../../includes/ssde-md.md)] crea e gestisce statistiche temporanee in `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-237">When statistics on a read-only database or read-only snapshot are missing or stale, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates and maintains temporary statistics in `tempdb`.</span></span> <span data-ttu-id="e18a8-238">Quando il [!INCLUDE[ssDE](../../../includes/ssde-md.md)] crea statistiche temporanee, al nome delle statistiche viene aggiunto il suffisso _readonly_database_statistic per distinguere le statistiche temporanee da quelle permanenti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-238">When the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates temporary statistics, the statistics name is appended with the suffix _readonly_database_statistic to differentiate the temporary statistics from the permanent statistics.</span></span> <span data-ttu-id="e18a8-239">Il suffisso _readonly_database_statistic è riservato alle statistiche generate da [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="e18a8-239">The suffix _readonly_database_statistic is reserved for statistics generated by [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="e18a8-240">È possibile creare script per le statistiche temporanee e riprodurli in un database di lettura e scrittura.</span><span class="sxs-lookup"><span data-stu-id="e18a8-240">Scripts for the temporary statistics can be created and reproduced on a read-write database.</span></span> <span data-ttu-id="e18a8-241">Quando viene creato uno script, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] modifica il suffisso del nome delle statistiche da _readonly_database_statistic a _readonly_database_statistic_scripted.</span><span class="sxs-lookup"><span data-stu-id="e18a8-241">When scripted, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] changes the suffix of the statistics name from _readonly_database_statistic to _readonly_database_statistic_scripted.</span></span>  
  
 <span data-ttu-id="e18a8-242">Solo in [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] è possibile creare e aggiornare le statistiche temporanee.</span><span class="sxs-lookup"><span data-stu-id="e18a8-242">Only [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can create and update temporary statistics.</span></span> <span data-ttu-id="e18a8-243">È tuttavia possibile eliminare le statistiche temporanee e monitorare le relative proprietà utilizzando gli stessi strumenti utilizzati per le statistiche permanenti:</span><span class="sxs-lookup"><span data-stu-id="e18a8-243">However, you can delete temporary statistics and monitor statistics properties using the same tools that you use for permanent statistics:</span></span>  
  
-   <span data-ttu-id="e18a8-244">Eliminare le statistiche temporanee usando l'istruzione [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e18a8-244">Delete temporary statistics using the [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="e18a8-245">Monitorare le statistiche usando le viste del catalogo **sys.stats** e **sys.stats_columns** .</span><span class="sxs-lookup"><span data-stu-id="e18a8-245">Monitor statistics using the **sys.stats** and **sys.stats_columns** catalog views.</span></span> <span data-ttu-id="e18a8-246">**sys_stats** include una colonna, **is_temporary** , che indica quali statistiche sono permanenti e quali invece temporanee.</span><span class="sxs-lookup"><span data-stu-id="e18a8-246">**sys_stats** includes the **is_temporary** column, to indicate which statistics are permanent and which are temporary.</span></span>  
  
 <span data-ttu-id="e18a8-247">Poiché le statistiche temporanee sono archiviate in `tempdb`, un riavvio del servizio [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] comporta l'indisponibilità di tutte le statistiche temporanee.</span><span class="sxs-lookup"><span data-stu-id="e18a8-247">Because temporary statistics are stored in `tempdb`, a restart of the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service causes all temporary statistics to disappear.</span></span>  
  
##  <a name="when-to-update-statistics"></a><a name="UpdateStatistics"></a><span data-ttu-id="e18a8-248">Quando aggiornare le statistiche</span><span class="sxs-lookup"><span data-stu-id="e18a8-248">When to Update Statistics</span></span>  
 <span data-ttu-id="e18a8-249">Query Optimizer determina che le statistiche potrebbero non essere aggiornate, quindi ne effettua l'aggiornamento qualora siano necessarie per un piano di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-249">The query optimizer determines when statistics might be out-of-date and then updates them when they are needed for a query plan.</span></span> <span data-ttu-id="e18a8-250">In alcuni casi, è possibile migliorare il piano di query e le prestazioni di esecuzione delle query aggiornando le statistiche più frequentemente di quanto accada quando AUTO_UPDATE_STATISTICS è impostata su ON.</span><span class="sxs-lookup"><span data-stu-id="e18a8-250">In some cases you can improve the query plan and therefore improve query performance by updating statistics more frequently than occur when AUTO_UPDATE_STATISTICS is on.</span></span> <span data-ttu-id="e18a8-251">È possibile aggiornare le statistiche mediante l'istruzione UPDATE STATISTICS o la stored procedure sp_updatestats.</span><span class="sxs-lookup"><span data-stu-id="e18a8-251">You can update statistics with the UPDATE STATISTICS statement or the stored procedure sp_updatestats.</span></span>  
  
 <span data-ttu-id="e18a8-252">Sebbene consenta di garantire che le query vengano compilate con statistiche aggiornate,</span><span class="sxs-lookup"><span data-stu-id="e18a8-252">Updating statistics ensures that queries compile with up-to-date statistics.</span></span> <span data-ttu-id="e18a8-253">l'aggiornamento delle statistiche causa la ricompilazione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-253">However, updating statistics causes queries to recompile.</span></span> <span data-ttu-id="e18a8-254">Si consiglia di non aggiornare le statistiche troppo frequentemente perché è necessario mantenere un equilibrio a livello di prestazioni tra la necessità di migliorare i piani di query e il tempo necessario per la ricompilazione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-254">We recommend not updating statistics too frequently because there is a performance tradeoff between improving query plans and the time it takes to recompile queries.</span></span> <span data-ttu-id="e18a8-255">Tale equilibrio dipende dall'applicazione in uso.</span><span class="sxs-lookup"><span data-stu-id="e18a8-255">The specific tradeoffs depend on your application.</span></span>  
  
 <span data-ttu-id="e18a8-256">Quando si utilizza UPDATE STATISTICS o sp_updatestats per aggiornare le statistiche, mantenere AUTO_UPDATE_STATISTICS impostata su ON, affinché l'aggiornamento continui a essere eseguito regolarmente in Query Optimizer.</span><span class="sxs-lookup"><span data-stu-id="e18a8-256">When updating statistics with UPDATE STATISTICS or sp_updatestats, we recommend keeping AUTO_UPDATE_STATISTICS set to ON so that the query optimizer continues to routinely update statistics.</span></span> <span data-ttu-id="e18a8-257">Per altre informazioni sull'aggiornamento delle statistiche per una colonna, un indice, una tabella o una vista indicizzata, vedere [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-257">For more information about how to update statistics on a column, an index, a table, or an indexed view, see [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span></span> <span data-ttu-id="e18a8-258">Per informazioni sull'aggiornamento delle statistiche per tutte le tabelle interne e definite dall'utente nel database, vedere la stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-258">For information about how to update statistics for all user-defined and internal tables in the database, see the stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="e18a8-259">Per determinare la data dell'ultimo aggiornamento delle statistiche, usare la funzione [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e18a8-259">To determine when statistics were last updated, use the [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) function.</span></span>  
  
 <span data-ttu-id="e18a8-260">Aggiornare le statistiche nei seguenti casi:</span><span class="sxs-lookup"><span data-stu-id="e18a8-260">Consider updating statistics for the following conditions:</span></span>  
  
-   <span data-ttu-id="e18a8-261">I tempi di esecuzione delle query sono particolarmente lunghi.</span><span class="sxs-lookup"><span data-stu-id="e18a8-261">Query execution times are slow.</span></span>  
  
-   <span data-ttu-id="e18a8-262">Si verificano operazioni di inserimento in colonne chiave crescenti o decrescenti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-262">Insert operations occur on ascending or descending key columns.</span></span>  
  
-   <span data-ttu-id="e18a8-263">In seguito a operazioni di manutenzione.</span><span class="sxs-lookup"><span data-stu-id="e18a8-263">After maintenance operations.</span></span>  
  
### <a name="query-execution-times-are-slow"></a><span data-ttu-id="e18a8-264">I tempi di esecuzione delle query sono particolarmente lunghi</span><span class="sxs-lookup"><span data-stu-id="e18a8-264">Query Execution Times Are Slow</span></span>  
 <span data-ttu-id="e18a8-265">Se i tempi di risposta alle query sono troppo lunghi o imprevedibili, assicurarsi che le query dispongano di statistiche aggiornate prima di eseguire ulteriori procedure di risoluzione dei problemi.</span><span class="sxs-lookup"><span data-stu-id="e18a8-265">If query response times are slow or unpredictable, ensure that queries have up-to-date statistics before performing additional troubleshooting steps.</span></span>  
  
### <a name="insert-operations-occur-on-ascending-or-descending-key-columns"></a><span data-ttu-id="e18a8-266">Si verificano operazioni di inserimento in colonne chiave crescenti o decrescenti</span><span class="sxs-lookup"><span data-stu-id="e18a8-266">Insert Operations Occur on Ascending or Descending Key Columns</span></span>  
 <span data-ttu-id="e18a8-267">È possibile che le statistiche per colonne chiave crescenti o decrescenti, ad esempio colonne IDENTITY o timestamp in tempo reale, richiedano aggiornamenti più frequenti rispetto a quelli previsti in Query Optimizer.</span><span class="sxs-lookup"><span data-stu-id="e18a8-267">Statistics on ascending or descending key columns, such as IDENTITY or real-time timestamp columns, might require more frequent statistics updates than the query optimizer performs.</span></span> <span data-ttu-id="e18a8-268">Le operazioni di inserimento accodano nuovi valori alle colonne crescenti o decrescenti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-268">Insert operations append new values to ascending or descending columns.</span></span> <span data-ttu-id="e18a8-269">È possibile che il numero di righe aggiunte non sia sufficiente per attivare un aggiornamento delle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-269">The number of rows added might be too small to trigger a statistics update.</span></span> <span data-ttu-id="e18a8-270">Se le statistiche non sono aggiornate e le query effettuano la selezione dalle righe aggiunte più di recente, le statistiche correnti non disporranno delle stime della cardinalità per tali nuovi valori.</span><span class="sxs-lookup"><span data-stu-id="e18a8-270">If statistics are not up-to-date and queries select from the most recently added rows, the current statistics will not have cardinality estimates for these new values.</span></span> <span data-ttu-id="e18a8-271">Ciò può comportare imprecisioni nelle stime della cardinalità e prestazioni di esecuzione delle query ridotte.</span><span class="sxs-lookup"><span data-stu-id="e18a8-271">This can result in inaccurate cardinality estimates and slow query performance.</span></span>  
  
 <span data-ttu-id="e18a8-272">Le stime della cardinalità di una query che effettua la selezione dalle date degli ordini di vendita più recenti non saranno ad esempio precise se le statistiche non sono aggiornate in modo da includere le stime della cardinalità di tali date.</span><span class="sxs-lookup"><span data-stu-id="e18a8-272">For example, a query that selects from the most recent sales order dates will have inaccurate cardinality estimates if the statistics are not updated to include cardinality estimates for the most recent sales order dates.</span></span>  
  
### <a name="after-maintenance-operations"></a><span data-ttu-id="e18a8-273">In seguito a operazioni di manutenzione</span><span class="sxs-lookup"><span data-stu-id="e18a8-273">After Maintenance Operations</span></span>  
 <span data-ttu-id="e18a8-274">Aggiornare le statistiche dopo avere eseguito procedure di manutenzione che modificano la distribuzione dei dati, quali il troncamento di una tabella o l'esecuzione di un inserimento bulk di un'elevata percentuale di righe.</span><span class="sxs-lookup"><span data-stu-id="e18a8-274">Consider updating statistics after performing maintenance procedures that change the distribution of data, such as truncating a table or performing a bulk insert of a large percentage of the rows.</span></span> <span data-ttu-id="e18a8-275">Ciò consente di evitare ritardi futuri nell'elaborazione delle query causati dall'attesa da parte delle query stesse degli aggiornamenti automatici delle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-275">This can avoid future delays in query processing while queries wait for automatic statistics updates.</span></span>  
  
 <span data-ttu-id="e18a8-276">Operazioni quali la ricompilazione, la deframmentazione o la riorganizzazione di un indice non modificano la distribuzione dei dati.</span><span class="sxs-lookup"><span data-stu-id="e18a8-276">Operations such as rebuilding, defragmenting, or reorganizing an index do not change the distribution of data.</span></span> <span data-ttu-id="e18a8-277">Non è pertanto necessario aggiornare le statistiche in seguito all'esecuzione di operazioni ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG o ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="e18a8-277">Therefore, you do not need to update statistics after performing ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG, or ALTER INDEX REORGANIZE operations.</span></span> <span data-ttu-id="e18a8-278">L'aggiornamento delle statistiche viene eseguito in Query Optimizer in seguito alla ricompilazione di un indice in una tabella o una vista mediante ALTER INDEX REBUILD o DBCC DBREINDEX. Tale aggiornamento delle statistiche è tuttavia il risultato della ricostruzione dell'indice.</span><span class="sxs-lookup"><span data-stu-id="e18a8-278">The query optimizer updates statistics when you rebuild an index on a table or view with ALTER INDEX REBUILD or DBCC DBREINDEX, however; this statistics update is a byproduct of re-creating the index.</span></span> <span data-ttu-id="e18a8-279">L'aggiornamento delle statistiche non viene eseguito in Query Optimizer dopo operazioni DBCC INDEXDEFRAG o ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="e18a8-279">The query optimizer does not update statistics after DBCC INDEXDEFRAG or ALTER INDEX REORGANIZE operations.</span></span>  
  
##  <a name="queries-that-use-statistics-effectively"></a><a name="DesignStatistics"></a><span data-ttu-id="e18a8-280">Query che utilizzano le statistiche in modo efficace</span><span class="sxs-lookup"><span data-stu-id="e18a8-280">Queries That Use Statistics Effectively</span></span>  
 <span data-ttu-id="e18a8-281">Alcune implementazioni delle query, quali le variabili locali e le espressioni complesse nel predicato di query, possono comportare la definizione di piani di query non ottimali.</span><span class="sxs-lookup"><span data-stu-id="e18a8-281">Certain query implementations, such as local variables and complex expressions in the query predicate, can lead to suboptimal query plans.</span></span> <span data-ttu-id="e18a8-282">Per evitare che ciò accada, attenersi alle linee guida relative alla progettazione delle query per un utilizzo efficace delle statistiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-282">Following query design guidelines for using statistics effectively can help to avoid this.</span></span> <span data-ttu-id="e18a8-283">Per altre informazioni sui predicati, vedere [Condizione di ricerca&#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e18a8-283">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="e18a8-284">È possibile migliorare i piani di query applicando le linee guida relative alla progettazione delle query che prevedono un utilizzo efficace delle statistiche, al fine di migliorare le *stime della cardinalità* per espressioni, variabili e funzioni usate nei predicati di query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-284">You can improve query plans by applying query design guidelines that use statistics effectively to improve *cardinality estimates* for expressions, variables, and functions used in query predicates.</span></span> <span data-ttu-id="e18a8-285">Se il valore di un'espressione, di una variabile o di una funzione non è noto, Query Optimizer non è in grado di determinare il valore da ricercare nell'istogramma e non può pertanto recuperare la stima della cardinalità ottimale dall'istogramma.</span><span class="sxs-lookup"><span data-stu-id="e18a8-285">When the query optimizer does not know the value of an expression, variable, or function, it does not know which value to lookup in the histogram and therefore cannot retrieve the best cardinality estimate from the histogram.</span></span> <span data-ttu-id="e18a8-286">In tal caso, la stima della cardinalità di Query Optimizer si basa sul numero medio di righe per valore distinct per tutte le righe campionate nell'istogramma.</span><span class="sxs-lookup"><span data-stu-id="e18a8-286">Instead, the query optimizer bases the cardinality estimate on the average number of rows per distinct value for all of the sampled rows in the histogram.</span></span> <span data-ttu-id="e18a8-287">Ciò comporta stime della cardinalità non ottimali e può causare una riduzione delle prestazioni di esecuzione delle query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-287">This leads to suboptimal cardinality estimates and can hurt query performance.</span></span>  
  
 <span data-ttu-id="e18a8-288">Nelle linee guida seguenti viene indicato come scrivere query per migliorare i piani di query grazie all'ottimizzazione delle stime della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="e18a8-288">The following guidelines describe how to write queries to improve query plans by improving cardinality estimates.</span></span>  
  
### <a name="improving-cardinality-estimates-for-expressions"></a><span data-ttu-id="e18a8-289">Miglioramento delle stime della cardinalità per le espressioni</span><span class="sxs-lookup"><span data-stu-id="e18a8-289">Improving Cardinality Estimates for Expressions</span></span>  
 <span data-ttu-id="e18a8-290">Per migliorare le stime della cardinalità per le espressioni, attenersi alle seguenti linee guida:</span><span class="sxs-lookup"><span data-stu-id="e18a8-290">To improve cardinality estimates for expressions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="e18a8-291">Se possibile, semplificare le espressioni contenenti costanti.</span><span class="sxs-lookup"><span data-stu-id="e18a8-291">Whenever possible, simplify expressions with constants in them.</span></span> <span data-ttu-id="e18a8-292">Query Optimizer non valuta tutte le funzioni e le espressioni che contengono costanti prima di determinare le stime della cardinalità.</span><span class="sxs-lookup"><span data-stu-id="e18a8-292">The query optimizer does not evaluate all functions and expressions containing constants prior to determining cardinality estimates.</span></span> <span data-ttu-id="e18a8-293">Semplificare ad esempio l'espressione ABS(`-100) to 100`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-293">For example, simplify the expression ABS(`-100) to 100`.</span></span>  
  
-   <span data-ttu-id="e18a8-294">Se l'espressione utilizza più variabili, creare una colonna calcolata per l'espressione, quindi creare le statistiche o un indice nella colonna calcolata.</span><span class="sxs-lookup"><span data-stu-id="e18a8-294">If the expression uses multiple variables, consider creating a computed column for the expression and then create statistics or an index on the computed column.</span></span> <span data-ttu-id="e18a8-295">È ad esempio possibile che la stima della cardinalità del predicato di query `WHERE PRICE + Tax > 100` sia migliore se si crea una colonna calcolata per l'espressione `Price + Tax`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-295">For example, the query predicate `WHERE PRICE + Tax > 100` might have a better cardinality estimate if you create a computed column for the expression `Price + Tax`.</span></span>  
  
### <a name="improving-cardinality-estimates-for-variables-and-functions"></a><span data-ttu-id="e18a8-296">Miglioramento delle stime della cardinalità per variabili e funzioni</span><span class="sxs-lookup"><span data-stu-id="e18a8-296">Improving Cardinality Estimates for Variables and Functions</span></span>  
 <span data-ttu-id="e18a8-297">Per migliorare le stime della cardinalità per variabili e funzioni, attenersi alle seguenti linee guida:</span><span class="sxs-lookup"><span data-stu-id="e18a8-297">To improve the cardinality estimates for variables and functions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="e18a8-298">Se nel predicato di query viene utilizzata una variabile locale, riscrivere la query in modo da utilizzare un parametro anziché una variabile locale.</span><span class="sxs-lookup"><span data-stu-id="e18a8-298">If the query predicate uses a local variable, consider rewriting the query to use a parameter instead of a local variable.</span></span> <span data-ttu-id="e18a8-299">Il valore di una variabile locale non è noto quando Query Optimizer crea il piano di esecuzione della query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-299">The value of a local variable is not known when the query optimizer creates the query execution plan.</span></span> <span data-ttu-id="e18a8-300">Quando una query utilizza un parametro, Query Optimizer utilizza la stima della cardinalità per il primo valore di parametro effettivo passato alla stored procedure.</span><span class="sxs-lookup"><span data-stu-id="e18a8-300">When a query uses a parameter, the query optimizer uses the cardinality estimate for the first actual parameter value that is passed to the stored procedure.</span></span>  
  
-   <span data-ttu-id="e18a8-301">Utilizzare una tabella standard o una tabella temporanea per archiviare i risultati di funzioni con valori di tabella con più istruzioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-301">Consider using a standard table or temporary table to hold the results of multi-statement table-valued functions.</span></span> <span data-ttu-id="e18a8-302">Query Optimizer non crea statistiche per le funzioni con valori di tabella con più istruzioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-302">The query optimizer does not create statistics for multi-statement table-valued functions.</span></span> <span data-ttu-id="e18a8-303">In questo modo, Query Optimizer è in grado di creare statistiche per le colonne della tabella e utilizzarle per definire un piano di query più efficace.</span><span class="sxs-lookup"><span data-stu-id="e18a8-303">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span>  
  
-   <span data-ttu-id="e18a8-304">Utilizzare una tabella standard o una tabella temporanea in sostituzione delle variabili di tabella.</span><span class="sxs-lookup"><span data-stu-id="e18a8-304">Consider using a standard table or temporary table as a replacement for table variables.</span></span> <span data-ttu-id="e18a8-305">Query Optimizer non crea statistiche per le variabili di tabella.</span><span class="sxs-lookup"><span data-stu-id="e18a8-305">The query optimizer does not create statistics for table variables.</span></span> <span data-ttu-id="e18a8-306">In questo modo, Query Optimizer è in grado di creare statistiche per le colonne della tabella e utilizzarle per definire un piano di query più efficace.</span><span class="sxs-lookup"><span data-stu-id="e18a8-306">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span> <span data-ttu-id="e18a8-307">Diversi elementi determinano l'opportunità di utilizzare una tabella temporanea o una variabile di tabella. Le variabili di tabella utilizzate nelle stored procedure causano un numero di ricompilazioni delle stored procedure inferiore rispetto alle tabelle temporanee.</span><span class="sxs-lookup"><span data-stu-id="e18a8-307">There are tradeoffs in determining whether to use a temporary table or a table variable; Table variables used in stored procedures cause fewer recompilations of the stored procedure than temporary tables.</span></span> <span data-ttu-id="e18a8-308">In base all'applicazione in uso, è possibile che l'utilizzo di una tabella temporanea al posto di una variabile di tabella non comporti un miglioramento delle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-308">Depending on the application, using a temporary table instead of a table variable might not improve performance.</span></span>  
  
-   <span data-ttu-id="e18a8-309">Se una stored procedure contiene una query che utilizza un parametro passato, evitare di modificare il valore del parametro all'interno della stored procedure prima di utilizzarlo nella query.</span><span class="sxs-lookup"><span data-stu-id="e18a8-309">If a stored procedure contains a query that uses a passed-in parameter, avoid changing the parameter value within the stored procedure before using it in the query.</span></span> <span data-ttu-id="e18a8-310">Le stime della cardinalità per la query sono basate sul valore del parametro passato, non sul valore aggiornato.</span><span class="sxs-lookup"><span data-stu-id="e18a8-310">The cardinality estimates for the query are based on the passed-in parameter value and not the updated value.</span></span> <span data-ttu-id="e18a8-311">Per evitare di modificare il valore del parametro, è possibile riscrivere la query in modo da utilizzare due stored procedure.</span><span class="sxs-lookup"><span data-stu-id="e18a8-311">To avoid changing the parameter value, you can rewrite the query to use two stored procedures.</span></span>  
  
     <span data-ttu-id="e18a8-312">La seguente stored procedure `Sales.GetRecentSales` modifica ad esempio il valore del parametro `@date` se `@date is NULL`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-312">For example, the following stored procedure `Sales.GetRecentSales` changes the value of the parameter `@date` when `@date is NULL`.</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
     <span data-ttu-id="e18a8-313">Se la prima chiamata alla stored procedure `Sales.GetRecentSales` passa un valore NULL per il parametro `@date` , Query Optimizer compilerà la stored procedure con la stima della cardinalità per `@date = NULL` anche se il predicato di query non è chiamato con `@date = NULL`.</span><span class="sxs-lookup"><span data-stu-id="e18a8-313">If the first call to the stored procedure `Sales.GetRecentSales` passes a NULL for the `@date` parameter, the query optimizer will compile the stored procedure with the cardinality estimate for `@date = NULL` even though the query predicate is not called with `@date = NULL`.</span></span> <span data-ttu-id="e18a8-314">È possibile che tale stima della cardinalità differisca notevolmente rispetto al numero di righe nel risultato della query effettivo.</span><span class="sxs-lookup"><span data-stu-id="e18a8-314">This cardinality estimate might be significantly different than the number of rows in the actual query result.</span></span> <span data-ttu-id="e18a8-315">È pertanto possibile che in Query Optimizer venga scelto un piano di query non ottimale.</span><span class="sxs-lookup"><span data-stu-id="e18a8-315">As a result, the query optimizer might choose a suboptimal query plan.</span></span> <span data-ttu-id="e18a8-316">Per evitare che ciò accada, è possibile riscrivere la stored procedure utilizzando due procedure, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="e18a8-316">To help avoid this, you can rewrite the stored procedure into two procedures as follows:</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNullRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        EXEC Sales.GetNonNullRecentSales @date;  
    END  
    GO  
    IF OBJECT_ID ( 'Sales.GetNonNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNonNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNonNullRecentSales (@date datetime)  
    AS BEGIN  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
### <a name="improving-cardinality-estimates-with-query-hints"></a><span data-ttu-id="e18a8-317">Miglioramento delle stime della cardinalità con gli hint per la query</span><span class="sxs-lookup"><span data-stu-id="e18a8-317">Improving Cardinality Estimates with Query Hints</span></span>  
 <span data-ttu-id="e18a8-318">Per migliorare le stime della cardinalità per le variabili locali, è possibile utilizzare gli hint per la query OPTIMIZE FOR o OPTIMIZE FOR UNKNOWN con RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="e18a8-318">To improve cardinality estimates for local variables, you can use the OPTIMIZE FOR or OPTIMIZE FOR UNKNOWN query hints with RECOMPILE.</span></span> <span data-ttu-id="e18a8-319">Per altre informazioni, vedere [Hint per la query &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span><span class="sxs-lookup"><span data-stu-id="e18a8-319">For more information, see [Query Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span></span>  
  
 <span data-ttu-id="e18a8-320">In alcune applicazioni, la ricompilazione della query ogni volta che viene eseguita può richiedere tempi troppo lunghi.</span><span class="sxs-lookup"><span data-stu-id="e18a8-320">For some applications, recompiling the query each time it executes might take too much time.</span></span> <span data-ttu-id="e18a8-321">L'hint per la query OPTIMIZER FOR può risultare utile anche se non si utilizza l'opzione RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="e18a8-321">The OPTIMIZER FOR query hint can help even if you don't use the RECOMPILE option.</span></span> <span data-ttu-id="e18a8-322">È possibile ad esempio aggiungere un'opzione OPTIMIZER FOR alla stored procedure Sales.GetRecentSales per indicare una data specifica.</span><span class="sxs-lookup"><span data-stu-id="e18a8-322">For example, you could add an OPTIMIZER FOR option to the stored procedure Sales.GetRecentSales to specify a specific date.</span></span> <span data-ttu-id="e18a8-323">Nell'esempio seguente viene aggiunta l'opzione OPTIMIZE FOR alla procedura Sales.GetRecentSales.</span><span class="sxs-lookup"><span data-stu-id="e18a8-323">The following example adds the OPTIMIZE FOR option to the Sales.GetRecentSales procedure.</span></span>  
  
```sql
USE AdventureWorks2012;  
GO  
IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
    DROP PROCEDURE Sales.GetRecentSales;  
GO  
CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
AS BEGIN  
    IF @date is NULL  
        SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
    SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
    WHERE h.SalesOrderID = d.SalesOrderID  
    AND h.OrderDate > @date  
    OPTION ( OPTIMIZE FOR ( @date = '2004-05-01 00:00:00.000'))  
END;  
GO  
```  
  
### <a name="improving-cardinality-estimates-with-plan-guides"></a><span data-ttu-id="e18a8-324">Miglioramento delle stime della cardinalità con le guide di piano</span><span class="sxs-lookup"><span data-stu-id="e18a8-324">Improving Cardinality Estimates with Plan Guides</span></span>  
 <span data-ttu-id="e18a8-325">È possibile che le linee guida relative alla progettazione delle query non siano valide per alcune applicazioni, in quanto non è possibile modificare la query o l'utilizzo dell'hint per la query RECOMPILE potrebbe causare un numero eccessivo di ricompilazioni.</span><span class="sxs-lookup"><span data-stu-id="e18a8-325">For some applications, query design guidelines might not apply because you cannot change the query or using the RECOMPILE query hint might be cause too many recompiles.</span></span> <span data-ttu-id="e18a8-326">È possibile utilizzare le guide di piano per specificare altri hint, ad esempio USE PLAN, in modo da controllare il comportamento della query mentre si collabora con il fornitore dell'applicazione per esaminarne le modifiche.</span><span class="sxs-lookup"><span data-stu-id="e18a8-326">You can use plan guides to specify other hints, such as USE PLAN, to control the behavior of the query while investigating application changes with the application vendor.</span></span> <span data-ttu-id="e18a8-327">Per altre informazioni sulle guide di piano, vedere [Guide di piano](../performance/plan-guides.md).</span><span class="sxs-lookup"><span data-stu-id="e18a8-327">For more information about plan guides, see [Plan Guides](../performance/plan-guides.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e18a8-328">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="e18a8-328">See Also</span></span>  
 <span data-ttu-id="e18a8-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-333">[Opzioni ALTER DATABASE SET &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span><span class="sxs-lookup"><span data-stu-id="e18a8-333">[ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span></span>  
 <span data-ttu-id="e18a8-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span></span>  
 <span data-ttu-id="e18a8-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="e18a8-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span></span>  
 [<span data-ttu-id="e18a8-337">Creare indici filtrati</span><span class="sxs-lookup"><span data-stu-id="e18a8-337">Create Filtered Indexes</span></span>](../indexes/create-filtered-indexes.md)  
