---
title: Eseguire un ciclo su file e tabelle di Excel usando un contenitore Ciclo Foreach | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- connections [Integration Services], Excel
- Excel [Integration Services]
- connection managers [Integration Services], Excel
ms.assetid: a5393c1a-cc37-491a-a260-7aad84dbff68
author: chugugrace
ms.author: chugu
ms.openlocfilehash: 51de779b6869d80245302741035e6169aa750c83
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87627329"
---
# <a name="loop-through-excel-files-and-tables-by-using-a-foreach-loop-container"></a><span data-ttu-id="98dd8-102">Esecuzione di un ciclo su file e tabelle di Excel utilizzando un contenitore Ciclo Foreach</span><span class="sxs-lookup"><span data-stu-id="98dd8-102">Loop through Excel Files and Tables by Using a Foreach Loop Container</span></span>
  <span data-ttu-id="98dd8-103">In questo argomento vengono illustrate le procedure per l'esecuzione di un ciclo sulle cartelle di lavoro di Excel archiviate in una directory oppure sulle tabelle incluse in una cartella di Excel mediante il contenitore Ciclo Foreach con l'enumeratore appropriato.</span><span class="sxs-lookup"><span data-stu-id="98dd8-103">The procedures in this topic describe how to loop through the Excel workbooks in a folder, or through the tables in an Excel workbook, by using the Foreach Loop container with the appropriate enumerator.</span></span>  
  
### <a name="to-loop-through-excel-files-by-using-the-foreach-file-enumerator"></a><span data-ttu-id="98dd8-104">Per eseguire un ciclo su un gruppo di file di Excel mediante Foreach File Enumerator</span><span class="sxs-lookup"><span data-stu-id="98dd8-104">To loop through Excel files by using the Foreach File enumerator</span></span>  
  
1.  <span data-ttu-id="98dd8-105">Creare una variabile stringa che riceverà il percorso e il nome del file di Excel correnti a ogni iterazione del ciclo.</span><span class="sxs-lookup"><span data-stu-id="98dd8-105">Create a string variable that will receive the current Excel path and file name on each iteration of the loop.</span></span> <span data-ttu-id="98dd8-106">Per evitare problemi di convalida, assegnare un percorso e un nome file di Excel validi come valore iniziale della variabile.</span><span class="sxs-lookup"><span data-stu-id="98dd8-106">To avoid validation issues, assign a valid Excel path and file name as the initial value of the variable.</span></span> <span data-ttu-id="98dd8-107">Nell'espressione di esempio indicata di seguito in questa procedura viene utilizzata una variabile denominata `ExcelFile`.</span><span class="sxs-lookup"><span data-stu-id="98dd8-107">(The sample expression shown later in this procedure uses the variable name, `ExcelFile`.)</span></span>  
  
2.  <span data-ttu-id="98dd8-108">Facoltativamente, creare un'altra variabile stringa che conterrà il valore dell'argomento Proprietà estese della stringa di connessione a Excel.</span><span class="sxs-lookup"><span data-stu-id="98dd8-108">Optionally, create another string variable that will hold the value for the Extended Properties argument of the Excel connection string.</span></span> <span data-ttu-id="98dd8-109">Tale argomento contiene una serie di valori che specificano la versione di Excel e determinano se la prima riga contiene i nomi delle colonne, nonché se viene utilizzata la modalità di importazione.</span><span class="sxs-lookup"><span data-stu-id="98dd8-109">This argument contains a series of values that specify the Excel version and determine whether the first row contains column names, and whether import mode is used.</span></span> <span data-ttu-id="98dd8-110">Nell'espressione di esempio riportata di seguito in questa procedura viene utilizzata una variabile denominata `ExtProperties`, con un valore iniziale "`Excel 8.0;HDR=Yes`".</span><span class="sxs-lookup"><span data-stu-id="98dd8-110">(The sample expression shown later in this procedure uses the variable name `ExtProperties`, with an initial value of "`Excel 8.0;HDR=Yes`".)</span></span>  
  
     <span data-ttu-id="98dd8-111">Se non si utilizza una variabile per l'argomento Proprietà estese, è necessario aggiungerla manualmente all'espressione contenente la stringa di connessione.</span><span class="sxs-lookup"><span data-stu-id="98dd8-111">If you do not use a variable for the Extended Properties argument, then you must add it manually to the expression that contains the connection string.</span></span>  
  
3.  <span data-ttu-id="98dd8-112">Aggiungere un contenitore ciclo foreach alla scheda **flusso di controllo** . Per informazioni su come configurare il contenitore ciclo foreach, vedere [configurare un contenitore ciclo foreach](foreach-loop-container.md).</span><span class="sxs-lookup"><span data-stu-id="98dd8-112">Add a Foreach Loop container to the **Control Flow** tab. For information about how to configure the Foreach Loop Container, see [Configure a Foreach Loop Container](foreach-loop-container.md).</span></span>  
  
4.  <span data-ttu-id="98dd8-113">Nella pagina **Raccolta** dell' **Editor ciclo Foreach**selezionare l'enumeratore Foreach File, quindi specificare la directory in cui si trovano le cartelle di lavoro di Excel e il filtro file (in genere, con estensione \*.xls).</span><span class="sxs-lookup"><span data-stu-id="98dd8-113">On the **Collection** page of the **Foreach Loop Editor**, select the Foreach File enumerator, specify the folder in which the Excel workbooks are located, and specify the file filter (ordinarily \*.xls).</span></span>  
  
5.  <span data-ttu-id="98dd8-114">Nella pagina **Mapping variabili** eseguire il mapping dell'indice 0 a una variabile stringa definita dall'utente che riceverà il percorso e il nome del file di Excel corrente a ogni iterazione del ciclo.</span><span class="sxs-lookup"><span data-stu-id="98dd8-114">On the **Variable Mapping** page, map Index 0 to a user-defined string variable that will receive the current Excel path and file name on each iteration of the loop.</span></span> <span data-ttu-id="98dd8-115">Nell'espressione di esempio indicata di seguito in questa procedura viene utilizzata una variabile denominata `ExcelFile`.</span><span class="sxs-lookup"><span data-stu-id="98dd8-115">(The sample expression shown later in this procedure uses the variable name `ExcelFile`.)</span></span>  
  
6.  <span data-ttu-id="98dd8-116">Chiudere l' **Editor ciclo Foreach**.</span><span class="sxs-lookup"><span data-stu-id="98dd8-116">Close the **Foreach Loop Editor**.</span></span>  
  
7.  <span data-ttu-id="98dd8-117">Aggiungere una gestione connessione Excel in un pacchetto, come descritto in [Aggiungere, eliminare o condividere una gestione connessione in un pacchetto](../add-delete-or-share-a-connection-manager-in-a-package.md).</span><span class="sxs-lookup"><span data-stu-id="98dd8-117">Add an Excel connection manager to the package as described in [Add, Delete, or Share a Connection Manager in a Package](../add-delete-or-share-a-connection-manager-in-a-package.md).</span></span> <span data-ttu-id="98dd8-118">Selezionare un file di una cartella di lavoro di Excel esistente per la connessione, per evitare errori di convalida.</span><span class="sxs-lookup"><span data-stu-id="98dd8-118">Select an existing Excel workbook file for the connection to avoid validation errors.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="98dd8-119">Per evitare errori di convalida durante la configurazione delle attività e dei componenti dei flussi di dati che usano questa gestione connessione Excel, selezionare una cartella di lavoro di Excel esistente nella finestra di dialogo **Editor gestione connessione Excel**.</span><span class="sxs-lookup"><span data-stu-id="98dd8-119">To avoid validation errors as you configure tasks and data flow components that use this Excel connection manager, select an existing Excel workbook in the **Excel Connection Manager Editor**.</span></span> <span data-ttu-id="98dd8-120">Questa cartella di lavoro non verrà utilizzata dalla gestione connessione in fase di esecuzione dopo aver configurato un'espressione per la proprietà `ConnectionString`, come descritto nella procedura seguente.</span><span class="sxs-lookup"><span data-stu-id="98dd8-120">The connection manager will not use this workbook at run time after you configure an expression for the `ConnectionString` property as described in the following steps.</span></span> <span data-ttu-id="98dd8-121">Dopo aver creato e configurato il pacchetto, è possibile cancellare il valore della proprietà `ConnectionString` nella finestra Proprietà.</span><span class="sxs-lookup"><span data-stu-id="98dd8-121">After you create and configure the package, you can clear the value of the `ConnectionString` property in the Properties window.</span></span> <span data-ttu-id="98dd8-122">Se, tuttavia, si cancella questo valore, la proprietà relativa alla stringa di connessione della gestione connessione Excel non sarà più valida fino a quando non viene eseguito il ciclo Foreach.</span><span class="sxs-lookup"><span data-stu-id="98dd8-122">However, if you clear this value, the connection string property of the Excel connection manager is no longer valid until the Foreach Loop runs.</span></span> <span data-ttu-id="98dd8-123">Per evitare errori di convalida, è pertanto necessario impostare la proprietà `DelayValidation` su `True` nelle attività in cui viene utilizzata la gestione connessione o nel pacchetto.</span><span class="sxs-lookup"><span data-stu-id="98dd8-123">Therefore you must set the `DelayValidation` property to `True` on the tasks in which the connection manager is used, or on the package, to avoid validation errors.</span></span>  
    >   
    >  <span data-ttu-id="98dd8-124">È inoltre necessario utilizzare il valore predefinito `False` per la proprietà `RetainSameConnection` della gestione connessione Excel.</span><span class="sxs-lookup"><span data-stu-id="98dd8-124">You must also use the default value of `False` for the `RetainSameConnection` property of the Excel connection manager.</span></span> <span data-ttu-id="98dd8-125">Se si modifica questo valore in `True`, ogni iterazione del ciclo continuerà ad aprire la prima cartella di lavoro di Excel.</span><span class="sxs-lookup"><span data-stu-id="98dd8-125">If you change this value to `True`, each iteration of the loop will continue to open the first Excel workbook.</span></span>  
  
8.  <span data-ttu-id="98dd8-126">Selezionare la nuova gestione connessione Excel, fare clic sulla proprietà **Espressioni** nella finestra Proprietà e quindi fare clic sul pulsante con i puntini di sospensione (...).</span><span class="sxs-lookup"><span data-stu-id="98dd8-126">Select the new Excel connection manager, click the **Expressions** property in the Properties window, and then click the ellipsis.</span></span>  
  
9. <span data-ttu-id="98dd8-127">Nell' **Editor espressioni di proprietà**selezionare la `ConnectionString` proprietà, quindi fare clic sui puntini di sospensione.</span><span class="sxs-lookup"><span data-stu-id="98dd8-127">In the **Property Expressions Editor**, select the `ConnectionString` property, and then click the ellipsis.</span></span>  
  
10. <span data-ttu-id="98dd8-128">In Generatore di espressioni immettere l'espressione seguente:</span><span class="sxs-lookup"><span data-stu-id="98dd8-128">In the Expression Builder, enter the following expression:</span></span>  
  
    ```  
    "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" +  @[User::ExcelFile] + ";Extended Properties=\"" + @[User::ExtProperties] + "\""  
    ```  
  
     <span data-ttu-id="98dd8-129">Si noti l'uso del carattere di escape "\\" per le virgolette interne necessarie per racchiudere il valore dell'argomento Extended Properties.</span><span class="sxs-lookup"><span data-stu-id="98dd8-129">Note the use of the escape character "\\" to escape the inner quotation marks required around the value of the Extended Properties argument.</span></span>  
  
     <span data-ttu-id="98dd8-130">L'argomento Proprietà estese non è facoltativo.</span><span class="sxs-lookup"><span data-stu-id="98dd8-130">The Extended Properties argument is not optional.</span></span> <span data-ttu-id="98dd8-131">Se non si utilizza una variabile per contenere il relativo valore, è necessario aggiungerla manualmente all'espressione, come indicato nell'esempio seguente per un file di Excel 2003:</span><span class="sxs-lookup"><span data-stu-id="98dd8-131">If you do not use a variable to contain its value, then you must add it manually to the expression, as in the following example for an Excel 2003 file:</span></span>  
  
    ```  
    "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" +  @[User::ExcelFile] + ";Extended Properties=Excel 8.0"  
    ```  
  
11. <span data-ttu-id="98dd8-132">Creare attività nel contenitore Ciclo Foreach mediante le quali viene utilizzata la gestione connessione Excel per eseguire le stesse operazioni in ogni cartella di lavoro di Excel corrispondente allo schema e al percorso di file specificati.</span><span class="sxs-lookup"><span data-stu-id="98dd8-132">Create tasks in the Foreach Loop container that use the Excel connection manager to perform the same operations on each Excel workbook that matches the specified file location and pattern.</span></span>  
  
### <a name="to-loop-through-excel-tables-by-using-the-foreach-adonet-schema-rowset-enumerator"></a><span data-ttu-id="98dd8-133">Per eseguire un ciclo su un gruppo di tabelle mediante Foreach ADO.NET Schema Rowset Enumerator</span><span class="sxs-lookup"><span data-stu-id="98dd8-133">To loop through Excel tables by using the Foreach ADO.NET Schema Rowset enumerator</span></span>  
  
1.  <span data-ttu-id="98dd8-134">Creare una gestione connessione ADO.NET che utilizzi il provider OLE DB Microsoft Jet per connettersi a una cartella di lavoro di Excel.</span><span class="sxs-lookup"><span data-stu-id="98dd8-134">Create an ADO.NET connection manager that uses the Microsoft Jet OLE DB Provider to connect to an Excel workbook.</span></span> <span data-ttu-id="98dd8-135">Nella pagina Tutte della finestra di dialogo **Gestione connessione** assicurarsi di immettere Excel 8.0 come valore della proprietà Extended Properties.</span><span class="sxs-lookup"><span data-stu-id="98dd8-135">On the All page of the **Connection Manager** dialog box, make sure that you enter Excel 8.0 as the value of the Extended Properties property.</span></span> <span data-ttu-id="98dd8-136">Per altre informazioni, vedere [aggiungere, eliminare o condividere una gestione connessione in un pacchetto](../add-delete-or-share-a-connection-manager-in-a-package.md).</span><span class="sxs-lookup"><span data-stu-id="98dd8-136">For more information, see [Add, Delete, or Share a Connection Manager in a Package](../add-delete-or-share-a-connection-manager-in-a-package.md).</span></span>  
  
2.  <span data-ttu-id="98dd8-137">Creare una variabile stringa che riceverà il nome della tabella corrente a ogni iterazione del ciclo.</span><span class="sxs-lookup"><span data-stu-id="98dd8-137">Create a string variable that will receive the name of the current table on each iteration of the loop.</span></span>  
  
3.  <span data-ttu-id="98dd8-138">Aggiungere un contenitore ciclo foreach alla scheda **flusso di controllo** . Per informazioni su come configurare il contenitore ciclo foreach, vedere [configurare un contenitore ciclo foreach](foreach-loop-container.md).</span><span class="sxs-lookup"><span data-stu-id="98dd8-138">Add a Foreach Loop container to the **Control Flow** tab. For information about how to configure the Foreach Loop container, see [Configure a Foreach Loop Container](foreach-loop-container.md).</span></span>  
  
4.  <span data-ttu-id="98dd8-139">Nella pagina **Raccolta** dell' **Editor ciclo Foreach**selezionare Enumeratore Foreach ADO.NET set di righe dello schema.</span><span class="sxs-lookup"><span data-stu-id="98dd8-139">On the **Collection** page of the **Foreach Loop Editor**, select the Foreach ADO.NET Schema Rowset enumerator.</span></span>  
  
5.  <span data-ttu-id="98dd8-140">Selezionare la gestione connessione ADO.NET creata in precedenza come valore di **Connessione**.</span><span class="sxs-lookup"><span data-stu-id="98dd8-140">As the value of **Connection**, select the ADO.NET connection manager that you created previously.</span></span>  
  
6.  <span data-ttu-id="98dd8-141">Selezionare Tabelle come valore di **Schema**.</span><span class="sxs-lookup"><span data-stu-id="98dd8-141">As the value of **Schema**, select Tables.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="98dd8-142">Nell'elenco di tabelle di una cartella di Excel sono inclusi sia i fogli di lavoro (con suffisso $) sia gli intervalli denominati.</span><span class="sxs-lookup"><span data-stu-id="98dd8-142">The list of tables in an Excel workbook includes both worksheets (which have the $ suffix) and named ranges.</span></span> <span data-ttu-id="98dd8-143">Se è necessario applicare un filtro all'elenco per individuare solo fogli di lavoro o solo intervalli denominati, potrebbe essere necessario scrivere appositamente codice personalizzato in un'attività Script.</span><span class="sxs-lookup"><span data-stu-id="98dd8-143">If you have to filter the list for only worksheets or only named ranges, you may have to write custom code in a Script task for this purpose.</span></span> <span data-ttu-id="98dd8-144">Per altre informazioni, vedere [Uso di file di Excel con l'attività Script](script-task.md).</span><span class="sxs-lookup"><span data-stu-id="98dd8-144">For more information, see [Working with Excel Files with the Script Task](script-task.md).</span></span>  
  
7.  <span data-ttu-id="98dd8-145">Nella pagina **Mapping variabili** eseguire il mapping tra l'indice 2 e la variabile stringa creata in precedenza in modo che contenga il nome della tabella corrente.</span><span class="sxs-lookup"><span data-stu-id="98dd8-145">On the **Variable Mappings** page, map Index 2 to the string variable created earlier to hold the name of the current table.</span></span>  
  
8.  <span data-ttu-id="98dd8-146">Chiudere l' **Editor ciclo Foreach**.</span><span class="sxs-lookup"><span data-stu-id="98dd8-146">Close the **Foreach Loop Editor**.</span></span>  
  
9. <span data-ttu-id="98dd8-147">Creare attività nel contenitore Ciclo Foreach che utilizzano la gestione connessione Excel per eseguire le stesse operazioni in ogni tabella di Excel inclusa nella cartella di lavoro specificata.</span><span class="sxs-lookup"><span data-stu-id="98dd8-147">Create tasks in the Foreach Loop container that use the Excel connection manager to perform the same operations on each Excel table in the specified workbook.</span></span> <span data-ttu-id="98dd8-148">Se per esaminare il nome della tabella enumerata o per lavorare con ogni tabella si usa un'attività Script, ricordarsi di aggiungere la variabile stringa alla proprietà ReadOnlyVariables dell'attività Script.</span><span class="sxs-lookup"><span data-stu-id="98dd8-148">If you use a Script Task to examine the enumerated table name or to work with each table, remember to add the string variable to the ReadOnlyVariables property of the Script task.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="98dd8-149">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="98dd8-149">See Also</span></span>  
 <span data-ttu-id="98dd8-150">[Importare dati da Excel o esportare dati in Excel con SQL Server Integration Services (SSIS)](../load-data-to-from-excel-with-ssis.md) [configurare un contenitore ciclo foreach](foreach-loop-container.md) </span><span class="sxs-lookup"><span data-stu-id="98dd8-150">[Import data from Excel or export data to Excel with SQL Server Integration Services (SSIS)](../load-data-to-from-excel-with-ssis.md) [Configure a Foreach Loop Container](foreach-loop-container.md) </span></span>  
 <span data-ttu-id="98dd8-151">[Aggiungere o modificare un'espressione di proprietà](../expressions/add-or-change-a-property-expression.md) </span><span class="sxs-lookup"><span data-stu-id="98dd8-151">[Add or Change a Property Expression](../expressions/add-or-change-a-property-expression.md) </span></span>  
 <span data-ttu-id="98dd8-152">[Gestione connessione Excel](../connection-manager/excel-connection-manager.md) </span><span class="sxs-lookup"><span data-stu-id="98dd8-152">[Excel Connection Manager](../connection-manager/excel-connection-manager.md) </span></span>  
 <span data-ttu-id="98dd8-153">[Origine Excel](../data-flow/excel-source.md) </span><span class="sxs-lookup"><span data-stu-id="98dd8-153">[Excel Source](../data-flow/excel-source.md) </span></span>  
 <span data-ttu-id="98dd8-154">[Destinazione Excel](../data-flow/excel-destination.md) </span><span class="sxs-lookup"><span data-stu-id="98dd8-154">[Excel Destination](../data-flow/excel-destination.md) </span></span>  
 [<span data-ttu-id="98dd8-155">Utilizzo di file di Excel con l'attività Script</span><span class="sxs-lookup"><span data-stu-id="98dd8-155">Working with Excel Files with the Script Task</span></span>](script-task.md)  
  
  
