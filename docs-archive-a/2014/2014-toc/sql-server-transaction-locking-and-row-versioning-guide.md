---
title: Guida per il controllo delle versioni delle righe e il blocco della transazione di SQL Server | Microsoft Docs
ms.custom: ''
ms.date: 01/24/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
ms.assetid: c7757153-9697-4f01-881c-800e254918c9
author: rothja
ms.author: jroth
ms.openlocfilehash: c79f9997249568c88409394441d28c71da453d63
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87625108"
---
# <a name="sql-server-transaction-locking-and-row-versioning-guide"></a><span data-ttu-id="ca04c-102">Guida per il controllo delle versioni delle righe e il blocco della transazione di SQL Server</span><span class="sxs-lookup"><span data-stu-id="ca04c-102">SQL Server Transaction Locking and Row Versioning Guide</span></span>

  <span data-ttu-id="ca04c-103">Nei sistemi con numerosi utenti, la gestione delle transazioni nei database spesso comporta problemi di prestazioni e contesa delle risorse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-103">In any database, mismanagement of transactions often leads to contention and performance problems in systems that have many users.</span></span> <span data-ttu-id="ca04c-104">Con l'aumento progressivo del numero di utenti che accedono ai dati, diventa importante disporre di applicazioni che utilizzino le transazioni in modo efficiente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-104">As the number of users that access the data increases, it becomes important to have applications that use transactions efficiently.</span></span> <span data-ttu-id="ca04c-105">In questa guida vengono descritti i meccanismi di blocco e controllo delle versioni delle righe utilizzati dal [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] per assicurare l'integrità fisica di ogni transazione e fornire informazioni su come le applicazioni possono controllare le transazioni con efficienza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-105">This guide describes the locking and row versioning mechanisms the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses to ensure the physical integrity of each transaction and provides information on how applications can control transactions efficiently.</span></span>  
  
<span data-ttu-id="ca04c-106">**Si applica a**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] tramite, [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] se non specificato diversamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-106">**Applies to**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] through [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] unless noted otherwise.</span></span>  
  
##  <a name="in-this-guide"></a><a name="Top"></a><span data-ttu-id="ca04c-107">Contenuto della Guida</span><span class="sxs-lookup"><span data-stu-id="ca04c-107">In This Guide</span></span>  

 [<span data-ttu-id="ca04c-108">Nozioni fondamentali sulle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-108">Transaction Basics</span></span>](#Basics)  
  
 [<span data-ttu-id="ca04c-109">Nozioni fondamentali sul blocco e sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-109">Locking and Row Versioning Basics</span></span>](#Lock_Basics)  
  
 [<span data-ttu-id="ca04c-110">Blocco nel motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-110">Locking in the Database Engine</span></span>](#Lock_Engine)  
  
 [<span data-ttu-id="ca04c-111">Livelli di isolamento basati sul controllo delle versioni delle righe nel Motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-111">Row Versioning-based Isolation Levels in the Database Engine</span></span>](#Row_versioning)  
  
 [<span data-ttu-id="ca04c-112">Personalizzazione del blocco per un indice</span><span class="sxs-lookup"><span data-stu-id="ca04c-112">Customizing Locking for an Index</span></span>](#Customize)  
  
 [<span data-ttu-id="ca04c-113">Informazioni sulle transazioni avanzate</span><span class="sxs-lookup"><span data-stu-id="ca04c-113">Advanced Transaction Information</span></span>](#Advanced)  
  
##  <a name="transaction-basics"></a><a name="Basics"></a> <span data-ttu-id="ca04c-114">Nozioni fondamentali sulle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-114">Transaction Basics</span></span>  

 <span data-ttu-id="ca04c-115">Una transazione è una sequenza di operazioni eseguite in un'unica unità logica di lavoro.</span><span class="sxs-lookup"><span data-stu-id="ca04c-115">A transaction is a sequence of operations performed as a single logical unit of work.</span></span> <span data-ttu-id="ca04c-116">Per essere considerata una transazione, un'unità logica di lavoro deve includere quattro proprietà, dette ACID (atomicità, consistenza, isolamento e durata):</span><span class="sxs-lookup"><span data-stu-id="ca04c-116">A logical unit of work must exhibit four properties, called the atomicity, consistency, isolation, and durability (ACID) properties, to qualify as a transaction.</span></span>  
  
 <span data-ttu-id="ca04c-117">Atomicità</span><span class="sxs-lookup"><span data-stu-id="ca04c-117">Atomicity</span></span>  
 <span data-ttu-id="ca04c-118">Una transazione deve essere un'unità di lavoro atomica, ovvero devono essere eseguite tutte le modifiche dei dati oppure non ne deve essere eseguita nessuna.</span><span class="sxs-lookup"><span data-stu-id="ca04c-118">A transaction must be an atomic unit of work; either all of its data modifications are performed, or none of them are performed.</span></span>  
  
 <span data-ttu-id="ca04c-119">Consistenza</span><span class="sxs-lookup"><span data-stu-id="ca04c-119">Consistency</span></span>  
 <span data-ttu-id="ca04c-120">Al termine della transazione i dati devono essere consistenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-120">When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="ca04c-121">Per salvaguardare l'integrità dei dati in un database relazionale, è necessario che alle modifiche eseguite dalla transazione vengano applicate tutte le regole.</span><span class="sxs-lookup"><span data-stu-id="ca04c-121">In a relational database, all rules must be applied to the transaction's modifications to maintain all data integrity.</span></span> <span data-ttu-id="ca04c-122">Al termine della transazione tutte le strutture di dati interne, ad esempio gli indici ad albero B o gli elenchi collegati doppiamente, devono risultare corrette.</span><span class="sxs-lookup"><span data-stu-id="ca04c-122">All internal data structures, such as B-tree indexes or doubly-linked lists, must be correct at the end of the transaction.</span></span>  
  
 <span data-ttu-id="ca04c-123">Isolamento</span><span class="sxs-lookup"><span data-stu-id="ca04c-123">Isolation</span></span>  
 <span data-ttu-id="ca04c-124">Le modifiche eseguite da transazioni simultanee devono essere isolate dalle modifiche eseguite da qualsiasi altra transazione simultanea.</span><span class="sxs-lookup"><span data-stu-id="ca04c-124">Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="ca04c-125">Una transazione riconosce lo stato dei dati precedente alla modifica eseguita da una transazione simultanea oppure lo stato successivo al completamento della seconda transazione, ma non è in grado di riconoscere stati intermedi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-125">A transaction either recognizes data in the state it was in before another concurrent transaction modified it, or it recognizes the data after the second transaction has completed, but it does not recognize an intermediate state.</span></span> <span data-ttu-id="ca04c-126">Questa proprietà viene detta serializzabilità in quanto consente di ricaricare i dati iniziali e di eseguire nuovamente una serie di transazioni in modo da ripristinare lo stato dei dati successivo all'esecuzione delle transazioni originali.</span><span class="sxs-lookup"><span data-stu-id="ca04c-126">This is referred to as serializability because it results in the ability to reload the starting data and replay a series of transactions to end up with the data in the same state it was in after the original transactions were performed.</span></span>  
  
 <span data-ttu-id="ca04c-127">Durabilità</span><span class="sxs-lookup"><span data-stu-id="ca04c-127">Durability</span></span>  
 <span data-ttu-id="ca04c-128">Gli effetti di una transazione completamente durevole completata sono permanenti all'interno del sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-128">After a fully durable transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="ca04c-129">Le modifiche eseguite rimangono valide anche in caso di errore del sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-129">The modifications persist even in the event of a system failure.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="ca04c-130">e versioni successive consente transazioni durevoli ritardate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-130">and later enable delayed durable transactions.</span></span> <span data-ttu-id="ca04c-131">Le transazioni durevoli ritardate vengono sottoposte a commit prima che il record del log delle transazioni diventi permanente su disco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-131">Delayed durable transactions commit before the transaction log record is persisted to disk.</span></span> <span data-ttu-id="ca04c-132">Per altre informazioni sulla durabilità delle transazioni ritardate, vedere [Controllo della durabilità delle transazioni](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-132">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="ca04c-133">I programmatori SQL devono avviare e terminare le transazioni in modo da garantire la consistenza logica dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-133">SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.</span></span> <span data-ttu-id="ca04c-134">In particolare, il programmatore deve definire la sequenza delle modifiche dei dati in modo che lo stato dei dati risulti consistente rispetto alle regole business dell'organizzazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-134">The programmer must define the sequence of data modifications that leave the data in a consistent state relative to the organization's business rules.</span></span> <span data-ttu-id="ca04c-135">Le istruzioni di modifica devono quindi essere incluse in un'unica transazione in modo da poter applicare l'integrità fisica della transazione stessa in [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-135">The programmer includes these modification statements in a single transaction so that the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can enforce the physical integrity of the transaction.</span></span>  
  
 <span data-ttu-id="ca04c-136">Un sistema di database aziendale, quale un'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)], deve implementare i meccanismi necessari per garantire l'integrità fisica di ogni transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-136">It is the responsibility of an enterprise database system, such as an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], to provide mechanisms ensuring the physical integrity of each transaction.</span></span> <span data-ttu-id="ca04c-137">[!INCLUDE[ssDE](../includes/ssde-md.md)] include:</span><span class="sxs-lookup"><span data-stu-id="ca04c-137">The [!INCLUDE[ssDE](../includes/ssde-md.md)] provides:</span></span>  
  
-   <span data-ttu-id="ca04c-138">Meccanismi di blocco che salvaguardano l'isolamento delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-138">Locking facilities that preserve transaction isolation.</span></span>  
  
-   <span data-ttu-id="ca04c-139">Meccanismi di registrazione che garantiscono la durabilità delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-139">Logging facilities ensure transaction durability.</span></span> <span data-ttu-id="ca04c-140">Per le transazioni completamente durevoli, il record del log viene finalizzato su disco prima del commit delle transazioni stesse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-140">For fully durable transactions the log record is hardened to disk before the transactions commits.</span></span> <span data-ttu-id="ca04c-141">Pertanto, anche in caso di errore dell'hardware del server, del sistema operativo o della stessa istanza del [!INCLUDE[ssDE](../includes/ssde-md.md)], l'istanza usa i log delle transazioni al riavvio per eseguire automaticamente il rollback delle eventuali transazioni non completate fino al punto in cui si è verificato l'errore di sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-141">Thus, even if the server hardware, operating system, or the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] itself fails, the instance uses the transaction logs upon restart to automatically roll back any uncompleted transactions to the point of the system failure.</span></span> <span data-ttu-id="ca04c-142">Le transazioni durevoli ritardate vengono sottoposte a commit prima che il record del log delle transazioni venga finalizzato su disco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-142">Delayed durable transactions commit before the transaction log record is hardened to disk.</span></span> <span data-ttu-id="ca04c-143">Tali transazioni potrebbero andare perdute se si verifica un errore di sistema prima della finalizzazione del record del log su disco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-143">Such transactions may be lost if there is a system failure before the log record is hardened to disk.</span></span> <span data-ttu-id="ca04c-144">Per altre informazioni sulla durabilità delle transazioni ritardate, vedere [Controllo della durabilità delle transazioni](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-144">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
-   <span data-ttu-id="ca04c-145">Caratteristiche di gestione delle transazioni che ne garantiscono l'atomicità e la consistenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-145">Transaction management features that enforce transaction atomicity and consistency.</span></span> <span data-ttu-id="ca04c-146">Una transazione avviata deve essere completata (sottoposta a commit). In caso contrario tutte le modifiche apportate ai dati dall'inizio della transazione verranno annullate dal [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-146">After a transaction has started, it must be successfully completed (committed), or the [!INCLUDE[ssDE](../includes/ssde-md.md)] undoes all of the data modifications made since the transaction started.</span></span> <span data-ttu-id="ca04c-147">Questa operazione viene definita come rollback di una transazione perché ripristina lo stato dei dati precedente alle modifiche.</span><span class="sxs-lookup"><span data-stu-id="ca04c-147">This operation is referred to as rolling back a transaction because it returns the data to the state it was prior to those changes.</span></span>  
  
### <a name="controlling-transactions"></a><span data-ttu-id="ca04c-148">Controllo delle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-148">Controlling Transactions</span></span>  

 <span data-ttu-id="ca04c-149">Nelle applicazioni le transazioni vengono controllate principalmente specificandone l'inizio e la fine.</span><span class="sxs-lookup"><span data-stu-id="ca04c-149">Applications control transactions mainly by specifying when a transaction starts and ends.</span></span> <span data-ttu-id="ca04c-150">Per specificare tali informazioni, è possibile utilizzare le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] o le funzioni API (Application Programming Interface).</span><span class="sxs-lookup"><span data-stu-id="ca04c-150">This can be specified by using either [!INCLUDE[tsql](../includes/tsql-md.md)] statements or database application programming interface (API) functions.</span></span> <span data-ttu-id="ca04c-151">Il sistema deve essere in grado di gestire correttamente gli errori che comportano l'interruzione di una transazione prima che questa venga completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-151">The system must also be able to correctly handle errors that terminate a transaction before it completes.</span></span> <span data-ttu-id="ca04c-152">Per ulteriori informazioni, vedere [Istruzioni Transaction &#40;&#41;Transact-SQL ](/sql/t-sql/language-elements/transactions-transact-sql), [transazioni in ODBC](https://technet.microsoft.com/library/ms131281.aspx) e [transazioni in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span><span class="sxs-lookup"><span data-stu-id="ca04c-152">For more information, see [Transaction Statements &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [Transactions in ODBC](https://technet.microsoft.com/library/ms131281.aspx) and [Transactions in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span></span>  
  
 <span data-ttu-id="ca04c-153">Per impostazione predefinita, le transazioni vengono gestite a livello della connessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-153">By default, transactions are managed at the connection level.</span></span> <span data-ttu-id="ca04c-154">Quando viene avviata una transazione su una connessione, tutte le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] eseguite su tale connessione fanno parte della transazione fino a quando questa non viene completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-154">When a transaction is started on a connection, all [!INCLUDE[tsql](../includes/tsql-md.md)] statements executed on that connection are part of the transaction until the transaction ends.</span></span> <span data-ttu-id="ca04c-155">Tuttavia, nell'ambito di una sessione MARS (Multiple Active Result Set) una transazione [!INCLUDE[tsql](../includes/tsql-md.md)] esplicita o implicita diventa una transazione con ambito batch gestita a livello di batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-155">However, under a multiple active result set (MARS) session, a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction becomes a batch-scoped transaction that is managed at the batch level.</span></span> <span data-ttu-id="ca04c-156">Una volta completato il batch, se per la transazione con ambito batch non viene eseguito il commit o il rollback, il rollback viene eseguito automaticamente da [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-156">When the batch completes, if the batch-scoped transaction is not committed or rolled back, it is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="ca04c-157">Per ulteriori informazioni, vedere [Mars (Multiple Active Result Sets) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="ca04c-157">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
#### <a name="starting-transactions"></a><span data-ttu-id="ca04c-158">Avvio di transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-158">Starting Transactions</span></span>  

 <span data-ttu-id="ca04c-159">Utilizzando le funzioni API e le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] è possibile avviare transazioni in un'istanza di [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] come transazioni esplicite, con autocommit o implicite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-159">Using API functions and [!INCLUDE[tsql](../includes/tsql-md.md)] statements, you can start transactions in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] as explicit, autocommit, or implicit transactions.</span></span>  
  
 <span data-ttu-id="ca04c-160">**Transazioni esplicite**</span><span class="sxs-lookup"><span data-stu-id="ca04c-160">**Explicit Transactions**</span></span>  
 <span data-ttu-id="ca04c-161">Per transazione esplicita si intende una transazione di cui vengono definiti in modo esplicito l'inizio e la fine della transazione tramite una funzione dell'API o l'emissione delle istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION o ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-161">An explicit transaction is one in which you explicitly define both the start and end of the transaction through an API function or by issuing the [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION, or ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)] statements.</span></span> <span data-ttu-id="ca04c-162">Al termine della transazione, viene ripristinata la modalità precedente all'avvio della transazione esplicita, ovvero la modalità transazione implicita o autocommit.</span><span class="sxs-lookup"><span data-stu-id="ca04c-162">When the transaction ends, the connection returns to the transaction mode it was in before the explicit transaction was started, either implicit or autocommit mode.</span></span>  
  
 <span data-ttu-id="ca04c-163">In una transazione esplicita è possibile utilizzare tutte le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)], ad eccezione delle seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-163">You can use all [!INCLUDE[tsql](../includes/tsql-md.md)] statements in an explicit transaction, except for the following statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="ca04c-164">ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="ca04c-164">ALTER DATABASE</span></span>|<span data-ttu-id="ca04c-165">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="ca04c-165">CREATE DATABASE</span></span>|<span data-ttu-id="ca04c-166">DROP FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="ca04c-166">DROP FULLTEXT INDEX</span></span>|  
|<span data-ttu-id="ca04c-167">ALTER FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="ca04c-167">ALTER FULLTEXT CATALOG</span></span>|<span data-ttu-id="ca04c-168">CREATE FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="ca04c-168">CREATE FULLTEXT CATALOG</span></span>|<span data-ttu-id="ca04c-169">RECONFIGURE</span><span class="sxs-lookup"><span data-stu-id="ca04c-169">RECONFIGURE</span></span>|  
|<span data-ttu-id="ca04c-170">ALTER FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="ca04c-170">ALTER FULLTEXT INDEX</span></span>|<span data-ttu-id="ca04c-171">CREATE FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="ca04c-171">CREATE FULLTEXT INDEX</span></span>|<span data-ttu-id="ca04c-172">RESTORE</span><span class="sxs-lookup"><span data-stu-id="ca04c-172">RESTORE</span></span>|  
|<span data-ttu-id="ca04c-173">BACKUP</span><span class="sxs-lookup"><span data-stu-id="ca04c-173">BACKUP</span></span>|<span data-ttu-id="ca04c-174">DROP DATABASE</span><span class="sxs-lookup"><span data-stu-id="ca04c-174">DROP DATABASE</span></span>|<span data-ttu-id="ca04c-175">Stored procedure di sistema full-text</span><span class="sxs-lookup"><span data-stu-id="ca04c-175">Full-text system stored procedures</span></span>|  
|<span data-ttu-id="ca04c-176">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="ca04c-176">CREATE DATABASE</span></span>|<span data-ttu-id="ca04c-177">DROP FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="ca04c-177">DROP FULLTEXT CATALOG</span></span>|<span data-ttu-id="ca04c-178">sp_dboption per l'impostazione delle opzioni di database o delle procedure di sistema che modificano il database master all'interno di transazioni implicite o esplicite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-178">sp_dboption to set database options or any system procedure that modifies the master database inside explicit or implicit transactions.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-179">UPDATE STATISTICS può essere utilizzato all'interno di una transazione esplicita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-179">UPDATE STATISTICS can be used inside an explicit transaction.</span></span> <span data-ttu-id="ca04c-180">Tuttavia, UPDATE STATISTICS esegue il commit indipendentemente dalla transazione che la contiene e non è possibile eseguire il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-180">However, UPDATE STATISTICS commits independently of the enclosing transaction and cannot be rolled back.</span></span>  
  
 <span data-ttu-id="ca04c-181">**Transazioni con autocommit**</span><span class="sxs-lookup"><span data-stu-id="ca04c-181">**Autocommit Transactions**</span></span>  
 <span data-ttu-id="ca04c-182">La modalità autocommit è la modalità predefinita per la gestione delle transazioni nel motore di database di SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ca04c-182">Autocommit mode is the default transaction management mode of the SQL Server Database Engine.</span></span> <span data-ttu-id="ca04c-183">Viene eseguito il commit o il rollback di ogni istruzione Transact-SQL completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-183">Every Transact-SQL statement is committed or rolled back when it completes.</span></span> <span data-ttu-id="ca04c-184">Se un'istruzione viene completata correttamente, ne viene eseguito il commit. Se invece si verifica un errore, viene eseguito il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-184">If a statement completes successfully, it is committed; if it encounters any error, it is rolled back.</span></span> <span data-ttu-id="ca04c-185">In una connessione a un'istanza del motore di database è sempre attivata la modalità predefinita autocommit, a meno che tale modalità non sia stata annullata da transazioni implicite o esplicite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-185">A connection to an instance of the Database Engine operates in autocommit mode whenever this default mode has not been overridden by either explicit or implicit transactions.</span></span> <span data-ttu-id="ca04c-186">La modalità autocommit è l'impostazione predefinita anche in ADO, OLE DB, ODBC e DB-Library.</span><span class="sxs-lookup"><span data-stu-id="ca04c-186">Autocommit mode is also the default mode for ADO, OLE DB, ODBC, and DB-Library.</span></span>  
  
 <span data-ttu-id="ca04c-187">**Transazioni implicite**</span><span class="sxs-lookup"><span data-stu-id="ca04c-187">**Implicit Transactions**</span></span>  
 <span data-ttu-id="ca04c-188">Se per una connessione è attivata la modalità di esecuzione implicita delle transazioni, dopo che è stato eseguito il commit o il rollback della transazione corrente, nell'istanza del motore di database viene avviata automaticamente una nuova transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-188">When a connection is operating in implicit transaction mode, the instance of the Database Engine automatically starts a new transaction after the current transaction is committed or rolled back.</span></span> <span data-ttu-id="ca04c-189">Non è necessario specificare l'inizio di una transazione. È sufficiente eseguirne il commit o il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-189">You do nothing to delineate the start of a transaction; you only commit or roll back each transaction.</span></span> <span data-ttu-id="ca04c-190">La modalità di esecuzione implicita delle transazioni genera il concatenamento delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-190">Implicit transaction mode generates a continuous chain of transactions.</span></span> <span data-ttu-id="ca04c-191">La modalità di esecuzione implicita delle transazioni viene impostata tramite una funzione API o l'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-191">Set implicit transaction mode on through either an API function or the [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON statement.</span></span>  
  
 <span data-ttu-id="ca04c-192">Se viene impostata la modalità di esecuzione implicita delle transazioni per una connessione, l'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] avvia automaticamente una transazione dopo l'esecuzione di una delle istruzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-192">After implicit transaction mode has been set on for a connection, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically starts a transaction when it first executes any of these statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="ca04c-193">MODIFICA TABELLA</span><span class="sxs-lookup"><span data-stu-id="ca04c-193">ALTER TABLE</span></span>|<span data-ttu-id="ca04c-194">FETCH</span><span class="sxs-lookup"><span data-stu-id="ca04c-194">FETCH</span></span>|<span data-ttu-id="ca04c-195">REVOKE</span><span class="sxs-lookup"><span data-stu-id="ca04c-195">REVOKE</span></span>|  
|<span data-ttu-id="ca04c-196">CREATE</span><span class="sxs-lookup"><span data-stu-id="ca04c-196">CREATE</span></span>|<span data-ttu-id="ca04c-197">GRANT</span><span class="sxs-lookup"><span data-stu-id="ca04c-197">GRANT</span></span>|<span data-ttu-id="ca04c-198">SELECT</span><span class="sxs-lookup"><span data-stu-id="ca04c-198">SELECT</span></span>|  
|<span data-ttu-id="ca04c-199">DELETE</span><span class="sxs-lookup"><span data-stu-id="ca04c-199">DELETE</span></span>|<span data-ttu-id="ca04c-200">INSERT</span><span class="sxs-lookup"><span data-stu-id="ca04c-200">INSERT</span></span>|<span data-ttu-id="ca04c-201">TRUNCATE TABLE</span><span class="sxs-lookup"><span data-stu-id="ca04c-201">TRUNCATE TABLE</span></span>|  
|<span data-ttu-id="ca04c-202">DROP</span><span class="sxs-lookup"><span data-stu-id="ca04c-202">DROP</span></span>|<span data-ttu-id="ca04c-203">OPEN</span><span class="sxs-lookup"><span data-stu-id="ca04c-203">OPEN</span></span>|<span data-ttu-id="ca04c-204">UPDATE</span><span class="sxs-lookup"><span data-stu-id="ca04c-204">UPDATE</span></span>|  
  
 <span data-ttu-id="ca04c-205">**Transazioni con ambito batch**</span><span class="sxs-lookup"><span data-stu-id="ca04c-205">**Batch-scoped Transactions**</span></span>  
 <span data-ttu-id="ca04c-206">Applicabile solo a MARS (Multiple Active Result Set). Una transazione definita a livello di ambito di batch è una transazione [!INCLUDE[tsql](../includes/tsql-md.md)] esplicita o implicita che inizia in una sessione MARS.</span><span class="sxs-lookup"><span data-stu-id="ca04c-206">Applicable only to multiple active result sets (MARS), a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction that starts under a MARS session becomes a batch-scoped transaction.</span></span> <span data-ttu-id="ca04c-207">Se per una transazione definita a livello di ambito di batch non è stato eseguito il commit o il rollback quando il batch è completato, il rollback viene eseguito automaticamente da [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-207">A batch-scoped transaction that is not committed or rolled back when a batch completes is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="ca04c-208">**Transazioni distribuite**</span><span class="sxs-lookup"><span data-stu-id="ca04c-208">**Distributed Transactions**</span></span>  
 <span data-ttu-id="ca04c-209">Le transazioni distribuite sono estese a due o più server noti come strumenti di gestione delle risorse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-209">Distributed transactions span two or more servers known as resource managers.</span></span> <span data-ttu-id="ca04c-210">La gestione della transazione deve essere coordinata tra i vari strumenti di gestione delle risorse tramite un componente server denominato gestore delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-210">The management of the transaction must be coordinated between the resource managers by a server component called a transaction manager.</span></span> <span data-ttu-id="ca04c-211">Ogni istanza del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] può fungere come strumento di gestione delle risorse per le transazioni distribuite coordinate da gestori delle transazioni quali [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC) o altri gestori che supportano la specifica Open Group XA per l'elaborazione di transazioni distribuite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-211">Each instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can operate as a resource manager in distributed transactions coordinated by transaction managers, such as [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC), or other transaction managers that support the Open Group XA specification for distributed transaction processing.</span></span> <span data-ttu-id="ca04c-212">Per ulteriori informazioni, vedere la documentazione di MS DTC.</span><span class="sxs-lookup"><span data-stu-id="ca04c-212">For more information, see the MS DTC documentation.</span></span>  
  
 <span data-ttu-id="ca04c-213">Una transazione eseguita in una singola istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] ed estesa a due o più database è in effetti una transazione distribuita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-213">A transaction within a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] that spans two or more databases is actually a distributed transaction.</span></span> <span data-ttu-id="ca04c-214">Nell'istanza le transazioni distribuite vengono gestite internamente e appaiono all'utente come transazioni locali.</span><span class="sxs-lookup"><span data-stu-id="ca04c-214">The instance manages the distributed transaction internally; to the user, it operates as a local transaction.</span></span>  
  
 <span data-ttu-id="ca04c-215">A livello dell'applicazione le transazioni distribuite vengono gestite in modo simile alle transazioni locali.</span><span class="sxs-lookup"><span data-stu-id="ca04c-215">At the application, a distributed transaction is managed much the same as a local transaction.</span></span> <span data-ttu-id="ca04c-216">Al termine della transazione l'applicazione ne richiede il commit o il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-216">At the end of the transaction, the application requests the transaction to be either committed or rolled back.</span></span> <span data-ttu-id="ca04c-217">Il commit di transazioni distribuite deve essere gestito dal gestore delle transazioni in modo diverso per evitare che, in seguito a un errore della rete, alcuni strumenti di gestione delle risorse eseguano il commit correttamente mentre altri eseguano il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-217">A distributed commit must be managed differently by the transaction manager to minimize the risk that a network failure may result in some resource managers successfully committing while others roll back the transaction.</span></span> <span data-ttu-id="ca04c-218">A tale scopo il processo di commit viene gestito in due fasi, ovvero una fase preparatoria e la fase di commit effettivo. Questo tipo di commit è noto come commit in due fasi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-218">This is achieved by managing the commit process in two phases (the prepare phase and the commit phase), which is known as a two-phase commit (2PC).</span></span>  
  
 <span data-ttu-id="ca04c-219">Fase preparatoria</span><span class="sxs-lookup"><span data-stu-id="ca04c-219">Prepare phase</span></span>  
 <span data-ttu-id="ca04c-220">Quando il gestore delle transazioni riceve una richiesta di commit, invia un comando di preparazione a tutti gli strumenti di gestione delle risorse coinvolti nella transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-220">When the transaction manager receives a commit request, it sends a prepare command to all of the resource managers involved in the transaction.</span></span> <span data-ttu-id="ca04c-221">Ogni strumento esegue quindi tutte le operazioni necessarie per rendere la transazione durevole. Tutti i buffer contenenti immagini del log relative alla transazione vengono inoltre trasferiti su disco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-221">Each resource manager then does everything required to make the transaction durable, and all buffers holding log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="ca04c-222">Dopo avere completato la fase preparatoria, lo strumento di gestione delle risorse comunica al gestore delle transazioni l'esito, positivo o negativo, della preparazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-222">As each resource manager completes the prepare phase, it returns success or failure of the prepare to the transaction manager.</span></span> <span data-ttu-id="ca04c-223">Con [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] è stata introdotta la durabilità delle transazioni ritardate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-223">[!INCLUDE[ssSQL14](../includes/sssql14-md.md)] introduced delayed transaction durability.</span></span> <span data-ttu-id="ca04c-224">Le transazioni durevoli ritardate vengono sottoposte a commit prima che le immagini di log della transazione vengano scaricate su disco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-224">Delayed durable transactions commit before log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="ca04c-225">Per altre informazioni sulla durabilità delle transazioni ritardate, vedere [Controllo della durabilità delle transazioni](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-225">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="ca04c-226">Fase di commit</span><span class="sxs-lookup"><span data-stu-id="ca04c-226">Commit phase</span></span>  
 <span data-ttu-id="ca04c-227">Se la fase preparatoria ha esito positivo in tutti gli strumenti di gestione delle risorse, il gestore delle transazioni invia comandi di commit agli strumenti di gestione,</span><span class="sxs-lookup"><span data-stu-id="ca04c-227">If the transaction manager receives successful prepares from all of the resource managers, it sends commit commands to each resource manager.</span></span> <span data-ttu-id="ca04c-228">i quali possono quindi completare il commit.</span><span class="sxs-lookup"><span data-stu-id="ca04c-228">The resource managers can then complete the commit.</span></span> <span data-ttu-id="ca04c-229">Se il commit viene eseguito correttamente da parte di tutti gli strumenti di gestione delle risorse, il gestore delle transazioni invia all'applicazione una notifica di operazione riuscita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-229">If all of the resource managers report a successful commit, the transaction manager then sends a success notification to the application.</span></span> <span data-ttu-id="ca04c-230">Se viene segnalato un tentativo di preparazione non riuscito in uno strumento di gestione delle risorse, il gestore delle transazioni invia un comando di rollback a tutti gli strumenti di gestione e segnala all'applicazione che il commit ha avuto esito negativo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-230">If any resource manager reported a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="ca04c-231">Le applicazioni [!INCLUDE[ssDE](../includes/ssde-md.md)] possono gestire le transazioni distribuite attraverso [!INCLUDE[tsql](../includes/tsql-md.md)] o le API di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-231">[!INCLUDE[ssDE](../includes/ssde-md.md)] applications can manage distributed transactions either through [!INCLUDE[tsql](../includes/tsql-md.md)] or the database API.</span></span> <span data-ttu-id="ca04c-232">Per altre informazioni, vedere [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-232">For more information, see [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span></span>  
  
#### <a name="ending-transactions"></a><span data-ttu-id="ca04c-233">Interruzione di transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-233">Ending Transactions</span></span>  

 <span data-ttu-id="ca04c-234">Per interrompere una transazione, è possibile utilizzare l'istruzione COMMIT o ROLLBACK oppure una funzione API corrispondente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-234">You can end transactions with either a COMMIT or ROLLBACK statement, or through a corresponding API function.</span></span>  
  
 <span data-ttu-id="ca04c-235">COMMIT</span><span class="sxs-lookup"><span data-stu-id="ca04c-235">COMMIT</span></span>  
 <span data-ttu-id="ca04c-236">Se una transazione viene completata correttamente, è necessario eseguirne il commit.</span><span class="sxs-lookup"><span data-stu-id="ca04c-236">If a transaction is successful, commit it.</span></span> <span data-ttu-id="ca04c-237">L'istruzione COMMIT consente di integrare in modo permanente nel database tutte le modifiche apportate dalla transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-237">A COMMIT statement guarantees all of the transaction's modifications are made a permanent part of the database.</span></span> <span data-ttu-id="ca04c-238">L'istruzione consente inoltre di liberare le risorse, ad esempio i blocchi, utilizzate dalla transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-238">A COMMIT also frees resources, such as locks, used by the transaction.</span></span>  
  
 <span data-ttu-id="ca04c-239">ROLLBACK</span><span class="sxs-lookup"><span data-stu-id="ca04c-239">ROLLBACK</span></span>  
 <span data-ttu-id="ca04c-240">Se in una transazione si verifica un errore oppure l'utente decide di annullare la transazione, è necessario eseguirne il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-240">If an error occurs in a transaction, or if the user decides to cancel the transaction, then roll the transaction back.</span></span> <span data-ttu-id="ca04c-241">L'istruzione ROLLBACK consente di annullare tutte le modifiche apportate ai dati ripristinandone lo stato corrente all'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-241">A ROLLBACK statement backs out all modifications made in the transaction by returning the data to the state it was in at the start of the transaction.</span></span> <span data-ttu-id="ca04c-242">L'istruzione consente inoltre di liberare le risorse utilizzate dalla transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-242">A ROLLBACK also frees resources held by the transaction.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-243">Nelle connessioni abilitate per supportare più MARS, non è possibile eseguire il commit di una transazione avviata tramite una funzione API mentre vi sono richieste di esecuzione in sospeso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-243">Under connections enabled to support multiple active result sets (MARS), an explicit transaction started through an API function cannot be committed while there are pending requests for execution.</span></span> <span data-ttu-id="ca04c-244">Qualsiasi tentativo di eseguire il commit di questo tipo di transazione durante l'esecuzione di operazioni in sospeso restituisce un errore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-244">Any attempt to commit this type of  transaction while there are outstanding operations running will result in an error.</span></span>  
  
#### <a name="errors-during-transaction-processing"></a><span data-ttu-id="ca04c-245">Errori durante l'elaborazione delle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-245">Errors During Transaction Processing</span></span>  

 <span data-ttu-id="ca04c-246">Se una transazione non viene eseguita correttamente a causa di un errore grave, in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] ne viene eseguito automaticamente il rollback e tutte le risorse utilizzate dalla transazione vengono liberate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-246">If an error prevents the successful completion of a transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] automatically rolls back the transaction and frees all resources held by the transaction.</span></span> <span data-ttu-id="ca04c-247">Se viene interrotta la connessione di rete tra il client e [!INCLUDE[ssDE](../includes/ssde-md.md)], quando la rete notifica l'istanza dell'interruzione viene eseguito il rollback delle transazioni in sospeso per tale connessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-247">If the client's network connection to an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] is broken, any outstanding transactions for the connection are rolled back when the network notifies the instance of the break.</span></span> <span data-ttu-id="ca04c-248">La connessione viene interrotta anche se si verifica un errore nell'applicazione client oppure se il computer client viene spento o riavviato. Anche in questi casi, dopo la notifica dell'interruzione, nell'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] viene eseguito il rollback delle transazioni in sospeso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-248">If the client application fails or if the client computer goes down or is restarted, this also breaks the connection, and the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] rolls back any outstanding connections when the network notifies it of the break.</span></span> <span data-ttu-id="ca04c-249">Questa operazione viene eseguita anche se l'applicazione client viene disconnessa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-249">If the client logs off the application, any outstanding transactions are rolled back.</span></span>  
  
 <span data-ttu-id="ca04c-250">Se in un batch si verifica un errore di runtime in un'istruzione, ad esempio la violazione di un vincolo, per impostazione predefinita in [!INCLUDE[ssDE](../includes/ssde-md.md)] viene eseguito solo il rollback dell'istruzione che ha generato l'errore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-250">If a run-time statement error (such as a constraint violation) occurs in a batch, the default behavior in the [!INCLUDE[ssDE](../includes/ssde-md.md)] is to roll back only the statement that generated the error.</span></span> <span data-ttu-id="ca04c-251">Per modificare questa impostazione, è possibile utilizzare l'istruzione SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-251">You can change this behavior using the SET XACT_ABORT statement.</span></span> <span data-ttu-id="ca04c-252">In seguito all'esecuzione di questa istruzione, qualsiasi errore di runtime di un'istruzione comporta il rollback automatico della transazione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-252">After SET XACT_ABORT ON is executed, any run-time statement error causes an automatic rollback of the current transaction.</span></span> <span data-ttu-id="ca04c-253">L'opzione SET XACT_ABORT non ha alcun effetto sugli errori di compilazione, quali gli errori di sintassi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-253">Compile errors, such as syntax errors, are not affected by SET XACT_ABORT.</span></span> <span data-ttu-id="ca04c-254">Per altre informazioni, vedere [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-254">For more information, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-255">Quando si verificano errori, è necessario includere un intervento di correzione (COMMIT o ROLLBACK) nel codice dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-255">When errors occur, corrective action (COMMIT or ROLLBACK) should be included in application code.</span></span> <span data-ttu-id="ca04c-256">Uno strumento efficace per la gestione degli errori, inclusi quelli nelle transazioni, è il [!INCLUDE[tsql](../includes/tsql-md.md)] try... Costrutto CATCH.</span><span class="sxs-lookup"><span data-stu-id="ca04c-256">One effective tool for handling errors, including those in transactions, is the [!INCLUDE[tsql](../includes/tsql-md.md)] TRY...CATCH construct.</span></span> <span data-ttu-id="ca04c-257">Per altre informazioni ed esempi che includono le transazioni, vedere [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-257">For more information with examples that include transactions, see [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span></span> <span data-ttu-id="ca04c-258">A partire da [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] , è possibile utilizzare l'istruzione throw per generare un'eccezione e trasferire l'esecuzione a un blocco catch di un try... Costrutto CATCH.</span><span class="sxs-lookup"><span data-stu-id="ca04c-258">Beginning with [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], you can use the THROW statement to raise an exception and transfers execution to a CATCH block of a TRY...CATCH construct.</span></span> <span data-ttu-id="ca04c-259">Per altre informazioni, vedere [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-259">For more information, see [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span></span>  
  
##### <a name="compile-and-run-time-errors-in-autocommit-mode"></a><span data-ttu-id="ca04c-260">Errori di compilazione e di run-time in modalità autocommit</span><span class="sxs-lookup"><span data-stu-id="ca04c-260">Compile and Run-time Errors in Autocommit mode</span></span>  

 <span data-ttu-id="ca04c-261">In modalità autocommit, a volte potrebbe sembrare che in un'istanza del [!INCLUDE[ssDE](../includes/ssde-md.md)] venga eseguito il rollback di un intero batch anziché di una sola istruzione SQL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-261">In autocommit mode, it sometimes appears as if an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] has rolled back an entire batch instead of just one SQL statement.</span></span> <span data-ttu-id="ca04c-262">Ciò si verifica solo in caso di errori di compilazione, non di errori di run-time.</span><span class="sxs-lookup"><span data-stu-id="ca04c-262">This happens if the error encountered is a compile error, not a run-time error.</span></span> <span data-ttu-id="ca04c-263">Un errore di compilazione impedisce infatti a [!INCLUDE[ssDE](../includes/ssde-md.md)] di compilare un piano di esecuzione e non viene pertanto eseguita alcuna parte del batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-263">A compile error prevents the [!INCLUDE[ssDE](../includes/ssde-md.md)] from building an execution plan, so nothing in the batch is executed.</span></span> <span data-ttu-id="ca04c-264">Anche se può sembrare che sia stato eseguito il rollback di tutte le istruzioni precedenti a quella che ha generato l'errore, in realtà l'errore impedisce l'esecuzione di qualsiasi elemento del batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-264">Although it appears that all of the statements before the one generating the error were rolled back, the error prevented anything in the batch from being executed.</span></span> <span data-ttu-id="ca04c-265">Nell'esempio seguente, a causa di un errore di compilazione non vengono eseguite le istruzioni `INSERT` del terzo batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-265">In the following example, none of the `INSERT` statements in the third batch are executed because of a compile error.</span></span> <span data-ttu-id="ca04c-266">In apparenza viene eseguito il rollback delle prime due istruzioni `INSERT`, mentre in realtà tali istruzioni non vengono eseguite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-266">It appears that the first two `INSERT` statements are rolled back when they are never executed.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUSE (3, 'ccc');  -- Syntax error.  
GO  
SELECT * FROM TestBatch;  -- Returns no rows.  
GO  
```  
  
 <span data-ttu-id="ca04c-267">Nell'esempio seguente, la terza istruzione `INSERT` genera un errore di run-time di chiave primaria duplicata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-267">In the following example, the third `INSERT` statement generates a run-time duplicate primary key error.</span></span> <span data-ttu-id="ca04c-268">Poiché le prime due istruzioni `INSERT` hanno avuto esito positivo e ne è stato pertanto eseguito il commit, tali istruzioni rimangono valide anche dopo l'errore di run-time.</span><span class="sxs-lookup"><span data-stu-id="ca04c-268">The first two `INSERT` statements are successful and committed, so they remain after the run-time error.</span></span>  
  
```sql  
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUES (1, 'ccc');  -- Duplicate key error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="ca04c-269">In [!INCLUDE[ssDE](../includes/ssde-md.md)] viene utilizzata la risoluzione dei nomi posticipata, in base alla quale i nomi degli oggetti vengono risolti solo in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-269">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses deferred name resolution, in which object names are not resolved until execution time.</span></span> <span data-ttu-id="ca04c-270">Nell'esempio seguente vengono eseguite le prime due istruzioni `INSERT` e ne viene quindi eseguito il commit. Le due righe inserite rimangono nella tabella `TestBatch` anche dopo l'errore di run-time generato dalla terza istruzione `INSERT` a causa di un riferimento a una tabella non esistente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-270">In the following example, the first two `INSERT` statements are executed and committed, and those two rows remain in the `TestBatch` table after the third `INSERT` statement generates a run-time error by referring to a table that does not exist.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBch VALUES (3, 'ccc');  -- Table name error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="ca04c-271">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-271">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-and-row-versioning-basics"></a><a name="Lock_Basics"></a> <span data-ttu-id="ca04c-272">Nozioni fondamentali sui blocchi e sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-272">Locking and Row Versioning Basics</span></span>  

 <span data-ttu-id="ca04c-273">Per garantire l'integrità delle transazioni e mantenere la consistenza dei database se più utenti accedono simultaneamente ai dati, nel [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] vengono utilizzati i meccanismi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-273">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses the following mechanisms to ensure the integrity of transactions and maintain the consistency of databases when multiple users are accessing data at the same time:</span></span>  
  
-   <span data-ttu-id="ca04c-274">Blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-274">Locking</span></span>  
  
     <span data-ttu-id="ca04c-275">Ogni transazione richiede blocchi di diversi tipi sulle risorse, ad esempio sulle righe, le pagine o le tabelle dalle quali è dipendente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-275">Each transaction requests locks of different types on the resources, such as rows, pages, or tables, on which the transaction is dependent.</span></span> <span data-ttu-id="ca04c-276">I blocchi impediscono alle altre transazioni di modificare le risorse in modo tale da creare problemi alla transazione che richiede il blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-276">The locks block other transactions from modifying the resources in a way that would cause problems for the transaction requesting the lock.</span></span> <span data-ttu-id="ca04c-277">Ogni transazione libera i relativi blocchi quando non è più dipendente dalle risorse bloccate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-277">Each transaction frees its locks when it no longer has a dependency on the locked resources.</span></span>  
  
-   <span data-ttu-id="ca04c-278">Controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-278">Row versioning</span></span>  
  
     <span data-ttu-id="ca04c-279">Se viene attivato un livello di isolamento basato sul controllo delle versioni delle righe, [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene le versioni di ogni riga modificata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-279">When a row versioning-based isolation level is enabled, the [!INCLUDE[ssDE](../includes/ssde-md.md)] maintains versions of each row that is modified.</span></span> <span data-ttu-id="ca04c-280">Anziché proteggere tutte le operazioni di lettura con blocchi, nelle applicazioni è possibile specificare che una transazione utilizza le versioni di riga per visualizzare la versione dei dati esistente all'inizio della transazione o della query.</span><span class="sxs-lookup"><span data-stu-id="ca04c-280">Applications can specify that a transaction use the row versions to view data as it existed at the start of the transaction or query instead of protecting all reads with locks.</span></span> <span data-ttu-id="ca04c-281">Se si utilizza il controllo delle versioni delle righe, le possibilità che un'operazione di lettura possa bloccare altre transazioni vengono ridotte al minimo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-281">By using row versioning, the chance that a read operation will block other transactions is greatly reduced.</span></span>  
  
 <span data-ttu-id="ca04c-282">L'utilizzo di blocchi e il controllo delle versioni delle righe impediscono agli utenti di leggere dati di cui non è stato eseguito il commit e di modificare simultaneamente gli stessi dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-282">Locking and row versioning prevent users from reading uncommitted data and prevent multiple users from attempting to change the same data at the same time.</span></span> <span data-ttu-id="ca04c-283">Se non si utilizzano queste funzionalità, è possibile che le query eseguite sui dati generino risultati imprevisti, restituendo dati di cui non è ancora stato eseguito il commit nel database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-283">Without locking or row versioning, queries executed against that data could produce unexpected results by returning data that has not yet been committed in the database.</span></span>  
  
 <span data-ttu-id="ca04c-284">Nelle applicazioni è possibile scegliere il livello di isolamento delle transazioni, ovvero il livello di protezione delle transazioni dalle modifiche eseguite da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-284">Applications can choose transaction isolation levels, which define the level of protection for the transaction from modifications made by other transactions.</span></span> <span data-ttu-id="ca04c-285">Per personalizzare ulteriormente il funzionamento in base ai requisiti specifici di un'applicazione, è possibile specificare hint a livello di tabella per le singole istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-285">Table-level hints can be specified for individual [!INCLUDE[tsql](../includes/tsql-md.md)] statements to further tailor behavior to fit the requirements of the application.</span></span>  
  
### <a name="managing-concurrent-data-access"></a><span data-ttu-id="ca04c-286">Gestione dell'accesso ai dati simultaneo</span><span class="sxs-lookup"><span data-stu-id="ca04c-286">Managing Concurrent Data Access</span></span>  

 <span data-ttu-id="ca04c-287">Quando più utenti accedono a una risorsa contemporaneamente si parla di accesso simultaneo alla risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-287">Users who access a resource at the same time are said to be accessing the resource concurrently.</span></span> <span data-ttu-id="ca04c-288">L'accesso ai dati simultaneo richiede meccanismi per evitare gli effetti negativi derivanti dal tentativo, da parte di più utenti, di tentare di modificare le risorse che altri utenti stanno utilizzando in modo attivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-288">Concurrent data access requires mechanisms to prevent adverse effects when multiple users try to modify resources that other users are actively using.</span></span>  
  
#### <a name="concurrency-effects"></a><span data-ttu-id="ca04c-289">Effetti della concorrenza</span><span class="sxs-lookup"><span data-stu-id="ca04c-289">Concurrency Effects</span></span>  

 <span data-ttu-id="ca04c-290">Le operazioni di modifica dei dati eseguite da un utente possono influire sulle operazioni di lettura o modifica degli stessi dati eseguite contemporaneamente da altri utenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-290">Users modifying data can affect other users who are reading or modifying the same data at the same time.</span></span> <span data-ttu-id="ca04c-291">Tale fenomeno è denominato accesso simultaneo ai dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-291">These users are said to be accessing the data concurrently.</span></span> <span data-ttu-id="ca04c-292">Se il sistema di archiviazione dati non dispone di controllo della concorrenza, gli utenti potrebbero riscontrare gli effetti collaterali seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-292">If a data storage system has no concurrency control, users could see the following side effects:</span></span>  
  
-   <span data-ttu-id="ca04c-293">Perdita di aggiornamenti</span><span class="sxs-lookup"><span data-stu-id="ca04c-293">Lost updates</span></span>  
  
     <span data-ttu-id="ca04c-294">Il problema della perdita degli aggiornamenti si verifica quando due o più transazioni selezionano la stessa riga, la quale viene quindi aggiornata in base al valore selezionato inizialmente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-294">Lost updates occur when two or more transactions select the same row and then update the row based on the value originally selected.</span></span> <span data-ttu-id="ca04c-295">Ogni transazione non è, infatti, a conoscenza dell'esecuzione delle altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-295">Each transaction is unaware of the other transactions.</span></span> <span data-ttu-id="ca04c-296">L'ultimo aggiornamento pertanto sovrascrive quelli eseguiti in precedenza dalle altre transazioni, con conseguente perdita di dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-296">The last update overwrites updates made by the other transactions, which results in lost data.</span></span>  
  
     <span data-ttu-id="ca04c-297">Si supponga, ad esempio, che due revisori creino una copia in formato elettronico del medesimo documento</span><span class="sxs-lookup"><span data-stu-id="ca04c-297">For example, two editors make an electronic copy of the same document.</span></span> <span data-ttu-id="ca04c-298">e successivamente modifichino e salvino la propria copia del documento. Con questa operazione la copia originale del documento viene sovrascritta e</span><span class="sxs-lookup"><span data-stu-id="ca04c-298">Each editor changes the copy independently and then saves the changed copy thereby overwriting the original document.</span></span> <span data-ttu-id="ca04c-299">l'ultimo revisore che esegue il salvataggio sovrascrive la copia modificata dall'altro revisore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-299">The editor who saves the changed copy last overwrites the changes made by the other editor.</span></span> <span data-ttu-id="ca04c-300">Questo problema potrebbe essere evitato impedendo a un revisore di accedere al file finché l'altro non abbia completato l'operazione ed eseguito il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-300">This problem could be avoided if one editor could not access the file until the other editor had finished and committed the transaction.</span></span>  
  
-   <span data-ttu-id="ca04c-301">Dipendenza di cui non è stato eseguito il commit (lettura dirty).</span><span class="sxs-lookup"><span data-stu-id="ca04c-301">Uncommitted dependency (dirty read)</span></span>  
  
     <span data-ttu-id="ca04c-302">La dipendenza uncommitted si verifica quando una transazione seleziona una riga mentre questa viene aggiornata da un'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-302">Uncommitted dependency occurs when a second transaction selects a row that is being updated by another transaction.</span></span> <span data-ttu-id="ca04c-303">La seconda transazione legge i dati di cui non è ancora stato eseguito il commit, i quali potrebbero venire modificati dalla transazione che sta eseguendo l'aggiornamento della riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-303">The second transaction is reading data that has not been committed yet and may be changed by the transaction updating the row.</span></span>  
  
     <span data-ttu-id="ca04c-304">Si supponga, ad esempio, che un revisore stia modificando un documento in formato elettronico</span><span class="sxs-lookup"><span data-stu-id="ca04c-304">For example, an editor is making changes to an electronic document.</span></span> <span data-ttu-id="ca04c-305">e che un secondo revisore apra una copia del documento contenente tutte le modifiche apportate fino a quel momento e lo distribuisca ai destinatari del documento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-305">During the changes, a second editor takes a copy of the document that includes all the changes made so far, and distributes the document to the intended audience.</span></span> <span data-ttu-id="ca04c-306">Si supponga inoltre che il primo revisore decida di eliminare le modifiche apportate e quindi salvi il documento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-306">The first editor then decides the changes made so far are wrong and removes the edits and saves the document.</span></span> <span data-ttu-id="ca04c-307">In questo caso, il documento distribuito contiene modifiche non più esistenti e quindi da considerare come non più valide.</span><span class="sxs-lookup"><span data-stu-id="ca04c-307">The distributed document contains edits that no longer exist and should be treated as if they never existed.</span></span> <span data-ttu-id="ca04c-308">Questo problema potrebbe essere evitato impedendo a tutti gli utenti di leggere il documento modificato fino a quando il primo revisore non salva definitivamente le modifiche ed esegue il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-308">This problem could be avoided if no one could read the changed document until the first editor does the final save of modifications and commits the transaction.</span></span>  
  
-   <span data-ttu-id="ca04c-309">Analisi inconsistente (lettura non ripetibile)</span><span class="sxs-lookup"><span data-stu-id="ca04c-309">Inconsistent analysis (nonrepeatable read)</span></span>  
  
     <span data-ttu-id="ca04c-310">L'analisi inconsistente si verifica quando una transazione accede più volte alla stessa riga e legge ogni volta dati diversi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-310">Inconsistent analysis occurs when a second transaction accesses the same row several times and reads different data each time.</span></span> <span data-ttu-id="ca04c-311">Questo problema è molto simile alla dipendenza uncommitted, in quanto una transazione modifica i dati che una seconda transazione sta leggendo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-311">Inconsistent analysis is similar to uncommitted dependency in that another transaction is changing the data that a second transaction is reading.</span></span> <span data-ttu-id="ca04c-312">Nel caso dell'analisi inconsistente, tuttavia, la transazione di modifica ha già eseguito il commit dei dati letti dalla transazione di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-312">However, in inconsistent analysis, the data read by the second transaction was committed by the transaction that made the change.</span></span> <span data-ttu-id="ca04c-313">Con l'analisi inconsistente vengono, inoltre, eseguite due o più operazioni di lettura della stessa riga e a ogni lettura le informazioni vengono modificate da un'altra transazione. Da ciò deriva il termine lettura non ripetibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-313">Also, inconsistent analysis involves multiple reads (two or more) of the same row, and each time the information is changed by another transaction; thus, the term nonrepeatable read.</span></span>  
  
     <span data-ttu-id="ca04c-314">Si supponga, ad esempio, che un revisore legga lo stesso documento due volte e che nell'intervallo tra la prima e la seconda lettura l'autore del documento apporti alcune modifiche.</span><span class="sxs-lookup"><span data-stu-id="ca04c-314">For example, an editor reads the same document twice, but between each reading the writer rewrites the document.</span></span> <span data-ttu-id="ca04c-315">Quando il revisore legge il documento la seconda volta, il testo risulta diverso,</span><span class="sxs-lookup"><span data-stu-id="ca04c-315">When the editor reads the document for the second time, it has changed.</span></span> <span data-ttu-id="ca04c-316">ovvero la lettura originale non è ripetibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-316">The original read was not repeatable.</span></span> <span data-ttu-id="ca04c-317">Questo problema potrebbe essere evitato impedendo all'autore di modificare il documento fino a quando il revisore non ha completato l'ultima lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-317">This problem could be avoided if the writer could not change the document until the editor has finished reading it for the last time.</span></span>  
  
-   <span data-ttu-id="ca04c-318">Lettura di righe fantasma</span><span class="sxs-lookup"><span data-stu-id="ca04c-318">Phantom reads</span></span>  
  
     <span data-ttu-id="ca04c-319">Una lettura fantasma è una situazione che si verifica quando vengono eseguite due query identiche e la raccolta di righe restituite dalla seconda query è diversa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-319">A phantom read is a situation that occurs when two identical queries are executed and the collection of rows returned by the second query is different.</span></span> <span data-ttu-id="ca04c-320">Nell'esempio seguente viene illustrato come può verificarsi questa condizione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-320">The example below shows how this may occur.</span></span> <span data-ttu-id="ca04c-321">Si supponga che le due transazioni seguenti vengano eseguite contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-321">Assume the two transactions below are executing at the same time.</span></span> <span data-ttu-id="ca04c-322">Le due istruzioni SELECT nella prima transazione possono restituire risultati diversi perché l'istruzione INSERT nella seconda transazione modifica i dati utilizzati da entrambe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-322">The two SELECT statements in the first transaction may return different results because the INSERT statement in the second transaction changes the data used by both.</span></span>  
  
    ```sql  
    --Transaction 1  
    BEGIN TRAN;  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    --The INSERT statement from the second transaction occurs here.  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    COMMIT;  
    ```  
  
    ```sql  
    --Transaction 2  
    BEGIN TRAN;  
    INSERT INTO dbo.employee  
       SET name = 'New' WHERE ID = 5;  
    COMMIT;   
    ```  
  
-   <span data-ttu-id="ca04c-323">Letture di righe mancanti e doppie provocate dagli aggiornamenti della riga</span><span class="sxs-lookup"><span data-stu-id="ca04c-323">Missing and double reads caused by row updates</span></span>  
  
    -   <span data-ttu-id="ca04c-324">Riga aggiornata mancante o più visualizzazioni di una riga aggiornata</span><span class="sxs-lookup"><span data-stu-id="ca04c-324">Missing a updated row or seeing an updated row multiple times</span></span>  
  
         <span data-ttu-id="ca04c-325">Le transazioni eseguite al livello READ UNCOMMITTED non acquisiscono blocchi condivisi per evitare che altre transazioni possano modificare i dati letti dalla transazione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-325">Transactions that are running at the READ UNCOMMITTED level do not issue shared locks to prevent other transactions from modifying data read by the current transaction.</span></span> <span data-ttu-id="ca04c-326">Le transazioni in esecuzione al livello READ COMMITTED generano blocchi condivisi, ma i blocchi di riga o pagina vengono rilasciati dopo la lettura della riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-326">Transactions that are running at the READ COMMITTED level do issue shared locks, but the row or page locks are released after the row is read.</span></span> <span data-ttu-id="ca04c-327">In entrambi i casi, quando si esegue l'analisi di un indice, se un altro utente modifica la colonna della chiave di indice della riga durante la lettura, è possibile che la riga venga visualizzata nuovamente se la modifica principale sposta la riga di una posizione in avanti nell'analisi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-327">In either case, when you are scanning an index, if another user changes the index key column of the row during your read, the row might appear again if the key change moved the row to a position ahead of your scan.</span></span> <span data-ttu-id="ca04c-328">Analogamente, la riga potrebbe non essere visualizzata se la modifica principale sposta la riga in una posizione già letta all'interno dell'indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-328">Similarly, the row might not appear if the key change moved the row to a position in the index that you had already read.</span></span> <span data-ttu-id="ca04c-329">Per evitare questo, utilizzare l'hint SERIALIZABLE o HOLDLOCK o il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-329">To avoid this, use the SERIALIZABLE or HOLDLOCK hint, or row versioning.</span></span> <span data-ttu-id="ca04c-330">Per altre informazioni, vedere [Hint di tabella &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="ca04c-330">For more information, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
    -   <span data-ttu-id="ca04c-331">Mancare una o più righe che non rappresentano l'obiettivo dell'aggiornamento</span><span class="sxs-lookup"><span data-stu-id="ca04c-331">Missing one or more rows that were not the target of update</span></span>  
  
         <span data-ttu-id="ca04c-332">Quando si utilizza READ UNCOMMITTED, se la query legge righe usando un'analisi di ordine di allocazione (utilizzando le pagine di IAM), è possibile perdere righe se un'altra transazione provoca la suddivisione di una pagina.</span><span class="sxs-lookup"><span data-stu-id="ca04c-332">When you are using READ UNCOMMITTED, if your query reads rows using an allocation order scan (using IAM pages), you might miss rows if another transaction is causing a page split.</span></span> <span data-ttu-id="ca04c-333">Questo non può verificarsi con Read committed perché durante la suddivisione di una pagina viene usato un blocco di tabella che non si verifica se la tabella non ha un indice cluster, poiché gli aggiornamenti non provocano suddivisioni di pagine.</span><span class="sxs-lookup"><span data-stu-id="ca04c-333">This cannot occur when you are using read committed because a table lock is held during a page split and does not happen if the table does not have a clustered index, because updates do not cause page splits.</span></span>  
  
#### <a name="types-of-concurrency"></a><span data-ttu-id="ca04c-334">Tipi di concorrenza</span><span class="sxs-lookup"><span data-stu-id="ca04c-334">Types of Concurrency</span></span>  

 <span data-ttu-id="ca04c-335">Se molti utenti cercano di modificare contemporaneamente i dati di un database, è necessario implementare un sistema di controlli che impedisca che le modifiche apportate da un utente danneggino il lavoro di altri utenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-335">When many people attempt to modify data in a database at the same time, a system of controls must be implemented so that modifications made by one person do not adversely affect those of another person.</span></span> <span data-ttu-id="ca04c-336">Questa funzionalità è denominata controllo della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-336">This is called concurrency control.</span></span>  
  
 <span data-ttu-id="ca04c-337">I metodi per l'applicazione del controllo della concorrenza rientrano in due diverse categorie:</span><span class="sxs-lookup"><span data-stu-id="ca04c-337">Concurrency control theory has two classifications for the methods of instituting concurrency control:</span></span>  
  
-   <span data-ttu-id="ca04c-338">Controllo della concorrenza pessimistica</span><span class="sxs-lookup"><span data-stu-id="ca04c-338">Pessimistic concurrency control</span></span>  
  
     <span data-ttu-id="ca04c-339">Un sistema di blocchi impedisce agli utenti di modificare i dati con effetto su altri utenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-339">A system of locks prevents users from modifying data in a way that affects other users.</span></span> <span data-ttu-id="ca04c-340">Dopo che un utente ha eseguito un'operazione che causa l'applicazione di un blocco, gli altri utenti non sono in grado di eseguire operazioni in conflitto con il blocco finché questo non viene rilasciato dal proprietario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-340">After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it.</span></span> <span data-ttu-id="ca04c-341">Viene utilizzato l'aggettivo pessimistica in quanto questo tipo di controllo si utilizza principalmente in ambienti con elevata contesa dei dati, in cui il costo della protezione dei dati tramite i blocchi è inferiore al costo rappresentato dal rollback delle transazioni in caso di conflitti di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-341">This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.</span></span>  
  
-   <span data-ttu-id="ca04c-342">Controllo della concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="ca04c-342">Optimistic concurrency control</span></span>  
  
     <span data-ttu-id="ca04c-343">Quando si utilizza il controllo della concorrenza ottimistica, la lettura dei dati da parte degli utenti non comporta il blocco dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-343">In optimistic concurrency control, users do not lock data when they read it.</span></span> <span data-ttu-id="ca04c-344">Quando un utente esegue l'aggiornamento dei dati, il sistema verifica se i dati sono stati modificati da un altro utente dopo la lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-344">When a user updates data, the system checks to see if another user changed the data after it was read.</span></span> <span data-ttu-id="ca04c-345">In questo caso, si verifica un errore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-345">If another user updated the data, an error is raised.</span></span> <span data-ttu-id="ca04c-346">In genere, l'utente per cui viene visualizzato l'errore esegue il rollback della transazione e ricomincia dall'inizio.</span><span class="sxs-lookup"><span data-stu-id="ca04c-346">Typically, the user receiving the error rolls back the transaction and starts over.</span></span> <span data-ttu-id="ca04c-347">Viene utilizzato l'aggettivo ottimistica in quanto questo tipo di controllo si utilizza principalmente in ambienti con ridotta contesa dei dati, in cui il costo dell'esecuzione occasionale del rollback di una transazione è minore rispetto al costo del blocco dei dati durante la lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-347">This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.</span></span>  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="ca04c-348">supporta un intervallo del controllo della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-348">supports a range of concurrency control.</span></span> <span data-ttu-id="ca04c-349">Gli utenti specificano il tipo di controllo della concorrenza selezionando i livelli di isolamento delle transazioni per le connessioni oppure le opzioni di concorrenza nei cursori.</span><span class="sxs-lookup"><span data-stu-id="ca04c-349">Users specify the type of concurrency control by selecting transaction isolation levels for connections or concurrency options on cursors.</span></span> <span data-ttu-id="ca04c-350">È possibile definire questi attributi utilizzando le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] o le proprietà e gli attributi delle API di database quali ADO, ADO.NET, OLE DB e ODBC.</span><span class="sxs-lookup"><span data-stu-id="ca04c-350">These attributes can be defined using [!INCLUDE[tsql](../includes/tsql-md.md)] statements, or through the properties and attributes of database application programming interfaces (APIs) such as ADO, ADO.NET, OLE DB, and ODBC.</span></span>  
  
#### <a name="isolation-levels-in-the-database-engine"></a><span data-ttu-id="ca04c-351">Livelli di isolamento nel motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-351">Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="ca04c-352">Le transazioni specificano un livello di isolamento che definisce il grado di isolamento di una transazione dalle modifiche alle risorse o ai dati apportate da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-352">Transactions specify an isolation level that defines the degree to which one transaction must be isolated from resource or data modifications made by other transactions.</span></span> <span data-ttu-id="ca04c-353">I livelli di isolamento sono descritti in termini di effetti secondari consentiti sulla concorrenza, ad esempio letture dirty o fantasma.</span><span class="sxs-lookup"><span data-stu-id="ca04c-353">Isolation levels are described in terms of which concurrency side-effects, such as dirty reads or phantom reads, are allowed.</span></span>  
  
 <span data-ttu-id="ca04c-354">I livelli di isolamento delle transazioni controllano gli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-354">Transaction isolation levels control:</span></span>  
  
-   <span data-ttu-id="ca04c-355">Se i blocchi vengono acquisiti alla lettura dei dati e quali tipi di blocchi vengono richiesti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-355">Whether locks are taken when data is read, and what type of locks are requested.</span></span>  
  
-   <span data-ttu-id="ca04c-356">La durata dei blocchi di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-356">How long the read locks are held.</span></span>  
  
-   <span data-ttu-id="ca04c-357">Se un'operazione di lettura che fa riferimento a righe modificate da un'altra transazione:</span><span class="sxs-lookup"><span data-stu-id="ca04c-357">Whether a read operation referencing rows modified by another transaction:</span></span>  
  
    -   <span data-ttu-id="ca04c-358">Si blocca fino al rilascio del blocco esclusivo sulla riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-358">Blocks until the exclusive lock on the row is freed.</span></span>  
  
    -   <span data-ttu-id="ca04c-359">Recupera la versione di cui è stato eseguito il commit della riga esistente al momento dell'avvio dell'istruzione o della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-359">Retrieves the committed version of the row that existed at the time the statement or transaction started.</span></span>  
  
    -   <span data-ttu-id="ca04c-360">Legge la modifica dei dati di cui non è stato eseguito il commit.</span><span class="sxs-lookup"><span data-stu-id="ca04c-360">Reads the uncommitted data modification.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="ca04c-361">La scelta di un livello di isolamento delle transazioni non ha effetto sui blocchi acquisiti per proteggere le modifiche dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-361">Choosing a transaction isolation level does not affect the locks acquired to protect data modifications.</span></span> <span data-ttu-id="ca04c-362">Una transazione ottiene sempre un blocco esclusivo su qualsiasi dato da essa modificato, che mantiene fino al suo completamento, indipendentemente dal livello di isolamento impostato per la transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-362">A transaction always gets an exclusive lock on any data it modifies, and holds that lock until the transaction completes, regardless of the isolation level set for that transaction.</span></span> <span data-ttu-id="ca04c-363">Per le operazioni di lettura, i livelli di isolamento delle transazioni definiscono essenzialmente il livello di protezione dagli effetti delle modifiche apportate da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-363">For read operations, transaction isolation levels primarily define the level of protection from the effects of modifications made by other transactions.</span></span>  
  
 <span data-ttu-id="ca04c-364">Un livello di isolamento inferiore aumenta la possibilità per un maggior numero di utenti di accedere ai dati contemporaneamente, ma anche la quantità di effetti di concorrenza (ad esempio letture dirty o perdita di aggiornamenti) potenzialmente verificabili.</span><span class="sxs-lookup"><span data-stu-id="ca04c-364">A lower isolation level increases the ability of many users to access data at the same time, but increases the number of concurrency effects (such as dirty reads or lost updates) users might encounter.</span></span> <span data-ttu-id="ca04c-365">Per contro, un livello di isolamento elevato riduce i tipi di effetti di concorrenza verificabili, ma richiede più risorse di sistema e aumenta le probabilità che una transazione venga bloccata da un'altra.</span><span class="sxs-lookup"><span data-stu-id="ca04c-365">Conversely, a higher isolation level reduces the types of concurrency effects that users may encounter, but requires more system resources and increases the chances that one transaction will block another.</span></span> <span data-ttu-id="ca04c-366">La scelta del livello di isolamento corretto dipende dal giusto equilibrio tra requisiti relativi all'integrità dei dati per l'applicazione e overhead di ogni livello di isolamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-366">Choosing the appropriate isolation level depends on balancing the data integrity requirements of the application against the overhead of each isolation level.</span></span> <span data-ttu-id="ca04c-367">Il livello di isolamento più elevato, Serializable, garantisce che una transazione recuperi esattamente gli stessi dati a ogni ripetizione di un'operazione di lettura. Tuttavia questo avviene applicando un livello di blocco con probabilità effetti su altri utenti in sistemi multiutente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-367">The highest isolation level, serializable, guarantees that a transaction will retrieve exactly the same data every time it repeats a read operation, but it does this by performing a level of locking that is likely to impact other users in multi-user systems.</span></span> <span data-ttu-id="ca04c-368">Il livello di isolamento minimo, Read uncommitted, è in grado di recuperare i dati modificati ma di cui non è stato eseguito il commit da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-368">The lowest isolation level, read uncommitted, may retrieve data that has been modified but not committed by other transactions.</span></span> <span data-ttu-id="ca04c-369">In tale livello possono verificarsi tutti gli effetti secondari della concorrenza, ma l'assenza di blocco in lettura e di controllo delle versioni riduce al minimo l'overhead.</span><span class="sxs-lookup"><span data-stu-id="ca04c-369">All of the concurrency side effects can happen in read uncommitted, but there is no read locking or versioning, so overhead is minimized.</span></span>  
  
##### <a name="database-engine-isolation-levels"></a><span data-ttu-id="ca04c-370">Livelli di isolamento del motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-370">Database Engine Isolation Levels</span></span>  

 <span data-ttu-id="ca04c-371">Lo standard ISO definisce i livelli di isolamento seguenti, tutti supportati da [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="ca04c-371">The ISO standard defines the following isolation levels, all of which are supported by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span></span>  
  
|<span data-ttu-id="ca04c-372">Livello di isolamento</span><span class="sxs-lookup"><span data-stu-id="ca04c-372">Isolation Level</span></span>|<span data-ttu-id="ca04c-373">Definizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-373">Definition</span></span>|  
|---------------------|----------------|  
|<span data-ttu-id="ca04c-374">Read Uncommitted</span><span class="sxs-lookup"><span data-stu-id="ca04c-374">Read uncommitted</span></span>|<span data-ttu-id="ca04c-375">Il livello di isolamento delle transazioni più basso, sufficiente solo a garantire che i dati danneggiati fisicamente non vengano letti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-375">The lowest isolation level where transactions are isolated only enough to ensure that physically corrupt data is not read.</span></span> <span data-ttu-id="ca04c-376">In questo livello sono consentite le letture dirty, quindi una transazione può vedere le modifiche non ancora sottoposte al commit apportate da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-376">In this level, dirty reads are allowed, so one transaction may see not-yet-committed changes made by other transactions.</span></span>|  
|<span data-ttu-id="ca04c-377">Read Committed</span><span class="sxs-lookup"><span data-stu-id="ca04c-377">Read committed</span></span>|<span data-ttu-id="ca04c-378">Consente a una transazione di leggere i dati letti in precedenza (ma non modificati) da un'altra transazione senza attendere che tale transazione venga completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-378">Allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="ca04c-379">Il [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene i blocchi in scrittura (acquisiti sui dati selezionati) fino alla fine della transazione, ma rilascia i blocchi in lettura non appena viene eseguita l'operazione SELECT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-379">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps write locks (acquired on selected data) until the end of the transaction, but read locks are released as soon as the SELECT operation is performed.</span></span> <span data-ttu-id="ca04c-380">Si tratta del livello predefinito del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-380">This is the [!INCLUDE[ssDE](../includes/ssde-md.md)] default level.</span></span>|  
|<span data-ttu-id="ca04c-381">Repeatable Read</span><span class="sxs-lookup"><span data-stu-id="ca04c-381">Repeatable read</span></span>|<span data-ttu-id="ca04c-382">Il [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene i blocchi in scrittura e lettura che vengono acquisiti sui dati selezionati fino alla fine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-382">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks that are acquired on selected data until the end of the transaction.</span></span> <span data-ttu-id="ca04c-383">Tuttavia dal momento che i blocchi di intervallo non sono gestiti, è possibile che si verifichino letture fantasma.</span><span class="sxs-lookup"><span data-stu-id="ca04c-383">However, because range-locks are not managed, phantom reads can occur.</span></span>|  
|<span data-ttu-id="ca04c-384">Serializable</span><span class="sxs-lookup"><span data-stu-id="ca04c-384">Serializable</span></span>|<span data-ttu-id="ca04c-385">Il livello più alto corrispondente all'isolamento completo di una transazione dall'altra.</span><span class="sxs-lookup"><span data-stu-id="ca04c-385">The highest level where transactions are completely isolated from one another.</span></span> <span data-ttu-id="ca04c-386">Il [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene i blocchi in scrittura e lettura acquisiti sui dati selezionati che vengono rilasciati alla fine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-386">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks acquired on selected data to be released at the end of the transaction.</span></span> <span data-ttu-id="ca04c-387">I blocchi di intervallo vengono acquisiti quando un'operazione SELECT utilizza una clausola WHERE con intervallo, specialmente per evitare letture fantasma.</span><span class="sxs-lookup"><span data-stu-id="ca04c-387">Range-locks are acquired when a SELECT operation uses a ranged WHERE clause, especially to avoid phantom reads.</span></span><br /><br /> <span data-ttu-id="ca04c-388">**Nota:** È possibile che le operazioni e le transazioni DDL in tabelle replicate abbiano esito negativo quando è richiesto il livello di isolamento serializable.</span><span class="sxs-lookup"><span data-stu-id="ca04c-388">**Note:** DDL operations and transactions on replicated tables may fail when serializable isolation level is requested.</span></span> <span data-ttu-id="ca04c-389">Ciò è dovuto al fatto che le query di replica utilizzano hint che possono essere incompatibili con il livello di isolamento serializable.</span><span class="sxs-lookup"><span data-stu-id="ca04c-389">This is because replication queries use hints that may be incompatible with serializable isolation level.</span></span>|  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="ca04c-390">supporta inoltre due livelli di isolamento delle transazioni aggiuntivi che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-390">also supports two additional transaction isolation levels that use row versioning.</span></span> <span data-ttu-id="ca04c-391">il primo è un'implementazione dell'isolamento Read committed, l'altro è un livello di isolamento delle transazioni, Snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-391">One is an implementation of read committed isolation, and one is a transaction isolation level, snapshot.</span></span>  
  
|<span data-ttu-id="ca04c-392">Livello di isolamento del controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-392">Row Versioning Isolation Level</span></span>|<span data-ttu-id="ca04c-393">Definizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-393">Definition</span></span>|  
|------------------------------------|----------------|  
|<span data-ttu-id="ca04c-394">Snapshot Read Committed</span><span class="sxs-lookup"><span data-stu-id="ca04c-394">Read Committed Snapshot</span></span>|<span data-ttu-id="ca04c-395">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su ON, l'isolamento Read committed utilizza il controllo delle versioni delle righe per assicurare consistenza in lettura a livello di istruzioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-395">When the READ_COMMITTED_SNAPSHOT database option is set ON, read committed isolation uses row versioning to provide statement-level read consistency.</span></span> <span data-ttu-id="ca04c-396">Le operazioni di lettura richiedono solo i blocchi di livello di tabella SCH-S e nessun blocco di pagina o di riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-396">Read operations require only SCH-S table level locks and no page or row locks.</span></span> <span data-ttu-id="ca04c-397">Il motore di database utilizza il controllo delle versioni delle righe per presentare a ogni istruzione uno snapshot dei dati consistente dal punto di vista transazionale, rappresentativo dei dati esistenti al momento dell'avvio dell'istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-397">That is, the Database Engine uses row versioning to present each statement with a transactionally consistent snapshot of the data as it existed at the start of the statement.</span></span> <span data-ttu-id="ca04c-398">Non vengono utilizzati blocchi per proteggere i dati da aggiornamenti eseguiti da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-398">Locks are not used to protect the data from updates by other transactions.</span></span> <span data-ttu-id="ca04c-399">Una funzione definita dall'utente può restituire dati sottoposti a commit dopo che è iniziata l'istruzione contenente l'UDF.</span><span class="sxs-lookup"><span data-stu-id="ca04c-399">A user-defined function can return data that was committed after the time the statement containing the UDF began.</span></span><br /><br /> <span data-ttu-id="ca04c-400">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su OFF, ossia l'impostazione predefinita, l'isolamento Read committed utilizza blocchi condivisi per evitare che altre transazioni modifichino le righe mentre la transazione corrente esegue un'operazione di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-400">When the READ_COMMITTED_SNAPSHOT database option is set OFF, which is the default setting, read committed isolation uses shared locks to prevent other transactions from modifying rows while the current transaction is running a read operation.</span></span> <span data-ttu-id="ca04c-401">I blocchi condivisi impediscono inoltre che l'istruzione possa leggere righe modificate da altre transazioni, fino al completamento di tali transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-401">The shared locks also block the statement from reading rows modified by other transactions until the other transaction is completed.</span></span> <span data-ttu-id="ca04c-402">Entrambe le implementazioni sono conformi alla definizione ISO di isolamento di cui è stato eseguito il commit in lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-402">Both implementations meet the ISO definition of read committed isolation.</span></span>|  
|<span data-ttu-id="ca04c-403">Snapshot</span><span class="sxs-lookup"><span data-stu-id="ca04c-403">Snapshot</span></span>|<span data-ttu-id="ca04c-404">Il livello di isolamento dello snapshot utilizza il controllo delle versioni delle righe per assicurare consistenza in lettura a livello di transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-404">The snapshot isolation level uses row versioning to provide transaction-level read consistency.</span></span> <span data-ttu-id="ca04c-405">Le operazioni di lettura non acquisiscono blocchi di pagina o di riga, ma solo blocchi della tabella SCH-S.</span><span class="sxs-lookup"><span data-stu-id="ca04c-405">Read operations acquire no page or row locks; only SCH-S table locks are acquired.</span></span> <span data-ttu-id="ca04c-406">Quando viene eseguita la lettura delle righe modificate da un'altra transazione, esse recuperano la versione della riga esistente all'avvio della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-406">When reading rows modified by another transaction, they retrieve the version of the row that existed when the transaction started.</span></span> <span data-ttu-id="ca04c-407">È possibile utilizzare l'isolamento snapshot in un database solo quando l'opzione di database ALLOW_SNAPSHOT_ISOLATION è impostata su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-407">You can only use Snapshot isolation against a database when the ALLOW_SNAPSHOT_ISOLATION database option is set ON.</span></span> <span data-ttu-id="ca04c-408">Per impostazione predefinita, l'opzione è impostata su OFF per i database utente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-408">By default, this option is set OFF for user databases.</span></span><br /><br /> <span data-ttu-id="ca04c-409">**Nota:** [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] non supporta il controllo delle versioni dei metadati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-409">**Note:**  [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not support versioning of metadata.</span></span> <span data-ttu-id="ca04c-410">Per questo motivo, esistono restrizioni sulle operazioni DDL che possono eseguite in una transazione esplicita che viene eseguita con l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-410">For this reason, there are restrictions on what DDL operations can be performed in an explicit transaction that is running under snapshot isolation.</span></span> <span data-ttu-id="ca04c-411">Le istruzioni DDL seguenti non sono consentite con l'isolamento snapshot dopo un'istruzione BEGIN TRANSACTION: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME o qualsiasi istruzione DDL di Common Language Runtime (CLR).</span><span class="sxs-lookup"><span data-stu-id="ca04c-411">The following DDL statements are not permitted under snapshot isolation after a BEGIN TRANSACTION statement: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or any common language runtime (CLR) DDL statement.</span></span> <span data-ttu-id="ca04c-412">Queste istruzioni sono consentite quando si usa l'isolamento dello snapshot all'interno di transazioni implicite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-412">These statements are permitted when you are using snapshot isolation within implicit transactions.</span></span> <span data-ttu-id="ca04c-413">Per definizione, una transazione implicita è una sola istruzione che rende possibile l'applicazione della semantica dell'isolamento dello snapshot, anche con le istruzioni DDL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-413">An implicit transaction, by definition, is a single statement that makes it possible to enforce the semantics of snapshot isolation, even with DDL statements.</span></span> <span data-ttu-id="ca04c-414">Le violazioni di questo principio possono provocare l'errore 3961: "Transazione di isolamento dello snapshot non riuscita nel database '%. \* ls' perché l'oggetto a cui accede l'istruzione è stato modificato da un'istruzione DDL in un'altra transazione simultanea fin dall'inizio di questa transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-414">Violations of this principle can cause error 3961: "Snapshot isolation transaction failed in database '%.\*ls' because the object accessed by the statement has been modified by a DDL statement in another concurrent transaction since the start of this transaction.</span></span> <span data-ttu-id="ca04c-415">Operazione non consentita perché il controllo delle versioni non viene applicato ai metadati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-415">It is not allowed because the metadata is not versioned.</span></span> <span data-ttu-id="ca04c-416">L'aggiornamento simultaneo dei metadati può causare problemi di incoerenza in combinazione con l'isolamento dello snapshot".</span><span class="sxs-lookup"><span data-stu-id="ca04c-416">A concurrent update to metadata could lead to inconsistency if mixed with snapshot isolation."</span></span>|  
  
 <span data-ttu-id="ca04c-417">Nella tabella seguente vengono illustrati gli effetti secondari della concorrenza attivati dai diversi livelli di isolamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-417">The following table shows the concurrency side effects enabled by the different isolation levels.</span></span>  
  
|<span data-ttu-id="ca04c-418">Livello di isolamento</span><span class="sxs-lookup"><span data-stu-id="ca04c-418">Isolation level</span></span>|<span data-ttu-id="ca04c-419">Lettura dirty</span><span class="sxs-lookup"><span data-stu-id="ca04c-419">Dirty read</span></span>|<span data-ttu-id="ca04c-420">Nonrepeatable read</span><span class="sxs-lookup"><span data-stu-id="ca04c-420">Nonrepeatable read</span></span>|<span data-ttu-id="ca04c-421">Lettura fantasma</span><span class="sxs-lookup"><span data-stu-id="ca04c-421">Phantom</span></span>|  
|---------------------|----------------|------------------------|-------------|  
|<span data-ttu-id="ca04c-422">**Read uncommitted**</span><span class="sxs-lookup"><span data-stu-id="ca04c-422">**Read uncommitted**</span></span>|<span data-ttu-id="ca04c-423">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-423">Yes</span></span>|<span data-ttu-id="ca04c-424">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-424">Yes</span></span>|<span data-ttu-id="ca04c-425">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-425">Yes</span></span>|  
|<span data-ttu-id="ca04c-426">**Read committed**</span><span class="sxs-lookup"><span data-stu-id="ca04c-426">**Read committed**</span></span>|<span data-ttu-id="ca04c-427">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-427">No</span></span>|<span data-ttu-id="ca04c-428">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-428">Yes</span></span>|<span data-ttu-id="ca04c-429">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-429">Yes</span></span>|  
|<span data-ttu-id="ca04c-430">**Repeatable read**</span><span class="sxs-lookup"><span data-stu-id="ca04c-430">**Repeatable read**</span></span>|<span data-ttu-id="ca04c-431">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-431">No</span></span>|<span data-ttu-id="ca04c-432">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-432">No</span></span>|<span data-ttu-id="ca04c-433">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-433">Yes</span></span>|  
|<span data-ttu-id="ca04c-434">**Snapshot**</span><span class="sxs-lookup"><span data-stu-id="ca04c-434">**Snapshot**</span></span>|<span data-ttu-id="ca04c-435">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-435">No</span></span>|<span data-ttu-id="ca04c-436">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-436">No</span></span>|<span data-ttu-id="ca04c-437">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-437">No</span></span>|  
|<span data-ttu-id="ca04c-438">**Serializable**</span><span class="sxs-lookup"><span data-stu-id="ca04c-438">**Serializable**</span></span>|<span data-ttu-id="ca04c-439">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-439">No</span></span>|<span data-ttu-id="ca04c-440">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-440">No</span></span>|<span data-ttu-id="ca04c-441">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-441">No</span></span>|  
  
 <span data-ttu-id="ca04c-442">Per altre informazioni sui tipi specifici di blocco o di controllo delle versioni delle righe controllati da ogni livello di isolamento delle transazioni, vedere [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-442">For more information about the specific types of locking or row versioning controlled by each transaction isolation level, see [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-443">Per impostare i livelli di isolamento delle transazioni, è possibile utilizzare [!INCLUDE[tsql](../includes/tsql-md.md)] o un'API di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-443">Transaction isolation levels can be set using [!INCLUDE[tsql](../includes/tsql-md.md)] or through a database API.</span></span>  
  
 [!INCLUDE[tsql](../includes/tsql-md.md)]  
 <span data-ttu-id="ca04c-444">Gli script [!INCLUDE[tsql](../includes/tsql-md.md)] utilizzano l'istruzione SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-444">[!INCLUDE[tsql](../includes/tsql-md.md)] scripts use the SET TRANSACTION ISOLATION LEVEL statement.</span></span>  
  
 <span data-ttu-id="ca04c-445">ADO</span><span class="sxs-lookup"><span data-stu-id="ca04c-445">ADO</span></span>  
 <span data-ttu-id="ca04c-446">Nelle applicazioni ADO la proprietà `IsolationLevel` dell'oggetto **Connection** viene impostata suadXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead o adXactReadSerializable.</span><span class="sxs-lookup"><span data-stu-id="ca04c-446">ADO applications set the `IsolationLevel` property of the **Connection** object to adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead, or adXactReadSerializable.</span></span>  
  
 <span data-ttu-id="ca04c-447">ADO.NET</span><span class="sxs-lookup"><span data-stu-id="ca04c-447">ADO.NET</span></span>  
 <span data-ttu-id="ca04c-448">Le applicazioni ADO.NET che usano lo spazio dei nomi gestito `System.Data.SqlClient` possono chiamare il metodo `SqlConnection.BeginTransaction` e impostare l'opzione *IsolationLevel* su Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable e Snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-448">ADO.NET applications using the `System.Data.SqlClient` managed namespace can call the `SqlConnection.BeginTransaction` method and set the *IsolationLevel* option to Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable, and Snapshot.</span></span>  
  
 <span data-ttu-id="ca04c-449">OLE DB</span><span class="sxs-lookup"><span data-stu-id="ca04c-449">OLE DB</span></span>  
 <span data-ttu-id="ca04c-450">Quando si avvia una transazione, le applicazioni che usano OLE DB chiamano `ITransactionLocal::StartTransaction` con l'opzione *isoLevel* impostata su ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT o ISOLATIONLEVEL_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-450">When starting a transaction, applications using OLE DB call `ITransactionLocal::StartTransaction` with *isoLevel* set to ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT, or ISOLATIONLEVEL_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="ca04c-451">Quando si specifica il livello di isolamento delle transazioni in modalità autocommit, le applicazioni OLE DB possono impostare la proprietà DBPROPSET_SESSION DBPROP_SESS_AUTOCOMMITISOLEVELS su DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED o DBPROPVAL_TI_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-451">When specifying the transaction isolation level in autocommit mode, OLE DB applications can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED, or DBPROPVAL_TI_SNAPSHOT.</span></span>  
  
 <span data-ttu-id="ca04c-452">ODBC</span><span class="sxs-lookup"><span data-stu-id="ca04c-452">ODBC</span></span>  
 <span data-ttu-id="ca04c-453">Le applicazioni ODBC chiamano `SQLSetConnectAttr` con l'opzione *Attribute* impostata su SQL_ATTR_TXN_ISOLATION e l'opzione *ValuePtr* impostata su SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ o SQL_TXN_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-453">ODBC applications call `SQLSetConnectAttr` with *Attribute* set to SQL_ATTR_TXN_ISOLATION and *ValuePtr* set to SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ, or SQL_TXN_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="ca04c-454">Per le transazioni snapshot, le applicazioni chiamano `SQLSetConnectAttr` con l'opzione Attribute impostata su SQL_COPT_SS_TXN_ISOLATION e l'opzione ValuePtr impostata su SQL_TXN_SS_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-454">For snapshot transactions, applications call `SQLSetConnectAttr` with Attribute set to SQL_COPT_SS_TXN_ISOLATION and ValuePtr set to SQL_TXN_SS_SNAPSHOT.</span></span> <span data-ttu-id="ca04c-455">È possibile recuperare una transazione snapshot utilizzando SQL_COPT_SS_TXN_ISOLATION oppure SQL_ATTR_TXN_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="ca04c-455">A snapshot transaction can be retrieved using either SQL_COPT_SS_TXN_ISOLATION or SQL_ATTR_TXN_ISOLATION.</span></span>  
  
 <span data-ttu-id="ca04c-456">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-456">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-in-the-database-engine"></a><a name="Lock_Engine"></a> <span data-ttu-id="ca04c-457">Blocchi nel motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-457">Locking in the Database Engine</span></span>  

 <span data-ttu-id="ca04c-458">I blocchi costituiscono un meccanismo utilizzato nel [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] per sincronizzare l'accesso allo stesso dato eseguito contemporaneamente da più utenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-458">Locking is a mechanism used by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] to synchronize access by multiple users to the same piece of data at the same time.</span></span>  
  
 <span data-ttu-id="ca04c-459">Prima che una transazione acquisisca una dipendenza sullo stato corrente del dato, ad esempio mediante un'operazione di lettura o modifica dei dati, deve proteggersi dagli effetti di un'altra transazione che esegue operazioni di modifica sugli stessi dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-459">Before a transaction acquires a dependency on the current state of a piece of data, such as by reading or modifying the data, it must protect itself from the effects of another transaction modifying the same data.</span></span> <span data-ttu-id="ca04c-460">A tale scopo, la transazione richiede il blocco del dato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-460">The transaction does this by requesting a lock on the piece of data.</span></span> <span data-ttu-id="ca04c-461">I blocchi sono caratterizzati da diverse modalità e possono ad esempio essere condivisi o esclusivi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-461">Locks have different modes, such as shared or exclusive.</span></span> <span data-ttu-id="ca04c-462">La modalità di blocco consente di definire il livello di dipendenza della transazione sui dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-462">The lock mode defines the level of dependency the transaction has on the data.</span></span> <span data-ttu-id="ca04c-463">Non è possibile concedere a una transazione un blocco che determina un conflitto con la modalità di blocco già concessa a un'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-463">No transaction can be granted a lock that would conflict with the mode of a lock already granted on that data to another transaction.</span></span> <span data-ttu-id="ca04c-464">Se una transazione richiede una modalità di blocco in conflitto con un blocco già concesso sugli stessi dati, l'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] metterà in pausa la transazione richiedente fino al rilascio del primo blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-464">If a transaction requests a lock mode that conflicts with a lock that has already been granted on the same data, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] will pause the requesting transaction until the first lock is released.</span></span>  
  
 <span data-ttu-id="ca04c-465">Quando una transazione modifica un dato, il blocco di protezione della modifica viene mantenuto fino alla fine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-465">When a transaction modifies a piece of data, it holds the lock protecting the modification until the end of the transaction.</span></span> <span data-ttu-id="ca04c-466">La durata dei blocchi acquisiti da una transazione per proteggere le operazioni di lettura dipende dall'impostazione del livello di isolamento della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-466">How long a transaction holds the locks acquired to protect read operations depends on the transaction isolation level setting.</span></span> <span data-ttu-id="ca04c-467">I blocchi acquisiti da una transazione vengono rilasciati al completamento della transazione, ovvero in corrispondenza del commit o del rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-467">All locks held by a transaction are released when the transaction completes (either commits or rolls back).</span></span>  
  
 <span data-ttu-id="ca04c-468">I blocchi non vengono in genere richiesti direttamente dalle applicazioni,</span><span class="sxs-lookup"><span data-stu-id="ca04c-468">Applications do not typically request locks directly.</span></span> <span data-ttu-id="ca04c-469">ma gestiti internamente da un componente di [!INCLUDE[ssDE](../includes/ssde-md.md)] denominato Gestione blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-469">Locks are managed internally by a part of the [!INCLUDE[ssDE](../includes/ssde-md.md)] called the lock manager.</span></span> <span data-ttu-id="ca04c-470">Quando un'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] elabora un'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)], Query Processor di [!INCLUDE[ssDE](../includes/ssde-md.md)] determina le risorse cui accedere,</span><span class="sxs-lookup"><span data-stu-id="ca04c-470">When an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] processes a [!INCLUDE[tsql](../includes/tsql-md.md)] statement, the [!INCLUDE[ssDE](../includes/ssde-md.md)] query processor determines which resources are to be accessed.</span></span> <span data-ttu-id="ca04c-471">nonché i tipi di blocchi necessari per proteggere le singole risorse in base al tipo di accesso e all'impostazione del livello di isolamento della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-471">The query processor determines what types of locks are required to protect each resource based on the type of access and the transaction isolation level setting.</span></span> <span data-ttu-id="ca04c-472">Query Processor richiede quindi i blocchi appropriati a Gestione blocchi,</span><span class="sxs-lookup"><span data-stu-id="ca04c-472">The query processor then requests the appropriate locks from the lock manager.</span></span> <span data-ttu-id="ca04c-473">che li concede a meno che non si sia verificato un conflitto con blocchi acquisiti da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-473">The lock manager grants the locks if there are no conflicting locks held by other transactions.</span></span>  
  
### <a name="lock-granularity-and-hierarchies"></a><span data-ttu-id="ca04c-474">Granularità dei blocchi e gerarchie</span><span class="sxs-lookup"><span data-stu-id="ca04c-474">Lock Granularity and Hierarchies</span></span>  

 <span data-ttu-id="ca04c-475">Il [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supporta il blocco con livelli di granularità diversi, che consente a tipi diversi di risorse di venire bloccati da una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-475">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] has multigranular locking that allows different types of resources to be locked by a transaction.</span></span> <span data-ttu-id="ca04c-476">Per ridurre al minimo il costo associato ai blocchi, il [!INCLUDE[ssDE](../includes/ssde-md.md)] blocca automaticamente le risorse in base al livello più adatto per l'attività specifica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-476">To minimize the cost of locking, the [!INCLUDE[ssDE](../includes/ssde-md.md)] locks resources automatically at a level appropriate to the task.</span></span> <span data-ttu-id="ca04c-477">L'applicazione di un blocco con un livello di granularità inferiore, ad esempio a livello di riga, aumenta la concorrenza, ma anche l'overhead. Il numero dei blocchi da gestire infatti aumenta in modo proporzionale al numero di righe bloccate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-477">Locking at a smaller granularity, such as rows, increases concurrency but has a higher overhead because more locks must be held if many rows are locked.</span></span> <span data-ttu-id="ca04c-478">L'applicazione di un blocco con un livello di granularità superiore, ad esempio a livello di tabella, comporta invece un aumento dei costi in termini di concorrenza, in quanto bloccando un'intera tabella viene impedito ad altre transazioni di accedere a qualsiasi parte della tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-478">Locking at a larger granularity, such as tables, are expensive in terms of concurrency because locking an entire table restricts access to any part of the table by other transactions.</span></span> <span data-ttu-id="ca04c-479">L'overhead tuttavia risulta inferiore perché il numero di blocchi da gestire è minore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-479">However, it has a lower overhead because fewer locks are being maintained.</span></span>  
  
 <span data-ttu-id="ca04c-480">[!INCLUDE[ssDE](../includes/ssde-md.md)] deve spesso acquisire blocchi a più livelli di granularità per proteggere completamente una risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-480">The [!INCLUDE[ssDE](../includes/ssde-md.md)] often has to acquire locks at multiple levels of granularity to fully protect a resource.</span></span> <span data-ttu-id="ca04c-481">Un gruppo di blocchi a più livelli di granularità viene denominato gerarchia di blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-481">This group of locks at multiple levels of granularity is called a lock hierarchy.</span></span> <span data-ttu-id="ca04c-482">Ad esempio, per proteggere completamente una lettura di un indice, è possibile che un'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] debba acquisire blocchi condivisi sulle righe e blocchi preventivi condivisi sulle pagine e sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-482">For example, to fully protect a read of an index, an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] may have to acquire share locks on rows and intent share locks on the pages and table.</span></span>  
  
 <span data-ttu-id="ca04c-483">Nella tabella seguente sono illustrate le risorse che il [!INCLUDE[ssDE](../includes/ssde-md.md)] può bloccare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-483">The following table shows the resources that the [!INCLUDE[ssDE](../includes/ssde-md.md)] can lock.</span></span>  
  
|<span data-ttu-id="ca04c-484">Risorsa</span><span class="sxs-lookup"><span data-stu-id="ca04c-484">Resource</span></span>|<span data-ttu-id="ca04c-485">Descrizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-485">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="ca04c-486">RID</span><span class="sxs-lookup"><span data-stu-id="ca04c-486">RID</span></span>|<span data-ttu-id="ca04c-487">ID di riga utilizzato per bloccare una singola riga all'interno di un heap.</span><span class="sxs-lookup"><span data-stu-id="ca04c-487">A row identifier used to lock a single row within a heap.</span></span>|  
|<span data-ttu-id="ca04c-488">KEY</span><span class="sxs-lookup"><span data-stu-id="ca04c-488">KEY</span></span>|<span data-ttu-id="ca04c-489">Blocco di riga all'interno di un indice utilizzato per proteggere intervalli di chiavi nelle transazioni serializzabili.</span><span class="sxs-lookup"><span data-stu-id="ca04c-489">A row lock within an index used to protect key ranges in serializable transactions.</span></span>|  
|<span data-ttu-id="ca04c-490">PAGE</span><span class="sxs-lookup"><span data-stu-id="ca04c-490">PAGE</span></span>|<span data-ttu-id="ca04c-491">Pagina di database di 8 kilobyte (KB), ad esempio una pagina di dati o di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-491">An 8-kilobyte (KB) page in a database, such as data or index pages.</span></span>|  
|<span data-ttu-id="ca04c-492">EXTENT</span><span class="sxs-lookup"><span data-stu-id="ca04c-492">EXTENT</span></span>|<span data-ttu-id="ca04c-493">Gruppo contiguo di otto pagine, ad esempio di dati o di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-493">A contiguous group of eight pages, such as data or index pages.</span></span>|  
|<span data-ttu-id="ca04c-494">HoBT</span><span class="sxs-lookup"><span data-stu-id="ca04c-494">HoBT</span></span>|<span data-ttu-id="ca04c-495">Heap o albero B.</span><span class="sxs-lookup"><span data-stu-id="ca04c-495">A heap or B-tree.</span></span> <span data-ttu-id="ca04c-496">Un blocco che protegge un albero B (indice) o l'heap delle pagine di dati in una tabella che non dispone di un indice cluster.</span><span class="sxs-lookup"><span data-stu-id="ca04c-496">A lock protecting a B-tree (index) or the heap data pages in a table that does not have a clustered index.</span></span>|  
|<span data-ttu-id="ca04c-497">TABLE</span><span class="sxs-lookup"><span data-stu-id="ca04c-497">TABLE</span></span>|<span data-ttu-id="ca04c-498">Tabella intera, compresi tutti i dati e gli indici.</span><span class="sxs-lookup"><span data-stu-id="ca04c-498">The entire table, including all data and indexes.</span></span>|  
|<span data-ttu-id="ca04c-499">FILE</span><span class="sxs-lookup"><span data-stu-id="ca04c-499">FILE</span></span>|<span data-ttu-id="ca04c-500">File di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-500">A database file.</span></span>|  
|<span data-ttu-id="ca04c-501">APPLICATION</span><span class="sxs-lookup"><span data-stu-id="ca04c-501">APPLICATION</span></span>|<span data-ttu-id="ca04c-502">Risorsa specificata dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-502">An application-specified resource.</span></span>|  
|<span data-ttu-id="ca04c-503">METADATI</span><span class="sxs-lookup"><span data-stu-id="ca04c-503">METADATA</span></span>|<span data-ttu-id="ca04c-504">Blocchi a livello di metadati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-504">Metadata locks.</span></span>|  
|<span data-ttu-id="ca04c-505">ALLOCATION_UNIT</span><span class="sxs-lookup"><span data-stu-id="ca04c-505">ALLOCATION_UNIT</span></span>|<span data-ttu-id="ca04c-506">Unità di allocazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-506">An allocation unit.</span></span>|  
|<span data-ttu-id="ca04c-507">DATABASE</span><span class="sxs-lookup"><span data-stu-id="ca04c-507">DATABASE</span></span>|<span data-ttu-id="ca04c-508">Intero database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-508">The entire database.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-509">Gli HoBT e i blocchi TABLE possono essere interessati dall'opzione LOCK_ESCALATION di [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-509">HoBT and TABLE locks can be affected by the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="lock-modes"></a><span data-ttu-id="ca04c-510">Modalità blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-510">Lock Modes</span></span>  

 <span data-ttu-id="ca04c-511">Nel [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] le risorse vengono bloccate in base a modalità blocco diverse, che determinano il modo in cui le transazioni simultanee possono accedere alle risorse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-511">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] locks resources using different lock modes that determine how the resources can be accessed by concurrent transactions.</span></span>  
  
 <span data-ttu-id="ca04c-512">Nella tabella seguente sono incluse le modalità blocco delle risorse utilizzate in [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-512">The following table shows the resource lock modes that the [!INCLUDE[ssDE](../includes/ssde-md.md)] uses.</span></span>  
  
|<span data-ttu-id="ca04c-513">Modalità blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-513">Lock mode</span></span>|<span data-ttu-id="ca04c-514">Descrizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-514">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="ca04c-515">Condiviso (S)</span><span class="sxs-lookup"><span data-stu-id="ca04c-515">Shared (S)</span></span>|<span data-ttu-id="ca04c-516">Blocco utilizzato per operazioni di lettura che non comportano la modifica o l'aggiornamento dei dati, ad esempio l'istruzione SELECT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-516">Used for read operations that do not change or update data, such as a SELECT statement.</span></span>|  
|<span data-ttu-id="ca04c-517">Aggiornamento (U)</span><span class="sxs-lookup"><span data-stu-id="ca04c-517">Update (U)</span></span>|<span data-ttu-id="ca04c-518">Blocco utilizzato per risorse che possono essere aggiornate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-518">Used on resources that can be updated.</span></span> <span data-ttu-id="ca04c-519">Impedisce un tipo comune di deadlock che si verifica quando più sessioni leggono e bloccano le risorse ed eventualmente ne eseguono l'aggiornamento in un momento successivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-519">Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.</span></span>|  
|<span data-ttu-id="ca04c-520">Esclusivo (X)</span><span class="sxs-lookup"><span data-stu-id="ca04c-520">Exclusive (X)</span></span>|<span data-ttu-id="ca04c-521">Blocco utilizzato per operazioni di modifica dei dati, ad esempio UPDATE, INSERT e DELETE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-521">Used for data-modification operations, such as INSERT, UPDATE, or DELETE.</span></span> <span data-ttu-id="ca04c-522">Garantisce che non possano essere eseguiti più aggiornamenti simultanei della stessa risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-522">Ensures that multiple updates cannot be made to the same resource at the same time.</span></span>|  
|<span data-ttu-id="ca04c-523">Finalità</span><span class="sxs-lookup"><span data-stu-id="ca04c-523">Intent</span></span>|<span data-ttu-id="ca04c-524">Blocco utilizzato per definire una gerarchia di blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-524">Used to establish a lock hierarchy.</span></span> <span data-ttu-id="ca04c-525">Tra i tipi di blocchi preventivi sono inclusi i blocchi preventivi condivisi (IS), i blocchi preventivi esclusivi (IX) e i blocchi preventivi esclusivi condivisi (SIX).</span><span class="sxs-lookup"><span data-stu-id="ca04c-525">The types of intent locks are: intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>|  
|<span data-ttu-id="ca04c-526">SCHEMA</span><span class="sxs-lookup"><span data-stu-id="ca04c-526">Schema</span></span>|<span data-ttu-id="ca04c-527">Blocco utilizzato quando è in esecuzione un'operazione dipendente dallo schema della tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-527">Used when an operation dependent on the schema of a table is executing.</span></span> <span data-ttu-id="ca04c-528">Tra i tipi di blocchi di schema sono inclusi i blocchi di modifica dello schema (Sch-M) e i blocchi di stabilità dello schema (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="ca04c-528">The types of schema locks are: schema modification (Sch-M) and schema stability (Sch-S).</span></span>|  
|<span data-ttu-id="ca04c-529">Aggiornamento bulk (BU)</span><span class="sxs-lookup"><span data-stu-id="ca04c-529">Bulk Update (BU)</span></span>|<span data-ttu-id="ca04c-530">Blocco usato durante le operazioni di copia bulk dei dati in una tabella quando viene specificato l'hint **TABLOCK**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-530">Used when bulk copying data into a table and the **TABLOCK** hint is specified.</span></span>|  
|<span data-ttu-id="ca04c-531">Intervalli di chiavi</span><span class="sxs-lookup"><span data-stu-id="ca04c-531">Key-range</span></span>|<span data-ttu-id="ca04c-532">Modalità che consente di proteggere l'intervallo di righe lette da una query quando si utilizza il livello di isolamento della transazione Serializable.</span><span class="sxs-lookup"><span data-stu-id="ca04c-532">Protects the range of rows read by a query when using the serializable transaction isolation level.</span></span> <span data-ttu-id="ca04c-533">Garantisce che le altre transazioni non possano inserire righe da includere nelle query della transazione serializzabile se le query sono state nuovamente eseguite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-533">Ensures that other transactions cannot insert rows that would qualify for the queries of the serializable transaction if the queries were run again.</span></span>|  
  
#### <a name="shared-locks"></a><span data-ttu-id="ca04c-534">Blocchi condivisi</span><span class="sxs-lookup"><span data-stu-id="ca04c-534">Shared Locks</span></span>  

 <span data-ttu-id="ca04c-535">I blocchi condivisi (S) consentono la lettura (SELECT) di una risorsa da parte di transazioni simultanee con il controllo della concorrenza pessimistica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-535">Shared (S) locks allow concurrent transactions to read (SELECT) a resource under pessimistic concurrency control.</span></span> <span data-ttu-id="ca04c-536">senza che altre transazioni possano modificare i dati mentre il blocco condiviso (S) è applicato alla risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-536">No other transactions can modify the data while shared (S) locks exist on the resource.</span></span> <span data-ttu-id="ca04c-537">I blocchi condivisi applicati a una risorsa vengono rilasciati non appena viene completata l'operazione di lettura, a meno che il livello di isolamento della transazione non sia stato impostato su Repeatable Read o superiore oppure non sia in uso l'hint di blocco per mantenere attivo il blocco per l'intera durata della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-537">Shared (S) locks on a resource are released as soon as the read operation completes, unless the transaction isolation level is set to repeatable read or higher, or a locking hint is used to retain the shared (S) locks for the duration of the transaction.</span></span>  
  
#### <a name="update-locks"></a><span data-ttu-id="ca04c-538">Blocchi di aggiornamento</span><span class="sxs-lookup"><span data-stu-id="ca04c-538">Update Locks</span></span>  

 <span data-ttu-id="ca04c-539">I blocchi di aggiornamento (U) impediscono il verificarsi di una forma comune di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-539">Update (U) locks prevent a common form of deadlock.</span></span> <span data-ttu-id="ca04c-540">Durante una transazione Repeatable Read o Serializable la transazione legge i dati, acquisisce un blocco condiviso (S) sulla risorsa (pagina o riga) e modifica quindi i dati. Quest'ultima operazione comporta la conversione del blocco in blocco esclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="ca04c-540">In a repeatable read or serializable transaction, the transaction reads data, acquiring a shared (S) lock on the resource (page or row), and then modifies the data, which requires lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="ca04c-541">Se due transazioni acquisiscono blocchi in modalità condivisa su una risorsa e quindi eseguono un tentativo simultaneo di aggiornamento dei dati, una delle due transazioni eseguirà il tentativo di conversione del blocco in blocco esclusivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-541">If two transactions acquire shared-mode locks on a resource and then attempt to update data concurrently, one transaction attempts the lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="ca04c-542">La conversione di un blocco da condiviso a esclusivo non può essere eseguita immediatamente, in quanto il blocco esclusivo relativo a una transazione non è compatibile con il blocco condiviso relativo all'altra transazione. Si verifica pertanto un'attesa di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-542">The shared-mode-to-exclusive lock conversion must wait because the exclusive lock for one transaction is not compatible with the shared-mode lock of the other transaction; a lock wait occurs.</span></span> <span data-ttu-id="ca04c-543">La seconda transazione tenta di acquisire un blocco esclusivo (X) per la propria operazione di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-543">The second transaction attempts to acquire an exclusive (X) lock for its update.</span></span> <span data-ttu-id="ca04c-544">Poiché, tuttavia, entrambe le transazioni eseguono una conversione in blocco esclusivo (X) e ogni transazione è in attesa che l'altra rilasci il blocco condiviso, si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-544">Because both transactions are converting to exclusive (X) locks, and they are each waiting for the other transaction to release its shared-mode lock, a deadlock occurs.</span></span>  
  
 <span data-ttu-id="ca04c-545">Per evitare questo problema, vengono utilizzati i blocchi di aggiornamento (U).</span><span class="sxs-lookup"><span data-stu-id="ca04c-545">To avoid this potential deadlock problem, update (U) locks are used.</span></span> <span data-ttu-id="ca04c-546">Un blocco di aggiornamento (U) per una risorsa può essere acquisito da una sola transazione per volta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-546">Only one transaction can obtain an update (U) lock to a resource at a time.</span></span> <span data-ttu-id="ca04c-547">Se una transazione modifica una risorsa, il blocco di aggiornamento (U) viene convertito in blocco esclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="ca04c-547">If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.</span></span>  
  
#### <a name="exclusive-locks"></a><span data-ttu-id="ca04c-548">Blocchi esclusivi</span><span class="sxs-lookup"><span data-stu-id="ca04c-548">Exclusive Locks</span></span>  

 <span data-ttu-id="ca04c-549">I blocchi esclusivi (X) impediscono l'accesso a una risorsa da parte di transazioni simultanee.</span><span class="sxs-lookup"><span data-stu-id="ca04c-549">Exclusive (X) locks prevent access to a resource by concurrent transactions.</span></span> <span data-ttu-id="ca04c-550">Con un blocco esclusivo (X), nessun'altra transazione può modificare dati. Le operazioni di lettura possono essere eseguite solo utilizzando l'hint NOLOCK o il livello di isolamento Read Uncommitted.</span><span class="sxs-lookup"><span data-stu-id="ca04c-550">With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.</span></span>  
  
 <span data-ttu-id="ca04c-551">Le istruzioni di modifica dei dati, ad esempio INSERT, UPDATE e DELETE, combinano entrambe le operazioni di modifica e di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-551">Data modification statements, such as INSERT, UPDATE, and DELETE combine both modification and read operations.</span></span> <span data-ttu-id="ca04c-552">L'istruzione esegue innanzitutto le operazioni di lettura per acquisire dati prima di eseguire le operazioni di modifica necessarie.</span><span class="sxs-lookup"><span data-stu-id="ca04c-552">The statement first performs read operations to acquire data before performing the required modification operations.</span></span> <span data-ttu-id="ca04c-553">Le istruzioni di modifica dei dati, pertanto, richiedono in genere blocchi sia condivisi che esclusivi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-553">Data modification statements, therefore, typically request both shared locks and exclusive locks.</span></span> <span data-ttu-id="ca04c-554">Un'istruzione UPDATE, ad esempio, potrebbe comportare la modifica di righe in una tabella basata su un join con un'altra tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-554">For example, an UPDATE statement might modify rows in one table based on a join with another table.</span></span> <span data-ttu-id="ca04c-555">In questo caso, l'istruzione UPDATE richiede blocchi condivisi sulle righe lette nella tabella di join, nonché blocchi esclusivi sulle righe aggiornate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-555">In this case, the UPDATE statement requests shared locks on the rows read in the join table in addition to requesting exclusive locks on the updated rows.</span></span>  
  
#### <a name="intent-locks"></a><span data-ttu-id="ca04c-556">Blocchi preventivi</span><span class="sxs-lookup"><span data-stu-id="ca04c-556">Intent Locks</span></span>  

 <span data-ttu-id="ca04c-557">In [!INCLUDE[ssDE](../includes/ssde-md.md)] vengono utilizzati blocchi preventivi per proteggere l'applicazione di un blocco condiviso (S) o esclusivo (X) su una risorsa di livello inferiore nella gerarchia di blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-557">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses intent locks to protect placing a shared (S) lock or exclusive (X) lock on a resource lower in the lock hierarchy.</span></span> <span data-ttu-id="ca04c-558">I blocchi preventivi, in inglese "intent lock", sono così denominati in quanto vengono acquisiti prima di un blocco a un livello inferiore e, pertanto, indicano l'intenzione di applicare blocchi a livelli inferiori.</span><span class="sxs-lookup"><span data-stu-id="ca04c-558">Intent locks are named intent locks because they are acquired before a lock at the lower level, and therefore signal intent to place locks at a lower level.</span></span>  
  
 <span data-ttu-id="ca04c-559">I blocchi preventivi rispondono ai due obiettivi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-559">Intent locks serve two purposes:</span></span>  
  
-   <span data-ttu-id="ca04c-560">Impedire alle altre transazioni di modificare la risorsa di livello superiore in un modo che annullerebbe la validità del blocco applicato al livello inferiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-560">To prevent other transactions from modifying the higher-level resource in a way that would invalidate the lock at the lower level.</span></span>  
  
-   <span data-ttu-id="ca04c-561">Aumentare l'efficacia di [!INCLUDE[ssDE](../includes/ssde-md.md)] nel rilevare i conflitti tra blocchi a un livello di granularità superiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-561">To improve the efficiency of the [!INCLUDE[ssDE](../includes/ssde-md.md)] in detecting lock conflicts at the higher level of granularity.</span></span>  
  
 <span data-ttu-id="ca04c-562">Un blocco preventivo condiviso, ad esempio, viene richiesto a livello di tabella prima che nelle pagine o nelle righe all'interno della tabella vengano richiesti blocchi condivisi (S).</span><span class="sxs-lookup"><span data-stu-id="ca04c-562">For example, a shared intent lock is requested at the table level before shared (S) locks are requested on pages or rows within that table.</span></span> <span data-ttu-id="ca04c-563">L'impostazione di un blocco preventivo a livello di tabella consente di impedire l'acquisizione successiva da parte delle altre transazioni di un blocco esclusivo (X) sulla tabella contenente la pagina specifica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-563">Setting an intent lock at the table level prevents another transaction from subsequently acquiring an exclusive (X) lock on the table containing that page.</span></span> <span data-ttu-id="ca04c-564">I blocchi preventivi garantiscono prestazioni migliori, in quanto per determinare se una transazione può acquisire un blocco sulla tabella, in [!INCLUDE[ssDE](../includes/ssde-md.md)] vengono esaminati questi tipi di blocchi solo a livello di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-564">Intent locks improve performance because the [!INCLUDE[ssDE](../includes/ssde-md.md)] examines intent locks only at the table level to determine if a transaction can safely acquire a lock on that table.</span></span> <span data-ttu-id="ca04c-565">In questo modo, l'esame di ogni singola riga o pagina della tabella non risulta più necessario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-565">This removes the requirement to examine every row or page lock on the table to determine if a transaction can lock the entire table.</span></span>  
  
 <span data-ttu-id="ca04c-566">Tra i blocchi preventivi sono inclusi i blocchi preventivi condivisi (IS), i blocchi preventivi esclusivi (IX) e i blocchi preventivi esclusivi condivisi (SIX).</span><span class="sxs-lookup"><span data-stu-id="ca04c-566">Intent locks include intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>  
  
|<span data-ttu-id="ca04c-567">Modalità blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-567">Lock mode</span></span>|<span data-ttu-id="ca04c-568">Descrizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-568">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="ca04c-569">Blocco preventivo condiviso (IS)</span><span class="sxs-lookup"><span data-stu-id="ca04c-569">Intent shared (IS)</span></span>|<span data-ttu-id="ca04c-570">Consente di proteggere i blocchi condivisi richiesti o acquisiti su alcune risorse, ma non tutte, di livello inferiore nella gerarchia.</span><span class="sxs-lookup"><span data-stu-id="ca04c-570">Protects requested or acquired shared locks on some (but not all) resources lower in the hierarchy.</span></span>|  
|<span data-ttu-id="ca04c-571">Blocco preventivo esclusivo (IX)</span><span class="sxs-lookup"><span data-stu-id="ca04c-571">Intent exclusive (IX)</span></span>|<span data-ttu-id="ca04c-572">Consente di proteggere i blocchi esclusivi richiesti o acquisiti su alcune risorse, ma non tutte, di livello inferiore nella gerarchia.</span><span class="sxs-lookup"><span data-stu-id="ca04c-572">Protects requested or acquired exclusive locks on some (but not all) resources lower in the hierarchy.</span></span> <span data-ttu-id="ca04c-573">IX rappresenta un superset di IS e consente inoltre di proteggere la richiesta di blocchi condivisi sulle risorse di livello inferiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-573">IX is a superset of IS, and it also protects requesting shared locks on lower level resources.</span></span>|  
|<span data-ttu-id="ca04c-574">Blocco condiviso preventivo esclusivo (SIX)</span><span class="sxs-lookup"><span data-stu-id="ca04c-574">Shared with intent exclusive (SIX)</span></span>|<span data-ttu-id="ca04c-575">Consente di proteggere i blocchi condivisi richiesti o acquisiti su tutte le risorse di livello inferiore nella gerarchia e i blocchi preventivi esclusivi su alcune risorse, ma non tutte, di livello inferiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-575">Protects requested or acquired shared locks on all resources lower in the hierarchy and intent exclusive locks on some (but not all) of the lower level resources.</span></span> <span data-ttu-id="ca04c-576">I blocchi IS simultanei possono essere applicati alle risorse di livello principale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-576">Concurrent IS locks at the top-level resource are allowed.</span></span> <span data-ttu-id="ca04c-577">L'acquisizione di un blocco SIX su una tabella, ad esempio, comporta inoltre l'acquisizione di blocchi preventivi esclusivi sulle pagine di cui è in corso la modifica e di blocchi esclusivi sulle righe modificate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-577">For example, acquiring a SIX lock on a table also acquires intent exclusive locks on the pages being modified and exclusive locks on the modified rows.</span></span> <span data-ttu-id="ca04c-578">In un momento specifico è possibile impostare su ogni risorsa un solo blocco SIX per impedire aggiornamenti della risorsa da parte di altre transazioni, le quali, tuttavia, possono leggere le risorse di livello inferiore nella gerarchia ottenendo blocchi IS a livello di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-578">There can be only one SIX lock per resource at one time, preventing updates to the resource made by other transactions, although other transactions can read resources lower in the hierarchy by obtaining IS locks at the table level.</span></span>|  
|<span data-ttu-id="ca04c-579">Aggiornamento preventivo (IU)</span><span class="sxs-lookup"><span data-stu-id="ca04c-579">Intent update (IU)</span></span>|<span data-ttu-id="ca04c-580">Consente di proteggere i blocchi di aggiornamento richiesti o acquisiti su tutte le risorse di livello inferiore nella gerarchia.</span><span class="sxs-lookup"><span data-stu-id="ca04c-580">Protects requested or acquired update locks on all resources lower in the hierarchy.</span></span> <span data-ttu-id="ca04c-581">I blocchi IU vengono utilizzati solo sulle pagine.</span><span class="sxs-lookup"><span data-stu-id="ca04c-581">IU locks are used only on page resources.</span></span> <span data-ttu-id="ca04c-582">Tali blocchi vengono convertiti in blocchi IX se viene eseguita un'operazione di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-582">IU locks are converted to IX locks if an update operation takes place.</span></span>|  
|<span data-ttu-id="ca04c-583">Condiviso preventivo aggiornamento (SIU)</span><span class="sxs-lookup"><span data-stu-id="ca04c-583">Shared intent update (SIU)</span></span>|<span data-ttu-id="ca04c-584">Combinazione di blocchi S e IU, in seguito all'acquisizione di tali blocchi in modo distinto e simultaneo mantenendo entrambi i blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-584">A combination of S and IU locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span> <span data-ttu-id="ca04c-585">Una transazione, ad esempio, esegue una query con l'hint PAGLOCK e quindi effettua un'operazione di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-585">For example, a transaction executes a query with the PAGLOCK hint and then executes an update operation.</span></span> <span data-ttu-id="ca04c-586">La query con l'hint PAGLOCK acquisisce il blocco S, mentre l'operazione di aggiornamento acquisisce il blocco IU.</span><span class="sxs-lookup"><span data-stu-id="ca04c-586">The query with the PAGLOCK hint acquires the S lock, and the update operation acquires the IU lock.</span></span>|  
|<span data-ttu-id="ca04c-587">Aggiornamento preventivo esclusivo (UIX)</span><span class="sxs-lookup"><span data-stu-id="ca04c-587">Update intent exclusive (UIX)</span></span>|<span data-ttu-id="ca04c-588">Combinazione di blocchi U e IX, in seguito all'acquisizione di tali blocchi in modo distinto e simultaneo mantenendo entrambi i blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-588">A combination of U and IX locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span>|  
  
#### <a name="schema-locks"></a><span data-ttu-id="ca04c-589">Blocchi di schema</span><span class="sxs-lookup"><span data-stu-id="ca04c-589">Schema Locks</span></span>  

 <span data-ttu-id="ca04c-590">In [!INCLUDE[ssDE](../includes/ssde-md.md)] i blocchi di modifica dello schema (Sch-M) vengono utilizzati durante un'operazione DDL (Data Definition Language) su una tabella, ad esempio l'aggiunta di una colonna o l'eliminazione di una tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-590">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema modification (Sch-M) locks during a table data definition language (DDL) operation, such as adding a column or dropping a table.</span></span> <span data-ttu-id="ca04c-591">Finché viene mantenuto attivo, il blocco Sch-M impedisce l'accesso simultaneo alla tabella,</span><span class="sxs-lookup"><span data-stu-id="ca04c-591">During the time that it is held, the Sch-M lock prevents concurrent access to the table.</span></span> <span data-ttu-id="ca04c-592">ovvero blocca tutte le operazioni esterne.</span><span class="sxs-lookup"><span data-stu-id="ca04c-592">This means the Sch-M lock blocks all outside operations until the lock is released.</span></span>  
  
 <span data-ttu-id="ca04c-593">Alcune operazioni DML (Data Manipulation Language), ad esempio il troncamento delle tabelle, utilizzano i blocchi Sch-M per impedire l'accesso alle tabelle interessate da parte di operazioni simultanee.</span><span class="sxs-lookup"><span data-stu-id="ca04c-593">Some data manipulation language (DML) operations, such as table truncation, use Sch-M locks to prevent access to affected tables by concurrent operations.</span></span>  
  
 <span data-ttu-id="ca04c-594">In [!INCLUDE[ssDE](../includes/ssde-md.md)] vengono utilizzati i blocchi di stabilità dello schema (Sch-S) durante la compilazione e l'esecuzione delle query.</span><span class="sxs-lookup"><span data-stu-id="ca04c-594">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema stability (Sch-S) locks when compiling and executing queries.</span></span> <span data-ttu-id="ca04c-595">Questo tipo di blocco non esclude i blocchi transazionali, inclusi i blocchi esclusivi (X).</span><span class="sxs-lookup"><span data-stu-id="ca04c-595">Sch-S locks do not block any transactional locks, including exclusive (X) locks.</span></span> <span data-ttu-id="ca04c-596">Durante la compilazione di una query è pertanto possibile continuare l'esecuzione di altre transazioni, incluse quelle che prevedono blocchi X su tabelle.</span><span class="sxs-lookup"><span data-stu-id="ca04c-596">Therefore, other transactions, including those with X locks on a table, continue to run while a query is being compiled.</span></span> <span data-ttu-id="ca04c-597">Non è tuttavia possibile eseguire su tabelle operazioni DDL e DML simultanee che acquisiscono blocchi Sch-M.</span><span class="sxs-lookup"><span data-stu-id="ca04c-597">However, concurrent DDL operations, and concurrent DML operations that acquire Sch-M locks, cannot be performed on the table.</span></span>  
  
#### <a name="bulk-update-locks"></a><span data-ttu-id="ca04c-598">Blocchi aggiornamenti bulk</span><span class="sxs-lookup"><span data-stu-id="ca04c-598">Bulk Update Locks</span></span>  

 <span data-ttu-id="ca04c-599">I blocchi aggiornamenti bulk consentono a più thread di eseguire operazioni simultanee di caricamento bulk dei dati nella stessa tabella, impedendo l'accesso alla tabella ai processi che non eseguono il caricamento bulk.</span><span class="sxs-lookup"><span data-stu-id="ca04c-599">Bulk update (BU) locks allow multiple threads to bulk load data concurrently into the same table while preventing other processes that are not bulk loading data from accessing the table.</span></span> <span data-ttu-id="ca04c-600">Il [!INCLUDE[ssDE](../includes/ssde-md.md)] utilizza i blocchi di aggiornamento bulk quando vengono soddisfatte entrambe le condizioni seguenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-600">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses bulk update (BU) locks when both of the following conditions are true.</span></span>  
  
-   <span data-ttu-id="ca04c-601">Si utilizza l'istruzione Transact-SQL BULK INSERT o la funzione OPENROWSET(BULK) oppure si utilizza uno dei comandi Bulk Insert dell'API, ad esempio .NET SqlBulkCopy, le API Fast Load di OLEDB o le API Bulk Copy di ODBC per eseguire la copia bulk dei dati in una tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-601">You use the Transact-SQL BULK INSERT statement, or the OPENROWSET(BULK) function, or you use one of the Bulk Insert API commands such as .NET SqlBulkCopy, OLEDB Fast Load APIs, or the ODBC Bulk Copy APIs to bulk copy data into a table.</span></span>  
  
-   <span data-ttu-id="ca04c-602">L'hint **TABLOCK** è specificato o l'opzione della tabella **table lock on bulk load** è impostata tramite **sp_tableoption**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-602">The **TABLOCK** hint is specified or the **table lock on bulk load** table option is set using **sp_tableoption**.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="ca04c-603">A differenza dell'istruzione BULK INSERT, che contiene un blocco di aggiornamento bulk meno restrittivo, l'istruzione INSERT INTO...SELECT con l'hint TABLOCK contiene un blocco esclusivo (X) sulla tabella</span><span class="sxs-lookup"><span data-stu-id="ca04c-603">Unlike the BULK INSERT statement, which holds a less restrictive Bulk Update lock, INSERT INTO...SELECT with the TABLOCK hint holds an exclusive (X) lock on the table.</span></span> <span data-ttu-id="ca04c-604">che non consente di inserire righe utilizzando operazioni di inserimento parallele.</span><span class="sxs-lookup"><span data-stu-id="ca04c-604">This means that you cannot insert rows using parallel insert operations.</span></span>  
  
#### <a name="key-range-locks"></a><span data-ttu-id="ca04c-605">Blocchi intervalli di chiavi</span><span class="sxs-lookup"><span data-stu-id="ca04c-605">Key-Range Locks</span></span>  

 <span data-ttu-id="ca04c-606">I blocchi di intervalli di chiavi consentono di proteggere un intervallo di righe incluse in modo implicito in un set di record letto da un'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] in fase di utilizzo del livello di isolamento Serializable della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-606">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="ca04c-607">Il blocco di intervalli di chiavi impedisce le letture fantasma,</span><span class="sxs-lookup"><span data-stu-id="ca04c-607">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="ca04c-608">Tramite la protezione degli intervalli di chiavi tra righe, tali blocchi impediscono inserimenti o eliminazioni fantasma in un recordset a cui accede una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-608">By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.</span></span>  
  
### <a name="lock-compatibility"></a><span data-ttu-id="ca04c-609">Compatibilità tra blocchi</span><span class="sxs-lookup"><span data-stu-id="ca04c-609">Lock Compatibility</span></span>  

 <span data-ttu-id="ca04c-610">La compatibilità tra blocchi consente di stabilire se più transazioni possono acquisire blocchi sulla stessa risorsa contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-610">Lock compatibility controls whether multiple transactions can acquire locks on the same resource at the same time.</span></span> <span data-ttu-id="ca04c-611">Se una risorsa è già bloccata da un'altra transazione, è possibile autorizzare una nuova richiesta di blocco solo se la modalità di blocco richiesta è compatibile con quella esistente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-611">If a resource is already locked by another transaction, a new lock request can be granted only if the mode of the requested lock is compatible with the mode of the existing lock.</span></span> <span data-ttu-id="ca04c-612">In caso contrario, la transazione che richiede il nuovo blocco deve attendere il rilascio del blocco esistente oppure la scadenza dell'intervallo di timeout del blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-612">If the mode of the requested lock is not compatible with the existing lock, the transaction requesting the new lock waits for the existing lock to be released or for the lock timeout interval to expire.</span></span> <span data-ttu-id="ca04c-613">Non vi sono, ad esempio, modalità di blocco compatibili con i blocchi esclusivi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-613">For example, no lock modes are compatible with exclusive locks.</span></span> <span data-ttu-id="ca04c-614">In caso di presenza di un blocco esclusivo (X), nessun'altra transazione può acquisire altri blocchi di qualsiasi tipo, ovvero condivisi, di aggiornamento o esclusivi, sulla stessa risorsa fino a quando il blocco esclusivo (X) non viene rilasciato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-614">While an exclusive (X) lock is held, no other transaction can acquire a lock of any kind (shared, update, or exclusive) on that resource until the exclusive (X) lock is released.</span></span> <span data-ttu-id="ca04c-615">Se invece è stato applicato a una risorsa un blocco condiviso (S), le altre transazioni possono acquisire un blocco condiviso o un blocco di aggiornamento (U) sullo stesso elemento anche prima del completamento della prima transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-615">Alternatively, if a shared (S) lock has been applied to a resource, other transactions can also acquire a shared lock or an update (U) lock on that item even if the first transaction has not completed.</span></span> <span data-ttu-id="ca04c-616">Le altre transazioni, tuttavia, possono acquisire un blocco esclusivo solo dopo il rilascio del blocco condiviso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-616">However, other transactions cannot acquire an exclusive lock until the shared lock has been released.</span></span>  
  
 <span data-ttu-id="ca04c-617">Nella tabella seguente viene illustrata la compatibilità delle modalità di blocco più comuni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-617">The following table shows the compatibility of the most commonly encountered lock modes.</span></span>  
  
||<span data-ttu-id="ca04c-618">Modalità concessa esistente</span><span class="sxs-lookup"><span data-stu-id="ca04c-618">Existing granted mode</span></span>||||||  
|------|---------------------------|------|------|------|------|------|  
|<span data-ttu-id="ca04c-619">**Modalità richiesta**</span><span class="sxs-lookup"><span data-stu-id="ca04c-619">**Requested mode**</span></span>|<span data-ttu-id="ca04c-620">**IS**</span><span class="sxs-lookup"><span data-stu-id="ca04c-620">**IS**</span></span>|<span data-ttu-id="ca04c-621">**S**</span><span class="sxs-lookup"><span data-stu-id="ca04c-621">**S**</span></span>|<span data-ttu-id="ca04c-622">**U**</span><span class="sxs-lookup"><span data-stu-id="ca04c-622">**U**</span></span>|<span data-ttu-id="ca04c-623">**IX**</span><span class="sxs-lookup"><span data-stu-id="ca04c-623">**IX**</span></span>|<span data-ttu-id="ca04c-624">**SIX**</span><span class="sxs-lookup"><span data-stu-id="ca04c-624">**SIX**</span></span>|<span data-ttu-id="ca04c-625">**X**</span><span class="sxs-lookup"><span data-stu-id="ca04c-625">**X**</span></span>|  
|<span data-ttu-id="ca04c-626">**Blocco preventivo condiviso (IS)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-626">**Intent shared (IS)**</span></span>|<span data-ttu-id="ca04c-627">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-627">Yes</span></span>|<span data-ttu-id="ca04c-628">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-628">Yes</span></span>|<span data-ttu-id="ca04c-629">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-629">Yes</span></span>|<span data-ttu-id="ca04c-630">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-630">Yes</span></span>|<span data-ttu-id="ca04c-631">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-631">Yes</span></span>|<span data-ttu-id="ca04c-632">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-632">No</span></span>|  
|<span data-ttu-id="ca04c-633">**Condiviso (S)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-633">**Shared (S)**</span></span>|<span data-ttu-id="ca04c-634">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-634">Yes</span></span>|<span data-ttu-id="ca04c-635">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-635">Yes</span></span>|<span data-ttu-id="ca04c-636">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-636">Yes</span></span>|<span data-ttu-id="ca04c-637">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-637">No</span></span>|<span data-ttu-id="ca04c-638">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-638">No</span></span>|<span data-ttu-id="ca04c-639">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-639">No</span></span>|  
|<span data-ttu-id="ca04c-640">**Aggiornamento (U)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-640">**Update (U)**</span></span>|<span data-ttu-id="ca04c-641">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-641">Yes</span></span>|<span data-ttu-id="ca04c-642">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-642">Yes</span></span>|<span data-ttu-id="ca04c-643">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-643">No</span></span>|<span data-ttu-id="ca04c-644">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-644">No</span></span>|<span data-ttu-id="ca04c-645">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-645">No</span></span>|<span data-ttu-id="ca04c-646">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-646">No</span></span>|  
|<span data-ttu-id="ca04c-647">**Blocco preventivo esclusivo (IX)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-647">**Intent exclusive (IX)**</span></span>|<span data-ttu-id="ca04c-648">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-648">Yes</span></span>|<span data-ttu-id="ca04c-649">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-649">No</span></span>|<span data-ttu-id="ca04c-650">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-650">No</span></span>|<span data-ttu-id="ca04c-651">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-651">Yes</span></span>|<span data-ttu-id="ca04c-652">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-652">No</span></span>|<span data-ttu-id="ca04c-653">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-653">No</span></span>|  
|<span data-ttu-id="ca04c-654">**Blocco condiviso preventivo esclusivo (SIX)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-654">**Shared with intent exclusive (SIX)**</span></span>|<span data-ttu-id="ca04c-655">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-655">Yes</span></span>|<span data-ttu-id="ca04c-656">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-656">No</span></span>|<span data-ttu-id="ca04c-657">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-657">No</span></span>|<span data-ttu-id="ca04c-658">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-658">No</span></span>|<span data-ttu-id="ca04c-659">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-659">No</span></span>|<span data-ttu-id="ca04c-660">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-660">No</span></span>|  
|<span data-ttu-id="ca04c-661">**Esclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-661">**Exclusive (X)**</span></span>|<span data-ttu-id="ca04c-662">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-662">No</span></span>|<span data-ttu-id="ca04c-663">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-663">No</span></span>|<span data-ttu-id="ca04c-664">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-664">No</span></span>|<span data-ttu-id="ca04c-665">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-665">No</span></span>|<span data-ttu-id="ca04c-666">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-666">No</span></span>|<span data-ttu-id="ca04c-667">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-667">No</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-668">I blocchi preventivi esclusivi (IX) sono compatibili con la modalità di blocco IX perché tale modalità prevede l'intenzione di aggiornamento solo di alcune righe e non di tutte.</span><span class="sxs-lookup"><span data-stu-id="ca04c-668">An intent exclusive (IX) lock is compatible with an IX lock mode because IX means the intention is to update only some of the rows rather than all of them.</span></span> <span data-ttu-id="ca04c-669">Altre transazioni possono pertanto accedere alle risorse per la lettura o l'aggiornamento di alcune righe, a condizione che non utilizzino le righe già in fase di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-669">Other transactions that attempt to read or update some of the rows are also permitted as long as they are not the same rows being updated by other transactions.</span></span> <span data-ttu-id="ca04c-670">Se viene eseguito il tentativo di aggiornare la stessa riga da parte di due transazioni, a entrambe viene concesso il blocco IX a livello di tabella e pagina.</span><span class="sxs-lookup"><span data-stu-id="ca04c-670">Further, if two transactions attempt to update the same row, both transactions will be granted an IX lock at table and page level.</span></span> <span data-ttu-id="ca04c-671">Un blocco X a livello di riga viene tuttavia concesso a una delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-671">However, one transaction will be granted an X lock at row level.</span></span> <span data-ttu-id="ca04c-672">L'altra transazione dovrà rimanere in attesa fino alla rimozione di tale blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-672">The other transaction must wait until the row-level lock is removed.</span></span>  
  
 <span data-ttu-id="ca04c-673">Utilizzare la tabella seguente per determinare la compatibilità di tutte le modalità di blocco disponibili in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-673">Use the following table to determine the compatibility of all the lock modes available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="ca04c-674">![Diagramma che illustra la matrice di compatibilità dei blocchi](media/lockconflicttable.gif "Diagramma che illustra la matrice di compatibilità dei blocchi")</span><span class="sxs-lookup"><span data-stu-id="ca04c-674">![Diagram showing lock compatibility matrix](media/lockconflicttable.gif "Diagram showing lock compatibility matrix")</span></span>  
  
### <a name="key-range-locking"></a><span data-ttu-id="ca04c-675">Blocco di intervalli di chiavi</span><span class="sxs-lookup"><span data-stu-id="ca04c-675">Key-Range Locking</span></span>  

 <span data-ttu-id="ca04c-676">I blocchi di intervalli di chiavi consentono di proteggere un intervallo di righe incluse in modo implicito in un set di record letto da un'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] in fase di utilizzo del livello di isolamento Serializable della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-676">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="ca04c-677">Con questo livello di isolamento, una query eseguita durante una transazione deve ottenere sempre lo stesso set di righe ogni volta che viene eseguita all'interno della stessa transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-677">The serializable isolation level requires that any query executed during a transaction must obtain the same set of rows every time it is executed during the transaction.</span></span> <span data-ttu-id="ca04c-678">Il blocco di intervalli di chiavi garantisce che ciò avvenga impedendo ad altre transazioni di inserire nuove righe le cui chiavi rientrerebbero nell'intervallo di chiavi letto dalla transazione serializzabile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-678">A key range lock protects this requirement by preventing other transactions from inserting new rows whose keys would fall in the range of keys read by the serializable transaction.</span></span>  
  
 <span data-ttu-id="ca04c-679">Il blocco di intervalli di chiavi impedisce le letture fantasma,</span><span class="sxs-lookup"><span data-stu-id="ca04c-679">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="ca04c-680">nonché gli inserimenti fantasma in un recordset a cui accede una transazione attraverso la protezione degli intervalli di chiavi tra le righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-680">By protecting the ranges of keys between rows, it also prevents phantom insertions into a set of records accessed by a transaction.</span></span>  
  
 <span data-ttu-id="ca04c-681">Il blocco di intervalli di chiavi viene applicato a un indice specificando i valori iniziale e finale delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-681">A key-range lock is placed on an index, specifying a beginning and ending key value.</span></span> <span data-ttu-id="ca04c-682">In questo modo si impedisce ogni tentativo di inserimento, aggiornamento o eliminazione di una riga con un valore di chiave che rientra nell'intervallo in quanto tali operazioni dovrebbero acquisire un blocco sull'indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-682">This lock blocks any attempt to insert, update, or delete any row with a key value that falls in the range because those operations would first have to acquire a lock on the index.</span></span> <span data-ttu-id="ca04c-683">Ad esempio, una transazione serializzabile può eseguire un'istruzione SELECT che legge tutte le righe i cui valori di chiave sono compresi tra **'** AAA **'** e **'** CZZ **'**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-683">For example, a serializable transaction could issue a SELECT statement that reads all rows whose key values are between **'** AAA **'** and **'** CZZ **'**.</span></span> <span data-ttu-id="ca04c-684">Un blocco di intervalli di chiavi applicato ai valori di chiave compresi tra **'** AAA **'** e **'** CZZ **'** impedisce ad altre transazioni di inserire righe con valori di chiave all'interno di tale intervallo, ad esempio **'** ADG **'** , **'** BBD **'** o **'** CAL **'** .</span><span class="sxs-lookup"><span data-stu-id="ca04c-684">A key-range lock on the key values in the range from **'** AAA **'** to **'** CZZ **'** prevents other transactions from inserting rows with key values anywhere in that range, such as **'** ADG **'**, **'** BBD **'**, or **'** CAL **'**.</span></span>  
  
#### <a name="key-range-lock-modes"></a><span data-ttu-id="ca04c-685">Modalità di blocco di intervalli di chiavi</span><span class="sxs-lookup"><span data-stu-id="ca04c-685">Key-Range Lock Modes</span></span>  

 <span data-ttu-id="ca04c-686">I blocchi di intervalli di chiavi includono sia un componente intervallo sia un componente riga nel formato intervallo-riga:</span><span class="sxs-lookup"><span data-stu-id="ca04c-686">Key-range locks include both a range and a row component specified in range-row format:</span></span>  
  
-   <span data-ttu-id="ca04c-687">Intervallo indica la modalità di blocco che protegge l'intervallo di righe compreso tra due voci di indice consecutive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-687">Range represents the lock mode protecting the range between two consecutive index entries.</span></span>  
  
-   <span data-ttu-id="ca04c-688">Riga indica la modalità di blocco che protegge la voce di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-688">Row represents the lock mode protecting the index entry.</span></span>  
  
-   <span data-ttu-id="ca04c-689">Modalità indica la modalità di blocco combinato utilizzata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-689">Mode represents the combined lock mode used.</span></span> <span data-ttu-id="ca04c-690">Le modalità di blocco di intervalli di chiavi sono composte da due parti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-690">Key-range lock modes consist of two parts.</span></span> <span data-ttu-id="ca04c-691">La prima parte rappresenta il tipo di blocco usato per bloccare l'intervallo di indici (Range*T*), mentre la seconda rappresenta il tipo di blocco usato per bloccare una chiave specifica (*K*).</span><span class="sxs-lookup"><span data-stu-id="ca04c-691">The first represents the type of lock used to lock the index range (Range*T*) and the second represents the lock type used to lock a specific key (*K*).</span></span> <span data-ttu-id="ca04c-692">Le due parti sono unite da un segno meno (-), ad esempio Range*T*-*K*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-692">The two parts are connected with a hyphen (-), such as Range*T*-*K*.</span></span>  
  
    |<span data-ttu-id="ca04c-693">Range</span><span class="sxs-lookup"><span data-stu-id="ca04c-693">Range</span></span>|<span data-ttu-id="ca04c-694">Riga</span><span class="sxs-lookup"><span data-stu-id="ca04c-694">Row</span></span>|<span data-ttu-id="ca04c-695">Mode</span><span class="sxs-lookup"><span data-stu-id="ca04c-695">Mode</span></span>|<span data-ttu-id="ca04c-696">Descrizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-696">Description</span></span>|  
    |-----------|---------|----------|-----------------|  
    |<span data-ttu-id="ca04c-697">RangeS</span><span class="sxs-lookup"><span data-stu-id="ca04c-697">RangeS</span></span>|<span data-ttu-id="ca04c-698">S</span><span class="sxs-lookup"><span data-stu-id="ca04c-698">S</span></span>|<span data-ttu-id="ca04c-699">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="ca04c-699">RangeS-S</span></span>|<span data-ttu-id="ca04c-700">Intervallo condiviso, blocco di risorsa condiviso, analisi intervallo serializzabile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-700">Shared range, shared resource lock; serializable range scan.</span></span>|  
    |<span data-ttu-id="ca04c-701">RangeS</span><span class="sxs-lookup"><span data-stu-id="ca04c-701">RangeS</span></span>|<span data-ttu-id="ca04c-702">U</span><span class="sxs-lookup"><span data-stu-id="ca04c-702">U</span></span>|<span data-ttu-id="ca04c-703">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="ca04c-703">RangeS-U</span></span>|<span data-ttu-id="ca04c-704">Intervallo condiviso, blocco di risorsa di aggiornamento; analisi aggiornamento serializzabile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-704">Shared range, update resource lock; serializable update scan.</span></span>|  
    |<span data-ttu-id="ca04c-705">RangeI</span><span class="sxs-lookup"><span data-stu-id="ca04c-705">RangeI</span></span>|<span data-ttu-id="ca04c-706">Null</span><span class="sxs-lookup"><span data-stu-id="ca04c-706">Null</span></span>|<span data-ttu-id="ca04c-707">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-707">RangeI-N</span></span>|<span data-ttu-id="ca04c-708">Intervallo di inserimento, blocco di risorsa Null; utilizzato per verificare gli intervalli prima di inserire una nuova chiave nell'indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-708">Insert range, null resource lock; used to test ranges before inserting a new key into an index.</span></span>|  
    |<span data-ttu-id="ca04c-709">RangeX</span><span class="sxs-lookup"><span data-stu-id="ca04c-709">RangeX</span></span>|<span data-ttu-id="ca04c-710">X</span><span class="sxs-lookup"><span data-stu-id="ca04c-710">X</span></span>|<span data-ttu-id="ca04c-711">RangeX-X</span><span class="sxs-lookup"><span data-stu-id="ca04c-711">RangeX-X</span></span>|<span data-ttu-id="ca04c-712">Intervallo esclusivo, blocco di risorsa esclusivo; utilizzato per aggiornare una chiave di un intervallo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-712">Exclusive range, exclusive resource lock; used when updating a key in a range.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-713">La modalità di blocco Null interna è compatibile con tutti gli altri tipi di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-713">The internal Null lock mode is compatible with all other lock modes.</span></span>  
  
 <span data-ttu-id="ca04c-714">Le modalità di blocco di intervalli di chiavi sono basate sulla matrice di compatibilità illustrata di seguito che stabilisce quali blocchi sono compatibili con quelli ottenuti dalla sovrapposizione di chiavi e intervalli.</span><span class="sxs-lookup"><span data-stu-id="ca04c-714">Key-range lock modes have a compatibility matrix that shows which locks are compatible with other locks obtained on overlapping keys and ranges.</span></span>  
  
||<span data-ttu-id="ca04c-715">Modalità concessa esistente</span><span class="sxs-lookup"><span data-stu-id="ca04c-715">Existing granted mode</span></span>|||||||  
|------|---------------------------|------|------|------|------|------|------|  
|<span data-ttu-id="ca04c-716">**Modalità richiesta**</span><span class="sxs-lookup"><span data-stu-id="ca04c-716">**Requested mode**</span></span>|<span data-ttu-id="ca04c-717">**S**</span><span class="sxs-lookup"><span data-stu-id="ca04c-717">**S**</span></span>|<span data-ttu-id="ca04c-718">**U**</span><span class="sxs-lookup"><span data-stu-id="ca04c-718">**U**</span></span>|<span data-ttu-id="ca04c-719">**X**</span><span class="sxs-lookup"><span data-stu-id="ca04c-719">**X**</span></span>|<span data-ttu-id="ca04c-720">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="ca04c-720">**RangeS-S**</span></span>|<span data-ttu-id="ca04c-721">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="ca04c-721">**RangeS-U**</span></span>|<span data-ttu-id="ca04c-722">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="ca04c-722">**RangeI-N**</span></span>|<span data-ttu-id="ca04c-723">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="ca04c-723">**RangeX-X**</span></span>|  
|<span data-ttu-id="ca04c-724">**Condiviso (S)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-724">**Shared (S)**</span></span>|<span data-ttu-id="ca04c-725">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-725">Yes</span></span>|<span data-ttu-id="ca04c-726">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-726">Yes</span></span>|<span data-ttu-id="ca04c-727">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-727">No</span></span>|<span data-ttu-id="ca04c-728">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-728">Yes</span></span>|<span data-ttu-id="ca04c-729">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-729">Yes</span></span>|<span data-ttu-id="ca04c-730">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-730">Yes</span></span>|<span data-ttu-id="ca04c-731">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-731">No</span></span>|  
|<span data-ttu-id="ca04c-732">**Aggiornamento (U)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-732">**Update (U)**</span></span>|<span data-ttu-id="ca04c-733">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-733">Yes</span></span>|<span data-ttu-id="ca04c-734">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-734">No</span></span>|<span data-ttu-id="ca04c-735">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-735">No</span></span>|<span data-ttu-id="ca04c-736">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-736">Yes</span></span>|<span data-ttu-id="ca04c-737">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-737">No</span></span>|<span data-ttu-id="ca04c-738">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-738">Yes</span></span>|<span data-ttu-id="ca04c-739">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-739">No</span></span>|  
|<span data-ttu-id="ca04c-740">**Esclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="ca04c-740">**Exclusive (X)**</span></span>|<span data-ttu-id="ca04c-741">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-741">No</span></span>|<span data-ttu-id="ca04c-742">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-742">No</span></span>|<span data-ttu-id="ca04c-743">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-743">No</span></span>|<span data-ttu-id="ca04c-744">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-744">No</span></span>|<span data-ttu-id="ca04c-745">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-745">No</span></span>|<span data-ttu-id="ca04c-746">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-746">Yes</span></span>|<span data-ttu-id="ca04c-747">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-747">No</span></span>|  
|<span data-ttu-id="ca04c-748">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="ca04c-748">**RangeS-S**</span></span>|<span data-ttu-id="ca04c-749">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-749">Yes</span></span>|<span data-ttu-id="ca04c-750">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-750">Yes</span></span>|<span data-ttu-id="ca04c-751">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-751">No</span></span>|<span data-ttu-id="ca04c-752">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-752">Yes</span></span>|<span data-ttu-id="ca04c-753">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-753">Yes</span></span>|<span data-ttu-id="ca04c-754">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-754">No</span></span>|<span data-ttu-id="ca04c-755">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-755">No</span></span>|  
|<span data-ttu-id="ca04c-756">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="ca04c-756">**RangeS-U**</span></span>|<span data-ttu-id="ca04c-757">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-757">Yes</span></span>|<span data-ttu-id="ca04c-758">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-758">No</span></span>|<span data-ttu-id="ca04c-759">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-759">No</span></span>|<span data-ttu-id="ca04c-760">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-760">Yes</span></span>|<span data-ttu-id="ca04c-761">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-761">No</span></span>|<span data-ttu-id="ca04c-762">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-762">No</span></span>|<span data-ttu-id="ca04c-763">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-763">No</span></span>|  
|<span data-ttu-id="ca04c-764">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="ca04c-764">**RangeI-N**</span></span>|<span data-ttu-id="ca04c-765">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-765">Yes</span></span>|<span data-ttu-id="ca04c-766">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-766">Yes</span></span>|<span data-ttu-id="ca04c-767">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-767">Yes</span></span>|<span data-ttu-id="ca04c-768">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-768">No</span></span>|<span data-ttu-id="ca04c-769">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-769">No</span></span>|<span data-ttu-id="ca04c-770">Sì</span><span class="sxs-lookup"><span data-stu-id="ca04c-770">Yes</span></span>|<span data-ttu-id="ca04c-771">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-771">No</span></span>|  
|<span data-ttu-id="ca04c-772">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="ca04c-772">**RangeX-X**</span></span>|<span data-ttu-id="ca04c-773">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-773">No</span></span>|<span data-ttu-id="ca04c-774">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-774">No</span></span>|<span data-ttu-id="ca04c-775">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-775">No</span></span>|<span data-ttu-id="ca04c-776">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-776">No</span></span>|<span data-ttu-id="ca04c-777">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-777">No</span></span>|<span data-ttu-id="ca04c-778">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-778">No</span></span>|<span data-ttu-id="ca04c-779">No</span><span class="sxs-lookup"><span data-stu-id="ca04c-779">No</span></span>|  
  
#### <a name="conversion-locks"></a><span data-ttu-id="ca04c-780">Blocchi di conversione</span><span class="sxs-lookup"><span data-stu-id="ca04c-780">Conversion Locks</span></span>  

 <span data-ttu-id="ca04c-781">I blocchi di conversione vengono creati quando un blocco di intervalli di chiavi è sovrapposto a un altro blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-781">Conversion locks are created when a key-range lock overlaps another lock.</span></span>  
  
|<span data-ttu-id="ca04c-782">Blocco 1</span><span class="sxs-lookup"><span data-stu-id="ca04c-782">Lock 1</span></span>|<span data-ttu-id="ca04c-783">Blocco 2</span><span class="sxs-lookup"><span data-stu-id="ca04c-783">Lock 2</span></span>|<span data-ttu-id="ca04c-784">Blocco di conversione</span><span class="sxs-lookup"><span data-stu-id="ca04c-784">Conversion lock</span></span>|  
|------------|------------|---------------------|  
|<span data-ttu-id="ca04c-785">S</span><span class="sxs-lookup"><span data-stu-id="ca04c-785">S</span></span>|<span data-ttu-id="ca04c-786">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-786">RangeI-N</span></span>|<span data-ttu-id="ca04c-787">RangeI-S</span><span class="sxs-lookup"><span data-stu-id="ca04c-787">RangeI-S</span></span>|  
|<span data-ttu-id="ca04c-788">U</span><span class="sxs-lookup"><span data-stu-id="ca04c-788">U</span></span>|<span data-ttu-id="ca04c-789">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-789">RangeI-N</span></span>|<span data-ttu-id="ca04c-790">RangeI-U</span><span class="sxs-lookup"><span data-stu-id="ca04c-790">RangeI-U</span></span>|  
|<span data-ttu-id="ca04c-791">X</span><span class="sxs-lookup"><span data-stu-id="ca04c-791">X</span></span>|<span data-ttu-id="ca04c-792">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-792">RangeI-N</span></span>|<span data-ttu-id="ca04c-793">RangeI-X</span><span class="sxs-lookup"><span data-stu-id="ca04c-793">RangeI-X</span></span>|  
|<span data-ttu-id="ca04c-794">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-794">RangeI-N</span></span>|<span data-ttu-id="ca04c-795">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="ca04c-795">RangeS-S</span></span>|<span data-ttu-id="ca04c-796">RangeX-S</span><span class="sxs-lookup"><span data-stu-id="ca04c-796">RangeX-S</span></span>|  
|<span data-ttu-id="ca04c-797">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="ca04c-797">RangeI-N</span></span>|<span data-ttu-id="ca04c-798">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="ca04c-798">RangeS-U</span></span>|<span data-ttu-id="ca04c-799">RangeX-U</span><span class="sxs-lookup"><span data-stu-id="ca04c-799">RangeX-U</span></span>|  
  
 <span data-ttu-id="ca04c-800">I blocchi di conversione possono essere osservati per un breve periodo di tempo in diverse circostanze complesse, in alcuni casi durante l'esecuzione di processi simultanei.</span><span class="sxs-lookup"><span data-stu-id="ca04c-800">Conversion locks can be observed for a short period of time under different complex circumstances, sometimes while running concurrent processes.</span></span>  
  
#### <a name="serializable-range-scan-singleton-fetch-delete-and-insert"></a><span data-ttu-id="ca04c-801">Analisi intervallo serializzabile, recupero singleton, eliminazione e inserimento</span><span class="sxs-lookup"><span data-stu-id="ca04c-801">Serializable Range Scan, Singleton Fetch, Delete, and Insert</span></span>  

 <span data-ttu-id="ca04c-802">Il blocco di intervalli di chiavi garantisce la serializzabilità quando si eseguono le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-802">Key-range locking ensures that the following operations are serializable:</span></span>  
  
-   <span data-ttu-id="ca04c-803">Query di analisi intervallo</span><span class="sxs-lookup"><span data-stu-id="ca04c-803">Range scan query</span></span>  
  
-   <span data-ttu-id="ca04c-804">Recupero singleton di righe inesistenti</span><span class="sxs-lookup"><span data-stu-id="ca04c-804">Singleton fetch of nonexistent row</span></span>  
  
-   <span data-ttu-id="ca04c-805">Operazioni di eliminazione</span><span class="sxs-lookup"><span data-stu-id="ca04c-805">Delete operation</span></span>  
  
-   <span data-ttu-id="ca04c-806">Operazioni di inserimento</span><span class="sxs-lookup"><span data-stu-id="ca04c-806">Insert operation</span></span>  
  
 <span data-ttu-id="ca04c-807">Prima di eseguire un blocco di intervalli di chiavi, è necessario che siano soddisfatte le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-807">Before key-range locking can occur, the following conditions must be satisfied:</span></span>  
  
-   <span data-ttu-id="ca04c-808">Il livello di isolamento della transazione deve essere impostato su SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-808">The transaction-isolation level must be set to SERIALIZABLE.</span></span>  
  
-   <span data-ttu-id="ca04c-809">Query Processor deve utilizzare un indice per implementare il predicato di filtro dell'intervallo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-809">The query processor must use an index to implement the range filter predicate.</span></span> <span data-ttu-id="ca04c-810">La clausola WHERE in un'istruzione SELECT potrebbe, ad esempio, stabilire una condizione di intervallo con il predicato seguente: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'** .</span><span class="sxs-lookup"><span data-stu-id="ca04c-810">For example, the WHERE clause in a SELECT statement could establish a range condition with this predicate: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'**.</span></span> <span data-ttu-id="ca04c-811">Un blocco di intervalli di chiavi può essere acquisito solo se **ColumnX** è coperto da una chiave di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-811">A key-range lock can only be acquired if **ColumnX** is covered by an index key.</span></span>  
  
#### <a name="examples"></a><span data-ttu-id="ca04c-812">Esempi</span><span class="sxs-lookup"><span data-stu-id="ca04c-812">Examples</span></span>  

 <span data-ttu-id="ca04c-813">Gli esempi di blocco di intervalli di chiavi illustrati si basano sulla tabella e sull'indice seguenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-813">The following table and index are used as a basis for the key-range locking examples that follow.</span></span>  
  
 <span data-ttu-id="ca04c-814">![Illustrazione di una tabella di database con albero B dell'indice](media/btree4.gif "Illustrazione di una tabella di database con albero B dell'indice")</span><span class="sxs-lookup"><span data-stu-id="ca04c-814">![Database table with index b-tree illustration](media/btree4.gif "Database table with index b-tree illustration")</span></span>  
  
##### <a name="range-scan-query"></a><span data-ttu-id="ca04c-815">Query di analisi intervallo</span><span class="sxs-lookup"><span data-stu-id="ca04c-815">Range Scan Query</span></span>  

 <span data-ttu-id="ca04c-816">Per assicurare che una query per l'analisi di intervalli sia serializzabile, è necessario che la query restituisca gli stessi risultati a ogni esecuzione all'interno della stessa transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-816">To ensure a range scan query is serializable, the same query should return the same results each time it is executed within the same transaction.</span></span> <span data-ttu-id="ca04c-817">Altre transazioni non devono inserire nuove righe nella query per l'analisi di intervalli in quanto le righe potrebbero diventare inserimenti fantasma.</span><span class="sxs-lookup"><span data-stu-id="ca04c-817">New rows must not be inserted within the range scan query by other transactions; otherwise, these become phantom inserts.</span></span> <span data-ttu-id="ca04c-818">Nella query seguente vengono ad esempio utilizzati la tabella e l'indice illustrati nella figura precedente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-818">For example, the following query uses the table and index in the previous illustration:</span></span>  
  
```sql  
SELECT name  
    FROM mytable  
    WHERE name BETWEEN 'A' AND 'C';  
```  
  
 <span data-ttu-id="ca04c-819">I blocchi di intervalli di chiavi vengono applicati alle voci di indice che corrispondono all'intervallo delle righe di dati in cui il nome è compreso tra i valori Adam e Dale, in modo da impedire l'inserimento o l'eliminazione di nuove righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-819">Key-range locks are placed on the index entries corresponding to the range of data rows where the name is between the values Adam and Dale, preventing new rows qualifying in the previous query from being added or deleted.</span></span> <span data-ttu-id="ca04c-820">Sebbene il primo nome dell'intervallo sia Adam, il blocco di intervalli di chiavi in modalità RangeS-S applicato a questa voce di indice impedisce l'aggiunta prima del nome Adam di nuovi nomi che iniziano con la lettera A, ad esempio Abigail.</span><span class="sxs-lookup"><span data-stu-id="ca04c-820">Although the first name in this range is Adam, the RangeS-S mode key-range lock on this index entry ensures that no new names beginning with the letter A can be added before Adam, such as Abigail.</span></span> <span data-ttu-id="ca04c-821">In modo analogo, il blocco di intervalli di chiavi RangeS-S applicato alla voce di indice Dale impedisce l'aggiunta dopo il nome Carlos di nuovi nomi che iniziano con la lettera C, ad esempio Clive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-821">Similarly, the RangeS-S key-range lock on the index entry for Dale ensures that no new names beginning with the letter C can be added after Carlos, such as Clive.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-822">Il numero di blocchi RangeS-S mantenuti attivi è *n*+1, dove *n* è il numero di righe che soddisfano la query.</span><span class="sxs-lookup"><span data-stu-id="ca04c-822">The number of RangeS-S locks held is *n*+1, where *n* is the number of rows that satisfy the query.</span></span>  
  
##### <a name="singleton-fetch-of-nonexistent-data"></a><span data-ttu-id="ca04c-823">Recupero singleton di dati inesistenti</span><span class="sxs-lookup"><span data-stu-id="ca04c-823">Singleton Fetch of Nonexistent Data</span></span>  

 <span data-ttu-id="ca04c-824">Se una query di una transazione tenta di selezionare una riga inesistente, la successiva esecuzione della query all'interno della stessa transazione deve restituire il medesimo risultato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-824">If a query within a transaction attempts to select a row that does not exist, issuing the query at a later point within the same transaction has to return the same result.</span></span> <span data-ttu-id="ca04c-825">A nessun'altra transazione è consentito inserire la riga inesistente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-825">No other transaction can be allowed to insert that nonexistent row.</span></span> <span data-ttu-id="ca04c-826">Si consideri ad esempio la query seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-826">For example, given this query:</span></span>  
  
```sql 
SELECT name  
    FROM mytable  
    WHERE name = 'Bill';  
```  
  
 <span data-ttu-id="ca04c-827">Un blocco di intervalli di chiavi viene applicato alla voce di indice corrispondente all'intervallo di nomi compreso tra `Ben` e `Bing` in quanto il nome `Bill` verrebbe incluso alfabeticamente tra queste due voci di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-827">A key-range lock is placed on the index entry corresponding to the name range from `Ben` to `Bing` because the name `Bill` would be inserted between these two adjacent index entries.</span></span> <span data-ttu-id="ca04c-828">Il blocco di intervalli di chiavi in modalità RangeS-S viene applicato alla voce di indice `Bing`,</span><span class="sxs-lookup"><span data-stu-id="ca04c-828">The RangeS-S mode key-range lock is placed on the index entry `Bing`.</span></span> <span data-ttu-id="ca04c-829">impedendo così ad altre transazioni di inserire valori, ad esempio `Bill`, tra le voci di indice `Ben` e `Bing`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-829">This prevents any other transaction from inserting values, such as `Bill`, between the index entries `Ben` and `Bing`.</span></span>  
  
##### <a name="delete-operation"></a><span data-ttu-id="ca04c-830">Operazioni di eliminazione</span><span class="sxs-lookup"><span data-stu-id="ca04c-830">Delete Operation</span></span>  

 <span data-ttu-id="ca04c-831">Quando viene eliminato un valore in una transazione, l'intervallo a cui appartiene tale valore non deve necessariamente rimanere bloccato per l'intera durata della transazione che esegue l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-831">When deleting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the delete operation.</span></span> <span data-ttu-id="ca04c-832">Per mantenere la serializzabilità è infatti sufficiente bloccare il valore della chiave eliminata fino al termine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-832">Locking the deleted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="ca04c-833">Si consideri ad esempio l'istruzione DELETE seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-833">For example, given this DELETE statement:</span></span>  
  
```sql  
DELETE mytable  
    WHERE name = 'Bob';  
```  
  
 <span data-ttu-id="ca04c-834">Alla voce di indice corrispondente al nome `Bob` viene applicato un blocco esclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="ca04c-834">An exclusive (X) lock is placed on the index entry corresponding to the name `Bob`.</span></span> <span data-ttu-id="ca04c-835">Altre transazioni possono inserire o eliminare valori prima o dopo il valore eliminato `Bob`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-835">Other transactions can insert or delete values before or after the deleted value `Bob`.</span></span> <span data-ttu-id="ca04c-836">I tentativi di lettura, inserimento o eliminazione del valore `Bob` vengono invece bloccati fino a quando non viene eseguito il commit o il rollback della transazione che esegue l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-836">However, any transaction that attempts to read, insert, or delete the value `Bob` will be blocked until the deleting transaction either commits or rolls back.</span></span>  
  
 <span data-ttu-id="ca04c-837">È possibile eliminare intervalli usando tre modalità di blocco di base, ovvero il blocco di riga, il blocco di pagina o il blocco di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-837">Range delete can be executed using three basic lock modes: row, page, or table lock.</span></span> <span data-ttu-id="ca04c-838">La strategia di blocco, ovvero il blocco a livello di pagina, di tabella o di riga, viene scelta da Query Optimizer o specificata dall'utente tramite hint di ottimizzazione, ad esempio ROWLOCK, PAGLOCK o TABLOCK.</span><span class="sxs-lookup"><span data-stu-id="ca04c-838">The row, page, or table locking strategy is decided by query optimizer or can be specified by the user through optimizer hints such as ROWLOCK, PAGLOCK, or TABLOCK.</span></span> <span data-ttu-id="ca04c-839">Se si utilizza PAGLOCK o TABLOCK, [!INCLUDE[ssDE](../includes/ssde-md.md)] rilascia immediatamente la pagina di indice se vengono eliminate tutte le righe dalla pagina.</span><span class="sxs-lookup"><span data-stu-id="ca04c-839">When PAGLOCK or TABLOCK is used, the [!INCLUDE[ssDE](../includes/ssde-md.md)] immediately deallocates an index page if all rows are deleted from this page.</span></span> <span data-ttu-id="ca04c-840">Quando invece si utilizza ROWLOCK, le righe eliminate vengono semplicemente contrassegnate come eliminate e vengono rimosse dalla pagina di indice in un momento successivo tramite un processo in background.</span><span class="sxs-lookup"><span data-stu-id="ca04c-840">In contrast, when ROWLOCK is used, all deleted rows are marked only as deleted; they are removed from the index page later using a background task.</span></span>  
  
##### <a name="insert-operation"></a><span data-ttu-id="ca04c-841">Operazioni di inserimento</span><span class="sxs-lookup"><span data-stu-id="ca04c-841">Insert Operation</span></span>  

 <span data-ttu-id="ca04c-842">Quando si inserisce un valore in una transazione, l'intervallo in cui è compreso non deve essere bloccato per l'intera durata della transazione che esegue l'operazione di inserimento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-842">When inserting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="ca04c-843">Per mantenere la serializzabilità è infatti sufficiente bloccare il valore della chiave inserita fino al termine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-843">Locking the inserted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="ca04c-844">Si consideri ad esempio l'istruzione INSERT seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-844">For example, given this INSERT statement:</span></span>  
  
```sql  
INSERT mytable VALUES ('Dan');  
```  
  
 <span data-ttu-id="ca04c-845">Il blocco di intervalli di chiavi in modalità RangeI-N viene inserito nella voce di indice corrispondente al nome David per verificare l'intervallo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-845">The RangeI-N mode key-range lock is placed on the index entry corresponding to the name David to test the range.</span></span> <span data-ttu-id="ca04c-846">Se il blocco viene concesso, viene inserita la voce `Dan` e viene impostato un blocco esclusivo (X) sul valore `Dan`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-846">If the lock is granted, `Dan` is inserted and an exclusive (X) lock is placed on the value `Dan`.</span></span> <span data-ttu-id="ca04c-847">Il blocco di intervalli di chiavi in modalità RangeI-N è necessario solo per verificare l'intervallo e non viene mantenuto attivo per l'intera durata della transazione che esegue l'operazione di inserimento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-847">The RangeI-N mode key-range lock is necessary only to test the range and is not held for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="ca04c-848">Altre transazioni possono inserire o eliminare valori prima o dopo il valore inserito `Dan`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-848">Other transactions can insert or delete values before or after the inserted value `Dan`.</span></span> <span data-ttu-id="ca04c-849">Le transazioni che tuttavia tentano di leggere, inserire o eliminare il valore `Dan` sono bloccate fino a quando non viene eseguito il commit o il rollback della transazione di inserimento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-849">However, any transaction attempting to read, insert, or delete the value `Dan` will be locked until the inserting transaction either commits or rolls back.</span></span>  
  
### <a name="dynamic-locking"></a><span data-ttu-id="ca04c-850">Blocco dinamico</span><span class="sxs-lookup"><span data-stu-id="ca04c-850">Dynamic Locking</span></span>  

 <span data-ttu-id="ca04c-851">L'utilizzo dei blocchi a basso livello, ad esempio blocchi di riga, aumenta la concorrenza riducendo la probabilità che due transazioni richiedano i blocchi sullo stesso elemento di dati contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-851">Using low-level locks, such as row locks, increases concurrency by decreasing the probability that two transactions will request locks on the same piece of data at the same time.</span></span> <span data-ttu-id="ca04c-852">L'utilizzo dei blocchi a basso livello inoltre aumenta il numero dei blocchi e delle risorse necessarie a gestirli.</span><span class="sxs-lookup"><span data-stu-id="ca04c-852">Using low-level locks also increases the number of locks and the resources needed to manage them.</span></span> <span data-ttu-id="ca04c-853">I blocchi di tabella e di pagina ad alto livello comportano invece una diminuzione dell'overhead, ma a spese della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-853">Using high-level table or page locks lowers overhead, but at the expense of lowering concurrency.</span></span>  
  
 <span data-ttu-id="ca04c-854">![Diagramma di confronto tra costi e granularità](media/lockcht.gif "Diagramma di confronto tra costi e granularità")</span><span class="sxs-lookup"><span data-stu-id="ca04c-854">![Diagram showing cost versus granularity](media/lockcht.gif "Diagram showing cost versus granularity")</span></span>  
  
 <span data-ttu-id="ca04c-855">[!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa una strategia di blocco dinamico per determinare la combinazione di blocchi più efficiente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-855">The [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy to determine the most cost-effective locks.</span></span> <span data-ttu-id="ca04c-856">Il tipo di blocco più appropriato per l'esecuzione di una particolare query viene determinato in modo automatico da [!INCLUDE[ssDE](../includes/ssde-md.md)] in base alle caratteristiche dello schema e della query.</span><span class="sxs-lookup"><span data-stu-id="ca04c-856">The [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically determines what locks are most appropriate when the query is executed, based on the characteristics of the schema and query.</span></span> <span data-ttu-id="ca04c-857">Ad esempio, per ridurre l'overhead associato al blocco quando viene eseguita l'analisi di un indice, Query Optimizer potrebbe scegliere un blocco a livello di pagina per l'indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-857">For example, to reduce the overhead of locking, the optimizer may choose page-level locks in an index when performing an index scan.</span></span>  
  
 <span data-ttu-id="ca04c-858">L'utilizzo del blocco dinamico offre i vantaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-858">Dynamic locking has the following advantages:</span></span>  
  
-   <span data-ttu-id="ca04c-859">Amministrazione del database semplificata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-859">Simplified database administration.</span></span> <span data-ttu-id="ca04c-860">Gli amministratori di database non devono gestire le soglie di escalation dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-860">Database administrators do not have to adjust lock escalation thresholds.</span></span>  
  
-   <span data-ttu-id="ca04c-861">Prestazioni ottimizzate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-861">Increased performance.</span></span> <span data-ttu-id="ca04c-862">L'overhead di sistema viene ridotto al minimo in [!INCLUDE[ssDE](../includes/ssde-md.md)] tramite l'utilizzo di blocchi adatti al tipo di attività eseguita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-862">The [!INCLUDE[ssDE](../includes/ssde-md.md)] minimizes system overhead by using locks appropriate to the task.</span></span>  
  
-   <span data-ttu-id="ca04c-863">Gli sviluppatori di applicazioni possono dedicarsi interamente alle operazioni di sviluppo,</span><span class="sxs-lookup"><span data-stu-id="ca04c-863">Application developers can concentrate on development.</span></span> <span data-ttu-id="ca04c-864">in quanto i blocchi vengono modificati in modo automatico in [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-864">The [!INCLUDE[ssDE](../includes/ssde-md.md)] adjusts locking automatically.</span></span>  
  
 <span data-ttu-id="ca04c-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] e versioni successive il comportamento dell'escalation dei blocchi è stato modificato con l'introduzione dell'opzione LOCK_ESCALATION.</span><span class="sxs-lookup"><span data-stu-id="ca04c-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] and later versions, the behavior of lock escalation has changed with the introduction of the LOCK_ESCALATION option.</span></span> <span data-ttu-id="ca04c-866">Per ulteriori informazioni, vedere l'opzione LOCK_ESCALATION di [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-866">For more information, see the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="deadlocking"></a><span data-ttu-id="ca04c-867">Utilizzo di deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-867">Deadlocking</span></span>  

 <span data-ttu-id="ca04c-868">Un deadlock si verifica quando due o più attività si bloccano reciprocamente in modo permanente, in quanto ognuna delle attività prevede un blocco su una risorsa che le altre attività stanno cercando di bloccare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-868">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="ca04c-869">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="ca04c-869">For example:</span></span>  
  
-   <span data-ttu-id="ca04c-870">La transazione A acquisisce un blocco di condivisione nella riga 1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-870">Transaction A acquires a share lock on row 1.</span></span>  
  
-   <span data-ttu-id="ca04c-871">La transazione B acquisisce un blocco di condivisione nella riga 2.</span><span class="sxs-lookup"><span data-stu-id="ca04c-871">Transaction B acquires a share lock on row 2.</span></span>  
  
-   <span data-ttu-id="ca04c-872">La transazione A richiede ora un blocco esclusivo nella riga 2 ed è bloccata fino al completamento della transazione B e del relativo rilascio del blocco di condivisione nella riga 2.</span><span class="sxs-lookup"><span data-stu-id="ca04c-872">Transaction A now requests an exclusive lock on row 2, and is blocked until transaction B finishes and releases the share lock it has on row 2.</span></span>  
  
-   <span data-ttu-id="ca04c-873">La transazione B richiede ora un blocco esclusivo nella riga 1 ed è bloccata fino al completamento della transazione A e del relativo rilascio del blocco di condivisione nella riga 1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-873">Transaction B now requests an exclusive lock on row 1, and is blocked until transaction A finishes and releases the share lock it has on row 1.</span></span>  
  
 <span data-ttu-id="ca04c-874">La transazione A non può essere completata fino al completamento della transazione B, ma la transazione B è bloccata dalla transazione A. Questa condizione è detta anche dipendenza ciclica: la transazione A è dipendente dalla transazione B e la transazione B chiude il cerchio con una dipendenza rispetto alla transazione A.</span><span class="sxs-lookup"><span data-stu-id="ca04c-874">Transaction A cannot complete until transaction B completes, but transaction B is blocked by transaction A. This condition is also called a cyclic dependency: Transaction A has a dependency on transaction B, and transaction B closes the circle by having a dependency on transaction A.</span></span>  
  
 <span data-ttu-id="ca04c-875">Entrambe le transazioni in un deadlock restano in attesa per sempre fino a quando il deadlock non viene interrotto da un processo esterno.</span><span class="sxs-lookup"><span data-stu-id="ca04c-875">Both transactions in a deadlock will wait forever unless the deadlock is broken by an external process.</span></span> <span data-ttu-id="ca04c-876">La funzionalità di monitoraggio dei deadlock del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] ricerca periodicamente le attività interessate da un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-876">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] deadlock monitor periodically checks for tasks that are in a deadlock.</span></span> <span data-ttu-id="ca04c-877">Se viene rilevata una dipendenza ciclica, una delle attività viene scelta come vittima e le relative transazioni vengono terminate con un errore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-877">If the monitor detects a cyclic dependency, it chooses one of the tasks as a victim and terminates its transaction with an error.</span></span> <span data-ttu-id="ca04c-878">In questo modo l'altra attività potrà completare la propria transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-878">This allows the other task to complete its transaction.</span></span> <span data-ttu-id="ca04c-879">L'applicazione la cui transazione è stata terminata con un errore può eseguire un nuovo tentativo di transazione, che viene in genere completato al termine dell'altra transazione bloccata dal deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-879">The application with the transaction that terminated with an error can retry the transaction, which usually completes after the other deadlocked transaction has finished.</span></span>  
  
 <span data-ttu-id="ca04c-880">Spesso la condizione di deadlock viene confusa con il blocco normale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-880">Deadlocking is often confused with normal blocking.</span></span> <span data-ttu-id="ca04c-881">Quando una transazione richiede un blocco in una risorsa bloccata da un'altra transazione, la transazione che ha eseguito la richiesta resta in attesa fino quando il blocco non viene rilasciato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-881">When a transaction requests a lock on a resource locked by another transaction, the requesting transaction waits until the lock is released.</span></span> <span data-ttu-id="ca04c-882">Per impostazione predefinita, le transazioni di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] non prevedono alcun timeout, a meno che non sia stata impostata l'opzione LOCK_TIMEOUT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-882">By default, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] transactions do not time out, unless LOCK_TIMEOUT is set.</span></span> <span data-ttu-id="ca04c-883">La transazione che ha eseguito la richiesta viene bloccata, ma non tramite un deadlock, in quanto non ha tentato di bloccare la transazione proprietaria del blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-883">The requesting transaction is blocked, not deadlocked, because the requesting transaction has not done anything to block the transaction owning the lock.</span></span> <span data-ttu-id="ca04c-884">La transazione proprietaria del blocco completa e rilascia il blocco e quindi il blocco viene assegnato alla transazione che ha eseguito la richiesta, che può procedere.</span><span class="sxs-lookup"><span data-stu-id="ca04c-884">Eventually, the owning transaction will complete and release the lock, and then the requesting transaction will be granted the lock and proceed.</span></span>  
  
 <span data-ttu-id="ca04c-885">I deadlock sono a volte definiti anche blocchi critici.</span><span class="sxs-lookup"><span data-stu-id="ca04c-885">Deadlocks are sometimes called a deadly embrace.</span></span>  
  
 <span data-ttu-id="ca04c-886">Un deadlock si verifica in qualsiasi sistema con più thread e non soltanto in un sistema di gestione di database relazionali, e può interessare anche risorse diverse dai blocchi negli oggetti di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-886">Deadlock is a condition that can occur on any system with multiple threads, not just on a relational database management system, and can occur for resources other than locks on database objects.</span></span> <span data-ttu-id="ca04c-887">Un thread, ad esempio, in un sistema operativo a thread multipli può acquisire una o più risorse, ad esempio blocchi di memoria.</span><span class="sxs-lookup"><span data-stu-id="ca04c-887">For example, a thread in a multithreaded operating system might acquire one or more resources, such as blocks of memory.</span></span> <span data-ttu-id="ca04c-888">Se la risorsa che viene acquisita è già utilizzata da un altro thread, il primo thread deve aspettare che la risorsa venga rilasciata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-888">If the resource being acquired is currently owned by another thread, the first thread may have to wait for the owning thread to release the target resource.</span></span> <span data-ttu-id="ca04c-889">Il thread in attesa è considerato dipendente dal thread proprietario della risorsa richiesta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-889">The waiting thread is said to have a dependency on the owning thread for that particular resource.</span></span> <span data-ttu-id="ca04c-890">In un'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] le sessioni possono causare un deadlock durante l'acquisizione di risorse non di database, ad esempio la memoria o i thread.</span><span class="sxs-lookup"><span data-stu-id="ca04c-890">In an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], sessions can deadlock when acquiring nondatabase resources, such as memory or threads.</span></span>  
  
 <span data-ttu-id="ca04c-891">![Diagramma che illustra il deadlock della transazione](media/dedlck1.gif "Diagramma che illustra il deadlock della transazione")</span><span class="sxs-lookup"><span data-stu-id="ca04c-891">![Diagram showing transaction deadlock](media/dedlck1.gif "Diagram showing transaction deadlock")</span></span>  
  
 <span data-ttu-id="ca04c-892">Nell'illustrazione la transazione T1 è dipendente dalla transazione T2 per la risorsa di blocco della tabella **Part**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-892">In the illustration, transaction T1 has a dependency on transaction T2 for the **Part** table lock resource.</span></span> <span data-ttu-id="ca04c-893">In modo analogo, la transazione T2 presenta una dipendenza dalla transazione T1 per la risorsa di blocco della tabella **Supplier**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-893">Similarly, transaction T2 has a dependency on transaction T1 for the **Supplier** table lock resource.</span></span> <span data-ttu-id="ca04c-894">Poiché queste dipendenze creano un ciclo, si verifica un deadlock tra le transazioni T1 e T2.</span><span class="sxs-lookup"><span data-stu-id="ca04c-894">Because these dependencies form a cycle, there is a deadlock between transactions T1 and T2.</span></span>  
  
 <span data-ttu-id="ca04c-895">I deadlock possono verificarsi anche quando una tabella è partizionata e l'impostazione LOCK_ESCALATION di ALTER TABLE è impostata su AUTO.</span><span class="sxs-lookup"><span data-stu-id="ca04c-895">Deadlocks can also occur when a table is partitioned and the LOCK_ESCALATION setting of ALTER TABLE is set to AUTO.</span></span> <span data-ttu-id="ca04c-896">Quando LOCK_ESCALATION è impostato su AUTO, la concorrenza aumenta consentendo [!INCLUDE[ssDE](../includes/ssde-md.md)] a di bloccare le partizioni della tabella a livello di HoBT anziché a livello di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-896">When LOCK_ESCALATION is set to AUTO, concurrency increases by allowing the [!INCLUDE[ssDE](../includes/ssde-md.md)] to lock table partitions at the HoBT level instead of at the TABLE level.</span></span> <span data-ttu-id="ca04c-897">Tuttavia, quando transazioni separate contengono blocchi di partizioni in una tabella e richiedono un blocco in un punto nella partizione delle altre transazioni, si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-897">However, when separate transactions hold partition locks in a table and want a lock somewhere on the other transactions partition, this causes a deadlock.</span></span> <span data-ttu-id="ca04c-898">Questo tipo di deadlock può essere evitato impostando LOCK_ESCALATION su TABLE. Tuttavia, questa impostazione ridurrà la concorrenza forzando aggiornamenti di grandi dimensioni a una partizione attendere un blocco di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-898">This type of deadlock can be avoided by setting LOCK_ESCALATION to TABLE; although this setting will reduce concurrency by forcing large updates to a partition to wait for a table lock.</span></span>  
  
#### <a name="detecting-and-ending-deadlocks"></a><span data-ttu-id="ca04c-899">Rilevamento e interruzione di deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-899">Detecting and Ending Deadlocks</span></span>  

 <span data-ttu-id="ca04c-900">Un deadlock si verifica quando due o più attività si bloccano reciprocamente in modo permanente, in quanto ognuna delle attività prevede un blocco su una risorsa che le altre attività stanno cercando di bloccare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-900">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="ca04c-901">Nel grafico seguente viene illustrata una vista di alto livello di uno stato di deadlock in cui:</span><span class="sxs-lookup"><span data-stu-id="ca04c-901">The following graph presents a high level view of a deadlock state where:</span></span>  
  
-   <span data-ttu-id="ca04c-902">L'attività T1 prevede un blocco sulla risorsa R1, indicato dalla freccia da R1 a T1, e ha richiesto un blocco sulla risorsa R2, indicato dalla freccia da T1 a R2.</span><span class="sxs-lookup"><span data-stu-id="ca04c-902">Task T1 has a lock on resource R1 (indicated by the arrow from R1 to T1) and has requested a lock on resource R2 (indicated by the arrow from T1 to R2).</span></span>  
  
-   <span data-ttu-id="ca04c-903">L'attività T2 prevede un blocco sulla risorsa R2, indicato dalla freccia da R2 a T2, e ha richiesto un blocco sulla risorsa R1, indicato dalla freccia da T2 a R1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-903">Task T2 has a lock on resource R2 (indicated by the arrow from R2 to T2) and has requested a lock on resource R1 (indicated by the arrow from T2 to R1).</span></span>  
  
-   <span data-ttu-id="ca04c-904">Poiché nessuna attività può continuare fino a quando una risorsa diventa disponibile e nessuna risorsa può essere rilasciata fino a quando l'attività continua, si verifica una stato di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-904">Because neither task can continue until a resource is available and neither resource can be released until a task continues, a deadlock state exists.</span></span>  
  
 <span data-ttu-id="ca04c-905">![Diagramma in cui vengono mostrate le attività in stato di deadlock](media/task-deadlock-state.gif "Diagramma in cui vengono mostrate le attività in stato di deadlock")</span><span class="sxs-lookup"><span data-stu-id="ca04c-905">![Diagram showing tasks in a deadlock state](media/task-deadlock-state.gif "Diagram showing tasks in a deadlock state")</span></span>  
  
 <span data-ttu-id="ca04c-906">[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] rileva automaticamente i cicli di deadlock in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-906">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] automatically detects deadlock cycles within [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="ca04c-907">[!INCLUDE[ssDE](../includes/ssde-md.md)] sceglie una delle sessioni come vittima del deadlock e la transazione corrente viene terminata con un errore per interrompere il deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-907">The [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses one of the sessions as a deadlock victim and the current transaction is terminated with an error to break the deadlock.</span></span>  
  
##### <a name="resources-that-can-deadlock"></a><span data-ttu-id="ca04c-908">Risorse che possono causare un deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-908">Resources That Can Deadlock</span></span>  

 <span data-ttu-id="ca04c-909">Per conto di ogni sessione utente possono essere in esecuzione una o più attività e ogni attività può acquisire o attendere di acquisire risorse diverse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-909">Each user session might have one or more tasks running on its behalf where each task might acquire or wait to acquire a variety of resources.</span></span> <span data-ttu-id="ca04c-910">Di seguito sono elencati i tipi di risorse che possono causare blocchi che potrebbero provocare un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-910">The following types of resources can cause blocking that could result in a deadlock.</span></span>  
  
-   <span data-ttu-id="ca04c-911">**Blocchi**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-911">**Locks**.</span></span> <span data-ttu-id="ca04c-912">L'attesa di acquisizione di blocchi sulle risorse, ad esempio oggetti, pagine, righe, metadati e applicazioni, può causare deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-912">Waiting to acquire locks on resources, such as objects, pages, rows, metadata, and applications can cause deadlock.</span></span> <span data-ttu-id="ca04c-913">La transazione T1, ad esempio, prevede un blocco condiviso (S) sulla riga r1 ed è in attesa di ottenere un blocco esclusivo (X) su r2.</span><span class="sxs-lookup"><span data-stu-id="ca04c-913">For example, transaction T1 has a shared (S) lock on row r1 and is waiting to get an exclusive (X) lock on r2.</span></span> <span data-ttu-id="ca04c-914">La transazione T2 prevede un blocco condiviso (S) su r2 ed è in attesa di ottenere un blocco esclusivo (X) sulla riga r1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-914">Transaction T2 has a shared (S) lock on r2 and is waiting to get an exclusive (X) lock on row r1.</span></span> <span data-ttu-id="ca04c-915">Il risultato è un ciclo di blocco in cui T1 e T2 attendono che le risorse bloccate vengano rilasciate dall'altra attività.</span><span class="sxs-lookup"><span data-stu-id="ca04c-915">This results in a lock cycle in which T1 and T2 wait for each other to release the locked resources.</span></span>  
  
-   <span data-ttu-id="ca04c-916">**Thread di lavoro**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-916">**Worker threads**.</span></span> <span data-ttu-id="ca04c-917">Un'attività in coda in attesa di un thread di lavoro disponibile può causare un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-917">A queued task waiting for an available worker thread can cause deadlock.</span></span> <span data-ttu-id="ca04c-918">Se l'attività in coda è proprietaria di risorse che bloccano tutti i thread di lavoro, si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-918">If the queued task owns resources that are blocking all worker threads, a deadlock will result.</span></span> <span data-ttu-id="ca04c-919">La sessione S1 avvia ad esempio una transazione e acquisisce un blocco condiviso (S) sulla riga r1 e quindi va in sospensione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-919">For example, session S1 starts a transaction and acquires a shared (S) lock on row r1 and then goes to sleep.</span></span> <span data-ttu-id="ca04c-920">Le sessioni attive in esecuzione in tutti i thread di lavoro disponibili cercano di acquisire blocchi esclusivi (X) sulla riga r1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-920">Active sessions running on all available worker threads are trying to acquire exclusive (X) locks on row r1.</span></span> <span data-ttu-id="ca04c-921">Poiché la sessione S1 non riesce ad acquisire un thread di lavoro, non può eseguire la transazione e rilasciare il blocco sulla riga r1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-921">Because session S1 cannot acquire a worker thread, it cannot commit the transaction and release the lock on row r1.</span></span> <span data-ttu-id="ca04c-922">Di conseguenza, si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-922">This results in a deadlock.</span></span>  
  
-   <span data-ttu-id="ca04c-923">**Memoria**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-923">**Memory**.</span></span> <span data-ttu-id="ca04c-924">Quando richieste simultanee sono in attesa di concessioni di memoria che non possono essere soddisfatte con la memoria disponibile, può verificarsi un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-924">When concurrent requests are waiting for memory grants that cannot be satisfied with the available memory, a deadlock can occur.</span></span> <span data-ttu-id="ca04c-925">Due query simultanee, Q1 e Q2, vengono ad esempio eseguite come funzioni definite dall'utente che acquisiscono rispettivamente 10 MB e 20 MB di memoria.</span><span class="sxs-lookup"><span data-stu-id="ca04c-925">For example, two concurrent queries, Q1 and Q2, execute as user-defined functions that acquire 10MB and 20MB of memory respectively.</span></span> <span data-ttu-id="ca04c-926">Se per ogni query sono necessari 30 MB e la memoria disponibile totale è di 20 MB, Q1 e Q2 devono attendere che ognuna rilasci memoria e di conseguenza si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-926">If each query needs 30MB and the total available memory is 20MB, then Q1 and Q2 must wait for each other to release memory, and this results in a deadlock.</span></span>  
  
-   <span data-ttu-id="ca04c-927">**Risorse per l'esecuzione di query parallele.** Thread coordinator, producer o consumer associati a una porta di scambio possono bloccarsi a vicenda causando un deadlock, generalmente quando è incluso almeno un altro processo che non fa parte della query parallela.</span><span class="sxs-lookup"><span data-stu-id="ca04c-927">**Parallel query execution-related resources** Coordinator, producer, or consumer threads associated with an exchange port may block each other causing a deadlock usually when including at least one other process that is not a part of the parallel query.</span></span> <span data-ttu-id="ca04c-928">Quando inoltre viene avviata l'esecuzione di una query parallela, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determina il grado di parallelismo o il numero di thread di lavoro sulla base del carico di lavoro corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-928">Also, when a parallel query starts execution, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines the degree of parallelism, or the number of worker threads, based upon the current workload.</span></span> <span data-ttu-id="ca04c-929">Se il carico di lavoro del sistema cambia inaspettatamente, ad esempio per l'avvio di nuove query o per l'esaurimento dei thread di lavoro, è possibile che si verifichi un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-929">If the system workload unexpectedly changes, for example, where new queries start running on the server or the system runs out of worker threads, then a deadlock could occur.</span></span>  
  
-   <span data-ttu-id="ca04c-930">**Risorse MARS (Multiple Active Result Sets)** .</span><span class="sxs-lookup"><span data-stu-id="ca04c-930">**Multiple Active Result Sets (MARS) resources**.</span></span> <span data-ttu-id="ca04c-931">Queste risorse sono utilizzate per controllare in che modo più richieste attive vengono intercalate con il servizio MARS. Per ulteriori informazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-931">These resources are used to control interleaving of multiple active requests under MARS.</span></span> <span data-ttu-id="ca04c-932">Per ulteriori informazioni, vedere [Mars (Multiple Active Result Sets) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="ca04c-932">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
    -   <span data-ttu-id="ca04c-933">**Risorsa utente**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-933">**User resource**.</span></span> <span data-ttu-id="ca04c-934">Quando un thread è in attesa di una risorsa che è potenzialmente controllata da un'applicazione utente, la risorsa viene considerata risorsa esterna o utente e viene trattata come un blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-934">When a thread is waiting for a resource that is potentially controlled by a user application, the resource is considered to be an external or user resource and is treated like a lock.</span></span>  
  
    -   <span data-ttu-id="ca04c-935">**Mutex della sessione**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-935">**Session mutex**.</span></span> <span data-ttu-id="ca04c-936">Le attività in esecuzione in una sessione vengono intercalate, ovvero solo un'attività può essere eseguita in una sessione in un determinato momento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-936">The tasks running in one session are interleaved, meaning that only one task can run under the session at a given time.</span></span> <span data-ttu-id="ca04c-937">Per poter essere eseguita, l'attività deve disporre di accesso esclusivo al mutex della sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-937">Before the task can run, it must have exclusive access to the session mutex.</span></span>  
  
    -   <span data-ttu-id="ca04c-938">**Mutex della transazione**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-938">**Transaction mutex**.</span></span> <span data-ttu-id="ca04c-939">Tutte le attività in esecuzione in una transazione vengono intercalate, ovvero solo un'attività può essere eseguita in una transazione in un determinato momento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-939">All tasks running in one transaction are interleaved, meaning that only one task can run under the transaction at a given time.</span></span> <span data-ttu-id="ca04c-940">Per poter essere eseguita, l'attività deve disporre di accesso esclusivo al mutex della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-940">Before the task can run, it must have exclusive access to the transaction mutex.</span></span>  
  
     <span data-ttu-id="ca04c-941">Per essere eseguita in un servizio MARS, l'attività deve acquisire il mutex della sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-941">In order for a task to run under MARS, it must acquire the session mutex.</span></span> <span data-ttu-id="ca04c-942">Se l'attività è in esecuzione in una transazione, deve acquisire il mutex della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-942">If the task is running under a transaction, it must then acquire the transaction mutex.</span></span> <span data-ttu-id="ca04c-943">Questo consente di garantire che sia attiva una sola attività per volta in una determinata sessione e in una determinata transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-943">This guarantees that only one task is active at one time in a given session and a given transaction.</span></span> <span data-ttu-id="ca04c-944">Dopo che i mutex richiesti sono stati acquisiti, l'attività può essere eseguita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-944">Once the required mutexes have been acquired, the task can execute.</span></span> <span data-ttu-id="ca04c-945">Quando l'attività termine, oppure restituisce il risultato a metà della richiesta,  viene rilasciato prima il mutex della transazione, seguito da quello della sessione, in ordine inverso rispetto a quello di acquisizione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-945">When the task finishes, or yields in the middle of the request, it will first release transaction mutex followed by the session mutex in reverse order of acquisition.</span></span> <span data-ttu-id="ca04c-946">In queste risorse, tuttavia, possono verificarsi deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-946">However, deadlocks can occur with these resources.</span></span> <span data-ttu-id="ca04c-947">Nell'esempio di codice seguente vengono illustrate due attività, richiesta utente U1 e richiesta utente U2, in esecuzione nella stessa sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-947">In the following code example, two tasks, user request U1 and user request U2, are running in the same session.</span></span>  
  
    ```  
    U1:    Rs1=Command1.Execute("insert sometable EXEC usp_someproc");  
    U2:    Rs2=Command2.Execute("select colA from sometable");  
    ```  
  
     <span data-ttu-id="ca04c-948">La stored procedure in esecuzione dall'attività richiesta utente U1 ha acquisito il mutex della sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-948">The stored procedure executing from user request U1 has acquired the session mutex.</span></span> <span data-ttu-id="ca04c-949">Se per l'esecuzione della stored procedure è necessario molto tempo, in [!INCLUDE[ssDE](../includes/ssde-md.md)] viene considerato che la stored procedure è in attesa dell'input dell'utente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-949">If the stored procedure takes a long time to execute, it is assumed by the [!INCLUDE[ssDE](../includes/ssde-md.md)] that the stored procedure is waiting for input from the user.</span></span> <span data-ttu-id="ca04c-950">La richiesta utente U2 è in attesa del mutex della sessione mentre l'utente è in attesa del set di risultati da U2 e U1 è in attesa di una risorsa utente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-950">User request U2 is waiting for the session mutex while the user is waiting for the result set from U2, and U1 is waiting for a user resource.</span></span> <span data-ttu-id="ca04c-951">La rappresentazione logica di tale condizione di deadlock è la seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-951">This is deadlock state logically illustrated as:</span></span>  
  
 <span data-ttu-id="ca04c-952">![Diagramma logico che illustra il deadlock di un processo utente](media/udb9-logicflowexamplec.gif "Diagramma logico che illustra il deadlock di un processo utente")</span><span class="sxs-lookup"><span data-stu-id="ca04c-952">![Logic diagram showing user process deadlock.](media/udb9-logicflowexamplec.gif "Logic diagram showing user process deadlock.")</span></span>  
  
##### <a name="deadlock-detection"></a><span data-ttu-id="ca04c-953">Rilevamento di deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-953">Deadlock Detection</span></span>  

 <span data-ttu-id="ca04c-954">Tutte le risorse elencate nella sezione precedente fanno parte dello schema di rilevamento dei deadlock di [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-954">All of the resources listed in the section above participate in the [!INCLUDE[ssDE](../includes/ssde-md.md)] deadlock detection scheme.</span></span> <span data-ttu-id="ca04c-955">Il rilevamento dei deadlock viene eseguito da un thread di monitoraggio dei blocchi tramite il quale viene periodicamente iniziata una ricerca in tutte le attività in un'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-955">Deadlock detection is performed by a lock monitor thread that periodically initiates a search through all of the tasks in an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="ca04c-956">Il processo di ricerca è descritto dai punti seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-956">The following points describe the search process:</span></span>  
  
-   <span data-ttu-id="ca04c-957">L'intervallo predefinito è 5 secondi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-957">The default interval is 5 seconds.</span></span>  
  
-   <span data-ttu-id="ca04c-958">Se tramite il thread di monitoraggio dei blocchi vengono individuati deadlock, l'intervallo di rilevamento dei deadlock scende da 5 secondi a un minimo di 100 millisecondi, in base alla frequenza dei deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-958">If the lock monitor thread finds deadlocks, the deadlock detection interval will drop from 5 seconds to as low as 100 milliseconds depending on the frequency of deadlocks.</span></span>  
  
-   <span data-ttu-id="ca04c-959">Se tramite il thread di monitoraggio dei blocchi non vengono trovati ulteriori deadlock, in [!INCLUDE[ssDE](../includes/ssde-md.md)] gli intervalli tra le ricerche vengono aumentati a 5 secondi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-959">If the lock monitor thread stops finding deadlocks, the [!INCLUDE[ssDE](../includes/ssde-md.md)] increases the intervals between searches to 5 seconds.</span></span>  
  
-   <span data-ttu-id="ca04c-960">Se viene rilevato un deadlock, si presuppone che i thread successivi che devono attendete un blocco stiano entrando nel ciclo di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-960">If a deadlock has just been detected, it is assumed that the next threads that must wait for a lock are entering the deadlock cycle.</span></span> <span data-ttu-id="ca04c-961">La prima coppia di attese di blocco dopo il rilevamento di un deadlock genera immediatamente una ricerca di deadlock senza che venga atteso l'intervallo successivo di rilevamento dei deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-961">The first couple of lock waits after a deadlock has been detected will immediately trigger a deadlock search rather than wait for the next deadlock detection interval.</span></span> <span data-ttu-id="ca04c-962">Se, ad esempio, l'intervallo attuale è di 5 secondi ed è appena stato rilevato un deadlock, l'attesa di blocco successiva provoca l'avvio immediato della funzionalità di rilevamento di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-962">For example, if the current interval is 5 seconds, and a deadlock was just detected, the next lock wait will kick off the deadlock detector immediately.</span></span> <span data-ttu-id="ca04c-963">Se l'attesa di blocco fa parte di un deadlock, verrà rilevata immediatamente e non nel corso della ricerca di deadlock successiva.</span><span class="sxs-lookup"><span data-stu-id="ca04c-963">If this lock wait is part of a deadlock, it will be detected right away rather than during next deadlock search.</span></span>  
  
 <span data-ttu-id="ca04c-964">In [!INCLUDE[ssDE](../includes/ssde-md.md)] vengono in genere eseguite solo attività di rilevamento di deadlock periodiche.</span><span class="sxs-lookup"><span data-stu-id="ca04c-964">The [!INCLUDE[ssDE](../includes/ssde-md.md)] typically performs periodic deadlock detection only.</span></span> <span data-ttu-id="ca04c-965">Poiché il numero di deadlock di un sistema in genere è ridotto, il rilevamento periodico consente di ridurre l'overhead associato all'operazione di ricerca.</span><span class="sxs-lookup"><span data-stu-id="ca04c-965">Because the number of deadlocks encountered in the system is usually small, periodic deadlock detection helps to reduce the overhead of deadlock detection in the system.</span></span>  
  
 <span data-ttu-id="ca04c-966">Dopo l'avvio di una ricerca di deadlock per un thread specifico, viene identificata la risorsa di cui il thread è in attesa</span><span class="sxs-lookup"><span data-stu-id="ca04c-966">When the lock monitor initiates deadlock search for a particular thread, it identifies the resource on which the thread is waiting.</span></span> <span data-ttu-id="ca04c-967">e vengono individuati il proprietario o i proprietari della risorsa. La ricerca di deadlock viene quindi ripetuta in modo ricorsivo per gli stessi thread fino all'individuazione di un ciclo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-967">The lock monitor then finds the owner(s) for that particular resource and recursively continues the deadlock search for those threads until it finds a cycle.</span></span> <span data-ttu-id="ca04c-968">Un ciclo identificato in questo modo crea un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-968">A cycle identified in this manner forms a deadlock.</span></span>  
  
 <span data-ttu-id="ca04c-969">Dopo essere stato rilevato, un deadlock viene terminato da [!INCLUDE[ssDE](../includes/ssde-md.md)] tramite la scelta di una vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-969">After a deadlock is detected, the [!INCLUDE[ssDE](../includes/ssde-md.md)] ends a deadlock by choosing one of the threads as a deadlock victim.</span></span> <span data-ttu-id="ca04c-970">Tramite [!INCLUDE[ssDE](../includes/ssde-md.md)] viene terminato il batch attualmente in esecuzione per il thread, viene eseguito il rollback della transazione della vittima del deadlock e viene restituito all'applicazione un errore 1205.</span><span class="sxs-lookup"><span data-stu-id="ca04c-970">The [!INCLUDE[ssDE](../includes/ssde-md.md)] terminates the current batch being executed for the thread, rolls back the transaction of the deadlock victim, and returns a 1205 error to the application.</span></span> <span data-ttu-id="ca04c-971">Tramite il rollback della transazione per la vittima del deadlock vengono rilasciati tutti i blocchi della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-971">Rolling back the transaction for the deadlock victim releases all locks held by the transaction.</span></span> <span data-ttu-id="ca04c-972">In questo modo, le transazioni degli altri thread vengono sbloccate e possono continuare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-972">This allows the transactions of the other threads to become unblocked and continue.</span></span> <span data-ttu-id="ca04c-973">Tramite l'errore 1205 relativo alla vittima del deadlock vengono registrate nel log degli errori le informazioni sulle risorse e i thread coinvolti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-973">The 1205 deadlock victim error records information about the threads and resources involved in a deadlock in the error log.</span></span>  
  
 <span data-ttu-id="ca04c-974">Per impostazione predefinita, tramite [!INCLUDE[ssDE](../includes/ssde-md.md)] viene scelta come vittima del deadlock la sessione in cui è in esecuzione la transazione il cui rollback è meno costoso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-974">By default, the [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses as the deadlock victim the session running the transaction that is least expensive to roll back.</span></span> <span data-ttu-id="ca04c-975">In alternativa, è possibile specificare la priorità delle sessioni in una situazione di deadlock utilizzando l'istruzione SET DEADLOCK_PRIORITY.</span><span class="sxs-lookup"><span data-stu-id="ca04c-975">Alternatively, a user can specify the priority of sessions in a deadlock situation using the SET DEADLOCK_PRIORITY statement.</span></span> <span data-ttu-id="ca04c-976">Il valore di DEADLOCK_PRIORITY può essere impostato su LOW, NORMAL o HIGH oppure è possibile utilizzare qualsiasi valore intero compreso tra -10 e 10.</span><span class="sxs-lookup"><span data-stu-id="ca04c-976">DEADLOCK_PRIORITY can be set to LOW, NORMAL, or HIGH, or alternatively can be set to any integer value in the range (-10 to 10).</span></span> <span data-ttu-id="ca04c-977">L'impostazione predefinita per priorità di deadlock è NORMAL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-977">The deadlock priority defaults to NORMAL.</span></span> <span data-ttu-id="ca04c-978">Se le priorità di deadlock di due sessioni sono diverse, come vittima del deadlock verrà scelta la sessione con la priorità inferiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-978">If two sessions have different deadlock priorities, the session with the lower priority is chosen as the deadlock victim.</span></span> <span data-ttu-id="ca04c-979">Se entrambe le sessioni hanno la stessa priorità di deadlock, verrà scelta la sessione con la transazione il cui rollback è meno costoso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-979">If both sessions have the same deadlock priority, the session with the transaction that is least expensive to roll back is chosen.</span></span> <span data-ttu-id="ca04c-980">Se le sessioni coinvolte nel ciclo di deadlock hanno la stessa priorità di deadlock e lo stesso costo, la vittima viene scelta in modo casuale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-980">If sessions involved in the deadlock cycle have the same deadlock priority and the same cost, a victim is chosen randomly.</span></span>  
  
 <span data-ttu-id="ca04c-981">Quando si utilizza l'ambiente CLR, tramite la funzionalità di monitoraggio vengono automaticamente rilevati i deadlock per le  risorse di sincronizzazione, ovvero monitor, blocchi di lettura/scrittura e join di thread, a cui viene eseguito l'accesso all'interno di procedure gestite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-981">When working with CLR, the deadlock monitor automatically detects deadlock for synchronization resources (monitors, reader/writer lock and thread join) accessed inside managed procedures.</span></span> <span data-ttu-id="ca04c-982">Il deadlock viene tuttavia risolto generando un'eccezione nella procedura selezionata come vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-982">However, the deadlock is resolved by throwing an exception in the procedure that was selected to be the deadlock victim.</span></span> <span data-ttu-id="ca04c-983">È importante comprendere che l'eccezione non comporta il rilascio automatico delle risorse attualmente di proprietà della vittima, ma le risorse devono essere rilasciate esplicitamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-983">It is important to understand that the exception does not automatically release resources currently owned by the victim; the resources must be explicitly released.</span></span> <span data-ttu-id="ca04c-984">In modo coerente con il comportamento dell'eccezione, l'eccezione utilizzata per identificare una vittima del deadlock può essere intercettata e ignorata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-984">Consistent with exception behavior, the exception used to identify a deadlock victim can be caught and dismissed.</span></span>  
  
##### <a name="deadlock-information-tools"></a><span data-ttu-id="ca04c-985">Strumenti di informazione sui deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-985">Deadlock Information Tools</span></span>  

 <span data-ttu-id="ca04c-986">Per la visualizzazione di informazioni sui deadlock, il [!INCLUDE[ssDE](../includes/ssde-md.md)] offre strumenti di monitoraggio costituiti da due flag di traccia e da un evento grafico di deadlock in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-986">To view deadlock information, the [!INCLUDE[ssDE](../includes/ssde-md.md)] provides monitoring tools in the form of two trace flags, and the deadlock graph event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span></span>  
  
###### <a name="trace-flag-1204-and-trace-flag-1222"></a><span data-ttu-id="ca04c-987">Flag di traccia 1204 e flag di traccia 1222</span><span class="sxs-lookup"><span data-stu-id="ca04c-987">Trace Flag 1204 and Trace Flag 1222</span></span>  

 <span data-ttu-id="ca04c-988">In caso di deadlock, il flag di traccia 1204 e il flag di traccia 1222 restituiscono informazioni che vengono riportate nel log degli errori di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-988">When deadlocks occur, trace flag 1204 and trace flag 1222 return information that is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="ca04c-989">Il flag di traccia 1204 riporta informazioni sui deadlock formattate per ogni nodo interessato dal deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-989">Trace flag 1204 reports deadlock information formatted by each node involved in the deadlock.</span></span> <span data-ttu-id="ca04c-990">Il flag di traccia 1222 formatta le informazioni sui deadlock, prima per processi e poi per risorse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-990">Trace flag 1222 formats deadlock information, first by processes and then by resources.</span></span> <span data-ttu-id="ca04c-991">È possibile attivare entrambi i flag di traccia per ottenere due diverse rappresentazioni dello stesso evento di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-991">It is possible to enable both trace flags to obtain two representations of the same deadlock event.</span></span>  
  
 <span data-ttu-id="ca04c-992">Nella tabella seguente vengono illustrate le proprietà dei flag di traccia 1204 e 1222, nonché le relative similitudini e differenze.</span><span class="sxs-lookup"><span data-stu-id="ca04c-992">In addition to defining the properties of trace flag 1204 and 1222, the following table also shows the similarities and differences.</span></span>  
  
|<span data-ttu-id="ca04c-993">Proprietà</span><span class="sxs-lookup"><span data-stu-id="ca04c-993">Property</span></span>|<span data-ttu-id="ca04c-994">Flag di traccia 1204 e flag di traccia 1222</span><span class="sxs-lookup"><span data-stu-id="ca04c-994">Trace Flag 1204 and Trace Flag 1222</span></span>|<span data-ttu-id="ca04c-995">Solo flag di traccia 1204</span><span class="sxs-lookup"><span data-stu-id="ca04c-995">Trace Flag 1204 only</span></span>|<span data-ttu-id="ca04c-996">Solo flag di traccia 1222</span><span class="sxs-lookup"><span data-stu-id="ca04c-996">Trace Flag 1222 only</span></span>|  
|--------------|-----------------------------------------|--------------------------|--------------------------|  
|<span data-ttu-id="ca04c-997">Formato di output</span><span class="sxs-lookup"><span data-stu-id="ca04c-997">Output format</span></span>|<span data-ttu-id="ca04c-998">L'output viene acquisito nel log degli errori di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-998">Output is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>|<span data-ttu-id="ca04c-999">Mirato ai nodi interessati dal deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-999">Focused on the nodes involved in the deadlock.</span></span> <span data-ttu-id="ca04c-1000">Ogni nodo ha una sezione dedicata e la sezione finale descrive la vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1000">Each node has a dedicated section, and the final section describes the deadlock victim.</span></span>|<span data-ttu-id="ca04c-1001">Restituisce informazioni in un formato simile all'XML ma non conforme a uno schema XSD (XML Schema Definition).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1001">Returns information in an XML-like format that does not conform to an XML Schema Definition (XSD) schema.</span></span> <span data-ttu-id="ca04c-1002">Il formato presenta tre sezioni principali.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1002">The format has three major sections.</span></span> <span data-ttu-id="ca04c-1003">Nella prima sezione viene dichiarata la vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1003">The first section declares the deadlock victim.</span></span> <span data-ttu-id="ca04c-1004">Nella seconda sezione viene descritto ogni processo interessato dal deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1004">The second section describes each process involved in the deadlock.</span></span> <span data-ttu-id="ca04c-1005">Nella terza sezione vengono descritte le risorse che rappresentano un sinonimo dei nodi indicati nel flag di traccia 1204.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1005">The third section describes the resources that are synonymous with nodes in trace flag 1204.</span></span>|  
|<span data-ttu-id="ca04c-1006">Identificazione degli attributi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1006">Identifying attributes</span></span>|<span data-ttu-id="ca04c-1007">**SPID: \<x> ECID: \<x> .**</span><span class="sxs-lookup"><span data-stu-id="ca04c-1007">**SPID:\<x> ECID:\<x>.**</span></span> <span data-ttu-id="ca04c-1008">Identifica il thread dell'ID del processo di sistema in presenza di processi paralleli.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1008">Identifies the system process ID thread in cases of parallel processes.</span></span> <span data-ttu-id="ca04c-1009">La voce `SPID:<x> ECID:0` , dove \<x> viene sostituito dal valore SPID, rappresenta il thread principale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1009">The entry `SPID:<x> ECID:0`, where \<x> is replaced by the SPID value, represents the main thread.</span></span> <span data-ttu-id="ca04c-1010">La voce `SPID:<x> ECID:<y>` , dove \<x> viene sostituito dal valore SPID ed \<y> è maggiore di 0, rappresenta i sottothread per lo stesso SPID.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1010">The entry `SPID:<x> ECID:<y>`, where \<x> is replaced by the SPID value and \<y> is greater than 0, represents the sub-threads for the same SPID.</span></span><br /><br /> <span data-ttu-id="ca04c-1011">**BatchID** (**sbid** per il flag di traccia 1222).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1011">**BatchID** (**sbid** for trace flag 1222).</span></span> <span data-ttu-id="ca04c-1012">Identifica il batch da cui l'esecuzione del codice richiede o mantiene un blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1012">Identifies the batch from which code execution is requesting or holding a lock.</span></span> <span data-ttu-id="ca04c-1013">Quando MARS (Multiple Active Result Set) è disabilitato, il valore di BatchID è 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1013">When Multiple Active Result Sets (MARS) is disabled, the BatchID value is 0.</span></span> <span data-ttu-id="ca04c-1014">Quando MARS è abilitato, il valore per i batch attivi è compreso tra 1 e *n*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1014">When MARS is enabled, the value for active batches is 1 to *n*.</span></span> <span data-ttu-id="ca04c-1015">Se la sessione non contiene batch attivi, BatchID è 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1015">If there are no active batches in the session, BatchID is 0.</span></span><br /><br /> <span data-ttu-id="ca04c-1016">**Mode**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1016">**Mode**.</span></span> <span data-ttu-id="ca04c-1017">Specifica il tipo di blocco per una determinata risorsa richiesta, concessa o attesa da un thread.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1017">Specifies the type of lock for a particular resource that is requested, granted, or waited on by a thread.</span></span> <span data-ttu-id="ca04c-1018">Mode può essere IS (Preventivo condiviso), S (Condiviso), U (Aggiornamento), IX (Preventivo esclusivo), SIX (Condiviso preventivo esclusivo) e X (Esclusivo).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1018">Mode can be IS (Intent Shared), S (Shared), U (Update), IX (Intent Exclusive), SIX (Shared with Intent Exclusive), and X (Exclusive).</span></span><br /><br /> <span data-ttu-id="ca04c-1019">**Line #** (**line** per il flag di traccia 1222).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1019">**Line #** (**line** for trace flag 1222).</span></span> <span data-ttu-id="ca04c-1020">Elenca il numero di riga del batch di istruzioni corrente che era in esecuzione quando si è verificato il deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1020">Lists the line number in the current batch of statements that was being executed when the deadlock occurred.</span></span><br /><br /> <span data-ttu-id="ca04c-1021">**Input Buf** (**inputbuf** per il flag di traccia 1222).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1021">**Input Buf** (**inputbuf** for trace flag 1222).</span></span> <span data-ttu-id="ca04c-1022">Elenca tutte le istruzioni del batch corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1022">Lists all the statements in the current batch.</span></span>|<span data-ttu-id="ca04c-1023">**Node**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1023">**Node**.</span></span> <span data-ttu-id="ca04c-1024">Rappresenta il numero di voce nella catena del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1024">Represents the entry number in the deadlock chain.</span></span><br /><br /> <span data-ttu-id="ca04c-1025">**Lists**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1025">**Lists**.</span></span> <span data-ttu-id="ca04c-1026">Il proprietario del blocco può essere parte degli elenchi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1026">The lock owner can be part of these lists:</span></span><br /><br /> <span data-ttu-id="ca04c-1027">**Grant List**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1027">**Grant List**.</span></span> <span data-ttu-id="ca04c-1028">Enumera i proprietari correnti della risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1028">Enumerates the current owners of the resource.</span></span><br /><br /> <span data-ttu-id="ca04c-1029">**Convert List**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1029">**Convert List**.</span></span> <span data-ttu-id="ca04c-1030">Enumera i proprietari correnti che stanno tentando di convertire i propri blocchi a un livello superiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1030">Enumerates the current owners that are trying to convert their locks to a higher level.</span></span><br /><br /> <span data-ttu-id="ca04c-1031">**Wait List**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1031">**Wait List**.</span></span> <span data-ttu-id="ca04c-1032">Enumera le nuove richieste di blocco correnti per la risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1032">Enumerates current new lock requests for the resource.</span></span><br /><br /> <span data-ttu-id="ca04c-1033">**Statement Type**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1033">**Statement Type**.</span></span> <span data-ttu-id="ca04c-1034">Descrive il tipo di istruzione DML (SELECT, INSERT, UPDATE o DELETE) su cui i thread hanno autorizzazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1034">Describes the type of DML statement (SELECT, INSERT, UPDATE, or DELETE) on which the threads have permissions.</span></span><br /><br /> <span data-ttu-id="ca04c-1035">**Victim Resource Owner**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1035">**Victim Resource Owner**.</span></span> <span data-ttu-id="ca04c-1036">Specifica il thread partecipante che [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sceglie come vittima per interrompere il ciclo di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1036">Specifies the participating thread that [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] chooses as the victim to break the deadlock cycle.</span></span> <span data-ttu-id="ca04c-1037">Il thread scelto e tutti i sottothread esistenti vengono terminati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1037">The chosen thread and all existing sub-threads are terminated.</span></span><br /><br /> <span data-ttu-id="ca04c-1038">**Next Branch**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1038">**Next Branch**.</span></span> <span data-ttu-id="ca04c-1039">Rappresenta i due o più sottothread legati allo stesso SPID che sono interessati dal ciclo di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1039">Represents the two or more sub-threads from the same SPID that are involved in the deadlock cycle.</span></span>|<span data-ttu-id="ca04c-1040">**deadlock victim**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1040">**deadlock victim**.</span></span> <span data-ttu-id="ca04c-1041">Rappresenta l'indirizzo di memoria fisica dell'attività (vedere [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) selezionata come vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1041">Represents the physical memory address of the task (see [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) that was selected as a deadlock victim.</span></span> <span data-ttu-id="ca04c-1042">In caso di deadlock risolto, il valore può essere 0 (zero).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1042">It may be 0 (zero) in the case of an unresolved deadlock.</span></span> <span data-ttu-id="ca04c-1043">Un'attività in cui è in corso l'esecuzione del rollback non può essere scelta come vittima del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1043">A task that is rolling back cannot be chosen as a deadlock victim.</span></span><br /><br /> <span data-ttu-id="ca04c-1044">**executionstack**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1044">**executionstack**.</span></span> <span data-ttu-id="ca04c-1045">Rappresenta il codice [!INCLUDE[tsql](../includes/tsql-md.md)] in esecuzione al momento del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1045">Represents [!INCLUDE[tsql](../includes/tsql-md.md)] code that is being executed at the time the deadlock occurs.</span></span><br /><br /> <span data-ttu-id="ca04c-1046">**priority**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1046">**priority**.</span></span> <span data-ttu-id="ca04c-1047">Rappresenta la priorità di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1047">Represents deadlock priority.</span></span> <span data-ttu-id="ca04c-1048">In alcuni casi, la priorità di deadlock potrebbe essere modificata da [!INCLUDE[ssDE](../includes/ssde-md.md)] per un breve intervallo di tempo, per ottenere una concorrenza migliore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1048">In certain cases, the [!INCLUDE[ssDE](../includes/ssde-md.md)] may opt to alter the deadlock priority for a short duration to achieve better concurrency.</span></span><br /><br /> <span data-ttu-id="ca04c-1049">**logused**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1049">**logused**.</span></span> <span data-ttu-id="ca04c-1050">Spazio del log utilizzato dall'attività.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1050">Log space used by the task.</span></span><br /><br /> <span data-ttu-id="ca04c-1051">**owner id**. ID della transazione che ha il controllo della richiesta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1051">**owner id**. The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="ca04c-1052">**status**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1052">**status**.</span></span> <span data-ttu-id="ca04c-1053">Stato dell'attività.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1053">State of the task.</span></span> <span data-ttu-id="ca04c-1054">I possibili valori sono i seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1054">It is one of the following values:</span></span><br /><br /> <span data-ttu-id="ca04c-1055">>> **pending**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1055">>> **pending**.</span></span> <span data-ttu-id="ca04c-1056">in attesa di un thread di lavoro.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1056">Waiting for a worker thread.</span></span><br /><br /> <span data-ttu-id="ca04c-1057">>> **runnable**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1057">>> **runnable**.</span></span> <span data-ttu-id="ca04c-1058">Pronto per l'esecuzione ma in attesa di un quantum.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1058">Ready to run but waiting for a quantum.</span></span><br /><br /> <span data-ttu-id="ca04c-1059">>> **running**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1059">>> **running**.</span></span> <span data-ttu-id="ca04c-1060">in esecuzione nell'utilità di pianificazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1060">Currently running on the scheduler.</span></span><br /><br /> <span data-ttu-id="ca04c-1061">>> **suspended**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1061">>> **suspended**.</span></span> <span data-ttu-id="ca04c-1062">Esecuzione sospesa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1062">Execution is suspended.</span></span><br /><br /> <span data-ttu-id="ca04c-1063">>> **done**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1063">>> **done**.</span></span> <span data-ttu-id="ca04c-1064">Attività completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1064">Task has completed.</span></span><br /><br /> <span data-ttu-id="ca04c-1065">>> **spinloop**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1065">>> **spinloop**.</span></span> <span data-ttu-id="ca04c-1066">In attesa che venga liberato uno spinlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1066">Waiting for a spinlock to become free.</span></span><br /><br /> <span data-ttu-id="ca04c-1067">**waitresource**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1067">**waitresource**.</span></span> <span data-ttu-id="ca04c-1068">Risorsa necessaria per l'attività.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1068">The resource needed by the task.</span></span><br /><br /> <span data-ttu-id="ca04c-1069">**waittime**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1069">**waittime**.</span></span> <span data-ttu-id="ca04c-1070">Tempo, in millisecondi, di attesa per la risorsa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1070">Time in milliseconds waiting for the resource.</span></span><br /><br /> <span data-ttu-id="ca04c-1071">**schedulerid**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1071">**schedulerid**.</span></span> <span data-ttu-id="ca04c-1072">Utilità di pianificazione associata all'attività.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1072">Scheduler associated with this task.</span></span> <span data-ttu-id="ca04c-1073">Vedere [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1073">See [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span></span><br /><br /> <span data-ttu-id="ca04c-1074">**hostname**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1074">**hostname**.</span></span> <span data-ttu-id="ca04c-1075">Nome della workstation.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1075">The name of the workstation.</span></span><br /><br /> <span data-ttu-id="ca04c-1076">**isolationlevel**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1076">**isolationlevel**.</span></span> <span data-ttu-id="ca04c-1077">Livello di isolamento delle transazioni corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1077">The current transaction isolation level.</span></span><br /><br /> <span data-ttu-id="ca04c-1078">**Xactid**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1078">**Xactid**.</span></span> <span data-ttu-id="ca04c-1079">ID della transazione che ha il controllo della richiesta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1079">The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="ca04c-1080">**currentdb**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1080">**currentdb**.</span></span> <span data-ttu-id="ca04c-1081">ID del database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1081">The ID of the database.</span></span><br /><br /> <span data-ttu-id="ca04c-1082">**lastbatchstarted**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1082">**lastbatchstarted**.</span></span> <span data-ttu-id="ca04c-1083">Ultima volta in cui un processo client ha avviato un'esecuzione del batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1083">The last time a client process started batch execution.</span></span><br /><br /> <span data-ttu-id="ca04c-1084">**lastbatchcompleted**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1084">**lastbatchcompleted**.</span></span> <span data-ttu-id="ca04c-1085">Ultima volta in cui un processo client ha completato un'esecuzione del batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1085">The last time a client process completed batch execution.</span></span><br /><br /> <span data-ttu-id="ca04c-1086">**clientoption1 e clientoption2**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1086">**clientoption1 and clientoption2**.</span></span> <span data-ttu-id="ca04c-1087">Opzioni SET nella connessione client.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1087">Set options on this client connection.</span></span> <span data-ttu-id="ca04c-1088">Si tratta di una maschera di bit che include informazioni sulle opzioni generalmente controllate da istruzioni SET, ad esempio SET NOCOUNT e SET XACTABORT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1088">This is a bitmask that includes information about options usually controlled by SET statements such as SET NOCOUNT and SET XACTABORT.</span></span><br /><br /> <span data-ttu-id="ca04c-1089">**associatedObjectId**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1089">**associatedObjectId**.</span></span> <span data-ttu-id="ca04c-1090">Rappresenta l'ID di HoBT (Heap Or B-Tree).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1090">Represents the HoBT (heap or b-tree) ID.</span></span>|  
|<span data-ttu-id="ca04c-1091">Attributi risorsa</span><span class="sxs-lookup"><span data-stu-id="ca04c-1091">Resource attributes</span></span>|<span data-ttu-id="ca04c-1092">**RID**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1092">**RID**.</span></span> <span data-ttu-id="ca04c-1093">Identifica la singola riga di una tabella su cui un blocco viene mantenuto o richiesto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1093">Identifies the single row within a table on which a lock is held or requested.</span></span> <span data-ttu-id="ca04c-1094">RID è rappresentato come RID: *db_id:file_id:page_no:row_no*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1094">RID is represented as RID: *db_id:file_id:page_no:row_no*.</span></span> <span data-ttu-id="ca04c-1095">Ad esempio: `RID: 6:1:20789:0`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1095">For example, `RID: 6:1:20789:0`.</span></span><br /><br /> <span data-ttu-id="ca04c-1096">**OBJECT**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1096">**OBJECT**.</span></span> <span data-ttu-id="ca04c-1097">Identifica la tabella su cui un blocco viene mantenuto o richiesto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1097">Identifies the table on which a lock is held or requested.</span></span> <span data-ttu-id="ca04c-1098">OBJECT è rappresentato come OBJECT: *db_id:object_id*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1098">OBJECT is represented as OBJECT: *db_id:object_id*.</span></span> <span data-ttu-id="ca04c-1099">Ad esempio: `TAB: 6:2009058193`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1099">For example, `TAB: 6:2009058193`.</span></span><br /><br /> <span data-ttu-id="ca04c-1100">**KEY**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1100">**KEY**.</span></span> <span data-ttu-id="ca04c-1101">Identifica l'intervallo di chiavi di un indice su cui un blocco viene mantenuto o richiesto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1101">Identifies the key range within an index on which a lock is held or requested.</span></span> <span data-ttu-id="ca04c-1102">KEY è rappresentato come KEY: *db_id:hobt_id* (*valore hash della chiave di indice*).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1102">KEY is represented as KEY: *db_id:hobt_id* (*index key hash value*).</span></span> <span data-ttu-id="ca04c-1103">Ad esempio: `KEY: 6:72057594057457664 (350007a4d329)`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1103">For example, `KEY: 6:72057594057457664 (350007a4d329)`.</span></span><br /><br /> <span data-ttu-id="ca04c-1104">**PAG**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1104">**PAG**.</span></span> <span data-ttu-id="ca04c-1105">Identifica la risorsa di pagina su cui un blocco viene mantenuto o richiesto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1105">Identifies the page resource on which a lock is held or requested.</span></span> <span data-ttu-id="ca04c-1106">PAG è rappresentato come PAG: *db_id:file_id:page_no*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1106">PAG is represented as PAG: *db_id:file_id:page_no*.</span></span> <span data-ttu-id="ca04c-1107">Ad esempio: `PAG: 6:1:20789`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1107">For example, `PAG: 6:1:20789`.</span></span><br /><br /> <span data-ttu-id="ca04c-1108">**EXT**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1108">**EXT**.</span></span> <span data-ttu-id="ca04c-1109">Identifica la struttura extent.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1109">Identifies the extent structure.</span></span> <span data-ttu-id="ca04c-1110">EXT è rappresentato come EXT: *db_id:file_id:extent_no*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1110">EXT is represented as EXT: *db_id:file_id:extent_no*.</span></span> <span data-ttu-id="ca04c-1111">Ad esempio: `EXT: 6:1:9`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1111">For example, `EXT: 6:1:9`.</span></span><br /><br /> <span data-ttu-id="ca04c-1112">**DB**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1112">**DB**.</span></span> <span data-ttu-id="ca04c-1113">Identifica il blocco del database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1113">Identifies the database lock.</span></span> <span data-ttu-id="ca04c-1114">**DB è rappresentato in uno dei modi seguenti:**</span><span class="sxs-lookup"><span data-stu-id="ca04c-1114">**DB is represented in one of the following ways:**</span></span><br /><br /> <span data-ttu-id="ca04c-1115">DB: *db_id*</span><span class="sxs-lookup"><span data-stu-id="ca04c-1115">DB: *db_id*</span></span><br /><br /> <span data-ttu-id="ca04c-1116">DB: *db_id*[BULK-OP-DB], che identifica il blocco di database applicato dal database di backup.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1116">DB: *db_id*[BULK-OP-DB], which identifies the database lock taken by the backup database.</span></span><br /><br /> <span data-ttu-id="ca04c-1117">DB: *db_id*[BULK-OP-LOG], che identifica il blocco applicato dal log di backup per un particolare database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1117">DB: *db_id*[BULK-OP-LOG], which identifies the lock taken by the backup log for that particular database.</span></span><br /><br /> <span data-ttu-id="ca04c-1118">**APP**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1118">**APP**.</span></span> <span data-ttu-id="ca04c-1119">Identifica il blocco applicato da una risorsa di un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1119">Identifies the lock taken by an application resource.</span></span> <span data-ttu-id="ca04c-1120">APP è rappresentato come APP: *lock_resource*.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1120">APP is represented as APP: *lock_resource*.</span></span> <span data-ttu-id="ca04c-1121">Ad esempio: `APP: Formf370f478`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1121">For example, `APP: Formf370f478`.</span></span><br /><br /> <span data-ttu-id="ca04c-1122">**METADATA**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1122">**METADATA**.</span></span> <span data-ttu-id="ca04c-1123">Rappresenta le risorse di metadati interessate da un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1123">Represents metadata resources involved in a deadlock.</span></span> <span data-ttu-id="ca04c-1124">Poiché METADATA ha molte sottorisorse, il valore restituito dipende dalla sottorisorsa interessata dal deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1124">Because METADATA has many subresources, the value returned depends upon the subresource that has deadlocked.</span></span> <span data-ttu-id="ca04c-1125">Ad esempio, i metadati. USER_TYPE restituisce `user_type_id =` \<*integer_value*> .</span><span class="sxs-lookup"><span data-stu-id="ca04c-1125">For example, METADATA.USER_TYPE returns `user_type_id =` \<*integer_value*>.</span></span> <span data-ttu-id="ca04c-1126">Per altre informazioni sulle risorse e le sottorisorse METADATA, vedere [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1126">For more information about METADATA resources and subresources, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span><br /><br /> <span data-ttu-id="ca04c-1127">**HOBT**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1127">**HOBT**.</span></span> <span data-ttu-id="ca04c-1128">Rappresenta un heap o un albero B interessato da un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1128">Represents a heap or b-tree involved in a deadlock.</span></span>|<span data-ttu-id="ca04c-1129">Nessuna esclusiva di questo flag di traccia.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1129">None exclusive to this trace flag.</span></span>|<span data-ttu-id="ca04c-1130">Nessuna esclusiva di questo flag di traccia.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1130">None exclusive to this trace flag.</span></span>|  
  
###### <a name="trace-flag-1204-example"></a><span data-ttu-id="ca04c-1131">Esempio di flag di traccia 1204</span><span class="sxs-lookup"><span data-stu-id="ca04c-1131">Trace Flag 1204 Example</span></span>  

 <span data-ttu-id="ca04c-1132">L'esempio seguente illustra l'output che si ottiene quando il flag di traccia 1204 è attivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1132">The following example shows the output when trace flag 1204 is turned on.</span></span> <span data-ttu-id="ca04c-1133">In questo caso, la tabella in Node 1 è un heap senza indici e la tabella in Node 2 è un heap con un indice non cluster.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1133">In this case, the table in Node 1 is a heap with no indexes, and the table in Node 2 is a heap with a nonclustered index.</span></span> <span data-ttu-id="ca04c-1134">La chiave di indice in Node 2 è in corso di aggiornamento quando si verifica il deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1134">The index key in Node 2 is being updated when the deadlock occurs.</span></span>  
  
```  
Deadlock encountered .... Printing deadlock information  
Wait-for graph  
  
Node:1  
  
RID: 6:1:20789:0               CleanCnt:3 Mode:X Flags: 0x2  
 Grant List 0:  
   Owner:0x0315D6A0 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:55 ECID:0 XactLockInfo: 0x04D9E27C  
   SPID: 55 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
BEGIN TRANSACTION  
   EXEC usp_p2  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x03A3DAD0   
     Mode: U SPID:54 BatchID:0 ECID:0 TaskProxy:(0x04976374) Value:0x315d200 Cost:(0/868)  
  
Node:2  
  
KEY: 6:72057594057457664 (350007a4d329) CleanCnt:2 Mode:X Flags: 0x0  
 Grant List 0:  
   Owner:0x0315D140 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:54 ECID:0 XactLockInfo: 0x03A3DAF4  
   SPID: 54 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
     BEGIN TRANSACTION  
       EXEC usp_p1  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
  
Victim Resource Owner:  
 ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
```  
  
###### <a name="trace-flag-1222-example"></a><span data-ttu-id="ca04c-1135">Esempio di flag di traccia 1222</span><span class="sxs-lookup"><span data-stu-id="ca04c-1135">Trace Flag 1222 Example</span></span>  

 <span data-ttu-id="ca04c-1136">Nell'esempio seguente viene illustrato l'output che si ottiene quando il flag di traccia 1222 è attivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1136">The following example shows the output when trace flag 1222 is turned on.</span></span> <span data-ttu-id="ca04c-1137">In questo caso, una tabella è un heap senza indici e l'altra tabella è un heap con un indice non cluster.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1137">In this case, one table is a heap with no indexes, and the other table is a heap with a nonclustered index.</span></span> <span data-ttu-id="ca04c-1138">Nella seconda tabella, la chiave di indice è in corso di aggiornamento quando si verifica il deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1138">In the second table, the index key is being updated when the deadlock occurs.</span></span>  
  
```  
deadlock-list  
 deadlock victim=process689978  
  process-list  
   process id=process6891f8 taskpriority=0 logused=868   
   waitresource=RID: 6:1:20789:0 waittime=1359 ownerId=310444   
   transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:42.733 XDES=0x3a3dad0   
   lockMode=U schedulerid=1 kpid=1952 status=suspended spid=54   
   sbid=0 ecid=0 priority=0 transcount=2   
   lastbatchstarted=2005-09-05T11:22:42.733   
   lastbatchcompleted=2005-09-05T11:22:42.733   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310444 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p1 line=6 stmtstart=202   
     sqlhandle=0x0300060013e6446b027cbb00c69600000100000000000000  
     UPDATE T2 SET COL1 = 3 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600856aa70f503b8104000000000000000000000000  
     EXEC usp_p1       
    inputbuf  
      BEGIN TRANSACTION  
       EXEC usp_p1  
   process id=process689978 taskpriority=0 logused=380   
   waitresource=KEY: 6:72057594057457664 (350007a4d329)     
   waittime=5015 ownerId=310462 transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:44.077 XDES=0x4d9e258 lockMode=U   
   schedulerid=1 kpid=3024 status=suspended spid=55 sbid=0 ecid=0   
   priority=0 transcount=2 lastbatchstarted=2005-09-05T11:22:44.077   
   lastbatchcompleted=2005-09-05T11:22:44.077   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310462 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p2 line=6 stmtstart=200   
     sqlhandle=0x030006004c0a396c027cbb00c69600000100000000000000  
     UPDATE T1 SET COL1 = 4 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600d688e709b85f8904000000000000000000000000  
     EXEC usp_p2       
    inputbuf  
      BEGIN TRANSACTION  
        EXEC usp_p2      
  resource-list  
   ridlock fileid=1 pageid=20789 dbid=6 objectname=AdventureWorks2012.dbo.T2   
   id=lock3136940 mode=X associatedObjectId=72057594057392128  
    owner-list  
     owner id=process689978 mode=X  
    waiter-list  
     waiter id=process6891f8 mode=U requestType=wait  
   keylock hobtid=72057594057457664 dbid=6 objectname=AdventureWorks2012.dbo.T1   
   indexname=nci_T1_COL1 id=lock3136fc0 mode=X   
   associatedObjectId=72057594057457664  
    owner-list  
     owner id=process6891f8 mode=X  
    waiter-list  
     waiter id=process689978 mode=U requestType=wait  
```  
  
###### <a name="profiler-deadlock-graph-event"></a><span data-ttu-id="ca04c-1139">Evento Deadlock Graph di Profiler</span><span class="sxs-lookup"><span data-stu-id="ca04c-1139">Profiler Deadlock Graph Event</span></span>  

 <span data-ttu-id="ca04c-1140">Si tratta di un evento in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] che presenta una descrizione grafica delle attività e delle risorse coinvolte in un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1140">This is an event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] that presents a graphical depiction of the tasks and resources involved in a deadlock.</span></span> <span data-ttu-id="ca04c-1141">Nell'esempio seguente viene illustrato l'output prodotto da [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] quando l'evento Deadlock Graph è attivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1141">The following example shows the output from [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] when the deadlock graph event is turned on.</span></span>  
  
 <span data-ttu-id="ca04c-1142">![Diagramma di flusso logico che illustra il deadlock di un processo utente](media/udb9-profilerdeadlockgraphc.gif "Diagramma di flusso logico che illustra il deadlock di un processo utente")</span><span class="sxs-lookup"><span data-stu-id="ca04c-1142">![Logic flow diagram showing user process deadlock.](media/udb9-profilerdeadlockgraphc.gif "Logic flow diagram showing user process deadlock.")</span></span>  
  
 <span data-ttu-id="ca04c-1143">Per ulteriori informazioni sull'esecuzione di [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] Deadlock Graph, vedere [Save deadlock graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1143">For more information about running the [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] deadlock graph, see [Save Deadlock Graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span></span>  
  
#### <a name="handling-deadlocks"></a><span data-ttu-id="ca04c-1144">Gestione di deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-1144">Handling Deadlocks</span></span>  

 <span data-ttu-id="ca04c-1145">Quando un'istanza del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] sceglie una transazione come vittima di un deadlock, viene terminato il batch corrente, viene eseguito il rollback della transazione e viene restituito il messaggio di errore 1205 all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1145">When an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] chooses a transaction as a deadlock victim, it terminates the current batch, rolls back the transaction, and returns error message 1205 to the application.</span></span>  
  
 `Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thread} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.`  
  
 <span data-ttu-id="ca04c-1146">Poiché tutte le applicazioni che inviano query [!INCLUDE[tsql](../includes/tsql-md.md)] possono essere potenziali vittime del deadlock, devono includere un gestore degli errori in grado di intercettare il messaggio di errore 1205.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1146">Because any application submitting [!INCLUDE[tsql](../includes/tsql-md.md)] queries can be chosen as the deadlock victim, applications should have an error handler that can trap error message 1205.</span></span> <span data-ttu-id="ca04c-1147">Se questo errore non viene intercettato, l'applicazione continua a essere eseguita come se il rollback della transazione non avesse avuto luogo, con la conseguente generazione di errori.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1147">If an application does not trap the error, the application can proceed unaware that its transaction has been rolled back and errors can occur.</span></span>  
  
 <span data-ttu-id="ca04c-1148">Tramite l'implementazione di un gestore degli errori in grado di intercettare il messaggio di errore 1205, è possibile gestire la condizione di deadlock in un'applicazione ed eseguire gli interventi di correzione necessari, ad esempio il reinvio della query coinvolta nel deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1148">Implementing an error handler that traps error message 1205 allows an application to handle the deadlock situation and take remedial action (for example, automatically resubmitting the query that was involved in the deadlock).</span></span> <span data-ttu-id="ca04c-1149">Tramite il reinvio automatico della query l'utente non è necessario che l'utente sia a conoscenza del verificarsi del deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1149">By resubmitting the query automatically, the user does not need to know that a deadlock occurred.</span></span>  
  
 <span data-ttu-id="ca04c-1150">È consigliabile sospendere brevemente l'applicazione prima di reinviarne la query.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1150">The application should pause briefly before resubmitting its query.</span></span> <span data-ttu-id="ca04c-1151">In questo modo, la transazione interessata dal deadlock può completare e rilasciare i relativi blocchi che formano parte del ciclo di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1151">This gives the other transaction involved in the deadlock a chance to complete and release its locks that formed part of the deadlock cycle.</span></span> <span data-ttu-id="ca04c-1152">Ciò riduce la probabilità che il deadlock si verifichi di nuovo quando la query reinviata ne richiede i blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1152">This minimizes the likelihood of the deadlock reoccurring when the resubmitted query requests its locks.</span></span>  
  
#### <a name="minimizing-deadlocks"></a><span data-ttu-id="ca04c-1153">Riduzione dei deadlock</span><span class="sxs-lookup"><span data-stu-id="ca04c-1153">Minimizing Deadlocks</span></span>  

 <span data-ttu-id="ca04c-1154">I deadlock non possono essere evitati completamente. È tuttavia possibile ridurre il rischio di insorgenza di un deadlock attenendosi a determinate convenzioni di codifica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1154">Although deadlocks cannot be completely avoided, following certain coding conventions can minimize the chance of generating a deadlock.</span></span> <span data-ttu-id="ca04c-1155">La riduzione del numero di deadlock comporta un aumento della velocità effettiva delle transazioni e una diminuzione dell'overhead del sistema, in quanto il numero di transazioni su cui è necessario eseguire le operazioni seguenti risulta minimo:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1155">Minimizing deadlocks can increase transaction throughput and reduce system overhead because fewer transactions are:</span></span>  
  
-   <span data-ttu-id="ca04c-1156">Rollback, con il conseguente annullamento del lavoro eseguito.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1156">Rolled back, undoing all the work performed by the transaction.</span></span>  
  
-   <span data-ttu-id="ca04c-1157">Riesecuzione tramite l'applicazione, in quanto in corrispondenza del deadlock è stato eseguito il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1157">Resubmitted by applications because they were rolled back when deadlocked.</span></span>  
  
 <span data-ttu-id="ca04c-1158">Per ridurre il numero di deadlock, è possibile:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1158">To help minimize deadlocks:</span></span>  
  
-   <span data-ttu-id="ca04c-1159">Accedere sempre agli oggetti in base allo stesso ordine.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1159">Access objects in the same order.</span></span>  
  
-   <span data-ttu-id="ca04c-1160">Escludere l'interazione dell'utente nelle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1160">Avoid user interaction in transactions.</span></span>  
  
-   <span data-ttu-id="ca04c-1161">Ridurre la lunghezza delle transazioni e inserirle in un solo batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1161">Keep transactions short and in one batch.</span></span>  
  
-   <span data-ttu-id="ca04c-1162">Utilizzare un livello di isolamento basso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1162">Use a lower isolation level.</span></span>  
  
-   <span data-ttu-id="ca04c-1163">Utilizzare un livello di isolamento basato sul controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1163">Use a row versioning-based isolation level.</span></span>  
  
    -   <span data-ttu-id="ca04c-1164">Impostare l'opzione di database READ_COMMITTED_SNAPSHOT su ON affinché le transazioni Read Committed possano utilizzare il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1164">Set READ_COMMITTED_SNAPSHOT database option ON to enable read-committed transactions to use row versioning.</span></span>  
  
    -   <span data-ttu-id="ca04c-1165">Utilizzare l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1165">Use snapshot isolation.</span></span>  
  
-   <span data-ttu-id="ca04c-1166">Utilizzare connessioni associate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1166">Use bound connections.</span></span>  
  
##### <a name="access-objects-in-the-same-order"></a><span data-ttu-id="ca04c-1167">Accesso agli oggetti in base allo stesso ordine</span><span class="sxs-lookup"><span data-stu-id="ca04c-1167">Access Objects in the Same Order</span></span>  

 <span data-ttu-id="ca04c-1168">Se tutte le transazioni simultanee accedono agli oggetti nello stesso ordine, la possibilità che si verifichi un deadlock risulta notevolmente ridotta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1168">If all concurrent transactions access objects in the same order, deadlocks are less likely to occur.</span></span> <span data-ttu-id="ca04c-1169">Se, ad esempio, due transazioni simultanee ottengono un blocco prima nella tabella **Supplier** e quindi nella tabella **Part**, una transazione rimane bloccata sulla tabella **Supplier** fino al completamento dell'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1169">For example, if two concurrent transactions obtain a lock on the **Supplier** table and then on the **Part** table, one transaction is blocked on the **Supplier** table until the other transaction is completed.</span></span> <span data-ttu-id="ca04c-1170">Dopo il commit o il rollback della prima transazione, l'esecuzione della seconda continua e non si verifica alcun deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1170">After the first transaction commits or rolls back, the second continues, and a deadlock does not occur.</span></span> <span data-ttu-id="ca04c-1171">L'utilizzo di stored procedure per tutte le modifiche ai dati consente di standardizzare l'ordine di accesso agli oggetti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1171">Using stored procedures for all data modifications can standardize the order of accessing objects.</span></span>  
  
 <span data-ttu-id="ca04c-1172">![Diagramma che illustra come evitare il deadlock](media/dedlck2.gif "Diagramma che illustra come evitare il deadlock")</span><span class="sxs-lookup"><span data-stu-id="ca04c-1172">![Diagram showing deadlock avoidance](media/dedlck2.gif "Diagram showing deadlock avoidance")</span></span>  
  
##### <a name="avoid-user-interaction-in-transactions"></a><span data-ttu-id="ca04c-1173">Esclusione dell'interazione dell'utente nelle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1173">Avoid User Interaction in Transactions</span></span>  

 <span data-ttu-id="ca04c-1174">È consigliabile evitare la creazione di transazioni che prevedono l'interazione dell'utente. I batch eseguiti senza alcun intervento da parte dell'utente risultano infatti molto più veloci rispetto ai tempi di risposta di un utente a una query, ad esempio per rispondere alla richiesta di un parametro richiesto da un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1174">Avoid writing transactions that include user interaction, because the speed of batches running without user intervention is much faster than the speed at which a user must manually respond to queries, such as replying to a prompt for a parameter requested by an application.</span></span> <span data-ttu-id="ca04c-1175">Si supponga, ad esempio, che una transazione sia in attesa dell'input dell'utente e che l'utente sia a pranzo o abbia lasciato l'ufficio per il fine settimana. In questo caso la transazione non può essere completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1175">For example, if a transaction is waiting for user input and the user goes to lunch or even home for the weekend, the user delays the transaction from completing.</span></span> <span data-ttu-id="ca04c-1176">Questa situazione comporta una riduzione della velocità effettiva del sistema, in quanto i blocchi mantenuti attivi dalla transazione vengono rilasciati solo in corrispondenza del commit o del rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1176">This degrades system throughput because any locks held by the transaction are released only when the transaction is committed or rolled back.</span></span> <span data-ttu-id="ca04c-1177">Anche se non si verifica una situazione di deadlock, le altre transazioni che tentano di accedere alle stesse risorse vengono bloccate, in attesa del completamento della prima transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1177">Even if a deadlock situation does not arise, other transactions accessing the same resources are blocked while waiting for the transaction to complete.</span></span>  
  
##### <a name="keep-transactions-short-and-in-one-batch"></a><span data-ttu-id="ca04c-1178">Riduzione della lunghezza delle transazioni e inserimento delle transazioni in un solo batch</span><span class="sxs-lookup"><span data-stu-id="ca04c-1178">Keep Transactions Short and in One Batch</span></span>  

 <span data-ttu-id="ca04c-1179">Il deadlock si verifica in genere quando nello stesso database vengono eseguite contemporaneamente numerose transazioni estese.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1179">A deadlock typically occurs when several long-running transactions execute concurrently in the same database.</span></span> <span data-ttu-id="ca04c-1180">La lunghezza della transazione è direttamente proporzionale alla durata dei blocchi esclusivi o di aggiornamento che bloccano qualsiasi altra attività e che possono generare una situazione di deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1180">The longer the transaction, the longer the exclusive or update locks are held, blocking other activity and leading to possible deadlock situations.</span></span>  
  
 <span data-ttu-id="ca04c-1181">Se le transazioni vengono inserite in un singolo batch, è possibile minimizzare il tempo di round trip in rete durante l'esecuzione delle transazioni, con la conseguente riduzione di possibili ritardi nel completamento della transazione e nel rilascio dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1181">Keeping transactions in one batch minimizes network roundtrips during a transaction, reducing possible delays in completing the transaction and releasing locks.</span></span>  
  
##### <a name="use-a-lower-isolation-level"></a><span data-ttu-id="ca04c-1182">Utilizzo di livelli di isolamento bassi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1182">Use a Lower Isolation Level</span></span>  

 <span data-ttu-id="ca04c-1183">È importante determinare se una transazione è eseguibile a un livello di isolamento inferiore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1183">Determine whether a transaction can run at a lower isolation level.</span></span> <span data-ttu-id="ca04c-1184">Il livello di isolamento Read Committed per una transazione consente la lettura di dati letti in precedenza (ma non modificati) da un'altra transazione senza attendere che tale transazione venga completata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1184">Implementing read committed allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="ca04c-1185">Quando si imposta un livello di isolamento basso, quale Read Committed, i blocchi condivisi vengono mantenuti attivi per un periodo più breve rispetto a quello richiesto da un livello di isolamento più alto, quale Serializable,</span><span class="sxs-lookup"><span data-stu-id="ca04c-1185">Using a lower isolation level, such as read committed, holds shared locks for a shorter duration than a higher isolation level, such as serializable.</span></span> <span data-ttu-id="ca04c-1186">con la conseguente riduzione della contesa tra blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1186">This reduces locking contention.</span></span>  
  
##### <a name="use-a-row-versioning-based-isolation-level"></a><span data-ttu-id="ca04c-1187">Utilizzo di un livello di isolamento basato sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1187">Use a Row Versioning-based Isolation Level</span></span>  

 <span data-ttu-id="ca04c-1188">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su ON, durante le operazioni di lettura le transazioni eseguite con il livello di isolamento Read Committed utilizzano il controllo delle versioni delle righe invece dei blocchi condivisi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1188">When the READ_COMMITTED_SNAPSHOT database option is set ON, a transaction running under read committed isolation level uses row versioning rather than shared locks during read operations.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1189">Alcune applicazioni si avvalgono della funzione di blocco del livello di isolamento Read Committed.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1189">Some applications rely upon locking and blocking behavior of read committed isolation.</span></span> <span data-ttu-id="ca04c-1190">Per tali applicazioni sono necessarie alcune modifiche prima di abilitare questa opzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1190">For these applications, some change is required before this option can be enabled.</span></span>  
  
 <span data-ttu-id="ca04c-1191">Anche il livello di isolamento dello snapshot utilizza il controllo delle versioni delle righe, che non si avvale dei blocchi condivisi durante le operazioni di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1191">Snapshot isolation also uses row versioning, which does not use shared locks during read operations.</span></span> <span data-ttu-id="ca04c-1192">Affinché sia possibile eseguire transazioni con il livello di isolamento dello snapshot, è necessario impostare l'opzione di database ALLOW_SNAPSHOT_ISOLATION su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1192">Before a transaction can run under snapshot isolation, the ALLOW_SNAPSHOT_ISOLATION database option must be set ON.</span></span>  
  
 <span data-ttu-id="ca04c-1193">Implementare questi livelli di isolamento per ridurre i deadlock che si possono verificare tra operazioni di lettura e di scrittura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1193">Implement these isolation levels to minimize deadlocks that can occur between read and write operations.</span></span>  
  
##### <a name="use-bound-connections"></a><span data-ttu-id="ca04c-1194">Utilizzo di connessioni associate</span><span class="sxs-lookup"><span data-stu-id="ca04c-1194">Use Bound Connections</span></span>  

 <span data-ttu-id="ca04c-1195">L'utilizzo di connessioni associate garantisce la cooperazione tra due o più connessioni aperte dalla stessa applicazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1195">Using bound connections, two or more connections opened by the same application can cooperate with each other.</span></span> <span data-ttu-id="ca04c-1196">I blocchi acquisiti dalle connessioni secondarie vengono gestiti come se fossero stati acquisiti dalla connessione primaria e viceversa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1196">Any locks acquired by the secondary connections are held as if they were acquired by the primary connection, and vice versa.</span></span> <span data-ttu-id="ca04c-1197">Di conseguenza non si verificano blocchi reciproci tra le connessioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1197">Therefore they do not block each other.</span></span>  
  
### <a name="lock-partitioning"></a><span data-ttu-id="ca04c-1198">Partizionamento di blocchi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1198">Lock Partitioning</span></span>  

 <span data-ttu-id="ca04c-1199">Nei sistemi di computer di grandi dimensioni, i blocchi su oggetti di riferimento utilizzati di frequente può creare colli di bottiglia a livello delle prestazioni poiché l'acquisizione e il rilascio di blocchi determina la contesa nelle risorse di blocco interne.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1199">For large computer systems, locks on frequently referenced objects can become a performance bottleneck as acquiring and releasing locks place contention on internal locking resources.</span></span> <span data-ttu-id="ca04c-1200">Il partizionamento dei blocchi migliora le prestazioni poiché suddivide una singola risorsa di blocco in più risorse di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1200">Lock partitioning enhances locking performance by splitting a single lock resource into multiple lock resources.</span></span> <span data-ttu-id="ca04c-1201">Questa caratteristica è disponibile unicamente per i sistemi con 16 o più CPU, viene abilitata automaticamente e non è possibile disabilitarla.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1201">This feature is only available for systems with 16 or more CPUs, and is automatically enabled and cannot be disabled.</span></span> <span data-ttu-id="ca04c-1202">È possibile partizionare solo i blocchi degli oggetti. I blocchi di oggetti che includono un sottotipo non vengono partizionati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1202">Only object locks can be partitioned.Object locks that have a subtype are not partitioned.</span></span> <span data-ttu-id="ca04c-1203">Per altre informazioni, vedere [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1203">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
#### <a name="understanding-lock-partitioning"></a><span data-ttu-id="ca04c-1204">Informazioni sul partizionamento dei blocchi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1204">Understanding Lock Partitioning</span></span>  

 <span data-ttu-id="ca04c-1205">Le attività di blocco accedono a numerose risorse condivise, due delle quali vengono ottimizzate dal partizionamento dei blocchi:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1205">Locking tasks access several shared resources, two of which are optimized by lock partitioning:</span></span>  
  
-   <span data-ttu-id="ca04c-1206">**Spinlock**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1206">**Spinlock**.</span></span> <span data-ttu-id="ca04c-1207">Consente di controllare l'accesso a una risorsa di blocco, ad esempio una riga o una tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1207">This controls access to a lock resource, such as a row or a table.</span></span>  
  
     <span data-ttu-id="ca04c-1208">Senza il partizionamento dei blocchi, uno spinlock gestisce tutte le richieste di blocco per una singola risorsa di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1208">Without lock partitioning, one spinlock manages all lock requests for a single lock resource.</span></span> <span data-ttu-id="ca04c-1209">Nei sistemi con un volume di attività elevato, è possibile che si verifichi una contesa tra le risorse di blocco che rimangono in attesa della disponibilità dello spinlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1209">On systems that experience a large volume of activity, contention can occur as lock requests wait for the spinlock to become available.</span></span> <span data-ttu-id="ca04c-1210">In questo caso, l'acquisizione dei blocchi può determinare un collo di bottiglia e influire negativamente sulle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1210">Under this situation, acquiring locks can become a bottleneck and can negatively impact performance.</span></span>  
  
     <span data-ttu-id="ca04c-1211">Il partizionamento dei blocchi suddivide una singola risorsa di blocco in più risorse di blocco per ridurre la contesa per una singola risorsa di blocco e distribuisce il carico su più spinlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1211">To reduce contention on a single lock resource, lock partitioning splits a single lock resource into multiple lock resources to distribute the load across multiple spinlocks.</span></span>  
  
-   <span data-ttu-id="ca04c-1212">**Memoria**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1212">**Memory**.</span></span> <span data-ttu-id="ca04c-1213">Consente di archiviare le strutture delle risorse di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1213">This is used to store the lock resource structures.</span></span>  
  
     <span data-ttu-id="ca04c-1214">Dopo che lo spinlock è stato acquisito, le strutture di blocco vengono archiviate in memoria ed è quindi possibile accedervi ed eventualmente modificarle.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1214">Once the spinlock is acquired, lock structures are stored in memory and then accessed and possibly modified.</span></span> <span data-ttu-id="ca04c-1215">La distribuzione dell'accesso ai blocchi su più risorse consente di eliminare la necessità di trasferire blocchi di memoria tra le CPU e di migliorare pertanto le prestazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1215">Distributing lock access across multiple resources helps to eliminate the need to transfer memory blocks between CPUs, which will help to improve performance.</span></span>  
  
#### <a name="implementing-and-monitoring-lock-partitioning"></a><span data-ttu-id="ca04c-1216">Implementazione e monitoraggio del partizionamento dei blocchi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1216">Implementing and Monitoring Lock Partitioning</span></span>  

 <span data-ttu-id="ca04c-1217">Il partizionamento dei blocchi è attivato per impostazione predefinita nei sistemi con 16 o più CPU.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1217">Lock partitioning is turned on by default for systems with 16 or more CPUs.</span></span> <span data-ttu-id="ca04c-1218">Se il partizionamento è abilitato, nel log degli errori di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] viene registrato un messaggio informativo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1218">When lock partitioning is enabled, an informational message is recorded in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>  
  
 <span data-ttu-id="ca04c-1219">Se vengono acquisiti blocchi su una risorsa partizionata:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1219">When acquiring locks on a partitioned resource:</span></span>  
  
-   <span data-ttu-id="ca04c-1220">Su una singola partizione vengono acquisite solo le modalità di blocco NL, SCH-S, IS, IU e IX.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1220">Only NL, SCH-S, IS, IU, and IX lock modes are acquired on a single partition.</span></span>  
  
-   <span data-ttu-id="ca04c-1221">L'acquisizione dei blocchi condivisi (S) ed esclusivi (X) e degli altri blocchi in modalità diverse da NL, SCH-S, IS, IU e IX su tutte le partizioni deve essere eseguita a partire dalla partizione con ID 0 e successivamente in base all'ordine degli ID di partizione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1221">Shared (S), exclusive (X), and other locks in modes other than NL, SCH-S, IS, IU, and IX must be acquired on all partitions starting with partition ID 0 and following in partition ID order.</span></span> <span data-ttu-id="ca04c-1222">Questi blocchi su una risorsa partizionata utilizzano una quantità di memoria maggiore rispetto ai blocchi con la stessa modalità su una risorsa non partizionata, poiché ogni partizione rappresenta in effetti un blocco distinto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1222">These locks on a partitioned resource will use more memory than locks in the same mode on a non-partitioned resource since each partition is effectively a separate lock.</span></span> <span data-ttu-id="ca04c-1223">L'aumento della memoria è determinato dal numero delle partizioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1223">The memory increase is determined by the number of partitions.</span></span> <span data-ttu-id="ca04c-1224">I contatori dei blocchi di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] in Performance Monitor di Windows visualizzano informazioni sulla memoria utilizzata dai blocchi partizionati e non partizionati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1224">The [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lock counters in the Windows Performance Monitor will display information about memory used by partitioned and non-partitioned locks.</span></span>  
  
 <span data-ttu-id="ca04c-1225">All'avvio della transazione, viene assegnata una transazione a una partizione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1225">A transaction is assigned to a partition when the transaction starts.</span></span> <span data-ttu-id="ca04c-1226">Tutte le richieste di blocco partizionabili relative alla transazione utilizzano la partizione assegnata a tale transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1226">For the transaction, all lock requests that can be partitioned use the partition assigned to that transaction.</span></span> <span data-ttu-id="ca04c-1227">In questo modo, l'accesso alle risorse di blocco dello stesso oggetto da parte di transazioni diverse viene distribuito su partizioni diverse.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1227">By this method, access to lock resources of the same object by different transactions is distributed across different partitions.</span></span>  
  
 <span data-ttu-id="ca04c-1228">Nella colonna resource_lock_partition della vista a gestione dinamica sys.dm_tran_locks è disponibile l'ID di partizione di blocco per una risorsa di blocco partizionata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1228">The resource_lock_partition column in the sys.dm_tran_locks Dynamic Management View provides the lock partition ID for a lock partitioned resource.</span></span> <span data-ttu-id="ca04c-1229">Per altre informazioni, vedere [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1229">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1230">Nell'evento Locks di [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], la colonna BigintData1 fornisce l'ID partizione di blocco per una risorsa di blocco partizionata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1230">Under the Locks event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], the BigintData1 column provides the lock partition ID for a lock partitioned resource.</span></span>  
  
#### <a name="working-with-lock-partitioning"></a><span data-ttu-id="ca04c-1231">Utilizzo del partizionamento dei blocchi</span><span class="sxs-lookup"><span data-stu-id="ca04c-1231">Working with Lock Partitioning</span></span>  

 <span data-ttu-id="ca04c-1232">Negli esempi di codice seguenti viene illustrato il partizionamento dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1232">The following code examples illustrate lock partitioning.</span></span> <span data-ttu-id="ca04c-1233">Due transazioni vengono eseguite in due sessioni diverse allo scopo di illustrare il partizionamento dei blocchi in un computer con 16 CPU.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1233">In the examples, two transactions are executed in two different sessions in order to show lock partitioning behavior on a computer system with 16 CPUs.</span></span>  
  
 <span data-ttu-id="ca04c-1234">Le istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] seguenti creano gli oggetti di prova utilizzati negli esempi successivi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1234">These [!INCLUDE[tsql](../includes/tsql-md.md)] statements create test objects that are used in the examples that follow.</span></span>  
  
```sql  
-- Create a test table.  
CREATE TABLE TestTable  
    (col1        int);  
GO  
  
-- Create a clustered index on the table.  
CREATE CLUSTERED INDEX ci_TestTable   
    ON TestTable (col1);  
GO  
  
-- Populate the table.  
INSERT INTO TestTable VALUES (1);  
GO  
```  
  
##### <a name="example-a"></a><span data-ttu-id="ca04c-1235">Esempio A</span><span class="sxs-lookup"><span data-stu-id="ca04c-1235">Example A</span></span>  

 <span data-ttu-id="ca04c-1236">Sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1236">Session 1:</span></span>  
  
 <span data-ttu-id="ca04c-1237">Un'istruzione `SELECT` viene eseguita in una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1237">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="ca04c-1238">A causa dell'hint di blocco `HOLDLOCK`, l'istruzione acquisisce e mantiene un blocco preventivo condiviso (IS) sulla tabella. Nell'esempio, i blocchi di riga e di pagina vengono ignorati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1238">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="ca04c-1239">Il blocco IS viene acquisito solo nella partizione assegnata alla transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1239">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="ca04c-1240">In questo esempio si presume che il blocco IS venga acquisito nell'ID partizione 7.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1240">For this example, it is assumed that the IS lock is acquired on partition ID 7.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="ca04c-1241">Sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1241">Session 2:</span></span>  
  
 <span data-ttu-id="ca04c-1242">Viene avviata una transazione e l'istruzione `SELECT` eseguita nella transazione acquisisce e mantiene un blocco condiviso (S) sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1242">A transaction is started, and the `SELECT` statement running under this transaction will acquire and retain a shared (S) lock on the table.</span></span> <span data-ttu-id="ca04c-1243">Il blocco S viene acquisito in tutte le partizioni e pertanto si ottengono più blocchi di tabella, uno per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1243">The S lock will be acquired on all partitions which results in multiple table locks, one for each partition.</span></span> <span data-ttu-id="ca04c-1244">Ad esempio, in un sistema con 16 CPU verranno applicati 16 blocchi S negli ID di partizione di blocco da 0 a 15.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1244">For example, on a 16-cpu system, 16 S locks will be issued across lock partition IDs 0-15.</span></span> <span data-ttu-id="ca04c-1245">Il blocco S è compatibile con il blocco IS mantenuto dalla transazione sull'ID di partizione 7 nella sessione 1 e pertanto non si verifica alcun blocco tra le transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1245">Because the S lock is compatible with the IS lock being held on partition ID 7 by the transaction in session 1, there is no blocking between transactions.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCK, HOLDLOCK);  
```  
  
 <span data-ttu-id="ca04c-1246">Sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1246">Session 1:</span></span>  
  
 <span data-ttu-id="ca04c-1247">L'istruzione `SELECT` seguente viene eseguita nella transazione ancora attiva nella sessione 1.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1247">The following `SELECT` statement is executed under the transaction that is still active under session 1.</span></span> <span data-ttu-id="ca04c-1248">A causa dell'hint di blocco della tabella esclusivo (X), la transazione tenta di acquisire un blocco X sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1248">Because of the exclusive (X) table lock hint, the transaction will attempt to acquire an X lock on the table.</span></span> <span data-ttu-id="ca04c-1249">Il blocco S mantenuto dalla transazione nella sessione 2 blocca tuttavia il blocco X in corrispondenza dell'ID di partizione 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1249">However, the S lock that is being held by the transaction in session 2 will block the X lock at partition ID 0.</span></span>  
  
```sql  
SELECT col1  
    FROM TestTable  
    WITH (TABLOCKX);  
```  
  
##### <a name="example-b"></a><span data-ttu-id="ca04c-1250">Esempio B</span><span class="sxs-lookup"><span data-stu-id="ca04c-1250">Example B</span></span>  

 <span data-ttu-id="ca04c-1251">Sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1251">Session 1:</span></span>  
  
 <span data-ttu-id="ca04c-1252">Un'istruzione `SELECT` viene eseguita in una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1252">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="ca04c-1253">A causa dell'hint di blocco `HOLDLOCK`, l'istruzione acquisisce e mantiene un blocco preventivo condiviso (IS) sulla tabella. Nell'esempio, i blocchi di riga e di pagina vengono ignorati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1253">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="ca04c-1254">Il blocco IS viene acquisito solo nella partizione assegnata alla transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1254">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="ca04c-1255">In questo esempio si presume che il blocco IS venga acquisito nell'ID di partizione 6.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1255">For this example, it is assumed that the IS lock is acquired on partition ID 6.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="ca04c-1256">Sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1256">Session 2:</span></span>  
  
 <span data-ttu-id="ca04c-1257">Un'istruzione `SELECT` viene eseguita in una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1257">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="ca04c-1258">A causa dell'hint di blocco `TABLOCKX`, la transazione tenta di acquisire un blocco esclusivo (X) sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1258">Because of the `TABLOCKX` lock hint, the transaction tries to acquire an exclusive (X) lock on the table.</span></span> <span data-ttu-id="ca04c-1259">Tenere presente che il blocco X deve essere acquisito per tutte le partizioni a partire dall'ID di partizione 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1259">Remember that the X lock must be acquired on all partitions starting with partition ID 0.</span></span> <span data-ttu-id="ca04c-1260">Tale blocco viene acquisito per tutti gli ID di partizione da 0 a 5 ma viene bloccato dal blocco IS acquisito per l'ID di partizione 6.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1260">The X lock will be acquired on all partitions IDs 0-5 but will be blocked by the IS lock that is acquired on partition ID 6.</span></span>  
  
 <span data-ttu-id="ca04c-1261">Negli ID di partizione da 7 a 15 che non sono stati ancora raggiunti dal blocco X, le altre transazioni possono continuare ad acquisire blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1261">On partition IDs 7-15 that the X lock has not yet reached, other transactions can continue to acquire locks.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCKX, HOLDLOCK);  
```  
  
 <span data-ttu-id="ca04c-1262">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-1262">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="row-versioning-based-isolation-levels-in-the-database-engine"></a><a name="Row_versioning"></a><span data-ttu-id="ca04c-1263">Livelli di isolamento basati sul controllo delle versioni delle righe nel motore di database</span><span class="sxs-lookup"><span data-stu-id="ca04c-1263">Row Versioning-based Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="ca04c-1264">A partire da SQL Server 2005, nel motore di database è stata introdotta una implementazione di un livello di isolamento della transazione esistente, Read committed, che offre uno snapshot a livello di istruzione tramite il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1264">Starting with SQL Server 2005, the Database Engine offers an implementation of an existing transaction isolation level, read committed, that provides a statement level snapshot using row versioning.</span></span> <span data-ttu-id="ca04c-1265">Nel motore di database di SQL Server è stato inoltre introdotto un nuovo livello di isolamento della transazione, ovvero snapshot, che offre uno snapshot a livello di transazione anch'esso tramite il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1265">SQL Server Database Engine also offers a transaction isolation level, snapshot, that provides a transaction level snapshot also using row versioning.</span></span>  
  
 <span data-ttu-id="ca04c-1266">Il controllo delle versioni delle righe è un framework generale in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] che richiama un meccanismo copy-on-write quando una riga viene modificata o eliminata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1266">Row versioning is a general framework in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that invokes a copy-on-write mechanism when a row is modified or deleted.</span></span> <span data-ttu-id="ca04c-1267">È pertanto necessario che durante l'esecuzione della transazione, la versione precedente della riga sia disponibile per le transazioni che richiedono un precedente stato consistente dal punto di vista transazionale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1267">This requires that while the transaction is running, the old version of the row must be available for transactions that require an earlier transactionally consistent state.</span></span> <span data-ttu-id="ca04c-1268">Il controllo delle versioni delle righe utilizzato per eseguire quanto segue:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1268">Row versioning is used to do the following:</span></span>  
  
-   <span data-ttu-id="ca04c-1269">Compilare le tabelle **inserite** ed **eliminate** nei trigger.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1269">Build the **inserted** and **deleted** tables in triggers.</span></span> <span data-ttu-id="ca04c-1270">Le righe modificate dal trigger vengono sottoposte al controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1270">Any rows modified by the trigger are versioned.</span></span> <span data-ttu-id="ca04c-1271">Questo include le righe modificate dall'istruzione che ha avviato il trigger, nonché qualsiasi modifica ai dati eseguita dal trigger.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1271">This includes the rows modified by the statement that launched the trigger, as well as any data modifications made by the trigger.</span></span>  
  
-   <span data-ttu-id="ca04c-1272">Supportare più set di risultati attivi (MARS).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1272">Support Multiple Active Result Sets (MARS).</span></span> <span data-ttu-id="ca04c-1273">Se una sessione MARS genera un'istruzione di modifica dei dati (ad esempio INSERT, UPDATE oppure DELETE) nel momento in cui è attivo un set di risultati, le righe influenzate dall'istruzione di modifica sono sottoposte al controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1273">If a MARS session issues a data modification statement (such as INSERT, UPDATE, or DELETE) at a time there is an active result set, the rows affected by the modification statement are versioned.</span></span>  
  
-   <span data-ttu-id="ca04c-1274">Supportare operazioni di indice che specificano l'opzione ONLINE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1274">Support index operations that specify the ONLINE option.</span></span>  
  
-   <span data-ttu-id="ca04c-1275">Supportare i livelli di isolamento delle transazioni basate sul controllo delle versioni delle righe:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1275">Support row versioning-based transaction isolation levels:</span></span>  
  
    -   <span data-ttu-id="ca04c-1276">Una nuova implementazione del livello di isolamento read-committed che utilizza il controllo delle versioni delle righe per la consistenza di lettura a livello di istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1276">A new implementation of read committed isolation level that uses row versioning to provide statement-level read consistency.</span></span>  
  
    -   <span data-ttu-id="ca04c-1277">Un nuovo livello di isolamento, snapshot, per offrire consistenza di lettura a livello di transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1277">A new isolation level, snapshot, to provide transaction-level read consistency.</span></span>  
  
 <span data-ttu-id="ca04c-1278">Il database `tempdb` deve disporre di spazio sufficiente per l'archivio delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1278">The `tempdb` database must have enough space for the version store.</span></span> <span data-ttu-id="ca04c-1279">Quando lo spazio in `tempdb` è esaurito, le operazioni di aggiornamento arrestano la generazione di versioni, senza errori, mentre le operazioni di lettura possono avere esito negativo in quanto una particolare versione della riga necessaria non esiste più.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1279">When `tempdb` is full, update operations will stop generating versions and continue to succeed, but read operations might fail because a particular row version that is needed no longer exists.</span></span> <span data-ttu-id="ca04c-1280">Questo ha effetto su operazioni come indicizzazione online, MARS e di trigger.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1280">This affects operations like triggers, MARS, and online indexing.</span></span>  
  
 <span data-ttu-id="ca04c-1281">L'utilizzo del controllo delle versioni delle righe per transazioni snapshot e read-committed è un processo in due passaggi:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1281">Using row versioning for read-committed and snapshot transactions is a two-step process:</span></span>  
  
1.  <span data-ttu-id="ca04c-1282">Impostazione di una o entrambe le opzioni di database READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1282">Set either or both the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options ON.</span></span>  
  
2.  <span data-ttu-id="ca04c-1283">Impostazione del corretto livello di isolamento delle transazioni in un'applicazione:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1283">Set the appropriate transaction isolation level in an application:</span></span>  
  
    -   <span data-ttu-id="ca04c-1284">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è ON, le transazioni che impostano il livello di isolamento read-committed utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1284">When the READ_COMMITTED_SNAPSHOT database option is ON, transactions setting the read committed isolation level use row versioning.</span></span>  
  
    -   <span data-ttu-id="ca04c-1285">Quando l'opzione di database ALLOW_SNAPSHOT_ISOLATION è ON, le transazioni possono impostare il livello di isolamento snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1285">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, transactions can set the snapshot isolation level.</span></span>  
  
 <span data-ttu-id="ca04c-1286">Quando l'opzione di database READ_COMMITTED_SNAPSHOT oppure ALLOW_SNAPSHOT_ISOLATION è impostata su ON, [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assegna un numero di sequenza della transazione (XSN) a ogni transazione che modifica i dati utilizzando il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1286">When either READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database option is set ON, the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assigns a transaction sequence number (XSN) to each transaction that manipulates data using row versioning.</span></span> <span data-ttu-id="ca04c-1287">Le transazioni vengono avviate all'esecuzione di un'istruzione BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1287">Transactions start at the time a BEGIN TRANSACTION statement is executed.</span></span> <span data-ttu-id="ca04c-1288">Tuttavia, il numero di sequenza della transazione inizia con la prima operazione di lettura o scrittura dopo l'istruzione BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1288">However, the transaction sequence number starts with the first read or write operation after the BEGIN TRANSACTION statement.</span></span> <span data-ttu-id="ca04c-1289">Il numero di sequenza della transazione viene incrementato di uno a ogni assegnazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1289">The transaction sequence number is incremented by one each time it is assigned.</span></span>  
  
 <span data-ttu-id="ca04c-1290">Quando l'opzione di database READ_COMMITTED_SNAPSHOT oppure ALLOW_SNAPSHOT_ISOLATION è impostata su ON, le copie logiche (versioni) vengono mantenute per tutte le modifiche ai dati eseguite nel database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1290">When either the READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database options are ON, logical copies (versions) are maintained for all data modifications performed in the database.</span></span> <span data-ttu-id="ca04c-1291">Ogni volta che una riga viene modificata da una transazione specifica, l'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] archivia una versione della precedente immagine della riga di cui è stato eseguito il commit in `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1291">Every time a row is modified by a specific transaction, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stores a version of the previously committed image of the row in `tempdb`.</span></span> <span data-ttu-id="ca04c-1292">Ogni versione è contrassegnata con il numero di sequenza della transazione che ha eseguito la modifica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1292">Each version is marked with the transaction sequence number of the transaction that made the change.</span></span> <span data-ttu-id="ca04c-1293">Le versioni delle righe modificate vengono concatenate utilizzando un elenco di collegamenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1293">The versions of modified rows are chained using a link list.</span></span> <span data-ttu-id="ca04c-1294">Il valore di riga più recente viene sempre archiviato nel database corrente e concatenato alle righe con versioni archiviate in `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1294">The newest row value is always stored in the current database and chained to the versioned rows stored in `tempdb`.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1295">Per la modifica di oggetti LOB, solo il frammento modificato viene copiato nell'archivio delle versioni archiviato in `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1295">For modification of large objects (LOBs), only the changed fragment is copied to the version store in `tempdb`.</span></span>  
  
 <span data-ttu-id="ca04c-1296">Le versioni delle righe vengono mantenute abbastanza a lungo da soddisfare i requisiti delle transazioni in esecuzione con i livelli di isolamento basati sul controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1296">Row versions are held long enough to satisfy the requirements of transactions running under row versioning-based isolation levels.</span></span> <span data-ttu-id="ca04c-1297">[!INCLUDE[ssDE](../includes/ssde-md.md)] tiene traccia del primo numero di sequenza della transazione significativo ed elimina periodicamente tutte le versioni di riga che includono numeri di sequenza della transazione inferiori al primo numero di sequenza significativo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1297">The [!INCLUDE[ssDE](../includes/ssde-md.md)] tracks the earliest useful transaction sequence number and periodically deletes all row versions stamped with transaction sequence numbers that are lower than the earliest useful sequence number.</span></span>  
  
 <span data-ttu-id="ca04c-1298">Quando entrambe le opzioni di database sono impostate su OFF, solo le righe modificate da trigger o sessioni MARS, oppure lette da operazioni di indice ONLINE, vengono sottoposte al controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1298">When both database options are set to OFF, only rows modified by triggers or MARS sessions, or read by ONLINE index operations, are versioned.</span></span> <span data-ttu-id="ca04c-1299">Queste versioni di riga vengono rilasciate quando non sono più necessarie.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1299">Those row versions are released when no longer needed.</span></span> <span data-ttu-id="ca04c-1300">Un thread in background viene eseguito periodicamente per rimuovere le versioni di riga non aggiornate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1300">A background thread periodically executes to remove stale row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1301">Per le transazioni con esecuzione rapida, è possibile che una versione di una riga modificata venga memorizzata nel pool di buffer senza essere scritta nei file su disco del database `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1301">For short-running transactions, a version of a modified row may get cached in the buffer pool without getting written into the disk files of the `tempdb` database.</span></span> <span data-ttu-id="ca04c-1302">Se la necessità della riga con controllo delle versioni è di breve durata, essa verrà semplicemente eliminata dal pool di buffer, senza che si verifichi necessariamente un overhead I/O.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1302">If the need for the versioned row is short-lived, it will simply get dropped from the buffer pool and may not necessarily incur I/O overhead.</span></span>  
  
### <a name="behavior-when-reading-data"></a><span data-ttu-id="ca04c-1303">Comportamento durante la lettura dei dati</span><span class="sxs-lookup"><span data-stu-id="ca04c-1303">Behavior When Reading Data</span></span>  

 <span data-ttu-id="ca04c-1304">Quando le transazioni in esecuzione con l'isolamento basato sul controllo delle versioni delle righe eseguono la lettura dei dati, le operazioni di lettura non acquisiscono blocchi condivisi (S) sui dati da leggere, e pertanto non bloccano le transazioni che stanno modificando i dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1304">When transactions running under row versioning-based isolation read data, the read operations do not acquire shared (S) locks on the data being read, and therefore do not block transactions that are modifying data.</span></span> <span data-ttu-id="ca04c-1305">Inoltre, l'overhead delle risorse di blocco è ridotto al minimo in quanto il numero di blocchi acquisiti si riduce.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1305">Also, the overhead of locking resources is minimized as the number of locks acquired is reduced.</span></span> <span data-ttu-id="ca04c-1306">L'isolamento read-committed tramite controllo delle versioni delle righe e isolamento dello snapshot è pensato per assicurare consistenze a livello di istruzione o di transazione dei dati sottoposti a controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1306">Read committed isolation using row versioning and snapshot isolation are designed to provide statement-level or transaction-level read consistencies of versioned data.</span></span>  
  
 <span data-ttu-id="ca04c-1307">Tutte le query, incluse le transazioni in esecuzione con i livelli di isolamento basati sul controllo delle versioni delle righe, acquisiscono blocchi di stabilità dello schema (Sch-S) durante le fasi di compilazione ed esecuzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1307">All queries, including transactions running under row versioning-based isolation levels, acquire Sch-S (schema stability) locks during compilation and execution.</span></span> <span data-ttu-id="ca04c-1308">Per questo motivo, le query vengono bloccate quando una transazione simultanea mantiene attivo un blocco di modifica dello schema sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1308">Because of this, queries are blocked when a concurrent transaction holds a Sch-M (schema modification) lock on the table.</span></span> <span data-ttu-id="ca04c-1309">Ad esempio, un'operazione DDL (Data Definition Language) acquisisce un blocco Sch-M prima di modificare le informazioni dello schema della tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1309">For example, a data definition language (DDL) operation acquires a Sch-M lock before it modifies the schema information of the table.</span></span> <span data-ttu-id="ca04c-1310">Le transazioni delle query, incluse quelle in esecuzione con un livello di isolamento basato sul controllo delle versioni delle righe, vengono quindi bloccate durante il tentativo di acquisizione di un blocco Sch-S.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1310">Query transactions, including those running under a row versioning-based isolation level, are blocked when attempting to acquire a Sch-S lock.</span></span> <span data-ttu-id="ca04c-1311">Una query con blocco Sch-S blocca invece le transazioni simultanee che tentano di acquisire un blocco Sch-M.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1311">Conversely, a query holding a Sch-S lock blocks a concurrent transaction that attempts to acquire a Sch-M lock.</span></span>  
  
 <span data-ttu-id="ca04c-1312">Quando una transazione che utilizza il livello di isolamento dello snapshot ha inizio, l'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)] registra tutte le transazioni attualmente attive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1312">When a transaction using the snapshot isolation level starts, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] records all of the currently active transactions.</span></span> <span data-ttu-id="ca04c-1313">Quando la transazione snapshot legge una riga che include una catena delle versioni, [!INCLUDE[ssDE](../includes/ssde-md.md)] segue la catena e recupera la riga per la quale il numero di sequenza della transazione è:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1313">When the snapshot transaction reads a row that has a version chain, the [!INCLUDE[ssDE](../includes/ssde-md.md)] follows the chain and retrieves the row where the transaction sequence number is:</span></span>  
  
-   <span data-ttu-id="ca04c-1314">Più vicino ma inferiore al numero di sequenza della transazione snapshot che sta leggendo la riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1314">Closest to but lower than the sequence number of the snapshot transaction reading the row.</span></span>  
  
-   <span data-ttu-id="ca04c-1315">Non incluso nell'elenco delle transazioni attive quando la transazione snapshot ha avuto inizio.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1315">Not in the list of the transactions active when the snapshot transaction started.</span></span>  
  
 <span data-ttu-id="ca04c-1316">Le operazioni di lettura eseguite da una transazione snapshot recuperano l'ultima versione di ogni riga di cui è stato eseguito il commit al momento dell'avvio della transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1316">Read operations performed by a snapshot transaction retrieve the last version of each row that had been committed at the time the snapshot transaction started.</span></span> <span data-ttu-id="ca04c-1317">Questo determina uno snapshot dei dati, consistente dal punto di vista transazionale, nello stato in cui si trovavano all'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1317">This provides a transactionally consistent snapshot of the data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="ca04c-1318">Le transazioni read-committed che utilizzano il controllo delle versioni delle righe funzionano in modo analogo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1318">Read-committed transactions using row versioning operate in much the same way.</span></span> <span data-ttu-id="ca04c-1319">La differenza è rappresentata dal fatto che la transazione read-committed non utilizza un proprio numero di sequenza della transazione nella scelta delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1319">The difference is that the read-committed transaction does not use its own transaction sequence number when choosing row versions.</span></span> <span data-ttu-id="ca04c-1320">A ogni avvio di un'istruzione, la transazione read-committed legge l'ultimo numero di sequenza della transazione generato per l'istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1320">Each time a statement is started, the read-committed transaction reads the latest transaction sequence number issued for that instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="ca04c-1321">Si tratta del numero di sequenza della transazione utilizzato per selezionare le versioni di riga corrette per l'istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1321">This is the transaction sequence number used to select the correct row versions for that statement.</span></span> <span data-ttu-id="ca04c-1322">Questo consente alle transazioni read-committed di visualizzare uno snapshot dei dati nello stato in cui si trovavano all'inizio di ogni istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1322">This allows read-committed transactions to see a snapshot of the data as it exists at the start of each statement.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1323">Anche se le transazioni read-committed che utilizzano il controllo delle versioni delle righe offrono una vista consistente dei dati dal punto di vista transazionale a livello di istruzione, le versioni delle righe generate o utilizzate da questo tipo di transazione vengono mantenute fino al completamento della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1323">Even though read-committed transactions using row versioning provides a transactionally consistent view of the data at a statement level, row versions generated or accessed by this type of transaction are maintained until the transaction completes.</span></span>  
  
### <a name="behavior-when-modifying-data"></a><span data-ttu-id="ca04c-1324">Comportamento durante la modifica dei dati</span><span class="sxs-lookup"><span data-stu-id="ca04c-1324">Behavior When Modifying Data</span></span>  

 <span data-ttu-id="ca04c-1325">In una transazione read-committed che utilizza il controllo delle versioni delle righe, la selezione delle righe da aggiornare viene eseguita utilizzando un'analisi di blocco in cui un blocco di aggiornamento (U) viene utilizzato sulla riga di dati durante la lettura dei valori dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1325">In a read-committed transaction using row versioning, the selection of rows to update is done using a blocking scan where an update (U) lock is taken on the data row as data values are read.</span></span> <span data-ttu-id="ca04c-1326">Questo avviene anche per una transazione read-committed che non utilizza il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1326">This is the same as a read-committed transaction that does not use row versioning.</span></span> <span data-ttu-id="ca04c-1327">Se la riga di dati non rispetta i criteri di aggiornamento, il blocco di aggiornamento viene rilasciato sulla riga e la riga successiva viene bloccata e analizzata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1327">If the data row does not meet the update criteria, the update lock is released on that row and the next row is locked and scanned.</span></span>  
  
 <span data-ttu-id="ca04c-1328">Le transazioni eseguite con isolamento dello snapshot adottano un approccio ottimistico alla modifica dei dati, in quanto acquisiscono blocchi sui dati prima di eseguire la modifica con l'unico scopo di imporre i vincoli.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1328">Transactions running under snapshot isolation take an optimistic approach to data modification by acquiring locks on data before performing the modification only to enforce constraints.</span></span> <span data-ttu-id="ca04c-1329">In caso contrario, non vengono acquisiti blocchi sui dati fino a quando questi non devono essere modificati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1329">Otherwise, locks are not acquired on data until the data is to be modified.</span></span> <span data-ttu-id="ca04c-1330">Quando una riga di dati rispetta i criteri di aggiornamento, la transazione snapshot verifica che la riga di dati non sia stata modificata da una transazione simultanea che abbia eseguito il commit dopo l'inizio della transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1330">When a data row meets the update criteria, the snapshot transaction verifies that the data row has not been modified by a concurrent transaction that committed after the snapshot transaction began.</span></span> <span data-ttu-id="ca04c-1331">Se la riga di dati è stata modificata all'esterno della transazione snapshot, si verifica un conflitto di aggiornamento e la transazione snapshot viene interrotta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1331">If the data row has been modified outside of the snapshot transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span> <span data-ttu-id="ca04c-1332">Il conflitto di aggiornamento viene gestito da [!INCLUDE[ssDE](../includes/ssde-md.md)] e non è possibile disabilitare il rilevamento dei conflitti di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1332">The update conflict is handled by the [!INCLUDE[ssDE](../includes/ssde-md.md)] and there is no way to disable the update conflict detection.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1333">Le operazioni di aggiornamento in esecuzione con il livello di isolamento dello snapshot vengono eseguite internamente con isolamento read-committed quando la transazione snapshot accede a uno degli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1333">Update operations running under snapshot isolation internally execute under read committed isolation when the snapshot transaction accesses any of the following:</span></span>  
>   
>  <span data-ttu-id="ca04c-1334">Una tabella con un vincolo FOREIGN KEY.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1334">A table with a FOREIGN KEY constraint.</span></span>  
>   
>  <span data-ttu-id="ca04c-1335">Una tabella cui viene fatto riferimento nel vincolo FOREIGN KEY di un'altra tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1335">A table that is referenced in the FOREIGN KEY constraint of another table.</span></span>  
>   
>  <span data-ttu-id="ca04c-1336">Una vista indicizzata che fa riferimento a più tabelle.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1336">An indexed view referencing more than one table.</span></span>  
>   
>  <span data-ttu-id="ca04c-1337">Tuttavia, anche in queste condizioni l'operazione di aggiornamento continuerà per verificare che i dati non siano stati modificati da un'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1337">However, even under these conditions the update operation will continue to verify that the data has not been modified by another transaction.</span></span> <span data-ttu-id="ca04c-1338">In questo caso, la transazione snapshot rileverà un conflitto di aggiornamento e verrà interrotta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1338">If data has been modified by another transaction, the snapshot transaction encounters an update conflict and is terminated.</span></span>  
  
### <a name="behavior-in-summary"></a><span data-ttu-id="ca04c-1339">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="ca04c-1339">Behavior in Summary</span></span>  

 <span data-ttu-id="ca04c-1340">Nella tabella seguente vengono illustrate le differenze tra isolamento dello snapshot e isolamento read-committed utilizzando il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1340">The following table summarizes the differences between snapshot isolation and read committed isolation using row versioning.</span></span>  
  
|<span data-ttu-id="ca04c-1341">Proprietà</span><span class="sxs-lookup"><span data-stu-id="ca04c-1341">Property</span></span>|<span data-ttu-id="ca04c-1342">Livello di isolamento read-committed che utilizza il controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1342">Read-committed isolation level using row versioning</span></span>|<span data-ttu-id="ca04c-1343">Livello di isolamento dello snapshot</span><span class="sxs-lookup"><span data-stu-id="ca04c-1343">Snapshot isolation level</span></span>|  
|--------------|----------------------------------------------------------|------------------------------|  
|<span data-ttu-id="ca04c-1344">L'opzione di database che deve essere impostata su ON per attivare il supporto necessario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1344">The database option that must be set to ON to enable the required support.</span></span>|<span data-ttu-id="ca04c-1345">READ_COMMITTED_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="ca04c-1345">READ_COMMITTED_SNAPSHOT</span></span>|<span data-ttu-id="ca04c-1346">ALLOW_SNAPSHOT_ISOLATION</span><span class="sxs-lookup"><span data-stu-id="ca04c-1346">ALLOW_SNAPSHOT_ISOLATION</span></span>|  
|<span data-ttu-id="ca04c-1347">Modalità con cui una sessione richiede il tipo specifico di controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1347">How a session requests the specific type of row versioning.</span></span>|<span data-ttu-id="ca04c-1348">Utilizzare il livello di isolamento read-committed predefinito o eseguire l'istruzione SET TRANSACTION ISOLATION LEVEL per specificare il livello di isolamento READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1348">Use the default read-committed isolation level, or run the SET TRANSACTION ISOLATION LEVEL statement to specify the READ COMMITTED isolation level.</span></span> <span data-ttu-id="ca04c-1349">L'operazione può essere eseguita dopo l'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1349">This can be done after the transaction starts.</span></span>|<span data-ttu-id="ca04c-1350">Richiede l'esecuzione di SET TRANSACTION ISOLATION LEVEL per specificare il livello di isolamento SNAPSHOT prima dell'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1350">Requires the execution of SET TRANSACTION ISOLATION LEVEL to specify the SNAPSHOT isolation level before the start of the transaction.</span></span>|  
|<span data-ttu-id="ca04c-1351">La versione dei dati letta dalle istruzioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1351">The version of data read by statements.</span></span>|<span data-ttu-id="ca04c-1352">Tutti i dati di cui è stato eseguito il commit prima dell'inizio di ogni istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1352">All data that was committed before the start of each statement.</span></span>|<span data-ttu-id="ca04c-1353">Tutti i dati di cui è stato eseguito il commit prima dell'inizio di ogni transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1353">All data that was committed before the start of each transaction.</span></span>|  
|<span data-ttu-id="ca04c-1354">Procedura di gestione degli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1354">How updates are handled.</span></span>|<span data-ttu-id="ca04c-1355">Esegue il ripristino dalle versioni delle righe ai dati attuali per selezionare le righe per l'aggiornamento e utilizza i blocchi di aggiornamento sulle righe di dati selezionate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1355">Reverts from row versions to actual data to select rows to update and uses update locks on the data rows selected.</span></span> <span data-ttu-id="ca04c-1356">Acquisisce blocchi esclusivi sulle righe di dati effettive da modificare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1356">Acquires exclusive locks on actual data rows to be modified.</span></span> <span data-ttu-id="ca04c-1357">Nessun rilevamento dei conflitti di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1357">No update conflict detection.</span></span>|<span data-ttu-id="ca04c-1358">Utilizza le versioni delle righe per selezionare le righe da aggiornare.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1358">Uses row versions to select rows to update.</span></span> <span data-ttu-id="ca04c-1359">Tenta di acquisire un blocco esclusivo sulla riga di dati effettiva da modificare. Se i dati sono stati modificati da un'altra transazione, si verifica un conflitto di aggiornamento e la transazione snapshot viene interrotta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1359">Tries to acquire an exclusive lock on the actual data row to be modified, and if the data has been modified by another transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span>|  
|<span data-ttu-id="ca04c-1360">Rilevamento dei conflitti di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1360">Update conflict detection.</span></span>|<span data-ttu-id="ca04c-1361">No.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1361">None.</span></span>|<span data-ttu-id="ca04c-1362">Supporto integrato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1362">Integrated support.</span></span> <span data-ttu-id="ca04c-1363">Non disabilitabile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1363">Cannot be disabled.</span></span>|  
  
### <a name="row-versioning-resource-usage"></a><span data-ttu-id="ca04c-1364">Utilizzo delle risorse di controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1364">Row Versioning Resource Usage</span></span>  

 <span data-ttu-id="ca04c-1365">L'infrastruttura di controllo delle versioni delle righe supporta le caratteristiche seguenti disponibili in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1365">The row versioning framework supports the following features available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span></span>  
  
-   <span data-ttu-id="ca04c-1366">Trigger</span><span class="sxs-lookup"><span data-stu-id="ca04c-1366">Triggers</span></span>  
  
-   <span data-ttu-id="ca04c-1367">MARS (Multiple Active Result Set)</span><span class="sxs-lookup"><span data-stu-id="ca04c-1367">Multiple Active Results Sets (MARS)</span></span>  
  
-   <span data-ttu-id="ca04c-1368">Indicizzazione online</span><span class="sxs-lookup"><span data-stu-id="ca04c-1368">Online indexing</span></span>  
  
 <span data-ttu-id="ca04c-1369">L'infrastruttura di controllo delle versioni delle righe supporta inoltre i livelli di isolamento delle transazioni basati sul controllo delle versioni delle righe seguenti, disattivati per impostazione predefinita:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1369">The row versioning framework also supports the following row versioning-based transaction isolation levels, which by default are not enabled:</span></span>  
  
-   <span data-ttu-id="ca04c-1370">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su ON, le transazioni READ_COMMITTED offrono consistenza in lettura a livello di istruzioni tramite il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1370">When the READ_COMMITTED_SNAPSHOT database option is ON, READ_COMMITTED transactions provide statement-level read consistency using row versioning.</span></span>  
  
-   <span data-ttu-id="ca04c-1371">Quando l'opzione di database ALLOW_SNAPSHOT_ISOLATION è impostata su ON, le transazioni SNAPSHOT offrono consistenza in lettura a livello di istruzioni tramite il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1371">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, SNAPSHOT transactions provide transaction-level read consistency using row versioning.</span></span>  
  
 <span data-ttu-id="ca04c-1372">I livelli di isolamento basati sul controllo delle versioni delle righe consentono di ridurre il numero di blocchi acquisiti per transazione eliminando l'utilizzo di blocchi condivisi nelle operazioni di lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1372">Row versioning-based isolation levels reduce the number of locks acquired by transaction by eliminating the use of shared locks on read operations.</span></span> <span data-ttu-id="ca04c-1373">In questo modo, vengono garantite prestazioni di sistema migliori grazie alla riduzione delle risorse utilizzate per la gestione dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1373">This increases system performance by reducing the resources used to manage locks.</span></span> <span data-ttu-id="ca04c-1374">Le prestazioni risultano inoltre migliorate grazie al minor numero di volte in cui una transazione viene bloccata dai blocchi acquisiti da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1374">Performance is also increased by reducing the number of times a transaction is blocked by locks acquired by other transactions.</span></span>  
  
 <span data-ttu-id="ca04c-1375">I livelli di isolamento basati sul controllo delle versioni delle righe consentono di ridurre le risorse necessarie per le modifiche dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1375">Row versioning-based isolation levels increase the resources needed by data modifications.</span></span> <span data-ttu-id="ca04c-1376">L'attivazione di tali opzioni comporta il controllo delle versioni di tutte le modifiche dei dati per il database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1376">Enabling these options causes all data modifications for the database to be versioned.</span></span> <span data-ttu-id="ca04c-1377">Una copia dei dati precedente la modifica viene archiviata nel database tempdb anche quando non vi è alcuna transazione attiva che utilizza l'isolamento basato sul controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1377">A copy of the data before modification is stored in tempdb even when there are no active transactions using row versioning-based isolation.</span></span> <span data-ttu-id="ca04c-1378">I dati in seguito alla modifica includono un indicatore di misura ai dati a cui è stato applicato il controllo delle versioni archiviati in tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1378">The data after modification includes a pointer to the versioned data stored in tempdb.</span></span> <span data-ttu-id="ca04c-1379">Per oggetti di grandi dimensioni, in tempdb viene copiata solo la parte dell'oggetto modificata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1379">For large objects, only part of the object that changed is copied to tempdb.</span></span>  
  
#### <a name="space-used-in-tempdb"></a><span data-ttu-id="ca04c-1380">Spazio utilizzato in tempdb</span><span class="sxs-lookup"><span data-stu-id="ca04c-1380">Space Used in tempdb</span></span>  

 <span data-ttu-id="ca04c-1381">Per ogni istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)], in tempdb deve essere disponibile una quantità di spazio sufficiente per contenere le versioni di riga generate per ogni database incluso nell'istanza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1381">For each instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb must have enough space to hold the row versions generated for every database in the instance.</span></span> <span data-ttu-id="ca04c-1382">L'amministratore del database deve fare in modo che in tempdb sia disponibile una quantità di spazio elevata per supportare l'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1382">The database administrator must ensure that tempdb has ample space to support the version store.</span></span> <span data-ttu-id="ca04c-1383">In tempdb sono inclusi due archivi versioni:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1383">There are two version stores in tempdb:</span></span>  
  
-   <span data-ttu-id="ca04c-1384">L'archivio versioni compilazione degli indici online viene utilizzato per le compilazioni degli indici online in tutti i database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1384">The online index build version store is used for online index builds in all databases.</span></span>  
  
-   <span data-ttu-id="ca04c-1385">L'archivio versioni comune viene utilizzato per tutte le altre operazioni di modifica dei dati in tutti i database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1385">The common version store is used for all other data modification operations in all databases.</span></span>  
  
 <span data-ttu-id="ca04c-1386">Le versioni di riga devono essere archiviate per tutto il tempo necessario a una transazione attiva per accedervi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1386">Row versions must be stored for as long as an active transaction needs to access it.</span></span> <span data-ttu-id="ca04c-1387">Una volta al minuto un thread in background rimuove le versioni di riga che non sono più necessarie e libera il relativo spazio utilizzato in tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1387">Once every minute, a background thread removes row versions that are no longer needed and frees up the version space in tempdb.</span></span> <span data-ttu-id="ca04c-1388">Una transazione con esecuzione prolungata impedisce che venga liberato lo spazio nell'archivio versioni se si verificano le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1388">A long-running transaction prevents space in the version store from being released if it meets any of the following conditions:</span></span>  
  
-   <span data-ttu-id="ca04c-1389">Viene utilizzato l'isolamento basato sul controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1389">It uses row versioning-based isolation.</span></span>  
  
-   <span data-ttu-id="ca04c-1390">Vengono utilizzati trigger, MARS o operazioni di compilazione di indici online.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1390">It uses triggers, MARS, or online index build operations.</span></span>  
  
-   <span data-ttu-id="ca04c-1391">Vengono generate versioni di riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1391">It generates row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1392">Quando viene richiamato un trigger all'interno di una transazione, le versioni di riga create dal trigger vengono mantenute fino alla fine della transazione, anche se le versioni di riga non sono più necessarie al termine del trigger.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1392">When a trigger is invoked inside a transaction, the row versions created by the trigger are maintained until the end of the transaction, even though the row versions are no longer needed after the trigger completes.</span></span> <span data-ttu-id="ca04c-1393">Questa situazione riguarda inoltre le transazioni Read committed che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1393">This also applies to read-committed transactions that use row versioning.</span></span> <span data-ttu-id="ca04c-1394">Con questo tipo di transazione, una vista del database consistente a livello di transazioni è necessaria solo per ogni istruzione della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1394">With this type of transaction, a transactionally consistent view of the database is needed only for each statement in the transaction.</span></span> <span data-ttu-id="ca04c-1395">Le versioni di riga create per un'istruzione della transazione non sono pertanto più necessarie al termine dell'istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1395">This means that the row versions created for a statement in the transaction are no longer needed after the statement completes.</span></span> <span data-ttu-id="ca04c-1396">Le versioni di riga create da ogni istruzione della transazione vengono tuttavia mantenute fino al termine della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1396">However, row versions created by each statement in the transaction are maintained until the transaction completes.</span></span>  
  
 <span data-ttu-id="ca04c-1397">Quando in tempdb viene esaurito tutto lo spazio, [!INCLUDE[ssDE](../includes/ssde-md.md)] forza la compattazione degli archivi versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1397">When tempdb runs out of space, the [!INCLUDE[ssDE](../includes/ssde-md.md)] forces the version stores to shrink.</span></span> <span data-ttu-id="ca04c-1398">Durante il processo di compattazione, le transazioni con esecuzione prolungata che non hanno ancora generato versioni di riga vengono contrassegnate come vittime.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1398">During the shrink process, the longest running transactions that have not yet generated row versions are marked as victims.</span></span> <span data-ttu-id="ca04c-1399">Nel log degli errori viene generato un messaggio 3967 per ogni transazione vittima.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1399">A message 3967 is generated in the error log for each victim transaction.</span></span> <span data-ttu-id="ca04c-1400">Se una transazione viene contrassegnata come vittima, non può più leggere le versioni di riga nell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1400">If a transaction is marked as a victim, it can no longer read the row versions in the version store.</span></span> <span data-ttu-id="ca04c-1401">Quando la transazione tenta di leggere le versioni di riga, viene generato un messaggio 3966 e viene eseguito il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1401">When it attempts to read row versions, message 3966 is generated and the transaction is rolled back.</span></span> <span data-ttu-id="ca04c-1402">Se il processo di compattazione ha esito positivo, lo spazio viene reso disponibile in tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1402">If the shrinking process succeeds, space becomes available in tempdb.</span></span> <span data-ttu-id="ca04c-1403">In caso contrario, lo spazio di tempdb si esaurisce e si verificano le situazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1403">Otherwise, tempdb runs out of space and the following occurs:</span></span>  
  
-   <span data-ttu-id="ca04c-1404">L'esecuzione delle operazioni di scrittura prosegue, ma non vengono generate versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1404">Write operations continue to execute but do not generate versions.</span></span> <span data-ttu-id="ca04c-1405">Nel log degli errori viene visualizzato un messaggio informativo (3959), ma la transazione che scrive i dati non subisce alcun effetto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1405">An information message (3959) appears in the error log, but the transaction that writes data is not affected.</span></span>  
  
-   <span data-ttu-id="ca04c-1406">Le transazioni che tentano di accedere alle versioni di riga non generate a causa di un rollback completo di tempdb vengono terminate con un errore 3958.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1406">Transactions that attempt to access row versions that were not generated because of a tempdb full rollback terminate with an error 3958.</span></span>  
  
#### <a name="space-used-in-data-rows"></a><span data-ttu-id="ca04c-1407">Spazio utilizzato nelle righe di dati</span><span class="sxs-lookup"><span data-stu-id="ca04c-1407">Space Used in Data Rows</span></span>  

 <span data-ttu-id="ca04c-1408">Ogni riga del database può utilizzare fino a 14 byte alla fine della riga per le informazioni relative al controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1408">Each database row may use up to 14 bytes at the end of the row for row versioning information.</span></span> <span data-ttu-id="ca04c-1409">Tali informazioni contengono il numero di sequenza della transazione che ha eseguito il commit della versione e il puntatore alla riga di cui è stato eseguito il controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1409">The row versioning information contains the transaction sequence number of the transaction that committed the version and the pointer to the versioned row.</span></span> <span data-ttu-id="ca04c-1410">Questi 14 byte vengono aggiunti alla prima modifica della riga oppure quando viene inserita una nuova riga se si verifica una delle condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1410">These 14 bytes are added the first time the row is modified, or when a new row is inserted, under any of these conditions:</span></span>  
  
-   <span data-ttu-id="ca04c-1411">L'opzione READ_COMMITTED_SNAPSHOT o ALLOW_SNAPSHOT_ISOLATION è impostata su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1411">READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION options are ON.</span></span>  
  
-   <span data-ttu-id="ca04c-1412">La tabella include un trigger.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1412">The table has a trigger.</span></span>  
  
-   <span data-ttu-id="ca04c-1413">Viene utilizzato MARS (Multiple Active Results Set).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1413">Multiple Active Results Sets (MARS) is being used.</span></span>  
  
-   <span data-ttu-id="ca04c-1414">Nella tabella sono in esecuzione operazioni di compilazione di indici online.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1414">Online index build operations are currently running on the table.</span></span>  
  
 <span data-ttu-id="ca04c-1415">I 14 byte vengono rimossi dalla riga del database alla prima modifica della riga quando si verificano tutte le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1415">These 14 bytes are removed from the database row the first time the row is modified under all of these conditions:</span></span>  
  
-   <span data-ttu-id="ca04c-1416">Le opzioni READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION sono impostate su OFF.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1416">READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION options are OFF.</span></span>  
  
-   <span data-ttu-id="ca04c-1417">Il trigger non è più presente nella tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1417">The trigger no longer exists on the table.</span></span>  
  
-   <span data-ttu-id="ca04c-1418">Non si utilizza MARS.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1418">MARS is not being used.</span></span>  
  
-   <span data-ttu-id="ca04c-1419">Le operazioni di compilazione di indici online non sono in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1419">Online index build operations are not currently running.</span></span>  
  
 <span data-ttu-id="ca04c-1420">Se si utilizza una qualsiasi delle caratteristiche di controllo delle versioni delle righe, potrebbe essere necessario allocare spazio su disco sufficiente per includere i 14 byte per ogni riga del database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1420">If you use any of the row versioning features, you might need to allocate additional disk space for the database to accommodate the 14 bytes per database row.</span></span> <span data-ttu-id="ca04c-1421">L'aggiunta delle informazioni relative al controllo delle versioni delle righe può provocare la divisione delle pagine di indice o l'allocazione di una nuova pagina di dati se nella pagina corrente non è disponibile spazio sufficiente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1421">Adding the row versioning information can cause index page splits or the allocation of a new data page if there is not enough space available on the current page.</span></span> <span data-ttu-id="ca04c-1422">Se la lunghezza media della riga, ad esempio, è 100 byte, i 14 byte aggiuntivi provocano un aumento del 14 percento della tabella esistente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1422">For example, if the average row length is 100 bytes, the additional 14 bytes cause an existing table to grow up to 14 percent.</span></span>  
  
 <span data-ttu-id="ca04c-1423">La riduzione del [fattore di riempimento](../relational-databases/indexes/specify-fill-factor-for-an-index.md) potrebbe impedire o ridurre la frammentazione di pagine di indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1423">Decreasing the [fill factor](../relational-databases/indexes/specify-fill-factor-for-an-index.md) might help to prevent or decrease fragmentation of index pages.</span></span> <span data-ttu-id="ca04c-1424">Per visualizzare le informazioni sulla frammentazione per i dati e gli indici di una tabella o di una vista, è possibile utilizzare [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1424">To view fragmentation information for the data and indexes of a table or view, you can use [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span></span>  
  
#### <a name="space-used-in-large-objects"></a><span data-ttu-id="ca04c-1425">Spazio utilizzato in oggetti di grandi dimensioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1425">Space Used in Large Objects</span></span>  

 <span data-ttu-id="ca04c-1426">[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supporta sei tipi di dati in grado di includere stringhe estese di un massimo di 2 gigabyte (GB) di lunghezza: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text` e `image`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1426">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supports six data types that can hold large strings up to 2 gigabytes (GB) in length: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text`, and `image`.</span></span> <span data-ttu-id="ca04c-1427">Le stringhe estese per cui vengono utilizzati questi tipi di dati vengono archiviate in una serie di frammenti di dati collegati alla riga di dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1427">Large strings stored using these data types are stored in a series of data fragments that are linked to the data row.</span></span> <span data-ttu-id="ca04c-1428">Le informazioni relative al controllo delle versioni delle righe vengono archiviate in ogni frammento utilizzato per archiviare tali stringhe estese.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1428">Row versioning information is stored in each fragment used to store these large strings.</span></span> <span data-ttu-id="ca04c-1429">I frammenti di dati sono una raccolta di pagine dedicate a oggetti di grandi dimensioni in una tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1429">Data fragments are a collection of pages dedicated to large objects in a table.</span></span>  
  
 <span data-ttu-id="ca04c-1430">Man mano che nel database vengono aggiunti nuovi valori di grandi dimensioni, questi valori vengono allocati utilizzando un massimo di 8040 byte di dati per frammento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1430">As new large values are added to a database, they are allocated using a maximum of 8040 bytes of data per fragment.</span></span> <span data-ttu-id="ca04c-1431">Nelle versioni precedenti di [!INCLUDE[ssDE](../includes/ssde-md.md)] vengono archiviati fino a 8080 byte di dati `ntext`, `text` o `image` per frammento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1431">Earlier versions of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stored up to 8080 bytes of `ntext`, `text`, or `image` data per fragment.</span></span>  
  
 <span data-ttu-id="ca04c-1432">I dati LOB (Large Object) esistenti `ntext`, `text` e `image` non vengono aggiornati per lasciare spazio alle informazioni relative al controllo delle versioni delle righe quando un database viene aggiornato a [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] da una versione precedente di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1432">Existing `ntext`, `text`, and `image` large object (LOB) data is not updated to make space for the row versioning information when a database is upgraded to [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] from an earlier version of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="ca04c-1433">La prima volta che i dati LOB vengono modificati, tuttavia, vengono aggiornati dinamicamente per consentire l'archiviazione delle informazioni relative al controllo delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1433">However, the first time the LOB data is modified, it is dynamically upgraded to enable storage of versioning information.</span></span> <span data-ttu-id="ca04c-1434">Questa operazione viene eseguita anche se non vengono generate versioni di riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1434">This will happen even if row versions are not generated.</span></span> <span data-ttu-id="ca04c-1435">In seguito all'aggiornamento dei dati LOB, il numero massimo di byte archiviati per frammento viene ridotto da 8080 byte a 8040 byte.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1435">After the LOB data is upgraded, the maximum number of bytes stored per fragment is reduced from 8080 bytes to 8040 bytes.</span></span> <span data-ttu-id="ca04c-1436">Il processo di aggiornamento equivale all'eliminazione del valore LOB e al reinserimento dello stesso valore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1436">The upgrade process is equivalent to deleting the LOB value and reinserting the same value.</span></span> <span data-ttu-id="ca04c-1437">I dati LOB vengono aggiornati anche se viene modificato un solo byte.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1437">The LOB data is upgraded even if only one byte is modified.</span></span> <span data-ttu-id="ca04c-1438">Si tratta di un'operazione occasionale per ogni colonna `ntext`, `text` o `image`, ma ogni operazione può generare una quantità elevata di allocazioni di pagina e un'ingente attività di I/O, a seconda delle dimensioni dei dati LOB.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1438">This is a one-time operation for each `ntext`, `text`, or `image` column, but each operation may generate a large amount of page allocations and I/O activity depending upon the size of the LOB data.</span></span> <span data-ttu-id="ca04c-1439">Tali operazioni possono inoltre generare un'attività di registrazione elevata se la modifica viene registrata completamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1439">It may also generate a large amount of logging activity if the modification is fully logged.</span></span> <span data-ttu-id="ca04c-1440">Viene eseguita la registrazione minima delle operazioni WRITETEXT e UPDATETEXT se la modalità di recupero del database non è impostata su FULL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1440">WRITETEXT and UPDATETEXT operations are minimally logged if database recovery mode is not set to FULL.</span></span>  
  
 <span data-ttu-id="ca04c-1441">I tipi di dati `nvarchar(max)`, `varchar(max)` e `varbinary(max)` non sono disponibili nelle versioni precedenti di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1441">The `nvarchar(max)`, `varchar(max)`, and `varbinary(max)` data types are not available in earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="ca04c-1442">Per questo motivo, tali tipi dati non sono interessati da problemi di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1442">Therefore, they have no upgrade issues.</span></span>  
  
 <span data-ttu-id="ca04c-1443">Per soddisfare questo requisito, è necessario allocare spazio su disco sufficiente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1443">Enough disk space should be allocated to accommodate this requirement.</span></span>  
  
#### <a name="monitoring-row-versioning-and-the-version-store"></a><span data-ttu-id="ca04c-1444">Controllo delle versioni delle righe e archivio versioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1444">Monitoring Row Versioning and the Version Store</span></span>  

 <span data-ttu-id="ca04c-1445">Per il controllo delle versioni delle righe, l'archivio versioni e i processi di isolamento dello snapshot per le prestazioni e i problemi, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] offre strumenti in forma di viste a gestione dinamica e contatori delle prestazioni di Windows System Monitor.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1445">For monitoring row versioning, version store, and snapshot isolation processes for performance and problems, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] provides tools in the form of Dynamic Management Views (DMVs) and performance counters in Windows System Monitor.</span></span>  
  
##### <a name="dmvs"></a><span data-ttu-id="ca04c-1446">Viste a gestione dinamica</span><span class="sxs-lookup"><span data-stu-id="ca04c-1446">DMVs</span></span>  

 <span data-ttu-id="ca04c-1447">Le seguenti viste a gestione dinamica forniscono informazioni sullo stato attuale del sistema di tempdb e l'archivio versioni, nonché delle transazioni che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1447">The following DMVs provide information about the current system state of tempdb and the version store, as well as transactions using row versioning.</span></span>  
  
 <span data-ttu-id="ca04c-1448">sys.dm_db_file_space_usage.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1448">sys.dm_db_file_space_usage.</span></span> <span data-ttu-id="ca04c-1449">Restituisce informazioni sull'utilizzo dello spazio per ogni file nel database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1449">Returns space usage information for each file in the database.</span></span> <span data-ttu-id="ca04c-1450">Per altre informazioni, vedere [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1450">For more information, see [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1451">sys.dm_db_session_space_usage.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1451">sys.dm_db_session_space_usage.</span></span> <span data-ttu-id="ca04c-1452">Restituisce informazioni relative alle attività di allocazione e deallocazione delle pagine per sessione per il database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1452">Returns page allocation and deallocation activity by session for the database.</span></span> <span data-ttu-id="ca04c-1453">Per altre informazioni, vedere [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1453">For more information, see [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1454">sys.dm_db_task_space_usage.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1454">sys.dm_db_task_space_usage.</span></span> <span data-ttu-id="ca04c-1455">Restituisce informazioni sulle allocazioni e deallocazioni delle pagine per ogni attività per il database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1455">Returns page allocation and deallocation activity by task for the database.</span></span> <span data-ttu-id="ca04c-1456">Per altre informazioni, vedere [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1456">For more information, see [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1457">sys.dm_tran_top_version_generators.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1457">sys.dm_tran_top_version_generators.</span></span> <span data-ttu-id="ca04c-1458">Restituisce una tabella virtuale per gli oggetti indicante la maggior parte delle versioni nell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1458">Returns a virtual table for the objects producing the most versions in the version store.</span></span> <span data-ttu-id="ca04c-1459">Raggruppa le 256 lunghezze superiori dei record di aggregazione per database_id e rowset_id.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1459">It groups the top 256 aggregated record lengths by database_id and rowset_id.</span></span> <span data-ttu-id="ca04c-1460">Utilizzare questa funzione per trovare i maggiori consumer dell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1460">Use this function to find the largest consumers of the version store.</span></span> <span data-ttu-id="ca04c-1461">Per altre informazioni, vedere [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1461">For more information, see [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1462">sys.dm_tran_version_store.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1462">sys.dm_tran_version_store.</span></span> <span data-ttu-id="ca04c-1463">Restituisce una tabella virtuale in cui vengono visualizzati tutti i record di versione nell'archivio versioni comune.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1463">Returns a virtual table that displays all version records in the common version store.</span></span> <span data-ttu-id="ca04c-1464">Per altre informazioni, vedere [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1464">For more information, see [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1465">sys.dm_tran_top_version_generators e sys.dm_tran_version_store possono essere funzioni molto costose da eseguire, poiché entrambe inviano query all'intero archivio versioni, che potrebbe avere dimensioni estremamente elevate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1465">sys.dm_tran_top_version_generators and sys.dm_tran_version_store are potentially very expensive functions to run, since both query the entire version store, which could be very large.</span></span>  
  
 <span data-ttu-id="ca04c-1466">sys.dm_tran_active_snapshot_database_transactions.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1466">sys.dm_tran_active_snapshot_database_transactions.</span></span> <span data-ttu-id="ca04c-1467">Restituisce una tabella virtuale per tutte le transazioni attive in tutti i database dell'istanza di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1467">Returns a virtual table for all active transactions in all databases within the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] instance that use row versioning.</span></span> <span data-ttu-id="ca04c-1468">Le transazioni di sistema non vengono visualizzate in questa DMV.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1468">System transactions do not appear in this DMV.</span></span> <span data-ttu-id="ca04c-1469">Per altre informazioni, vedere [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1469">For more information, see [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1470">sys.dm_tran_transactions_snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1470">sys.dm_tran_transactions_snapshot.</span></span> <span data-ttu-id="ca04c-1471">Restituisce una tabella virtuale in cui vengono visualizzati gli snapshot creati da ogni transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1471">Returns a virtual table that displays snapshots taken by each transaction.</span></span> <span data-ttu-id="ca04c-1472">Lo snapshot contiene il numero di sequenza delle transazioni attive che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1472">The snapshot contains the sequence number of the active transactions that use row versioning.</span></span> <span data-ttu-id="ca04c-1473">Per altre informazioni, vedere [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1473">For more information, see [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1474">sys.dm_tran_current_transaction.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1474">sys.dm_tran_current_transaction.</span></span> <span data-ttu-id="ca04c-1475">Restituisce una singola riga in cui vengono visualizzate le informazioni sullo stato correlate al controllo delle versioni delle righe per la transazione nella sessione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1475">Returns a single row that displays row versioning-related state information of the transaction in the current session.</span></span> <span data-ttu-id="ca04c-1476">Per altre informazioni, vedere [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1476">For more information, see [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1477">sys.dm_tran_current_snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1477">sys.dm_tran_current_snapshot.</span></span> <span data-ttu-id="ca04c-1478">Restituisce una tabella virtuale in cui vengono visualizzate tutte le transazioni attive al momento in cui è stata avviata la transazione di isolamento dello snapshot corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1478">Returns a virtual table that displays all active transactions at the time the current snapshot isolation transaction starts.</span></span> <span data-ttu-id="ca04c-1479">Se la transazione corrente utilizza l'isolamento dello snapshot, questa funzione non restituisce alcuna riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1479">If the current transaction is using snapshot isolation, this function returns no rows.</span></span> <span data-ttu-id="ca04c-1480">sys.dm_tran_current_snapshot è simile a sys.dm_tran_transactions_snapshot, ad eccezione del fatto che restituisce solo le transazioni attive per lo snapshot corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1480">sys.dm_tran_current_snapshot is similar to sys.dm_tran_transactions_snapshot, except that it returns only the active transactions for the current snapshot.</span></span> <span data-ttu-id="ca04c-1481">Per altre informazioni, vedere [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1481">For more information, see [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span></span>  
  
##### <a name="performance-counters"></a><span data-ttu-id="ca04c-1482">Contatori delle prestazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1482">Performance Counters</span></span>  

 <span data-ttu-id="ca04c-1483">I contatori delle prestazioni di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] includono informazioni sulle prestazioni del sistema su cui incidono i processi di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1483">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] performance counters provide information about the system performance impacted by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] processes.</span></span> <span data-ttu-id="ca04c-1484">I contatori delle prestazioni seguenti consentono di monitorare tempdb e l'archivio versioni, nonché le transazioni che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1484">The following performance counters monitor tempdb and the version store, as well as transactions using row versioning.</span></span> <span data-ttu-id="ca04c-1485">I contatori delle prestazioni sono inclusi nell'oggetto prestazione SQLServer:Transactions.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1485">The performance counters are contained in the SQLServer:Transactions performance object.</span></span>  
  
 <span data-ttu-id="ca04c-1486">**Spazio disponibile in tempdb (KB)** .</span><span class="sxs-lookup"><span data-stu-id="ca04c-1486">**Free Space in tempdb (KB)**.</span></span> <span data-ttu-id="ca04c-1487">Esegue il monitoraggio della quantità, in kilobyte (KB), di spazio libero nel database tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1487">Monitors the amount, in kilobytes (KB), of free space in the tempdb database.</span></span> <span data-ttu-id="ca04c-1488">In tempdb deve essere disponibile una quantità di spazio sufficiente per gestire l'archivio versioni che supporta l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1488">There must be enough free space in tempdb to handle the version store that supports snapshot isolation.</span></span>  
  
 <span data-ttu-id="ca04c-1489">Nella formula seguente viene eseguito un calcolo approssimativo delle dimensioni dell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1489">The following formula provides a rough estimate of the size of the version store.</span></span> <span data-ttu-id="ca04c-1490">Per le transazioni con esecuzione prolungata, può essere utile monitorare la frequenza di generazione e pulizia per stimare le dimensioni massime dell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1490">For long-running transactions, it may be useful to monitor the generation and cleanup rate to estimate the maximum size of the version store.</span></span>  
  
 <span data-ttu-id="ca04c-1491">[dimensioni dell'archivio versioni comune] = 2 \* [dati dell'archivio versioni generati al minuto] \* [tempo massimo (in minuti) di esecuzione della transazione]</span><span class="sxs-lookup"><span data-stu-id="ca04c-1491">[size of common version store] = 2 \* [version store data generated per minute] \* [longest running time (minutes) of the transaction]</span></span>  
  
 <span data-ttu-id="ca04c-1492">Il tempo massimo di esecuzione delle transazioni non deve includere le compilazioni di indici online.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1492">The longest running time of transactions should not include online index builds.</span></span> <span data-ttu-id="ca04c-1493">Poiché queste operazioni possono richiedere una quantità di tempo prolungata nelle tabelle di dimensioni molto elevate, le compilazioni di indici online utilizzano un archivio versioni distinto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1493">Because these operations may take a long time on very large tables, online index builds use a separate version store.</span></span> <span data-ttu-id="ca04c-1494">Le dimensioni approssimative dell'archivio versioni compilazioni di indici online equivale alla quantità di dati modificati nella tabella, inclusi tutti gli indici, quando è attiva la compilazione di indici online.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1494">The approximate size of the online index build version store equals the amount of data modified in the table, including all indexes, while the online index build is active.</span></span>  
  
 <span data-ttu-id="ca04c-1495">**Dimensioni archivio versioni (KB)** .</span><span class="sxs-lookup"><span data-stu-id="ca04c-1495">**Version Store Size (KB)**.</span></span> <span data-ttu-id="ca04c-1496">Esegue il monitoraggio delle dimensioni in KB di tutti gli archivi versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1496">Monitors the size in KB of all version stores.</span></span> <span data-ttu-id="ca04c-1497">Queste informazioni consentono di determinare la quantità di spazio necessario nel database tempdb per l'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1497">This information helps determine the amount of space needed in the tempdb database for the version store.</span></span> <span data-ttu-id="ca04c-1498">Il monitoraggio di questo contatore per un certo periodo di tempo offre una stima utile dell'ulteriore spazio necessario per tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1498">Monitoring this counter over a period of time provides a useful estimate of additional space needed for tempdb.</span></span>  
  
 <span data-ttu-id="ca04c-1499">`Version Generation rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1499">`Version Generation rate (KB/s)`.</span></span> <span data-ttu-id="ca04c-1500">Esegue il monitoraggio della frequenza di generazione delle versioni in KB al secondo in tutti gli archivi versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1500">Monitors the version generation rate in KB per second in all version stores.</span></span>  
  
 <span data-ttu-id="ca04c-1501">`Version Cleanup rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1501">`Version Cleanup rate (KB/s)`.</span></span> <span data-ttu-id="ca04c-1502">Esegue il monitoraggio della frequenza di pulizia delle versioni in KB al secondo in tutti gli archivi versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1502">Monitors the version cleanup rate in KB per second in all version stores.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1503">Le informazioni incluse in Frequenza generazione versioni (KB/s) e Frequenza pulizia versioni (KB/s) possono essere utilizzate per prevedere i requisiti di spazio del database tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1503">Information from Version Generation rate (KB/s) and Version Cleanup rate (KB/s) can be used to predict tempdb space requirements.</span></span>  
  
 <span data-ttu-id="ca04c-1504">**Conteggio unità archivio versioni**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1504">**Version Store unit count**.</span></span> <span data-ttu-id="ca04c-1505">Esegue il monitoraggio del conteggio delle unità dell'archivio versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1505">Monitors the count of version store units.</span></span>  
  
 <span data-ttu-id="ca04c-1506">**Creazione unità archivio versioni**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1506">**Version Store unit creation**.</span></span> <span data-ttu-id="ca04c-1507">Esegue il monitoraggio del numero totale di unità dell'archivio versioni create per archiviare le versioni di riga dal momento in cui è stata avviata l'istanza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1507">Monitors the total number of version store units created to store row versions since the instance was started.</span></span>  
  
 <span data-ttu-id="ca04c-1508">**Troncamento unità archivio versioni**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1508">**Version Store unit truncation**.</span></span> <span data-ttu-id="ca04c-1509">Esegue il monitoraggio del numero totale di unità dell'archivio versioni troncate dal momento in cui è stata avviata l'istanza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1509">Monitors the total number of version store units truncated since the instance was started.</span></span> <span data-ttu-id="ca04c-1510">Un'unità dell'archivio versioni viene troncata quando in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] viene determinato che nessuna delle righe di versione archiviata nell'unità è necessaria per eseguire transazioni attive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1510">A version store unit is truncated when [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines that none of the version rows stored in the version store unit are needed to run active transactions.</span></span>  
  
 <span data-ttu-id="ca04c-1511">**Percentuale conflitti aggiornamento**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1511">**Update conflict ratio**.</span></span> <span data-ttu-id="ca04c-1512">Esegue il monitoraggio del rapporto tra le transazione snapshot di aggiornamento in cui sono presenti conflitti di aggiornamento e il numero totale di transazioni snapshot di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1512">Monitors the ratio of update snapshot transaction that have update conflicts to the total number of update snapshot transactions.</span></span>  
  
 <span data-ttu-id="ca04c-1513">**Tempo massimo esecuzione transazione**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1513">**Longest Transaction Running Time**.</span></span> <span data-ttu-id="ca04c-1514">Esegue il monitoraggio del tempo massimo di esecuzione in secondi di qualsiasi transazione che utilizza il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1514">Monitors the longest running time in seconds of any transaction using row versioning.</span></span> <span data-ttu-id="ca04c-1515">Queste informazioni possono essere utilizzate per determinare se alcune transazioni vengano eseguite in una quantità di tempo eccessiva.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1515">This can be used to determine if any transaction is running for an unreasonable amount of time.</span></span>  
  
 <span data-ttu-id="ca04c-1516">**Transazioni**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1516">**Transactions**.</span></span> <span data-ttu-id="ca04c-1517">Esegue il monitoraggio del numero totale di transazioni attive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1517">Monitors the total number of active transactions.</span></span> <span data-ttu-id="ca04c-1518">Non sono incluse le transazioni di sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1518">This does not include system transactions.</span></span>  
  
 <span data-ttu-id="ca04c-1519">`Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1519">`Snapshot Transactions`.</span></span> <span data-ttu-id="ca04c-1520">Esegue il monitoraggio del numero totale di transazioni snapshot attive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1520">Monitors the total number of active snapshot transactions.</span></span>  
  
 <span data-ttu-id="ca04c-1521">`Update Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1521">`Update Snapshot Transactions`.</span></span> <span data-ttu-id="ca04c-1522">Esegue il monitoraggio del numero totale di transazioni snapshot attive tramite cui vengono eseguite operazioni di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1522">Monitors the total number of active snapshot transactions that perform update operations.</span></span>  
  
 <span data-ttu-id="ca04c-1523">`NonSnapshot Version Transactions`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1523">`NonSnapshot Version Transactions`.</span></span> <span data-ttu-id="ca04c-1524">Esegue il monitoraggio del numero totale di transazioni non snapshot attive che generano record di versione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1524">Monitors the total number of active non-snapshot transactions that generate version records.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1525">La somma dei valori indicati in Transazioni snapshot di aggiornamento e Transazioni di versione non snapshot rappresenta il numero totale di transazioni coinvolte nella generazione delle versioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1525">The sum of Update Snapshot Transactions and NonSnapshot Version Transactions represents the total number of transactions that participate in version generation.</span></span> <span data-ttu-id="ca04c-1526">La differenza tra i valori indicati in Transazioni snapshot e Transazioni snapshot di aggiornamento rappresenta il numero di transazioni snapshot di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1526">The difference of Snapshot Transactions and Update Snapshot Transactions reports the number of read-only snapshot transactions.</span></span>  
  
### <a name="row-versioning-based-isolation-level-example"></a><span data-ttu-id="ca04c-1527">Esempio di livello di isolamento basato sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1527">Row Versioning-based Isolation Level Example</span></span>  

 <span data-ttu-id="ca04c-1528">Nell'esempio seguente vengono illustrate le differenze di comportamento tra le transazioni di isolamento dello snapshot e le transazioni Read Committed che utilizzano il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1528">The following examples show the differences in behavior between snapshot isolation transactions and read-committed transactions that use row versioning.</span></span>  
  
#### <a name="a-working-with-snapshot-isolation"></a><span data-ttu-id="ca04c-1529">R.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1529">A.</span></span> <span data-ttu-id="ca04c-1530">Utilizzo dell'isolamento dello snapshot</span><span class="sxs-lookup"><span data-stu-id="ca04c-1530">Working with snapshot isolation</span></span>  

 <span data-ttu-id="ca04c-1531">In questo esempio una transazione di isolamento dello snapshot legge dati che verranno successivamente modificati da un'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1531">In this example, a transaction running under snapshot isolation reads data that is then modified by another transaction.</span></span> <span data-ttu-id="ca04c-1532">La transazione snapshot non blocca l'operazione di aggiornamento eseguita dall'altra transazione e continua a leggere dati dalla riga con versione, ignorando la modifica dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1532">The snapshot transaction does not block the update operation executed by the other transaction, and it continues to read data from the versioned row, ignoring the data modification.</span></span> <span data-ttu-id="ca04c-1533">Quando, tuttavia, la transazione snapshot tenta di modificare dati che sono già stati modificati da un'altra transazione, viene generato un errore e la transazione snapshot termina.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1533">However, when the snapshot transaction attempts to modify the data that has already been modified by the other transaction, the snapshot transaction generates an error and is terminated.</span></span>  
  
 <span data-ttu-id="ca04c-1534">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1534">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or the 2008 or 2008R2 version of the AdventureWorks database.  
GO  
  
-- Enable snapshot isolation on the database.  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
GO  
  
-- Start a snapshot transaction  
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="ca04c-1535">Nella sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1535">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under snapshot isolation shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="ca04c-1536">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1536">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this shows  
    -- the employee having 48 vacation hours.  The  
    -- snapshot transaction is still reading data from  
    -- the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="ca04c-1537">Nella sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1537">On session 2:</span></span>  
  
```sql  
-- Commit the transaction; this commits the data  
-- modification.  
COMMIT TRANSACTION;  
GO  
```  
  
 <span data-ttu-id="ca04c-1538">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1538">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still   
    -- shows the employee having 48 vacation hours  
    -- even after the other transaction has committed  
    -- the data modification.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- Because the data has been modified outside of the  
    -- snapshot transaction, any further data changes to   
    -- that data by the snapshot transaction will cause   
    -- the snapshot transaction to fail. This statement   
    -- will generate a 3960 error and the transaction will   
    -- terminate.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION  
GO  
```  
  
#### <a name="b-working-with-read-committed-using-row-versioning"></a><span data-ttu-id="ca04c-1539">B.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1539">B.</span></span> <span data-ttu-id="ca04c-1540">Utilizzo di Read Committed con il controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1540">Working with read-committed using row versioning</span></span>  

 <span data-ttu-id="ca04c-1541">In questo esempio una transazione Read committed che utilizza il controllo delle versioni delle righe viene eseguita simultaneamente a un'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1541">In this example, a read-committed transaction using row versioning runs concurrently with another transaction.</span></span> <span data-ttu-id="ca04c-1542">La transazione Read committed si comporta in modo diverso da una transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1542">The read-committed transaction behaves differently than a snapshot transaction.</span></span> <span data-ttu-id="ca04c-1543">Come una transazione snapshot, la transazione Read committed legge le righe con versione anche dopo che i dati sono stati modificati dall'altra transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1543">Like a snapshot transaction, the read-committed transaction will read versioned rows even after the other transaction has modified data.</span></span> <span data-ttu-id="ca04c-1544">A differenza di una transazione snapshot, tuttavia, la transazione Read committed:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1544">However, unlike a snapshot transaction, the read-committed transaction will:</span></span>  
  
-   <span data-ttu-id="ca04c-1545">Legge i dati modificati dopo che l'altra transazione ha eseguito il commit delle modifiche dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1545">Read the modified data after the other transaction commits the data changes.</span></span>  
  
-   <span data-ttu-id="ca04c-1546">È in grado di aggiornare i dati modificati dall'altra transazione, a differenza della transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1546">Be able to update the data modified by the other transaction where the snapshot transaction could not.</span></span>  
  
 <span data-ttu-id="ca04c-1547">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1547">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or any earlier version of the AdventureWorks database.  
GO  
  
-- Enable READ_COMMITTED_SNAPSHOT on the database.  
-- For this statement to succeed, this session  
-- must be the only connection to the AdventureWorks2012  
-- database.  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
GO  
  
-- Start a read-committed transaction  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="ca04c-1548">Nella sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1548">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under read-committed using row versioning shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="ca04c-1549">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1549">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still shows  
    -- the employee having 48 vacation hours.  The  
    -- read-committed transaction is still reading data   
    -- from the versioned row and the other transaction   
    -- has not committed the data changes yet.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="ca04c-1550">Nella sessione 2:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1550">On session 2:</span></span>  
  
```sql  
-- Commit the transaction.  
COMMIT TRANSACTION;  
GO  
  
```  
  
 <span data-ttu-id="ca04c-1551">Nella sessione 1:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1551">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement which now shows the   
    -- employee having 40 vacation hours.  Being   
    -- read-committed, this transaction is reading the   
    -- committed data. This is different from snapshot  
    -- isolation which reads from the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- This statement, which caused the snapshot transaction   
    -- to fail, will succeed with read-committed using row versioning.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION;  
GO  
```  
  
### <a name="enabling-row-versioning-based-isolation-levels"></a><span data-ttu-id="ca04c-1552">Attivazione dei livelli di isolamento basati sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1552">Enabling Row Versioning-Based Isolation Levels</span></span>  

 <span data-ttu-id="ca04c-1553">Gli amministratori di database gestiscono le impostazioni a livello di database per il controllo delle versioni delle righe utilizzando le opzioni di database READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION dell'istruzione ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1553">Database administrators control the database-level settings for row versioning by using the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options in the ALTER DATABASE statement.</span></span>  
  
 <span data-ttu-id="ca04c-1554">Quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su ON, i meccanismi utilizzati per supportare l'opzione vengono attivati immediatamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1554">When the READ_COMMITTED_SNAPSHOT database option is set ON, the mechanisms used to support the option are activated immediately.</span></span> <span data-ttu-id="ca04c-1555">Quando si imposta l'opzione READ_COMMITTED_SNAPSHOT, nel database è consentita solo la connessione che esegue il comando ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1555">When setting the READ_COMMITTED_SNAPSHOT option, only the connection executing the ALTER DATABASE command is allowed in the database.</span></span> <span data-ttu-id="ca04c-1556">Nel database non devono essere presenti altre connessioni aperte fino al completamento del comando ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1556">There must be no other open connection in the database until ALTER DATABASE is complete.</span></span> <span data-ttu-id="ca04c-1557">Il database non deve essere in modalità utente singolo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1557">The database does not have to be in single-user mode.</span></span>  
  
 <span data-ttu-id="ca04c-1558">L'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] seguente consente di attivare l'opzione READ_COMMITTED_SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1558">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement enables READ_COMMITTED_SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
```  
  
 <span data-ttu-id="ca04c-1559">Quando l'opzione di database ALLOW_SNAPSHOT_ISOLATION è impostata su ON, l'istanza del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] non genera versioni di riga per i dati modificati fino al completamento di tutte le transazioni attive che includono dati modificati del database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1559">When the ALLOW_SNAPSHOT_ISOLATION database option is set ON, the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] does not generate row versions for modified data until all active transactions that have modified data in the database complete.</span></span> <span data-ttu-id="ca04c-1560">Se sono presenti transazioni di modifica attive, in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lo stato dell'opzione viene impostato su PENDING_ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1560">If there are active modification transactions, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sets the state of the option to PENDING_ON.</span></span> <span data-ttu-id="ca04c-1561">Dopo il completamento di tutte le transazioni di modifica, lo stato dell'opzione viene modificato in ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1561">After all of the modification transactions complete, the state of the option is changed to ON.</span></span> <span data-ttu-id="ca04c-1562">Gli utenti non possono avviare una transazione snapshot nel database fino a quando l'opzione non è impostata completamente su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1562">Users cannot start a snapshot transaction in that database until the option is fully ON.</span></span> <span data-ttu-id="ca04c-1563">Il database passa a uno stato PENDING_OFF quando l'amministratore del database imposta l'opzione ALLOW_SNAPSHOT_ISOLATION su OFF.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1563">The database passes through a PENDING_OFF state when the database administrator sets the ALLOW_SNAPSHOT_ISOLATION option to OFF.</span></span>  
  
 <span data-ttu-id="ca04c-1564">L'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] seguente consente di attivare l'opzione ALLOW_SNAPSHOT_ISOLATION:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1564">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement will enable ALLOW_SNAPSHOT_ISOLATION:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
```  
  
 <span data-ttu-id="ca04c-1565">Nella tabella seguente sono inclusi e descritti gli stati possibili dell'opzione ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1565">The following table lists and describes the states of the ALLOW_SNAPSHOT_ISOLATION option.</span></span> <span data-ttu-id="ca04c-1566">L'utilizzo dell'istruzione ALTER DATABASE con l'opzione ALLOW_SNAPSHOT_ISOLATION non blocca l'accesso in corso da parte degli utenti ai dati del database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1566">Using ALTER DATABASE with the ALLOW_SNAPSHOT_ISOLATION option does not block users who are currently accessing the database data.</span></span>  
  
|<span data-ttu-id="ca04c-1567">Stato del framework di isolamento dello snapshot per il database corrente</span><span class="sxs-lookup"><span data-stu-id="ca04c-1567">State of snapshot isolation framework for current database</span></span>|<span data-ttu-id="ca04c-1568">Descrizione</span><span class="sxs-lookup"><span data-stu-id="ca04c-1568">Description</span></span>|  
|----------------------------------------------------------------|-----------------|  
|<span data-ttu-id="ca04c-1569">OFF</span><span class="sxs-lookup"><span data-stu-id="ca04c-1569">OFF</span></span>|<span data-ttu-id="ca04c-1570">Il supporto per le transazioni di isolamento dello snapshot non è attivato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1570">The support for snapshot isolation transactions is not activated.</span></span> <span data-ttu-id="ca04c-1571">Non è consentita alcuna transazione di isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1571">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="ca04c-1572">PENDING_ON</span><span class="sxs-lookup"><span data-stu-id="ca04c-1572">PENDING_ON</span></span>|<span data-ttu-id="ca04c-1573">Il supporto per le transazioni di isolamento dello snapshot è in stato di transizione (da OFF a ON).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1573">The support for snapshot isolation transactions is in transition state (from OFF to ON).</span></span> <span data-ttu-id="ca04c-1574">Le transazioni aperte devono essere completate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1574">Open transactions must complete.</span></span><br /><br /> <span data-ttu-id="ca04c-1575">Non è consentita alcuna transazione di isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1575">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="ca04c-1576">ON</span><span class="sxs-lookup"><span data-stu-id="ca04c-1576">ON</span></span>|<span data-ttu-id="ca04c-1577">Il supporto per le transazioni di isolamento dello snapshot è attivato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1577">The support for snapshot isolation transactions is activated.</span></span><br /><br /> <span data-ttu-id="ca04c-1578">Le transazioni snapshot sono consentite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1578">Snapshot transactions are allowed.</span></span>|  
|<span data-ttu-id="ca04c-1579">PENDING_OFF</span><span class="sxs-lookup"><span data-stu-id="ca04c-1579">PENDING_OFF</span></span>|<span data-ttu-id="ca04c-1580">Il supporto per le transazioni di isolamento dello snapshot è in stato di transizione (da ON a OFF).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1580">The support for snapshot isolation transactions is in transition state (from ON to OFF).</span></span><br /><br /> <span data-ttu-id="ca04c-1581">Le transazioni snapshot avviate dopo questo momento non possono accedere al database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1581">Snapshot transactions started after this time cannot access this database.</span></span> <span data-ttu-id="ca04c-1582">Le transazioni di aggiornamento subiscono le conseguenze negative del controllo delle versioni nel database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1582">Update transactions still pay the cost of versioning in this database.</span></span> <span data-ttu-id="ca04c-1583">Le transazioni snapshot esistenti possono continuare ad accedere al database senza problemi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1583">Existing snapshot transactions can still access this database without a problem.</span></span> <span data-ttu-id="ca04c-1584">Lo stato PENDING_OFF non viene modificato in OFF fino al termine di tutte le transazioni snapshot attive quando lo stato di isolamento dello snapshot del database era impostato su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1584">The state PENDING_OFF does not become OFF until all snapshot transactions that were active when the database snapshot isolation state was ON finish.</span></span>|  
  
 <span data-ttu-id="ca04c-1585">Utilizzare la vista del catalogo sys.databases per determinare lo stato di entrambe le opzioni di database per il controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1585">Use the sys.databases catalog view to determine the state of both row versioning database options.</span></span>  
  
 <span data-ttu-id="ca04c-1586">Tutti gli aggiornamenti alle tabelle utente e ad alcune tabelle di sistema archiviate nei database master e msdb generano versioni di riga.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1586">All updates to user tables and some system tables stored in master and msdb generate row versions.</span></span>  
  
 <span data-ttu-id="ca04c-1587">L'opzione ALLOW_SNAPSHOT_ISOLATION viene impostata automaticamente su ON nei database master e msdb e non può essere disabilitata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1587">The ALLOW_SNAPSHOT_ISOLATION option is automatically set ON in the master and msdb databases, and cannot be disabled.</span></span>  
  
 <span data-ttu-id="ca04c-1588">Gli utenti non possono impostare l'opzione READ_COMMITTED_SNAPSHOT su ON nel database master, tempdb o msdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1588">Users cannot set the READ_COMMITTED_SNAPSHOT option ON in master, tempdb, or msdb.</span></span>  
  
### <a name="using-row-versioning-based-isolation-levels"></a><span data-ttu-id="ca04c-1589">Utilizzo di livelli di isolamento basati sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1589">Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="ca04c-1590">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] l'infrastruttura di controllo delle versioni delle righe è sempre abilitata e viene utilizzata da più caratteristiche.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1590">The row versioning framework is always enabled in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], and is used by multiple features.</span></span> <span data-ttu-id="ca04c-1591">Oltre a offrire livelli di isolamento basati sul controllo delle versioni delle righe, viene utilizzata per supportare le modifiche apportate in trigger e sessioni MARS (Multiple Active Result Sets) e le letture di dati per le operazioni sugli indici ONLINE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1591">Besides providing row versioning-based isolation levels, it is used to support modifications made in triggers and multiple active result sets (MARS) sessions, and to support data reads for ONLINE index operations.</span></span>  
  
 <span data-ttu-id="ca04c-1592">I livelli di isolamento basati sul controllo delle versioni delle righe sono attivati a livello di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1592">Row versioning-based isolation levels are enabled at the database level.</span></span> <span data-ttu-id="ca04c-1593">Le applicazioni che accedono agli oggetti da database abilitati possono eseguire query utilizzando i livelli di isolamento seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1593">Any application accessing objects from enabled databases can run queries using the following isolation levels:</span></span>  
  
-   <span data-ttu-id="ca04c-1594">Read Committed, che utilizza il controllo delle versioni delle righe mediante l'impostazione dell'opzione di database `READ_COMMITTED_SNAPSHOT` su `ON`, come illustrato nell'esempio di codice seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1594">Read-committed that uses row versioning by setting the `READ_COMMITTED_SNAPSHOT` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET READ_COMMITTED_SNAPSHOT ON;  
    ```  
  
     <span data-ttu-id="ca04c-1595">Quando il database è abilitato per READ_COMMITTED_SNAPSHOT, tutte le query in esecuzione nel livello di isolamento Read Committed utilizzano il controllo delle versioni delle righe. Ciò significa che le operazioni di lettura non comportano il blocco di quelle di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1595">When the database is enabled for READ_COMMITTED_SNAPSHOT, all queries running under the read committed isolation level use row versioning, which means that read operations do not block update operations.</span></span>  
  
-   <span data-ttu-id="ca04c-1596">Isolamento dello snapshot, mediante l'impostazione dell'opzione di database `ALLOW_SNAPSHOT_ISOLATION` su `ON`, come illustrato nell'esempio di codice seguente:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1596">Snapshot isolation by setting the `ALLOW_SNAPSHOT_ISOLATION` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET ALLOW_SNAPSHOT_ISOLATION ON;  
    ```  
  
     <span data-ttu-id="ca04c-1597">Una transazione in esecuzione in un livello di isolamento dello snapshot può accedere alle tabelle nel database abilitate per lo snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1597">A transaction running under snapshot isolation can access tables in the database that have been enabled for snapshot.</span></span> <span data-ttu-id="ca04c-1598">Per consentire l'accesso alle tabelle non abilitate per lo snapshot, è necessario modificare il livello di isolamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1598">To access tables that have not been enabled for snapshot, the isolation level must be changed.</span></span> <span data-ttu-id="ca04c-1599">Nell'esempio di codice seguente viene ad esempio illustrata un'istruzione `SELECT` che unisce in join due tabelle mentre è in esecuzione in una transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1599">For example, the following code example shows a `SELECT` statement that joins two tables while running under a snapshot transaction.</span></span> <span data-ttu-id="ca04c-1600">Una tabella appartiene a un database in cui non è stato attivato l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1600">One table belongs to a database in which snapshot isolation is not enabled.</span></span> <span data-ttu-id="ca04c-1601">Quando l'istruzione `SELECT` viene eseguita nel livello di isolamento dello snapshot, l'esecuzione non avviene correttamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1601">When the `SELECT` statement runs under snapshot isolation, it fails to execute successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
     <span data-ttu-id="ca04c-1602">Nell'esempio di codice seguente viene illustrata la stessa istruzione `SELECT` modificata in modo che il livello di isolamento della transazione sia Read Committed.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1602">The following code example shows the same `SELECT` statement that has been modified to change the transaction isolation level to read-committed.</span></span> <span data-ttu-id="ca04c-1603">Grazie a questa modifica, l'istruzione `SELECT` viene eseguita correttamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1603">Because of this change, the `SELECT` statement executes successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            WITH (READCOMMITTED)  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
#### <a name="limitations-of-transactions-using-row-versioning-based-isolation-levels"></a><span data-ttu-id="ca04c-1604">Limiti per le transazioni che utilizzano livelli di isolamento basati sul controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1604">Limitations of Transactions Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="ca04c-1605">Quando si utilizzano livelli di isolamento basati sul controllo delle versioni delle righe, considerare i limiti seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1605">Consider the following limitations when working with row versioning-based isolation levels:</span></span>  
  
-   <span data-ttu-id="ca04c-1606">Non è possibile attivare READ_COMMITTED_SNAPSHOT in tempdb, msdb o master.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1606">READ_COMMITTED_SNAPSHOT cannot be enabled in tempdb, msdb, or master.</span></span>  
  
-   <span data-ttu-id="ca04c-1607">Le tabelle temporanee globali sono archiviate in tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1607">Global temp tables are stored in tempdb.</span></span> <span data-ttu-id="ca04c-1608">Quando si accede a una tabella temporanea globale all'interno di una transazione snapshot, è necessario che si verifichi una delle condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1608">When accessing global temp tables inside a snapshot transaction, one of the following must happen:</span></span>  
  
    -   <span data-ttu-id="ca04c-1609">Impostare su ON l'opzione di database ALLOW_SNAPSHOT_ISOLATION in tempdb.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1609">Set the ALLOW_SNAPSHOT_ISOLATION database option ON in tempdb.</span></span>  
  
    -   <span data-ttu-id="ca04c-1610">Utilizzare un hint di isolamento per modificare il livello di isolamento per l'istruzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1610">Use an isolation hint to change the isolation level for the statement.</span></span>  
  
-   <span data-ttu-id="ca04c-1611">Le transazioni snapshot non hanno esito positivo nei casi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1611">Snapshot transactions fail when:</span></span>  
  
    -   <span data-ttu-id="ca04c-1612">Quando un database viene impostato come di sola lettura dopo l'avvio della transazione snapshot, ma prima dell'accesso al database da parte della transazione stessa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1612">A database is made read-only after the snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span>  
  
    -   <span data-ttu-id="ca04c-1613">Se si accede agli oggetti da più database, quando lo stato di un database è stato modificato in modo che il recupero del database sia avvenuto dopo l'avvio di una transazione snapshot, ma prima dell'accesso al database da parte della transazione stessa.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1613">If accessing objects from multiple databases, a database state was changed in such a way that database recovery occurred after a snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span> <span data-ttu-id="ca04c-1614">Quando, ad esempio, il database è stato impostato su OFFLINE e quindi su ONLINE, si è chiuso automaticamente e quindi si è aperto oppure è stato scollegato e quindi collegato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1614">For example: the database was set to OFFLINE and then to ONLINE, database autoclose and open, or database detach and attach.</span></span>  
  
-   <span data-ttu-id="ca04c-1615">Le transazioni distribuite, incluse le query in database partizionati distribuiti, non sono supportate nel livello di isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1615">Distributed transactions, including queries in distributed partitioned databases, are not supported under snapshot isolation.</span></span>  
  
-   <span data-ttu-id="ca04c-1616">Tramite [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] non vengono mantenute più versioni dei metadati di sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1616">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not keep multiple versions of system metadata.</span></span> <span data-ttu-id="ca04c-1617">Le istruzioni DLL (Data Definition Language) in tabelle e altri oggetti di database, ad esempio indici, viste, tipi di dati, stored procedure e funzioni CLR, comportano la modifica dei metadati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1617">Data definition language (DDL) statements on tables and other database objects (indexes, views, data types, stored procedures, and common language runtime functions) change metadata.</span></span> <span data-ttu-id="ca04c-1618">Se un oggetto viene modificato da un'istruzione DLL, eventuali riferimenti simultanei all'oggetto nel livello di isolamento dello snapshot causano un errore della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1618">If a DDL statement modifies an object, any concurrent reference to the object under snapshot isolation causes the snapshot transaction to fail.</span></span> <span data-ttu-id="ca04c-1619">Le transazioni Read Committed non hanno questo limite quando l'opzione di database READ_COMMITTED_SNAPSHOT è impostata su ON.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1619">Read-committed transactions do not have this limitation when the READ_COMMITTED_SNAPSHOT database option is ON.</span></span>  
  
     <span data-ttu-id="ca04c-1620">Un amministratore del database esegue, ad esempio, l'istruzione `ALTER INDEX` seguente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1620">For example, a database administrator executes the following `ALTER INDEX` statement.</span></span>  
  
    ```sql  
    USE AdventureWorks2012;  
    GO  
    ALTER INDEX AK_Employee_LoginID  
        ON HumanResources.Employee REBUILD;  
    GO  
    ```  
  
     <span data-ttu-id="ca04c-1621">Le transazioni snapshot attive al momento dell'esecuzione di `ALTER INDEX` ricevono un errore nel caso in cui cerchino di fare riferimento alla tabella `HumanResources.Employee` successivamente all'esecuzione dell'istruzione `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1621">Any snapshot transaction that is active when the `ALTER INDEX` statement is executed receives an error if it attempts to reference the `HumanResources.Employee` table after the `ALTER INDEX` statement is executed.</span></span> <span data-ttu-id="ca04c-1622">Le transazioni Read Committed che utilizzano il controllo delle versioni delle righe non sono interessate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1622">Read-committed transactions using row versioning are not affected.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="ca04c-1623">Le operazioni di tipo BULK INSERT possono comportare modifiche ai metadati della tabella di destinazione, ad esempio quando si disabilita la verifica dei vincoli.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1623">BULK INSERT operations may cause changes to target table metadata (for example, when disabling constraint checks).</span></span> <span data-ttu-id="ca04c-1624">In questo caso, le transazioni di isolamento dello snapshot simultanee che accedono a tabelle in cui è stato eseguito l'inserimento bulk non hanno esito positivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1624">When this happens, concurrent snapshot isolation transactions accessing bulk inserted tables fail.</span></span>  
  
 <span data-ttu-id="ca04c-1625">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-1625">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="customizing-locking-and-row-versioning"></a><span data-ttu-id="ca04c-1626">Personalizzazione dell'utilizzo di blocchi e del controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="ca04c-1626">Customizing Locking and Row Versioning</span></span>  
  
### <a name="customizing-the-lock-time-out"></a><span data-ttu-id="ca04c-1627">Personalizzazione del timeout del blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-1627">Customizing the Lock Time-Out</span></span>  

 <span data-ttu-id="ca04c-1628">Se un'istanza di [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] non può concedere un blocco a una transazione perché un'altra transazione è già proprietaria di un blocco in conflitto nella risorsa, la prima transazione viene bloccata in attesa del rilascio del blocco esistente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1628">When an instance of the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] cannot grant a lock to a transaction because another transaction already owns a conflicting lock on the resource, the first transaction becomes blocked waiting for the existing lock to be released.</span></span> <span data-ttu-id="ca04c-1629">Per impostazione predefinita, non è previsto alcun periodo di timeout obbligatorio e non è disponibile alcun metodo per verificare se, prima dell'applicazione di un blocco, una risorsa è bloccata. L'unica situazione rilevabile è il tentativo di accesso ai dati con il potenziale rischio di attivazione di un blocco per un tempo indeterminato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1629">By default, there is no mandatory time-out period and no way to test whether a resource is locked before locking it, except to attempt to access the data (and potentially get blocked indefinitely).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] usare la vista a gestione dinamica **sys.dm_os_waiting_tasks** per determinare se un processo è bloccato e qual è l'origine del blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sys.dm_os_waiting_tasks** dynamic management view to determine whether a process is being blocked and who is blocking it.</span></span> <span data-ttu-id="ca04c-1631">Nelle versioni precedenti di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] usare la stored procedure di sistema **sp_who**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1631">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sp_who** system stored procedure.</span></span>  
  
 <span data-ttu-id="ca04c-1632">L'impostazione LOCK_TIMEOUT consente a un'applicazione di definire il periodo di tempo massimo durante il quale un'istruzione rimane in attesa di una risorsa bloccata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1632">The LOCK_TIMEOUT setting allows an application to set a maximum time that a statement waits on a blocked resource.</span></span> <span data-ttu-id="ca04c-1633">Quando il periodo di attesa di un'istruzione supera il valore massimo impostato nell'opzione LOCK_TIMEOUT, l'istruzione bloccata viene annullata automaticamente e nell'applicazione viene restituito il messaggio di errore 1222 (`Lock request time-out period exceeded`).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1633">When a statement has waited longer than the LOCK_TIMEOUT setting, the blocked statement is canceled automatically, and error message 1222 (`Lock request time-out period exceeded`) is returned to the application.</span></span> <span data-ttu-id="ca04c-1634">Qualsiasi transazione contenente l'istruzione, tuttavia, non viene sottoposta a rollback o annullata tramite [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1634">Any transaction containing the statement, however, is not rolled back or canceled by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="ca04c-1635">Pertanto, l'applicazione deve avere un gestore degli errori in grado di intercettare il messaggio di errore 1222.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1635">Therefore, the application must have an error handler that can trap error message 1222.</span></span> <span data-ttu-id="ca04c-1636">Se questo errore non viene intercettato, l'applicazione continua a essere eseguita come se l'istruzione della transazione non fosse stata annullata. In questo caso possono verificarsi errori, in quanto le istruzioni successive della transazione potrebbero dipendere dall'istruzione che non è mai stata eseguita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1636">If an application does not trap the error, the application can proceed unaware that an individual statement within a transaction has been canceled, and errors can occur because statements later in the transaction might depend on the statement that was never executed.</span></span>  
  
 <span data-ttu-id="ca04c-1637">Mediante l'implementazione di un gestore degli errori in grado di intercettare il messaggio di errore 1222, è possibile gestire la condizione di timeout ed eseguire gli interventi di correzione necessari, ad esempio la riesecuzione automatica dell'istruzione bloccata oppure il rollback dell'intera transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1637">Implementing an error handler that traps error message 1222 allows an application to handle the time-out situation and take remedial action, such as: automatically resubmitting the statement that was blocked or rolling back the entire transaction.</span></span>  
  
 <span data-ttu-id="ca04c-1638">Per determinare l'impostazione del LOCK_TIMEOUT corrente, eseguire la @LOCK_TIMEOUT funzione @:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1638">To determine the current LOCK_TIMEOUT setting, execute the @@LOCK_TIMEOUT function:</span></span>  
  
```sql  
SELECT @@lock_timeout;  
GO  
```  
  
### <a name="customizing-transaction-isolation-level"></a><span data-ttu-id="ca04c-1639">Personalizzazione del livello di isolamento delle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1639">Customizing Transaction Isolation Level</span></span>  

 <span data-ttu-id="ca04c-1640">READ COMMITTED è il livello di isolamento predefinito per [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1640">READ COMMITTED is the default isolation level for the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="ca04c-1641">Se per un'applicazione è necessario impostare un livello di isolamento diverso, è possibile utilizzare i metodi seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1641">If an application must operate at a different isolation level, it can use the following methods to set the isolation level:</span></span>  
  
-   <span data-ttu-id="ca04c-1642">Eseguire l'istruzione [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1642">Run the [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="ca04c-1643">Le applicazioni ADO.NET che usano lo spazio dei nomi gestito System.Data.SqlClient possono specificare un'opzione *IsolationLevel* usando il metodo SqlConnection.BeginTransaction.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1643">ADO.NET applications that use the System.Data.SqlClient managed namespace can specify an *IsolationLevel* option by using the SqlConnection.BeginTransaction method.</span></span>  
  
-   <span data-ttu-id="ca04c-1644">Le applicazioni che utilizzano ADO possono impostare la proprietà `Autocommit Isolation Levels`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1644">Applications that use ADO can set the `Autocommit Isolation Levels` property.</span></span>  
  
-   <span data-ttu-id="ca04c-1645">Quando si avvia una transazione, le applicazioni che usano OLE DB possono chiamare ITransactionLocal::StartTransaction con *isoLevel* impostato sul livello di isolamento delle transazioni desiderato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1645">When starting a transaction, applications using OLE DB can call ITransactionLocal::StartTransaction with *isoLevel* set to the desired transaction isolation level.</span></span> <span data-ttu-id="ca04c-1646">Quando si specifica il livello di isolamento in modalità autocommit, le applicazioni che utilizzano OLE DB possono impostare la proprietà DBPROPSET_SESSION DBPROP_SESSION_AUTOCOMMITISOLEVELS sul livello di isolamento delle transazioni desiderato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1646">When specifying the isolation level in autocommit mode, applications that use OLE DB can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to the desired transaction isolation level.</span></span>  
  
-   <span data-ttu-id="ca04c-1647">Le applicazioni che usano ODBC possono impostare l'attributo SQL_COPT_SS_TXN_ISOLATION usando SQLSetConnectAttr.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1647">Applications that use ODBC can set the SQL_COPT_SS_TXN_ISOLATION attribute by using SQLSetConnectAttr.</span></span>  
  
 <span data-ttu-id="ca04c-1648">Quando si specifica il livello di isolamento, il comportamento del blocco per tutte le query e le istruzioni DLM nella sessione [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] dipende dal livello di isolamento stesso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1648">When the isolation level is specified, the locking behavior for all queries and data manipulation language (DML) statements in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] session operates at that isolation level.</span></span> <span data-ttu-id="ca04c-1649">Il livello di isolamento viene mantenuto come valido fino al termine della sessione o all'impostazione di un livello di isolamento diverso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1649">The isolation level remains in effect until the session terminates or until the isolation level is set to another level.</span></span>  
  
 <span data-ttu-id="ca04c-1650">Nell'esempio seguente viene impostato il livello di isolamento di `SERIALIZABLE`:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1650">The following example sets the `SERIALIZABLE` isolation level:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
SELECT BusinessEntityID  
    FROM HumanResources.Employee;  
GO  
```  
  
 <span data-ttu-id="ca04c-1651">Se necessario, il livello di isolamento impostato può essere ignorato per singole query o istruzioni DML specificando hint a livello di tabella,</span><span class="sxs-lookup"><span data-stu-id="ca04c-1651">The isolation level can be overridden for individual query or DML statements, if necessary, by specifying a table-level hint.</span></span> <span data-ttu-id="ca04c-1652">che non hanno alcun effetto sulle altre istruzioni della sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1652">Specifying a table-level hint does not affect other statements in the session.</span></span> <span data-ttu-id="ca04c-1653">È consigliabile utilizzare gli hint a livello di tabella per modificare il funzionamento predefinito del blocco solo se assolutamente necessario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1653">We recommend that table-level hints be used to change the default behavior only when absolutely necessary.</span></span>  
  
 <span data-ttu-id="ca04c-1654">Potrebbe essere necessario per [!INCLUDE[ssDE](../includes/ssde-md.md)] acquisire blocchi durante la lettura dei metadati anche se il livello di isolamento è impostato in modo da non richiedere blocchi di condivisione durante la lettura dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1654">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata even when the isolation level is set to a level where share locks are not requested when reading data.</span></span> <span data-ttu-id="ca04c-1655">Una transazione in esecuzione con il livello di isolamento Read uncommitted, ad esempio, non acquisisce blocchi di condivisione durante la lettura dei dati, ma potrebbe talvolta richiedere blocchi durante la lettura di una vista del catalogo di sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1655">For example, a transaction running at the read-uncommitted isolation level does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="ca04c-1656">È pertanto possibile che una transazione Read uncommitted provochi un blocco durante l'esecuzione di una query su una tabella quando una transazione simultanea modifica i metadati della tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1656">This means it is possible for a read uncommitted transaction to cause blocking when querying a table when a concurrent transaction is modifying the metadata of that table.</span></span>  
  
 <span data-ttu-id="ca04c-1657">Per determinare il livello di isolamento attualmente impostato, utilizzare l'istruzione `DBCC USEROPTIONS` come illustrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1657">To determine the transaction isolation level currently set, use the `DBCC USEROPTIONS` statement as shown in the following example.</span></span> <span data-ttu-id="ca04c-1658">Il set di risultati può variare rispetto a quello del sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1658">The result set may vary from the result set on your system.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;  
GO  
DBCC USEROPTIONS;  
GO  
```  
  
 [!INCLUDE[ssResult](../includes/ssresult-md.md)]  
  
 `Set Option                   Value`  
  
 `---------------------------- -------------------------------------------`  
  
 `textsize                     2147483647`  
  
 `language                     us_english`  
  
 `dateformat                   mdy`  
  
 `datefirst                    7`  
  
 `...                          ...`  
  
 `Isolation level              repeatable read`  
  
 ``  
  
 `(14 row(s) affected)`  
  
 ``  
  
 `DBCC execution completed. If DBCC printed error messages, contact your system administrator.`  
  
### <a name="locking-hints"></a><span data-ttu-id="ca04c-1659">Hint di blocco</span><span class="sxs-lookup"><span data-stu-id="ca04c-1659">Locking Hints</span></span>  

 <span data-ttu-id="ca04c-1660">È possibile specificare hint di blocco per riferimenti a una singola tabella nelle istruzioni SELECT, INSERT, UPDATE e DELETE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1660">Locking hints can be specified for individual table references in the SELECT, INSERT, UPDATE, and DELETE statements.</span></span> <span data-ttu-id="ca04c-1661">Gli hint specificano il tipo di blocco o di controllo delle versioni delle righe utilizzato dall'istanza di [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] per i dati della tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1661">The hints specify the type of locking or row versioning the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses for the table data.</span></span> <span data-ttu-id="ca04c-1662">Gli hint di blocco a livello di tabella possono essere utilizzati quando è necessario un controllo più fine dei tipi di blocco acquisiti su un oggetto.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1662">Table-level locking hints can be used when a finer control of the types of locks acquired on an object is required.</span></span> <span data-ttu-id="ca04c-1663">Questi hint sono prioritari rispetto al livello di isolamento della transazione impostato per la sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1663">These locking hints override the current transaction isolation level for the session.</span></span>  
  
 <span data-ttu-id="ca04c-1664">Per altre informazioni sugli hint di blocco e il relativo comportamento, vedere [Hint di tabella &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1664">For more information about the specific locking hints and their behaviors, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1665">Nel [!INCLUDE[ssDE](../includes/ssde-md.md)], Query Optimizer individua quasi sempre il livello di blocco appropriato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1665">The [!INCLUDE[ssDE](../includes/ssde-md.md)] query optimizer almost always chooses the correct locking level.</span></span> <span data-ttu-id="ca04c-1666">È consigliabile utilizzare gli hint di blocco a livello di tabella per modificare il comportamento predefinito del blocco solo se necessario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1666">We recommend that table-level locking hints be used to change the default locking behavior only when necessary.</span></span> <span data-ttu-id="ca04c-1667">La disattivazione di un livello di blocco può influire negativamente sulla concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1667">Disallowing a locking level can adversely affect concurrency.</span></span>  
  
 <span data-ttu-id="ca04c-1668">È possibile che il [!INCLUDE[ssDE](../includes/ssde-md.md)] debba acquisire blocchi durante la lettura di metadati, anche quando esegue l'elaborazione di un'istruzione SELECT con un hint di blocco che impedisce le richieste di blocchi di condivisione in fase di lettura dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1668">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata, even when processing a select with a locking hint that prevents requests for share locks when reading data.</span></span> <span data-ttu-id="ca04c-1669">Ad esempio, un'istruzione SELECT che utilizza l'hint NOLOCK non acquisisce blocchi di condivisione durante la lettura dei dati, ma può richiedere blocchi durante la lettura di una vista del catalogo di sistema.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1669">For example, a SELECT using the NOLOCK hint does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="ca04c-1670">Ciò significa che è possibile che un'istruzione SELECT che utilizza NOLOCK venga bloccata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1670">This means it is possible for a SELECT statement using NOLOCK to be blocked.</span></span>  
  
 <span data-ttu-id="ca04c-1671">Come illustrato nell'esempio seguente, se il livello di isolamento della transazione è impostato su `SERIALIZABLE` e l'hint di blocco a livello di tabella `NOLOCK` viene utilizzato con l'istruzione `SELECT`, i blocchi intervalli di chiavi in genere utilizzati per mantenere le transazioni serializzabili non vengono accettati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1671">As shown in the following example, if the transaction isolation level is set to `SERIALIZABLE`, and the table-level locking hint `NOLOCK` is used with the `SELECT` statement, key-range locks typically used to maintain serializable transactions are not taken.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
GO  
SELECT JobTitle  
    FROM HumanResources.Employee WITH (NOLOCK);  
GO  
  
-- Get information about the locks held by   
-- the transaction.  
SELECT    
        resource_type,   
        resource_subtype,   
        request_mode  
    FROM sys.dm_tran_locks  
    WHERE request_session_id = @@spid;  
  
-- End the transaction.  
ROLLBACK;  
GO  
```  
  
 <span data-ttu-id="ca04c-1672">L'unico blocco accettato che fa riferimento a `HumanResources.Employee` è un blocco di stabilità dello schema (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1672">The only lock taken that references `HumanResources.Employee` is a schema stability (Sch-S) lock.</span></span> <span data-ttu-id="ca04c-1673">In questo caso la serializzabilità non è garantita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1673">In this case, serializability is no longer guaranteed.</span></span>  
  
 <span data-ttu-id="ca04c-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] l'opzione LOCK_ESCALATION di ALTER TABLE può non accettare blocchi di tabella e attivare i blocchi HoBT sulle tabelle partizionate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], the LOCK_ESCALATION option of ALTER TABLE can disfavor table locks, and enable HoBT locks on partitioned tables.</span></span> <span data-ttu-id="ca04c-1675">Questa opzione non è un hint di blocco, ma può essere usata per ridurre l'escalation dei blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1675">This option is not a locking hint, but can but used to reduce lock escalation.</span></span> <span data-ttu-id="ca04c-1676">Per altre informazioni, vedere [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1676">For more information, see [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
###  <a name="customizing-locking-for-an-index"></a><a name="Customize"></a> <span data-ttu-id="ca04c-1677">Personalizzazione dei blocchi per un indice</span><span class="sxs-lookup"><span data-stu-id="ca04c-1677">Customizing Locking for an Index</span></span>  

 <span data-ttu-id="ca04c-1678">La strategia di blocco dinamico utilizzata dal [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] prevede la selezione automatica del livello di granularità dei blocchi ottimale per le query nella maggior parte dei casi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1678">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy that automatically chooses the best locking granularity for queries in most cases.</span></span> <span data-ttu-id="ca04c-1679">Si consiglia di non ignorare i livelli di blocco predefiniti, in cui è attivato il blocco a livello di pagina e di riga, a meno che i modelli di accesso a tabelle e indici non siano chiari e coerenti ed esista un problema di contesa tra risorse da risolvere.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1679">We recommend that you do not override the default locking levels, which have page and row locking on, unless table or index access patterns are well understood and consistent, and there is a resource contention problem to solve.</span></span> <span data-ttu-id="ca04c-1680">Se un livello di blocco viene ignorato, è possibile che l'accesso simultaneo a una tabella o a un indice venga ostacolato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1680">Overriding a locking level can significantly impede concurrent access to a table or index.</span></span> <span data-ttu-id="ca04c-1681">Se ad esempio si specificano solo blocchi a livello di tabella in una tabella di notevoli dimensioni usata molto frequentemente, è possibile che si verifichino colli di bottiglia perché gli utenti devono attendere il rilascio del blocco a livello di tabella prima di accedere alla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1681">For example, specifying only table-level locks on a large table that users access heavily can cause bottlenecks because users must wait for the table-level lock to be released before accessing the table.</span></span>  
  
 <span data-ttu-id="ca04c-1682">In alcuni casi, se i modelli di accesso sono chiari e coerenti, la disattivazione del blocco a livello di pagina o di riga può risultare vantaggioso.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1682">There are a few cases where disallowing page or row locking can be beneficial, if the access patterns are well understood and consistent.</span></span> <span data-ttu-id="ca04c-1683">Si supponga, ad esempio, che un'applicazione di database utilizzi una tabella di ricerca che viene aggiornata con frequenza settimanale in un processo batch.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1683">For example, a database application uses a lookup table that is updated weekly in a batch process.</span></span> <span data-ttu-id="ca04c-1684">L'accesso alla tabella da parte di utenti simultanei avviene con un blocco condiviso, mentre quello dell'aggiornamento batch settimanale con un blocco esclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1684">Concurrent readers access the table with a shared (S) lock and the weekly batch update accesses the table with an exclusive (X) lock.</span></span> <span data-ttu-id="ca04c-1685">Se il blocco a livello di pagina e di riga viene disattivato sulla tabella, l'overhead dei blocchi risulta ridotto nell'intera settimana, consentendo agli utenti di accedere simultaneamente alla tabella tramite blocchi a livello di tabella condivisi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1685">Turning off page and row locking on the table reduces the locking overhead throughout the week by allowing readers to concurrently access the table through shared table locks.</span></span> <span data-ttu-id="ca04c-1686">Quando viene eseguito, il processo batch può essere completato in modo efficiente, in quanto ottiene un blocco esclusivo sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1686">When the batch job runs, it can complete the update efficiently because it obtains an exclusive table lock.</span></span>  
  
 <span data-ttu-id="ca04c-1687">La disattivazione del blocco a livello di pagina o di riga può essere o meno accettabile perché l'aggiornamento batch settimanale impedirà agli utenti di accedere simultaneamente alla tabella durante l'esecuzione dell'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1687">Turning off page and row locking might or might not be acceptable because the weekly batch update will block the concurrent readers from accessing the table while the update runs.</span></span> <span data-ttu-id="ca04c-1688">Se il processo batch modifica solo alcune righe o pagine, è possibile modificare il livello di blocco per consentire il blocco a livello di riga o di pagina, consentendo in questo modo la lettura della tabella da parte di altre sessioni senza blocchi.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1688">If the batch job only changes a few rows or pages, you can change the locking level to allow row or page level locking, which will enable other sessions to read from the table without blocking.</span></span> <span data-ttu-id="ca04c-1689">Se il processo batch include un numero elevato di aggiornamenti, per assicurarsi che venga completato in modo efficiente è consigliabile ottenere un blocco esclusivo sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1689">If the batch job has a large number of updates, obtaining an exclusive lock on the table may be the best way to ensure the batch job finishes efficiently.</span></span>  
  
 <span data-ttu-id="ca04c-1690">A volte, quando due operazioni simultanee acquisiscono blocchi a livello di riga sulla stessa tabella e quindi si bloccano perché richiedono entrambe il blocco della pagina, si verifica un deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1690">Occasionally a deadlock occurs when two concurrent operations acquire row locks on the same table and then block because they both need to lock the page.</span></span> <span data-ttu-id="ca04c-1691">La disattivazione dei blocchi a livello di riga impone a una delle operazioni di attendere, evitando il deadlock.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1691">Disallowing row locks forces one of the operations to wait, avoiding the deadlock.</span></span>  
  
 <span data-ttu-id="ca04c-1692">La granularità dei blocchi utilizzata su un indice può essere impostata utilizzando le istruzioni CREATE INDEX e ALTER INDEX.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1692">The granularity of locking used on an index can be set using the CREATE INDEX and ALTER INDEX statements.</span></span> <span data-ttu-id="ca04c-1693">Le impostazioni del blocco si applicano sia alle pagine di indice che alle pagine di tabella.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1693">The lock settings apply to both the index pages and the table pages.</span></span> <span data-ttu-id="ca04c-1694">Inoltre, le istruzioni CREATE TABLE e ALTER TABLE possono essere utilizzate per impostare la granularità del blocco sui vincoli PRIMARY KEY e UNIQUE.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1694">In addition, the CREATE TABLE and ALTER TABLE statements can be used to set locking granularity on PRIMARY KEY and UNIQUE constraints.</span></span> <span data-ttu-id="ca04c-1695">Per garantire la compatibilità con le versioni precedenti, anche il sistema **sp_indexoption** stored procedure può impostare la granularità.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1695">For backwards compatibility, the **sp_indexoption** system stored procedure can also set the granularity.</span></span> <span data-ttu-id="ca04c-1696">Per visualizzare l'opzione di blocco corrente per un determinato indice, utilizzare la funzione INDEXPROPERTY.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1696">To display the current locking option for a given index, use the INDEXPROPERTY function.</span></span> <span data-ttu-id="ca04c-1697">È possibile impedire l'applicazione di blocchi a livello di pagina o di riga e della combinazione di questi due livelli di blocco per un particolare indice.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1697">Page-level locks, row-level locks, or a combination of page-level and row-level locks can be disallowed for a given index.</span></span>  
  
|<span data-ttu-id="ca04c-1698">Blocchi non consentiti</span><span class="sxs-lookup"><span data-stu-id="ca04c-1698">Disallowed locks</span></span>|<span data-ttu-id="ca04c-1699">Accesso all'indice da parte di</span><span class="sxs-lookup"><span data-stu-id="ca04c-1699">Index accessed by</span></span>|  
|----------------------|-----------------------|  
|<span data-ttu-id="ca04c-1700">A livello di pagina</span><span class="sxs-lookup"><span data-stu-id="ca04c-1700">Page level</span></span>|<span data-ttu-id="ca04c-1701">Blocchi a livello di riga e tabella</span><span class="sxs-lookup"><span data-stu-id="ca04c-1701">Row-level and table-level locks</span></span>|  
|<span data-ttu-id="ca04c-1702">A livello di riga</span><span class="sxs-lookup"><span data-stu-id="ca04c-1702">Row level</span></span>|<span data-ttu-id="ca04c-1703">Blocchi a livello di pagina e di tabella</span><span class="sxs-lookup"><span data-stu-id="ca04c-1703">Page-level and table-level locks</span></span>|  
|<span data-ttu-id="ca04c-1704">A livello di pagina e di riga</span><span class="sxs-lookup"><span data-stu-id="ca04c-1704">Page level and row level</span></span>|<span data-ttu-id="ca04c-1705">Blocchi a livello di tabella</span><span class="sxs-lookup"><span data-stu-id="ca04c-1705">Table-level locks</span></span>|  
  
 <span data-ttu-id="ca04c-1706">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-1706">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="advanced-transaction-information"></a><a name="Advanced"></a> <span data-ttu-id="ca04c-1707">Informazioni avanzate sulle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1707">Advanced Transaction Information</span></span>  
  
### <a name="nesting-transactions"></a><span data-ttu-id="ca04c-1708">Nidificazione delle transazioni</span><span class="sxs-lookup"><span data-stu-id="ca04c-1708">Nesting Transactions</span></span>  

 <span data-ttu-id="ca04c-1709">Le transazioni esplicite possono essere nidificate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1709">Explicit transactions can be nested.</span></span> <span data-ttu-id="ca04c-1710">Ciò consente principalmente il supporto delle transazioni all'interno di stored procedure che è possibile richiamare sia da un processo già incluso in una transazione che da processi privi di transazioni attive.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1710">This is primarily intended to support transactions in stored procedures that can be called either from a process already in a transaction or from processes that have no active transaction.</span></span>  
  
 <span data-ttu-id="ca04c-1711">Nell'esempio seguente viene illustrato l'utilizzo delle transazioni nidificate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1711">The following example shows the intended use of nested transactions.</span></span> <span data-ttu-id="ca04c-1712">La procedura `TransProc` applica la rispettiva transazione indipendentemente dalla modalità impostata in ogni processo da cui viene eseguita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1712">The procedure `TransProc` enforces its transaction regardless of the transaction mode of any process that executes it.</span></span> <span data-ttu-id="ca04c-1713">Se la procedura `TransProc` viene richiamata quando una transazione è attiva, la transazione nidificata in `TransProc` viene ignorata e, a seconda dell'azione finale eseguita per la transazione esterna, viene eseguito il commit o il rollback delle relative istruzioni INSERT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1713">If `TransProc` is called when a transaction is active, the nested transaction in `TransProc` is largely ignored, and its INSERT statements are committed or rolled back based on the final action taken for the outer transaction.</span></span> <span data-ttu-id="ca04c-1714">Se la procedura `TransProc` viene eseguita da un processo privo di transazione attiva, l'istruzione COMMIT TRANSACTION alla fine della procedura esegue correttamente il commit delle istruzioni INSERT.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1714">If `TransProc` is executed by a process that does not have an outstanding transaction, the COMMIT TRANSACTION at the end of the procedure effectively commits the INSERT statements.</span></span>  
  
```sql  
SET QUOTED_IDENTIFIER OFF;  
GO  
SET NOCOUNT OFF;  
GO  
CREATE TABLE TestTrans(Cola INT PRIMARY KEY,  
               Colb CHAR(3) NOT NULL);  
GO  
CREATE PROCEDURE TransProc @PriKey INT, @CharCol CHAR(3) AS  
BEGIN TRANSACTION InProc  
INSERT INTO TestTrans VALUES (@PriKey, @CharCol)  
INSERT INTO TestTrans VALUES (@PriKey + 1, @CharCol)  
COMMIT TRANSACTION InProc;  
GO  
/* Start a transaction and execute TransProc. */  
BEGIN TRANSACTION OutOfProc;  
GO  
EXEC TransProc 1, 'aaa';  
GO  
/* Roll back the outer transaction, this will  
   roll back TransProc's nested transaction. */  
ROLLBACK TRANSACTION OutOfProc;  
GO  
EXECUTE TransProc 3,'bbb';  
GO  
/* The following SELECT statement shows only rows 3 and 4 are   
   still in the table. This indicates that the commit  
   of the inner transaction from the first EXECUTE statement of  
   TransProc was overridden by the subsequent rollback. */  
SELECT * FROM TestTrans;  
GO  
```  
  
 <span data-ttu-id="ca04c-1715">Il commit delle transazioni interne viene ignorato da the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1715">Committing inner transactions is ignored by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="ca04c-1716">A seconda dell'operazione eseguita alla fine della transazione più esterna, viene eseguito il commit o il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1716">The transaction is either committed or rolled back based on the action taken at the end of the outermost transaction.</span></span> <span data-ttu-id="ca04c-1717">In caso di commit della transazione esterna, viene eseguito il commit anche delle transazioni nidificate</span><span class="sxs-lookup"><span data-stu-id="ca04c-1717">If the outer transaction is committed, the inner nested transactions are also committed.</span></span> <span data-ttu-id="ca04c-1718">e in caso di rollback della transazione esterna viene eseguito il rollback anche di tutte le transazioni interne, indipendentemente dal fatto che sia stato eseguito il commit delle singole transazioni interne.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1718">If the outer transaction is rolled back, then all inner transactions are also rolled back, regardless of whether or not the inner transactions were individually committed.</span></span>  
  
 <span data-ttu-id="ca04c-1719">Ogni chiamata di COMMIT TRANSACTION o COMMIT WORK viene applicata all'ultima istruzione BEGIN TRANSACTION eseguita.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1719">Each call to COMMIT TRANSACTION or COMMIT WORK applies to the last executed BEGIN TRANSACTION.</span></span> <span data-ttu-id="ca04c-1720">Se le istruzioni BEGIN TRANSACTION sono nidificate, l'istruzione COMMIT viene applicata solo alla transazione più interna,</span><span class="sxs-lookup"><span data-stu-id="ca04c-1720">If the BEGIN TRANSACTION statements are nested, then a COMMIT statement applies only to the last nested transaction, which is the innermost transaction.</span></span> <span data-ttu-id="ca04c-1721">Anche se un'istruzione COMMIT TRANSACTION *transaction_name* all'interno di una transazione nidificata fa riferimento al nome della transazione esterna, il commit viene applicato solo alla transazione più interna.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1721">Even if a COMMIT TRANSACTION *transaction_name* statement within a nested transaction refers to the transaction name of the outer transaction, the commit applies only to the innermost transaction.</span></span>  
  
 <span data-ttu-id="ca04c-1722">Il *transaction_name* parametro di un'istruzione ROLLBACK TRANSACTION non è valido per fare riferimento alle transazioni interne di un set di transazioni nidificate denominate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1722">It is not legal for the *transaction_name* parameter of a ROLLBACK TRANSACTION statement to refer to the inner transactions of a set of named nested transactions.</span></span> <span data-ttu-id="ca04c-1723">*transaction_name* può fare riferimento solo al nome della transazione più esterna.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1723">*transaction_name* can refer only to the transaction name of the outermost transaction.</span></span> <span data-ttu-id="ca04c-1724">Se a qualsiasi livello di un set di transazioni nidificate viene eseguita un'istruzione ROLLBACK TRANSACTION *transaction_name* che usa il nome della transazione esterna, viene eseguito il rollback di tutte le transazioni nidificate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1724">If a ROLLBACK TRANSACTION *transaction_name* statement using the name of the outer transaction is executed at any level of a set of nested transactions, all of the nested transactions are rolled back.</span></span> <span data-ttu-id="ca04c-1725">Se un'istruzione ROLLBACK WORK o ROLLBACK TRANSACTION senza un parametro *transaction_name* viene eseguita a qualsiasi livello di un set di transazioni nidificate, esegue il rollback di tutte le transazioni nidificate, inclusa la transazione più esterna.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1725">If a ROLLBACK WORK or ROLLBACK TRANSACTION statement without a *transaction_name* parameter is executed at any level of a set of nested transaction, it rolls back all of the nested transactions, including the outermost transaction.</span></span>  
  
 <span data-ttu-id="ca04c-1726">La @TRANCOUNT funzione @ registra il livello di nidificazione della transazione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1726">The @@TRANCOUNT function records the current transaction nesting level.</span></span> <span data-ttu-id="ca04c-1727">Ogni istruzione BEGIN TRANSACTION incrementa @ @TRANCOUNT di uno.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1727">Each BEGIN TRANSACTION statement increments @@TRANCOUNT by one.</span></span> <span data-ttu-id="ca04c-1728">Ogni istruzione COMMIT TRANSACTION o COMMIT WORK decrementa @ @TRANCOUNT di uno.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1728">Each COMMIT TRANSACTION or COMMIT WORK statement decrements @@TRANCOUNT by one.</span></span> <span data-ttu-id="ca04c-1729">Un'istruzione ROLLBACK WORK o ROLLBACK TRANSACTION che non dispone di un nome di transazione esegue il rollback di tutte le transazioni nidificate e decrementa @ @TRANCOUNT a 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1729">A ROLLBACK WORK or a ROLLBACK TRANSACTION statement that does not have a transaction name rolls back all nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="ca04c-1730">Un'istruzione ROLLBACK TRANSACTION che utilizza il nome della transazione più esterna in un set di transazioni nidificate esegue il rollback di tutte le transazioni nidificate e decrementa @ @TRANCOUNT a 0.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1730">A ROLLBACK TRANSACTION that uses the transaction name of the outermost transaction in a set of nested transactions rolls back all of the nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="ca04c-1731">Quando non si è sicuri se si è già in una transazione, selezionare @ @TRANCOUNT per determinare se è 1 o più.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1731">When you are unsure if you are already in a transaction, SELECT @@TRANCOUNT to determine if it is 1 or more.</span></span> <span data-ttu-id="ca04c-1732">Se @ @TRANCOUNT è 0, non si è in una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1732">If @@TRANCOUNT is 0, you are not in a transaction.</span></span>  
  
### <a name="using-bound-sessions"></a><span data-ttu-id="ca04c-1733">Utilizzo di sessioni associate</span><span class="sxs-lookup"><span data-stu-id="ca04c-1733">Using Bound Sessions</span></span>  

 <span data-ttu-id="ca04c-1734">Le sessioni associate semplificano il coordinamento di azioni tra più sessioni nello stesso server.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1734">Bound sessions ease the coordination of actions across multiple sessions on the same server.</span></span> <span data-ttu-id="ca04c-1735">Tramite le sessioni associate due o più sessioni possono condividere la stessa transazione e gli stessi blocchi, utilizzando gli stessi dati senza conflitti di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1735">Bound sessions allow two or more sessions to share the same transaction and locks, and can work on the same data without lock conflicts.</span></span> <span data-ttu-id="ca04c-1736">È possibile creare sessioni associate in base a più sessioni nella stessa applicazione oppure in base a più applicazioni con sessioni distinte.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1736">Bound sessions can be created from multiple sessions within the same application or from multiple applications with separate sessions.</span></span>  
  
 <span data-ttu-id="ca04c-1737">Per partecipare a una sessione associata, una sessione chiama **sp_getbindtoken** o **Srv_getbindtoken** (tramite Open Data Services) per ottenere un token di associazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1737">To participate in a bound session, a session calls **sp_getbindtoken** or **srv_getbindtoken** (through Open Data Services) to get a bind token.</span></span> <span data-ttu-id="ca04c-1738">Un token di associazione è una stringa di caratteri che identifica in modo univoco ogni transazione associata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1738">A bind token is a character string that uniquely identifies each bound transaction.</span></span> <span data-ttu-id="ca04c-1739">Il token di associazione viene quindi inviato alle altre sessioni da associare alla sessione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1739">The bind token is then sent to the other sessions to be bound with the current session.</span></span> <span data-ttu-id="ca04c-1740">Le altre sessioni vengono associate alla transazione chiamando **sp_bindsession** e usando il token di associazione ricevuto dalla prima sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1740">The other sessions bind to the transaction by calling **sp_bindsession**, using the bind token received from the first session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="ca04c-1741">Una sessione deve disporre di una transazione utente attiva affinché **sp_getbindtoken** o **srv_getbindtoken** abbia esito positivo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1741">A session must have an active user transaction in order for **sp_getbindtoken** or **srv_getbindtoken** to succeed.</span></span>  
  
 <span data-ttu-id="ca04c-1742">I token di associazione devono essere trasmessi dal codice dell'applicazione che esegue la prima sessione al codice dell'applicazione che successivamente associa le sessioni alla prima sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1742">Bind tokens must be transmitted from the application code that makes the first session to the application code that subsequently binds their sessions to the first session.</span></span> <span data-ttu-id="ca04c-1743">Non esistono istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] o funzioni API utilizzabili in un'applicazione per ottenere il token di associazione per una transazione avviata da un altro processo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1743">There is no [!INCLUDE[tsql](../includes/tsql-md.md)] statement or API function that an application can use to get the bind token for a transaction started by another process.</span></span> <span data-ttu-id="ca04c-1744">Di seguito vengono descritti alcuni dei metodi che è possibile utilizzare per la trasmissione di un token di associazione:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1744">Some of the methods that can be used to transmit a bind token include the following:</span></span>  
  
-   <span data-ttu-id="ca04c-1745">Se tutte le sessioni vengono iniziate dallo stesso processo dell'applicazione, i token di associazione possono essere archiviati nella memoria globale o passati come parametri di funzioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1745">If the sessions are all initiated from the same application process, bind tokens can be stored in global memory or passed into functions as a parameter.</span></span>  
  
-   <span data-ttu-id="ca04c-1746">Se le connessioni vengono eseguite da processi dell'applicazione distinti, i token di associazione possono essere trasmessi utilizzando la comunicazione interprocesso (IPC), ad esempio tramite DDE (scambio dinamico dei dati) o un chiamata RPC (Remote Procedure Call).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1746">If the sessions are made from separate application processes, bind tokens can be transmitted using interprocess communication (IPC), such as a remote procedure call (RPC) or dynamic data exchange (DDE).</span></span>  
  
-   <span data-ttu-id="ca04c-1747">I token di associazione possono essere archiviati in un'istanza di [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] che può essere letta dai processi in attesa di essere associati alla prima sessione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1747">Bind tokens can be stored in a table in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] that can be read by processes wanting to bind to the first session.</span></span>  
  
 <span data-ttu-id="ca04c-1748">In un set di sessioni associate può essere attiva una sola sessione per volta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1748">Only one session in a set of bound sessions can be active at any time.</span></span> <span data-ttu-id="ca04c-1749">Se una sessione esegue un'istruzione nell'istanza o è in attesa di risultati dall'istanza, le altre sessioni associate possono accedere all'istanza solo dopo il completamento dell'elaborazione della sessione corrente o l'annullamento dell'istruzione corrente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1749">If one session is executing a statement on the instance or has results pending from the instance, no other session bound to it can access the instance until the current session finishes processing or cancels the current statement.</span></span> <span data-ttu-id="ca04c-1750">Se l'istanza è occupata per l'elaborazione di un'istruzione da un'altra delle sessioni associate, viene generato un errore indicante che lo spazio della transazione è in uso e che è necessario riprovare la sessione in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1750">If the instance is busy processing a statement from another of the bound sessions, an error occurs indicating that the transaction space is in use and the session should retry later.</span></span>  
  
 <span data-ttu-id="ca04c-1751">Quando si associano sessioni, ogni sessione mantiene il relativo livello di isolamento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1751">When you bind sessions, each session retains its isolation level setting.</span></span> <span data-ttu-id="ca04c-1752">L'utilizzo dell'istruzione SET TRANSACTION ISOLATION LEVEL per modificare il livello di isolamento di una sessione non influisce sull'impostazione di qualsiasi altra sessione associata.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1752">Using SET TRANSACTION ISOLATION LEVEL to change the isolation level setting of one session does not affect the setting of any other session bound to it.</span></span>  
  
#### <a name="types-of-bound-sessions"></a><span data-ttu-id="ca04c-1753">Tipi di sessioni associate</span><span class="sxs-lookup"><span data-stu-id="ca04c-1753">Types of Bound Sessions</span></span>  

 <span data-ttu-id="ca04c-1754">Sono disponibili due tipi di sessioni associate, ovvero locali e distribuite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1754">The two types of bound sessions are local and distributed.</span></span>  
  
-   <span data-ttu-id="ca04c-1755">Sessione associata locale</span><span class="sxs-lookup"><span data-stu-id="ca04c-1755">Local bound session</span></span>  
  
     <span data-ttu-id="ca04c-1756">Consente alle sessioni associate di condividere lo spazio di una singola transazione in una sola istanza di [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ca04c-1756">Allows bound sessions to share the transaction space of a single transaction in a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span>  
  
-   <span data-ttu-id="ca04c-1757">Sessione associata distribuita</span><span class="sxs-lookup"><span data-stu-id="ca04c-1757">Distributed bound session</span></span>  
  
     <span data-ttu-id="ca04c-1758">Consente alle sessioni associate di condividere lo stesso spazio della transazione in due o più istanze fino a quando non viene eseguito il commit o il rollback dell'intera transazione tramite [!INCLUDE[msCoName](../includes/msconame-md.md)] Microsoft Distributed Transaction Coordinator (servizio MSDTC).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1758">Allows bound sessions to share the same transaction across two or more instances until the entire transaction is either committed or rolled back by using [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="ca04c-1759">Le sessioni associate distribuite non sono identificate da un token di associazione di tipo stringa, ma dai numeri di identificazione delle transazioni distribuite.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1759">Distributed bound sessions are not identified by a character string bind token; they are identified by distributed transaction identification numbers.</span></span> <span data-ttu-id="ca04c-1760">Se una sessione associata partecipa a una transazione locale ed esegue una chiamata RPC in un server remoto con l'opzione SET REMOTE_PROC_TRANSACTIONS impostata su ON, la transazione associata locale viene automaticamente promossa a transazione associata distribuita da MS DTC e viene avviata una sessione di MS DTC.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1760">If a bound session is involved in a local transaction and executes an RPC on a remote server with SET REMOTE_PROC_TRANSACTIONS ON, the local bound transaction is automatically promoted to a distributed bound transaction by MS DTC and an MS DTC session is started.</span></span>  
  
#### <a name="when-to-use-bound-sessions"></a><span data-ttu-id="ca04c-1761">Utilizzo delle sessioni associate</span><span class="sxs-lookup"><span data-stu-id="ca04c-1761">When to Use Bound Sessions</span></span>  

 <span data-ttu-id="ca04c-1762">Nelle versioni precedenti di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] le sessioni associate vengono prevalentemente utilizzate nello sviluppo di stored procedure estese che devono eseguire istruzioni [!INCLUDE[tsql](../includes/tsql-md.md)] per conto del processo che le chiama.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1762">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], bound sessions were primarily used in developing extended stored procedures that must execute [!INCLUDE[tsql](../includes/tsql-md.md)] statements on behalf of the process that calls them.</span></span> <span data-ttu-id="ca04c-1763">Quando tramite il processo chiamante il token di associazione viene passato come parametro della stored procedure estesa, la procedura può partecipare allo spazio della transazione del processo chiamante e viene pertanto integrata in tale processo.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1763">Having the calling process pass in a bind token as one parameter of the extended stored procedure allows the procedure to join the transaction space of the calling process, thereby integrating the extended stored procedure with the calling process.</span></span>  
  
 <span data-ttu-id="ca04c-1764">In [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] le stored procedure scritte utilizzando CLR sono più protette, scalabili e stabili rispetto alle stored procedure estese.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1764">In the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], stored procedures written using CLR are more secure, scalable, and stable than extended stored procedures.</span></span> <span data-ttu-id="ca04c-1765">Le stored procedure CLR utilizzano l'oggetto **SqlContext** per unire in join il contesto della sessione chiamante, non **sp_bindsession**.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1765">CLR-stored procedures use the **SqlContext** object to join the context of the calling session, not **sp_bindsession**.</span></span>  
  
 <span data-ttu-id="ca04c-1766">Le sessioni associate possono essere utilizzate per lo sviluppo di applicazioni a tre livelli in cui la logica di business è incorporata in programmi distinti che operano congiuntamente in una singola transazione aziendale.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1766">Bound sessions can be used to develop three-tier applications in which business logic is incorporated into separate programs that work cooperatively on a single business transaction.</span></span> <span data-ttu-id="ca04c-1767">Tali programmi devono essere sviluppati in modo da coordinarne accuratamente l'accesso a un database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1767">These programs must be coded to carefully coordinate their access to a database.</span></span> <span data-ttu-id="ca04c-1768">Poiché le due sessioni condividono gli stessi blocchi, i due programmi non devono tentare di modificare gli stessi dati simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1768">Because the two sessions share the same locks, the two programs must not try to modify the same data at the same time.</span></span> <span data-ttu-id="ca04c-1769">In qualsiasi momento può essere in funzione una sola sessione come parte della transazione. L'esecuzione parallela non è possibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1769">At any point in time, only one session can be doing work as part of the transaction; there can be no parallel execution.</span></span> <span data-ttu-id="ca04c-1770">La transazione può essere passata da una sessione all'altra solo in specifici punti definiti, ad esempio dopo il completamento di tutte le istruzioni DML e il recupero dei relativi risultati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1770">The transaction can only be switched between sessions at well-defined yield points, such as when all DML statements have completed and their results have been retrieved.</span></span>  
  
### <a name="coding-efficient-transactions"></a><span data-ttu-id="ca04c-1771">Codifica di transazioni efficienti</span><span class="sxs-lookup"><span data-stu-id="ca04c-1771">Coding Efficient Transactions</span></span>  

 <span data-ttu-id="ca04c-1772">È importante mantenere le transazioni il più brevi possibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1772">It is important to keep transactions as short as possible.</span></span> <span data-ttu-id="ca04c-1773">Quando viene avviata una transazione, un sistema di gestione di database (DBMS, Database Management System) deve tenere occupate molte risorse fino alla fine della transazione in modo da proteggerne le proprietà di atomicità, consistenza, isolamento e durevolezza (ACID, Atomicity, Consistency, Isolation and Durability).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1773">When a transaction is started, a database management system (DBMS) must hold many resources until the end of the transaction to protect the atomicity, consistency, isolation, and durability (ACID) properties of the transaction.</span></span> <span data-ttu-id="ca04c-1774">Se i dati vengono modificati, le righe modificate devono essere protette con blocchi esclusivi che ne impediscono la lettura da parte di altre transazioni. Tali blocchi devono essere mantenuti attivi fino al commit o al rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1774">If data is modified, the modified rows must be protected with exclusive locks that prevent any other transaction from reading the rows, and exclusive locks must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="ca04c-1775">In base alle impostazioni del livello di isolamento della transazione, le istruzioni SELECT possono acquisire blocchi che è necessario mantenere attivi fino a quando non è stato eseguito il commit o il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1775">Depending on transaction isolation level settings, SELECT statements may acquire locks that must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="ca04c-1776">Nei sistemi con numerosi utenti è necessario mantenere le transazioni più brevi possibile per ridurre la possibilità che si verifichino contese di risorse tra connessioni simultanee.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1776">Especially in systems with many users, transactions must be kept as short as possible to reduce locking contention for resources between concurrent connections.</span></span> <span data-ttu-id="ca04c-1777">Le transazioni non efficienti che richiedono tempi di esecuzione prolungati potrebbero non presentare alcun problema se il numero di utenti è ridotto, mentre sono assolutamente da evitare in sistemi con migliaia di utenti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1777">Long-running, inefficient transactions may not be a problem with small numbers of users, but they are intolerable in a system with thousands of users.</span></span> <span data-ttu-id="ca04c-1778">A partire da [!INCLUDE[ssSQL14](../includes/sssql14-md.md)], [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supporta le transazioni durevoli ritardate.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1778">Beginning with [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports delayed durable transactions.</span></span> <span data-ttu-id="ca04c-1779">Tali transazioni non garantiscono la durabilità.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1779">Delayed durable transactions do not guarantee durability.</span></span> <span data-ttu-id="ca04c-1780">Per altre informazioni, vedere l'argomento [Durabilità delle transazioni](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1780">See the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md) for more information.</span></span>  
  
#### <a name="coding-guidelines"></a><span data-ttu-id="ca04c-1781">Linee guida per la codifica</span><span class="sxs-lookup"><span data-stu-id="ca04c-1781">Coding Guidelines</span></span>  

 <span data-ttu-id="ca04c-1782">Di seguito vengono riportate alcune linee guida per la codifica di transazioni efficienti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1782">These are guidelines for coding efficient transactions:</span></span>  
  
-   <span data-ttu-id="ca04c-1783">Evitare di richiedere l'input dell'utente durante una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1783">Do not require input from users during a transaction.</span></span>  
  
     <span data-ttu-id="ca04c-1784">Richiedere agli utenti l'input necessario prima di avviare una transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1784">Get all required input from users before a transaction is started.</span></span> <span data-ttu-id="ca04c-1785">Se durante una transazione è necessario input dell'utente aggiuntivo, è consigliabile eseguire il rollback della transazione corrente e riavviarla dopo avere ottenuto l'input desiderato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1785">If additional user input is required during a transaction, roll back the current transaction and restart the transaction after the user input is supplied.</span></span> <span data-ttu-id="ca04c-1786">Anche se gli utenti rispondono immediatamente, i tempi di reazione umani sono in larga misura inferiori alla velocità del computer.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1786">Even if users respond immediately, human reaction times are vastly slower than computer speeds.</span></span> <span data-ttu-id="ca04c-1787">Tutte le risorse utilizzate dalla transazione vengono tenute occupate per periodi di tempo estremamente prolungati e possono pertanto causare potenziali problemi di blocco.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1787">All resources held by the transaction are held for an extremely long time, which has the potential to cause blocking problems.</span></span> <span data-ttu-id="ca04c-1788">Se gli utenti non rispondono, la transazione rimane attiva e continua a bloccare risorse critiche fino a quando non riceve una risposta, ovvero anche dopo diversi minuti o addirittura diverse ore.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1788">If users do not respond, the transaction remains active, locking critical resources until they respond, which may not happen for several minutes or even hours.</span></span>  
  
-   <span data-ttu-id="ca04c-1789">Se possibile, evitare di aprire una transazione durante l'analisi dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1789">Do not open a transaction while browsing through data, if at all possible.</span></span>  
  
     <span data-ttu-id="ca04c-1790">Le transazioni devono essere avviate solo dopo il completamento dell'analisi preliminare dei dati.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1790">Transactions should not be started until all preliminary data analysis has been completed.</span></span>  
  
-   <span data-ttu-id="ca04c-1791">Mantenere la transazione il più breve possibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1791">Keep the transaction as short as possible.</span></span>  
  
     <span data-ttu-id="ca04c-1792">Dopo avere determinato quali modifiche è necessario eseguire, avviare la transazione, eseguire le istruzioni di modifica e quindi eseguire immediatamente il commit o il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1792">After you know the modifications that have to be made, start a transaction, execute the modification statements, and then immediately commit or roll back.</span></span> <span data-ttu-id="ca04c-1793">Evitare di aprire la transazione prima che sia necessario.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1793">Do not open the transaction before it is required.</span></span>  
  
-   <span data-ttu-id="ca04c-1794">Per limitare i blocchi, è consigliabile utilizzare per le query di sola lettura un livello di isolamento basato sul controllo delle versioni delle righe.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1794">To reduce blocking, consider using a row versioning-based isolation level for read-only queries.</span></span>  
  
-   <span data-ttu-id="ca04c-1795">Utilizzare in modo intelligente i livelli bassi di isolamento delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1795">Make intelligent use of lower transaction isolation levels.</span></span>  
  
     <span data-ttu-id="ca04c-1796">Molte applicazioni possono essere codificate rapidamente in modo da utilizzare il livello di isolamento delle transazioni Read Committed.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1796">Many applications can be readily coded to use a read-committed transaction isolation level.</span></span> <span data-ttu-id="ca04c-1797">Non tutte le transazioni richiedono il livello di isolamento Serializable.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1797">Not all transactions require the serializable transaction isolation level.</span></span>  
  
-   <span data-ttu-id="ca04c-1798">Utilizzare in modo intelligente le opzioni di concorrenza dei cursori di livello più basso, ad esempio le opzioni di concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1798">Make intelligent use of lower cursor concurrency options, such as optimistic concurrency options.</span></span>  
  
     <span data-ttu-id="ca04c-1799">In un sistema in cui è improbabile che vengano eseguiti aggiornamenti simultanei, l'overhead associato all'errore occasionale causato dalla modifica dei dati da parte di altri utenti successivamente alla lettura dei dati stessi può essere molto più ridotto dell'overhead associato al blocco di ogni riga letta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1799">In a system with a low probability of concurrent updates, the overhead of dealing with an occasional "somebody else changed your data after you read it" error can be much lower than the overhead of always locking rows as they are read.</span></span>  
  
-   <span data-ttu-id="ca04c-1800">Durante una transazione, accedere alla quantità minima di dati possibile.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1800">Access the least amount of data possible while in a transaction.</span></span>  
  
     <span data-ttu-id="ca04c-1801">Ciò consente ridurre il numero di righe bloccate e pertanto anche la contesa tra le transazioni.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1801">This lessens the number of locked rows, thereby reducing contention between transactions.</span></span>  
  
#### <a name="avoiding-concurrency-and-resource-problems"></a><span data-ttu-id="ca04c-1802">Evitare problemi di concorrenza e delle risorse</span><span class="sxs-lookup"><span data-stu-id="ca04c-1802">Avoiding Concurrency and Resource Problems</span></span>  

 <span data-ttu-id="ca04c-1803">Per evitare problemi di concorrenza e delle risorse, è necessario gestire le transazioni implicite con la massima attenzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1803">To prevent concurrency and resource problems, manage implicit transactions carefully.</span></span> <span data-ttu-id="ca04c-1804">Quando si utilizzano transazioni implicite, l'istruzione [!INCLUDE[tsql](../includes/tsql-md.md)] che segue l'istruzione COMMIT o ROLLBACK avvia automaticamente una nuova transazione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1804">When using implicit transactions, the next [!INCLUDE[tsql](../includes/tsql-md.md)] statement after COMMIT or ROLLBACK automatically starts a new transaction.</span></span> <span data-ttu-id="ca04c-1805">Ciò potrebbe comportare l'apertura di una nuova transazione mentre nell'applicazione è in corso l'esame dei dati o addirittura quando viene richiesto l'input dell'utente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1805">This can cause a new transaction to be opened while the application browses through data, or even when it requires input from the user.</span></span> <span data-ttu-id="ca04c-1806">Dopo che è stata completata l'ultima transazione necessaria per la protezione delle modifiche ai dati, disabilitare le transazioni implicite fino a quando non è nuovamente necessaria una transazione per la protezione delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1806">After completing the last transaction required to protect data modifications, turn off implicit transactions until a transaction is once again required to protect data modifications.</span></span> <span data-ttu-id="ca04c-1807">In questo modo, quando nell'applicazione è in corso l'esame dei dati e viene richiesto l'input dell'utente, in [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] viene utilizzata la modalità autocommit.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1807">This process lets the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] use autocommit mode while the application is browsing data and getting input from the user.</span></span>  
  
 <span data-ttu-id="ca04c-1808">Inoltre, se è abilitato il livello di isolamento dello snapshot, anche se una nuova transazione non manterrà attivi i blocchi, una transazione con esecuzione prolungata consentirà di evitare la rimozione delle versioni precedenti da `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1808">In addition, when the snapshot isolation level is enabled, although a new transaction will not hold locks, a long-running transaction will prevent the old versions from being removed from `tempdb`.</span></span>  
  
### <a name="managing-long-running-transactions"></a><span data-ttu-id="ca04c-1809">Gestione di transazioni con esecuzione prolungata</span><span class="sxs-lookup"><span data-stu-id="ca04c-1809">Managing Long-Running Transactions</span></span>  

 <span data-ttu-id="ca04c-1810">Una *transazione con esecuzione prolungata* è una transazione attiva su cui non è stato eseguito tempestivamente il commit o il rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1810">A *long-running transaction* is an active transaction that has not been committed or roll backed the transaction in a timely manner.</span></span> <span data-ttu-id="ca04c-1811">Se, ad esempio, l'inizio e la fine di una transazione sono controllati dall'utente, una causa tipica di una transazione con esecuzione prolungata è l'avvio di una transazione da parte di un utente senza la successiva immissione di una risposta.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1811">For example, if the beginning and end of a transaction is controlled by the user, a typical cause of a long-running transaction is a user starting a transaction and then leaving while the transaction waits for a response from the user.</span></span>  
  
 <span data-ttu-id="ca04c-1812">Una transazione con esecuzione prolungata può causare seri problemi a un database, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1812">A long running transaction can cause serious problems for a database, as follows:</span></span>  
  
-   <span data-ttu-id="ca04c-1813">Se un'istanza del server viene chiusa dopo che una transazione attiva ha eseguito numerose modifiche di cui non è stato eseguito il commit, la fase di recupero del riavvio successivo può richiedere molto più tempo del tempo specificato dall'opzione di configurazione del server **intervallo di recupero** o dall'istruzione ALTER database... IMPOSTARE TARGET_RECOVERY_TIME opzione.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1813">If a server instance is shut down after an active transaction has performed many uncommitted modifications, the recovery phase of the subsequent restart can take much longer than the time specified by the **recovery interval** server configuration option or by the ALTER DATABASE... SET TARGET_RECOVERY_TIME option.</span></span> <span data-ttu-id="ca04c-1814">Queste opzioni controllano la frequenza di checkpoint attivi e indiretti, rispettivamente.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1814">These options control the frequency of active and indirect checkpoints, respectively.</span></span> <span data-ttu-id="ca04c-1815">Per altre informazioni sui tipi di checkpoint, vedere [Checkpoint di database &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1815">For more information about the types of checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span></span>  
  
-   <span data-ttu-id="ca04c-1816">Inoltre, sebbene una transazione in attesa di una risposta possa produrre un aumento minimo del log, posticipa il troncamento del log in modo indefinito con una conseguente crescita delle relative dimensioni con rischio di riempimento.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1816">More importantly, although a waiting transaction might generate very little log, it holds up log truncation indefinitely, causing the transaction log to grow and possibly fill up.</span></span> <span data-ttu-id="ca04c-1817">Se log delle transazioni si riempie, il database non può essere più aggiornato.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1817">If the transaction log fills up, the database cannot perform any more updates.</span></span> <span data-ttu-id="ca04c-1818">Per ulteriori informazioni, vedere la pagina relativa alla [risoluzione dei problemi relativi a un log delle transazioni completo &#40;SQL Server errore 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)e [al log delle transazioni &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1818">For more information, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), and [The Transaction Log &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span></span>  
  
#### <a name="discovering-long-running-transactions"></a><span data-ttu-id="ca04c-1819">Individuazione delle transazioni con esecuzione prolungata</span><span class="sxs-lookup"><span data-stu-id="ca04c-1819">Discovering Long-Running Transactions</span></span>  

 <span data-ttu-id="ca04c-1820">Per individuare le transazioni con esecuzione prolungata, utilizzare una delle alternative seguenti:</span><span class="sxs-lookup"><span data-stu-id="ca04c-1820">To look for long-running transactions, use one of the following:</span></span>  
  
-   <span data-ttu-id="ca04c-1821">**sys.dm_tran_database_transactions**</span><span class="sxs-lookup"><span data-stu-id="ca04c-1821">**sys.dm_tran_database_transactions**</span></span>  
  
     <span data-ttu-id="ca04c-1822">Questa vista a gestione dinamica restituisce informazioni sulle transazioni a livello di database.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1822">This dynamic management view returns information about transactions at the database level.</span></span> <span data-ttu-id="ca04c-1823">Per una transazione a esecuzione prolungata, le colonne particolarmente rilevanti sono quelle che indicano l'ora del primo record di log (**database_transaction_begin_time**), lo stato corrente della transazione (**database_transaction_state**) e il numero di sequenza del file di log (LSN) del record iniziale nel log delle transazioni (**database_transaction_begin_lsn**).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1823">For a long-running transaction, columns of particular interest include the time of the first log record (**database_transaction_begin_time**), the current state of the transaction (**database_transaction_state**), and the log sequence number (LSN) of the begin record in the transaction log (**database_transaction_begin_lsn**).</span></span>  
  
     <span data-ttu-id="ca04c-1824">Per altre informazioni, vedere [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1824">For more information, see [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span></span>  
  
-   <span data-ttu-id="ca04c-1825">DBCC OPENTRAN</span><span class="sxs-lookup"><span data-stu-id="ca04c-1825">DBCC OPENTRAN</span></span>  
  
     <span data-ttu-id="ca04c-1826">Questa istruzione consente di identificare l'ID utente del proprietario della transazione, in modo da risalire, se lo si desidera, all'origine della transazione per terminarla in modo più appropriato, ovvero tramite il commit invece del rollback.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1826">This statement lets you identify the user ID of the owner of the transaction, so you can potentially track down the source of the transaction for a more orderly termination (committing it rather than rolling it back).</span></span> <span data-ttu-id="ca04c-1827">Per altre informazioni, vedere [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1827">For more information, see [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span></span>  
  
#### <a name="stopping-a-transaction"></a><span data-ttu-id="ca04c-1828">Arresto di una transazione</span><span class="sxs-lookup"><span data-stu-id="ca04c-1828">Stopping a Transaction</span></span>  

 <span data-ttu-id="ca04c-1829">Potrebbe essere necessario utilizzare l'istruzione KILL.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1829">You may have to use the KILL statement.</span></span> <span data-ttu-id="ca04c-1830">Eseguire l'istruzione con cautela, soprattutto quando sono in esecuzione processi importanti.</span><span class="sxs-lookup"><span data-stu-id="ca04c-1830">Use this statement very carefully, however, especially when critical processes are running.</span></span> <span data-ttu-id="ca04c-1831">Per altre informazioni, vedere [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="ca04c-1831">For more information, see [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span></span>  
  
 <span data-ttu-id="ca04c-1832">![Icona freccia usata con il collegamento Torna all'inizio](media/uparrow16x16.gif "Icona freccia usata con il collegamento Torna all'inizio") [in questa guida](#Top)</span><span class="sxs-lookup"><span data-stu-id="ca04c-1832">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ca04c-1833">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="ca04c-1833">See Also</span></span>  

 <span data-ttu-id="ca04c-1834">[SQL Server 2005 isolamento delle transazioni basato sul controllo delle versioni delle righe](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span><span class="sxs-lookup"><span data-stu-id="ca04c-1834">[SQL Server 2005 Row Versioning-Based Transaction Isolation](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span></span>  
 <span data-ttu-id="ca04c-1835">[Overhead del controllo delle versioni delle righe](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span><span class="sxs-lookup"><span data-stu-id="ca04c-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span></span>  
 [<span data-ttu-id="ca04c-1836">Come creare una transazione autonoma in SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="ca04c-1836">How to create an autonomous transaction in SQL Server 2008</span></span>](https://blogs.msdn.com/b/sqlprogrammability/archive/2008/08/22/how-to-create-an-autonomous-transaction-in-sql-server-2008.aspx)  
  
  
