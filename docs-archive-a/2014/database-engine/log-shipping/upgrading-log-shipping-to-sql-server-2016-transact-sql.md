---
title: Aggiornamento del log shipping a SQL Server 2014 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87638038"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="58dca-102">Aggiornare il log shipping a SQL Server 2014 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="58dca-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="58dca-103">Quando si effettua l'aggiornamento da [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]o [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], è possibile mantenere le configurazioni per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="58dca-104">In questo argomento vengono descritti scenari alternativi e procedure consigliate per aggiornare una configurazione per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="58dca-105">La[compressione dei backup](../../relational-databases/backup-restore/backup-compression-sql-server.md) è stata introdotta in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span><span class="sxs-lookup"><span data-stu-id="58dca-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="58dca-106">In una configurazione per il log shipping aggiornata viene usata l'opzione di configurazione a livello di server **backup compression default** per controllare se la compressione dei backup viene usata per i file di backup del log delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="58dca-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="58dca-107">Il comportamento della compressione dei backup relativa ai backup del log può essere specificato per ogni configurazione per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="58dca-108">Per altre informazioni, vedere [Configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> <span data-ttu-id="58dca-109">Protezione dei dati prima dell'aggiornamento</span><span class="sxs-lookup"><span data-stu-id="58dca-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="58dca-110">Prima di eseguire un aggiornamento del log shipping, è consigliabile proteggere i dati.</span><span class="sxs-lookup"><span data-stu-id="58dca-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="58dca-111">**Per proteggere i dati**</span><span class="sxs-lookup"><span data-stu-id="58dca-111">**To protect your data**</span></span>

1.  <span data-ttu-id="58dca-112">Eseguire un backup completo di ciascun database primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="58dca-113">Per altre informazioni, vedere [Creare un backup completo del database &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="58dca-114">Eseguire il comando [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) in ciascun database primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="58dca-115">Aggiornamento dell'istanza del server di monitoraggio</span><span class="sxs-lookup"><span data-stu-id="58dca-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="58dca-116">L'istanza del server di monitoraggio, se presente, può essere aggiornata in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="58dca-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="58dca-117">Durante l'aggiornamento del server di monitoraggio, la configurazione per il log shipping continua a funzionare, ma lo stato relativo non viene registrato nelle tabelle sul monitor</span><span class="sxs-lookup"><span data-stu-id="58dca-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="58dca-118">e non verrà attivato alcun avviso configurato.</span><span class="sxs-lookup"><span data-stu-id="58dca-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="58dca-119">Dopo l'aggiornamento, è possibile eseguire la stored procedure di sistema [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) per aggiornare le informazioni contenute nelle tabelle di monitoraggio.</span><span class="sxs-lookup"><span data-stu-id="58dca-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="58dca-120">Aggiornamento delle configurazioni per il log shipping con un unico server secondario</span><span class="sxs-lookup"><span data-stu-id="58dca-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="58dca-121">Il processo di aggiornamento descritto in questa sezione prevede l'utilizzo di una configurazione costituita dal server primario e da un unico server secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="58dca-122">Tale configurazione è rappresentata nella figura seguente, in cui vengono illustrate un'istanza del server primario, A, e un'unica istanza del server secondario, B.</span><span class="sxs-lookup"><span data-stu-id="58dca-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="58dca-123">![Un server secondario e nessun server di monitoraggio](../media/ls-2-wayconfig-nomonitor.gif "Un server secondario e nessun server di monitoraggio")</span><span class="sxs-lookup"><span data-stu-id="58dca-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="58dca-124">Per informazioni sull'aggiornamento di più server secondari, vedere [Aggiornamento di più istanze del server secondario](#MultipleSecondaries)più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="58dca-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="58dca-125">Aggiornamento dell'istanza del server secondario</span><span class="sxs-lookup"><span data-stu-id="58dca-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="58dca-126">Il processo di aggiornamento prevede innanzitutto l'aggiornamento delle istanze del server secondario di una configurazione per il log shipping di [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] o versione successiva a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] prima di aggiornare l'istanza del server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="58dca-127">È sempre necessario aggiornare prima l'istanza del server secondario</span><span class="sxs-lookup"><span data-stu-id="58dca-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="58dca-128">per evitare che il log shipping funzioni in modo non corretto poiché un backup creato in una versione più recente di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] non può essere ripristinato in una versione precedente di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="58dca-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="58dca-129">Il log shipping non viene interrotto durante tutto il processo di aggiornamento poiché tramite i server secondari aggiornati si continuano a ripristinare i backup del log dal server primario [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="58dca-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="58dca-130">Il processo di aggiornamento delle istanze del server secondario dipende in parte dalla presenza di più server secondari nella configurazione per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="58dca-131">Per ulteriori informazioni, vedere [Aggiornamento di più istanze del server secondario](#MultipleSecondaries)più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="58dca-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="58dca-132">Durante l'aggiornamento dell'istanza del server secondario, i processi di copia del log shipping e di ripristino non sono in esecuzione e di conseguenza i backup del log delle transazioni non ripristinati si accumuleranno.</span><span class="sxs-lookup"><span data-stu-id="58dca-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="58dca-133">La quantità di accumulo dipende dalla frequenza di esecuzione dei backup pianificati nel server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="58dca-134">Se è stato configurato un server di monitoraggio separato, inoltre, è possibile che vengano generati avvisi che indicano che i ripristini non sono stati eseguiti per un tempo maggiore rispetto all'intervallo configurato.</span><span class="sxs-lookup"><span data-stu-id="58dca-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="58dca-135">Dopo che il server secondario è stato aggiornato, i processi dell'agente di log shipping riprendono e continuano a copiare e ripristinare i backup del log dall'istanza del server primario, ovvero il server A. La quantità di tempo necessaria affinché il server secondario aggiorni il database secondario varia a seconda del tempo impiegato per aggiornare il server secondario e della frequenza dei backup nel server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="58dca-136">Durante l'aggiornamento del server, il database secondario non viene aggiornato a un database di [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="58dca-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="58dca-137">Per eseguire l'aggiornamento, è necessario attivare la modalità online per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="58dca-138">L'opzione RESTORE WITH STANDBY non è supportata per i database che richiedono aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="58dca-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="58dca-139">Se un database secondario aggiornato è stato configurato tramite RESTORE WITH STANDBY, non sarà più possibile ripristinare i log delle transazioni dopo l'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="58dca-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="58dca-140">Per riprendere il log shipping sul database secondario, sarà necessario configurarlo nuovamente sul server di standby.</span><span class="sxs-lookup"><span data-stu-id="58dca-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="58dca-141">Per ulteriori informazioni sull'opzione STANDBY, vedere [argomenti di ripristino &#40;&#41;Transact-SQL ](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="58dca-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="58dca-142">Aggiornamento dell'istanza del server primario</span><span class="sxs-lookup"><span data-stu-id="58dca-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="58dca-143">Quando si pianifica un aggiornamento, un aspetto significativo da considerare è la quantità di tempo in cui il database non risulterà disponibile.</span><span class="sxs-lookup"><span data-stu-id="58dca-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="58dca-144">Nello scenario di aggiornamento più semplice il database non è disponibile durante l'aggiornamento del server primario (scenario 1 riportato di seguito).</span><span class="sxs-lookup"><span data-stu-id="58dca-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="58dca-145">A fronte di una maggiore complessità del processo di aggiornamento, è possibile aumentare la disponibilità del database eseguendo il failover del server primario [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] o versione successiva su un server secondario [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] prima di aggiornare il server primario originale (scenario 2 riportato di seguito).</span><span class="sxs-lookup"><span data-stu-id="58dca-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="58dca-146">Sono disponibili due scenari di failover diversi.</span><span class="sxs-lookup"><span data-stu-id="58dca-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="58dca-147">È possibile tornare al server primario originale e mantenere la configurazione per il log shipping originale</span><span class="sxs-lookup"><span data-stu-id="58dca-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="58dca-148">oppure è possibile rimuovere la configurazione per il log shipping originale prima di aggiornare il server primario originale e creare in un secondo momento una nuova configurazione utilizzando il nuovo server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="58dca-149">In questa sezione vengono descritti entrambi gli scenari.</span><span class="sxs-lookup"><span data-stu-id="58dca-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="58dca-150">Prima di aggiornare l'istanza del server primario, è necessario accertarsi di avere aggiornato l'istanza del server secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="58dca-151">Per ulteriori informazioni, vedere [Aggiornamento dell'istanza del server secondario](#UpgradeSecondary)in precedenza in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="58dca-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="58dca-152">Scenario 1: aggiornamento dell'istanza del server primario senza failover</span><span class="sxs-lookup"><span data-stu-id="58dca-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="58dca-153">Questo scenario è quello più semplice, ma provoca un tempo di inattività maggiore rispetto all'utilizzo del failover.</span><span class="sxs-lookup"><span data-stu-id="58dca-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="58dca-154">L'istanza del server primario viene semplicemente aggiornata e il database non è disponibile durante l'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="58dca-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="58dca-155">Dopo che il server è stato aggiornato, viene attivata automaticamente la modalità online per il database determinandone pertanto l'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="58dca-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="58dca-156">Dopo che il database è stato aggiornato, viene ripresa l'esecuzione dei processi per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="58dca-157">Scenario 2. Aggiornamento dell'istanza del server primario con failover</span><span class="sxs-lookup"><span data-stu-id="58dca-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="58dca-158">In questo scenario viene aumentata al massimo la disponibilità e ridotto al minimo il tempo di inattività.</span><span class="sxs-lookup"><span data-stu-id="58dca-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="58dca-159">Nello scenario viene utilizzato un failover controllato sull'istanza del server secondario che consente di mantenere il database disponibile durante l'aggiornamento dell'istanza del server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="58dca-160">Il tempo di inattività è limitato al tempo relativamente breve necessario per eseguire il failover anziché essere costituito dal tempo necessario per aggiornare l'istanza del server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="58dca-161">L'aggiornamento dell'istanza del server primario con failover è un processo costituito da tre procedure generali, ovvero l'esecuzione di un failover controllato sul server secondario, l'aggiornamento dell'istanza del server primario originale a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]e l'impostazione del log shipping in un'istanza del server primario di [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="58dca-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="58dca-162">Tali procedure vengono descritte in questa sezione.</span><span class="sxs-lookup"><span data-stu-id="58dca-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="58dca-163">Se si intende disporre dell'istanza del server secondario come nuova istanza del server primario, è necessario rimuovere la configurazione per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="58dca-164">Il log shipping dovrà essere riconfigurato dal nuovo server primario nel nuovo server secondario dopo l'aggiornamento dell'istanza del server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="58dca-165">Per ulteriori informazioni, vedere [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="58dca-166">Procedura 1: eseguire un failover controllato sul server secondario</span><span class="sxs-lookup"><span data-stu-id="58dca-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="58dca-167">Failover controllato sul server secondario:</span><span class="sxs-lookup"><span data-stu-id="58dca-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="58dca-168">Eseguire manualmente un [backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) della parte finale del log delle transazioni nel database primario SPECIFICAndo WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="58dca-169">Tale backup acquisisce qualsiasi record di log di cui non è stato eseguito il backup e attiva la modalità offline per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="58dca-170">Si noti che mentre il database è offline, il processo di backup del log shipping non riuscirà.</span><span class="sxs-lookup"><span data-stu-id="58dca-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="58dca-171">Nell'esempio seguente viene creato un backup della parte finale del log del database `AdventureWorks` nel server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="58dca-172">Il file di backup viene denominato `Failover_AW_20080315.trn`:</span><span class="sxs-lookup"><span data-stu-id="58dca-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="58dca-173">È consigliabile utilizzare una convenzione di denominazione del file distinta per differenziare il file di backup creato manualmente da quelli creati dal processo di backup del log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="58dca-174">Nel server secondario effettuare le seguenti operazioni:</span><span class="sxs-lookup"><span data-stu-id="58dca-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="58dca-175">Verificare che tutti i backup eseguiti automaticamente dai processi di backup del log shipping siano stati applicati.</span><span class="sxs-lookup"><span data-stu-id="58dca-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="58dca-176">Per verificare quali processi di backup sono stati applicati, usare l'stored procedure di sistema [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) sul server di monitoraggio o sul server primario e secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="58dca-177">Lo stesso file deve essere elencato nelle colonne **last_backup_file**, **last_copied_file**e **last_restored_file** .</span><span class="sxs-lookup"><span data-stu-id="58dca-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="58dca-178">Se un file di backup non è stato copiato né ripristinato, richiamare manualmente i processi di copia dell'agente e di ripristino relativi alla configurazione per il log shipping.</span><span class="sxs-lookup"><span data-stu-id="58dca-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="58dca-179">Per informazioni sull'avvio di un processo, vedere [Start a Job](../../ssms/agent/start-a-job.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="58dca-180">Copiare il file di backup del log finale creato nel passaggio 1 dalla condivisione file nel percorso locale utilizzato dal log shipping nel server secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="58dca-181">Ripristinare il backup del log finale specificando WITH RECOVERY per attivare la modalità online per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="58dca-182">In seguito a quest'ultima operazione, il database verrà aggiornato a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="58dca-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="58dca-183">Nell'esempio seguente viene ripristinato il backup della parte finale del log del database `AdventureWorks` nel database secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="58dca-184">Nell'esempio viene utilizzata l'opzione WITH RECOVERY che consente di attivare la modalità online per il database:</span><span class="sxs-lookup"><span data-stu-id="58dca-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="58dca-185">Per una configurazione in cui è presente più di un server secondario, è necessario tenere presente considerazioni aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="58dca-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="58dca-186">Per ulteriori informazioni, vedere [Aggiornamento di più istanze del server secondario](#MultipleSecondaries)più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="58dca-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="58dca-187">Eseguire il failover del database reindirizzando i client dal server primario originale (server A) al server secondario online (server B).</span><span class="sxs-lookup"><span data-stu-id="58dca-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="58dca-188">Verificare che lo spazio disponibile sul log delle transazioni del database secondario non si esaurisca mentre il database è online.</span><span class="sxs-lookup"><span data-stu-id="58dca-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="58dca-189">Per evitare che si verifichi questa situazione, potrebbe essere necessario eseguire un backup del log.</span><span class="sxs-lookup"><span data-stu-id="58dca-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="58dca-190">In questo caso è consigliabile eseguire il backup in un percorso condiviso, ovvero una *condivisione di backup*, in modo che i backup siano disponibili per eseguire il ripristino nell'altra istanza del server.</span><span class="sxs-lookup"><span data-stu-id="58dca-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="58dca-191">Procedura 2: aggiornare l'istanza del server primario originale a[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="58dca-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="58dca-192">Dopo aver aggiornato l'istanza del server primario originale a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], per il database sarà ancora attivata la modalità offline e il formato.</span><span class="sxs-lookup"><span data-stu-id="58dca-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="58dca-193">Procedura 3: impostare il log shipping in[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="58dca-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="58dca-194">La parte rimanente del processo di aggiornamento dipende dalla presenza della configurazione per il log shipping, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="58dca-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="58dca-195">Se è stata mantenuta la configurazione per il log shipping di [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]o versione successiva, tornare all'istanza del server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="58dca-196">Per ulteriori informazioni, vedere [Per tornare all'istanza del server primario originale](#SwitchToOrigPrimary)più avanti in questa sezione.</span><span class="sxs-lookup"><span data-stu-id="58dca-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="58dca-197">Se la configurazione per il log shipping è stata rimossa prima dell'esecuzione del failover, creare una nuova configurazione per il log shipping in cui l'istanza del server secondario originale costituisce la nuova istanza del server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="58dca-198">Per ulteriori informazioni, vedere [Per mantenere l'istanza precedente del server secondario come nuova istanza del server primario](#KeepOldSecondaryAsNewPrimary)più avanti in questa sezione.</span><span class="sxs-lookup"><span data-stu-id="58dca-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="58dca-199">Per tornare all'istanza del server primario originale</span><span class="sxs-lookup"><span data-stu-id="58dca-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="58dca-200">Nel server primario provvisorio (server B) eseguire il backup della parte finale del log utilizzando WITH NORECOVERY per crearlo e per attivare la modalità offline per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="58dca-201">La parte finale del log viene denominata `Switchback_AW_20080315.trn`, ad esempio:</span><span class="sxs-lookup"><span data-stu-id="58dca-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="58dca-202">Se nel database primario provvisorio sono stati eseguiti backup del log delle transazioni, ripristinare questi ultimi utilizzando WITH NORECOVERY nel database offline nel server primario originale (server A) anziché ripristinare il backup della parte finale del log creato nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="58dca-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="58dca-203">Il database viene aggiornato al formato di [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] nel momento in cui viene eseguito il primo ripristino del backup del log.</span><span class="sxs-lookup"><span data-stu-id="58dca-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="58dca-204">Ripristinare il backup della parte finale del log, `Switchback_AW_20080315.trn`, nel database primario originale (nel server A) utilizzando WITH RECOVERY per attivare la modalità online per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="58dca-205">Eseguire nuovamente il failover sul database primario originale (nel server A) reindirizzando i client al server secondario online dal server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="58dca-206">Dopo che il database è online, verrà ripresa la configurazione per il log shipping originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="58dca-207">Per conservare l'istanza precedente del server secondario come nuova istanza del server primario</span><span class="sxs-lookup"><span data-stu-id="58dca-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="58dca-208">Definire una nuova configurazione per il log shipping utilizzando l'istanza precedente del server secondario, B, come server primario e l'istanza precedente del server primario, A, come nuovo server secondario nel modo indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="58dca-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="58dca-209">All'inizio del processo, prima di recuperare il backup del log delle transazioni manuale in base al quale è stata attivata la modalità offline per il database, è necessario che la configurazione per il log shipping sia stata rimossa dal server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="58dca-210">Per evitare di eseguire un backup completo e di ripristinare il database nel nuovo server secondario (server A), applicare i backup del log dal nuovo database primario al nuovo database secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="58dca-211">Nella configurazione di esempio questa operazione prevede il ripristino dei backup del log eseguiti nel server B nel database nel server A.</span><span class="sxs-lookup"><span data-stu-id="58dca-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="58dca-212">Eseguire il backup del log dal nuovo database primario (nel server B).</span><span class="sxs-lookup"><span data-stu-id="58dca-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="58dca-213">Ripristinare i backup del log nella nuova istanza del server secondario (server A) tramite WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="58dca-214">La prima operazione di ripristino aggiorna il database a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="58dca-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="58dca-215">Configurare il log shipping con il server secondario precedente (server B) come istanza del server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="58dca-216">Se si utilizza [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specificare che il database secondario è già inizializzato.</span><span class="sxs-lookup"><span data-stu-id="58dca-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="58dca-217">Per altre informazioni, vedere [Configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="58dca-218">Eseguire il failover del database reindirizzando i client dal server primario originale (server A) al server secondario online (server B).</span><span class="sxs-lookup"><span data-stu-id="58dca-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="58dca-219">Quando si esegue il failover sul nuovo database primario, è necessario verificare che tutti i relativi metadati siano coerenti con quelli del database primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="58dca-220">Per altre informazioni, vedere [Gestione dei metadati quando si rende disponibile un database in un'altra istanza del server &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="58dca-221">Aggiornamento di più istanze del server secondario</span><span class="sxs-lookup"><span data-stu-id="58dca-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="58dca-222">Tale configurazione è rappresentata nella figura seguente, in cui vengono illustrate un'istanza del server primario, A, e due istanze del server secondario, B e C.</span><span class="sxs-lookup"><span data-stu-id="58dca-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="58dca-223">![Due server secondari e nessun server di monitoraggio](../media/ls-3-wayconfig-nomonitor.gif "Due server secondari e nessun server di monitoraggio")</span><span class="sxs-lookup"><span data-stu-id="58dca-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="58dca-224">In questa sezione viene descritto come eseguire l'aggiornamento tramite un failover e ritornare quindi al server primario originale.</span><span class="sxs-lookup"><span data-stu-id="58dca-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="58dca-225">Se sono presenti più istanze del server secondario, l'aggiornamento dell'istanza primaria con failover costituisce un processo più complesso.</span><span class="sxs-lookup"><span data-stu-id="58dca-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="58dca-226">Nella procedura seguente, dopo l'aggiornamento di tutti i server secondari, viene eseguito il failover del server primario su uno dei database secondari aggiornati.</span><span class="sxs-lookup"><span data-stu-id="58dca-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="58dca-227">Successivamente il server primario originale viene aggiornato e il failover del log shipping viene eseguito nuovamente su tale server.</span><span class="sxs-lookup"><span data-stu-id="58dca-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="58dca-228">È necessario aggiornare sempre tutte le istanze del server secondario prima di aggiornare il server primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="58dca-229">**Per eseguire l'aggiornamento utilizzando un failover e ritornare quindi al server primario originale**</span><span class="sxs-lookup"><span data-stu-id="58dca-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="58dca-230">Aggiornare tutte le istanze del server secondario (server B e server C).</span><span class="sxs-lookup"><span data-stu-id="58dca-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="58dca-231">Eseguire la parte finale del log delle transazioni del database primario (nel server A), quindi attivare la modalità offline per il database eseguendo il backup del log delle transazioni tramite WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="58dca-232">Nel server secondario su cui si intende eseguire il failover (server B) attivare la modalità online per il database secondario ripristinando il backup del log tramite WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="58dca-233">Nell'altro server secondario (server C) lasciare attivata la modalità offline per il database ripristinando il backup del log tramite WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="58dca-234">I processi di copia del log shipping e di ripristino verranno eseguiti nei server secondari, ma non eseguiranno alcuna operazione poiché i nuovi file di backup del log non saranno posizionati nella condivisione di backup.</span><span class="sxs-lookup"><span data-stu-id="58dca-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="58dca-235">Eseguire il failover del database reindirizzando i client dal server primario originale (server A) al server secondario online (server B).</span><span class="sxs-lookup"><span data-stu-id="58dca-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="58dca-236">Il database online diventa un server primario provvisorio, mantenendo disponibile il database mentre per il server primario originale è attivata la modalità offline (server A).</span><span class="sxs-lookup"><span data-stu-id="58dca-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="58dca-237">Aggiornare il server primario originale (server A).</span><span class="sxs-lookup"><span data-stu-id="58dca-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="58dca-238">Nel database in cui è stato eseguito il failover del database primario provvisorio (nel server B), eseguire manualmente il backup del log delle transazioni utilizzando WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="58dca-239">In questo modo viene attivata la modalità offline per il database.</span><span class="sxs-lookup"><span data-stu-id="58dca-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="58dca-240">Ripristinare tutti i backup del log delle transazioni creati nel database primario provvisorio (nel server B) a ogni altro database secondario (nel server C) tramite WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="58dca-241">In questo modo il log shipping continuerà a funzionare dal database primario originale dopo il relativo aggiornamento, senza che sia necessario eseguire un ripristino completo di ogni database secondario.</span><span class="sxs-lookup"><span data-stu-id="58dca-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="58dca-242">Ripristinare il log delle transazioni dal server primario provvisorio (server B) al database primario originale (nel server A) tramite WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="58dca-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="58dca-243">Ridistribuzione del log shipping</span><span class="sxs-lookup"><span data-stu-id="58dca-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="58dca-244">Se non si desidera eseguire la migrazione della configurazione per il log shipping tramite una delle procedure illustrate in precedenza, è possibile ridistribuire il log shipping reinizializzando il database secondario con un backup e ripristino completi del database primario.</span><span class="sxs-lookup"><span data-stu-id="58dca-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="58dca-245">Questa operazione è consigliabile nel caso di un database di piccole dimensioni oppure se non è essenziale garantire un livello di disponibilità elevato durante il processo di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="58dca-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="58dca-246">Per informazioni sull'abilitazione di log shipping, vedere [configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="58dca-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="58dca-247">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="58dca-247">See Also</span></span>
 <span data-ttu-id="58dca-248">[Backup del log delle transazioni &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [applicare backup del log delle transazioni &#40;SQL Server](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [tabelle e stored procedure per il log shipping](log-shipping-tables-and-stored-procedures.md)</span><span class="sxs-lookup"><span data-stu-id="58dca-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
