---
title: Log shipping e replica (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87630037"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="a28ba-102">Log shipping e replica (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="a28ba-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="a28ba-103">Il log shipping coinvolge due copie di un unico database che in genere risiedono in computer diversi.</span><span class="sxs-lookup"><span data-stu-id="a28ba-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="a28ba-104">In un momento dato solo una copia del database risulta disponibile per i client.</span><span class="sxs-lookup"><span data-stu-id="a28ba-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="a28ba-105">Questa copia è nota come database primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-105">This copy is known as the primary database.</span></span> <span data-ttu-id="a28ba-106">Gli aggiornamenti al database primario apportati dai client vengono propagati attraverso il log shipping all'altra copia del database, nota come database secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="a28ba-107">Il processo di log shipping prevede l'applicazione nel database secondario del log delle transazioni relativo a ogni operazione di inserimento, aggiornamento o eliminazione eseguita sul database primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="a28ba-108">Quando il log shipping viene utilizzato in combinazione con la replica, si noti quanto segue:</span><span class="sxs-lookup"><span data-stu-id="a28ba-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="a28ba-109">La replica non continua in caso di failover del server del log shipping.</span><span class="sxs-lookup"><span data-stu-id="a28ba-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="a28ba-110">Se si verifica il failover, gli agenti di replica non si connettono al server secondario. In questo modo le transazioni non vengono replicate nei Sottoscrittori.</span><span class="sxs-lookup"><span data-stu-id="a28ba-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="a28ba-111">Se si verifica il failback nel server primario, la replica viene ripresa.</span><span class="sxs-lookup"><span data-stu-id="a28ba-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="a28ba-112">Tutte le transazioni copiate durante il log shipping dal server secondario a quello primario vengono replicate nei Sottoscrittori.</span><span class="sxs-lookup"><span data-stu-id="a28ba-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="a28ba-113">Se il database primario viene perso definitivamente, è possibile rinominare il database secondario affinché la replica possa continuare.</span><span class="sxs-lookup"><span data-stu-id="a28ba-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="a28ba-114">Nella parte restante dell'argomento vengono descritti i requisiti e le procedure necessari in questo caso.</span><span class="sxs-lookup"><span data-stu-id="a28ba-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="a28ba-115">Nell'esempio seguente viene utilizzato il database di pubblicazione, ovvero il database più comune per cui eseguire il log shipping. Le operazioni possono tuttavia essere eseguite nei database di sottoscrizione e di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="a28ba-116">Per informazioni sul recupero di database oggetto di replica senza dover riconfigurare la replica, vedere [Backup e ripristino di database replicati](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a28ba-117">Per garantire la disponibilità del database di pubblicazione è consigliabile utilizzare il mirroring del database invece del log shipping.</span><span class="sxs-lookup"><span data-stu-id="a28ba-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="a28ba-118">Per altre informazioni, vedere [Mirroring e replica del database &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="a28ba-119">Requisiti e procedure per la replica dal database secondario se quello primario viene perso</span><span class="sxs-lookup"><span data-stu-id="a28ba-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="a28ba-120">Tenere presenti i requisiti e le considerazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="a28ba-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="a28ba-121">Se nel server primario sono inclusi più database di pubblicazione, distribuire i log per tutti i database di pubblicazione allo stesso server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="a28ba-122">Il percorso di installazione dell'istanza del server secondario deve corrispondere a quello dell'istanza del server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="a28ba-123">I percorsi dei database utente nel server secondario devono corrispondere a quelli nel server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="a28ba-124">Eseguire il backup della chiave master del servizio nel server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="a28ba-125">La chiave verrà ripristinata nel server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="a28ba-126">Per altre informazioni, vedere [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="a28ba-127">Il log shipping non costituisce una garanzia completa contro la perdita di dati.</span><span class="sxs-lookup"><span data-stu-id="a28ba-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="a28ba-128">Un errore nel database primario può provocare la perdita di dati di cui non è ancora stato eseguito il backup o di copie di backup andate perse quando si è verificato l'errore.</span><span class="sxs-lookup"><span data-stu-id="a28ba-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="a28ba-129">Log shipping con replica transazionale</span><span class="sxs-lookup"><span data-stu-id="a28ba-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="a28ba-130">Nel caso della replica transazionale, il funzionamento del log shipping dipende dall'opzione **sync with backup** .</span><span class="sxs-lookup"><span data-stu-id="a28ba-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="a28ba-131">Questa opzione può essere impostata nel database di pubblicazione e nel database di distribuzione. Nel caso del log shipping per il server di pubblicazione, è importante che l'opzione sia impostata nel database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="a28ba-132">L'impostazione di questa opzione nel database di pubblicazione garantisce che le transazioni vengano recapitate al database di distribuzione solo dopo che è stato eseguito il backup nel database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="a28ba-133">L'ultimo backup del database di pubblicazione può quindi essere ripristinato nel server secondario. In questo modo il database di distribuzione avrà le stesse transazioni del database di pubblicazione ripristinato.</span><span class="sxs-lookup"><span data-stu-id="a28ba-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="a28ba-134">Questa opzione garantisce la consistenza tra server di pubblicazione, server di distribuzione e Sottoscrittori in caso di failover del server di pubblicazione in un server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="a28ba-135">L'impostazione di questa opzione ha effetto sulla latenza e sulla velocità effettiva in quanto le transazioni non possono essere recapitate al database di distribuzione finché non ne viene eseguito il backup nel server di pubblicazione. Se l'applicazione in uso consente questa latenza, è consigliabile impostare l'opzione nel database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="a28ba-136">Se l'opzione **sync with backup** non è impostata, i Sottoscrittori potrebbero ricevere modifiche che non sono più incluse nel database recuperato nel server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="a28ba-137">Per altre informazioni, vedere [Strategie per il backup e il ripristino della replica snapshot e della replica transazionale](../../relational-databases/replication/transactional/transactional-replication.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="a28ba-138">**Per configurare la replica transazionale e il log shipping con l'opzione sync with backup**</span><span class="sxs-lookup"><span data-stu-id="a28ba-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="a28ba-139">Se l'opzione sync with backup non è impostata nel database di pubblicazione, eseguire `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span><span class="sxs-lookup"><span data-stu-id="a28ba-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="a28ba-140">Per altre informazioni, vedere [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="a28ba-141">Configurare il log shipping per il database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="a28ba-142">Per altre informazioni, vedere [Configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="a28ba-143">Se si verifica un errore nel server di pubblicazione, ripristinare l'ultimo log del database nel server secondario mediante l'opzione KEEP_REPLICATION di RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="a28ba-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="a28ba-144">In questo modo vengono mantenute tutte le impostazioni di replica per il database.</span><span class="sxs-lookup"><span data-stu-id="a28ba-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="a28ba-145">Per altre informazioni, vedere [Failover su un database secondario per il log shipping &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="a28ba-146">Ripristinare i database **msdb** e **master** dal server primario al server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="a28ba-147">Per altre informazioni, vedere [Backup e ripristino di Database di sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="a28ba-148">Se il server primario è anche un server di distribuzione, ripristinare il database di distribuzione dal server primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="a28ba-149">Le impostazioni e la configurazione di replica di questi database devono essere consistenti con quelle del database di pubblicazione nel server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="a28ba-150">Nel server secondario rinominare il computer e quindi l'istanza di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] in modo che i nuovi nomi corrispondano al nome del server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="a28ba-151">Per informazioni sulla ridenominazione di un computer, vedere la documentazione di Windows.</span><span class="sxs-lookup"><span data-stu-id="a28ba-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="a28ba-152">Per informazioni sulla ridenominazione del server, vedere [Rinominare un computer che ospita un'istanza autonoma di SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Ridenominare un'istanza del cluster di failover di SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="a28ba-153">Nel server secondario ripristinare la chiave master del servizio di cui è stato eseguito il backup dal server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="a28ba-154">Per altre informazioni, vedere [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="a28ba-155">**Per configurare la replica transazionale e il log shipping senza l'opzione sync with backup**</span><span class="sxs-lookup"><span data-stu-id="a28ba-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="a28ba-156">Configurare il log shipping per il database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="a28ba-157">Per altre informazioni, vedere [Configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="a28ba-158">Se si verifica un errore nel server di pubblicazione, ripristinare l'ultimo log del database nel server secondario mediante l'opzione KEEP_REPLICATION di RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="a28ba-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="a28ba-159">In questo modo vengono mantenute tutte le impostazioni di replica per il database.</span><span class="sxs-lookup"><span data-stu-id="a28ba-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="a28ba-160">Per altre informazioni, vedere [Failover su un database secondario per il log shipping &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="a28ba-161">Ripristinare i database **msdb** e **master** dal server primario al server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="a28ba-162">Per altre informazioni, vedere [Backup e ripristino di Database di sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="a28ba-163">Se il server primario è anche un server di distribuzione, ripristinare il database di distribuzione dal server primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="a28ba-164">Le impostazioni e la configurazione di replica di questi database devono essere consistenti con quelle del database di pubblicazione nel server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="a28ba-165">Nel server secondario rinominare il computer e quindi l'istanza di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] in modo che i nuovi nomi corrispondano al nome del server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="a28ba-166">Per informazioni sulla ridenominazione di un computer, vedere la documentazione di Windows.</span><span class="sxs-lookup"><span data-stu-id="a28ba-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="a28ba-167">Per informazioni sulla ridenominazione del server, vedere [Rinominare un computer che ospita un'istanza autonoma di SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Ridenominare un'istanza del cluster di failover di SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="a28ba-168">È possibile che venga visualizzato un messaggio di errore dell'agente di lettura log che informa l'utente che il database di pubblicazione e il database di distribuzione non sono sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="a28ba-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="a28ba-169">Nel server secondario ripristinare la chiave master del servizio di cui è stato eseguito il backup dal server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="a28ba-170">Per altre informazioni, vedere [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="a28ba-171">Eseguire **sp_replrestart**.</span><span class="sxs-lookup"><span data-stu-id="a28ba-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="a28ba-172">Questa stored procedure consente di forzare l'agente di lettura log in modo che le transazioni già replicate nel log del database di pubblicazione vengano ignorate.</span><span class="sxs-lookup"><span data-stu-id="a28ba-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="a28ba-173">Le transazioni applicate dopo il completamento della stored procedure vengono elaborate dall'agente di lettura log.</span><span class="sxs-lookup"><span data-stu-id="a28ba-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="a28ba-174">Per altre informazioni, vedere [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="a28ba-175">Dopo aver eseguito la stored procedure, riavviare l'agente di lettura log.</span><span class="sxs-lookup"><span data-stu-id="a28ba-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="a28ba-176">Per altre informazioni, vedere [Avviare e arrestare un agente di replica &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="a28ba-177">Le transazioni che sono già state distribuite al Sottoscrittore possono essere applicate al server di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="a28ba-178">Affinché non si verifichi un errore dell'agente di distribuzione durante il tentativo di riapplicazione di tali transazioni al Sottoscrittore, specificare il profilo agente **Continua in caso di errori di coerenza dei dati**.</span><span class="sxs-lookup"><span data-stu-id="a28ba-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="a28ba-179">Log shipping con replica di tipo merge</span><span class="sxs-lookup"><span data-stu-id="a28ba-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="a28ba-180">Eseguire la procedura seguente per configurare la replica di tipo merge e il log shipping.</span><span class="sxs-lookup"><span data-stu-id="a28ba-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="a28ba-181">**Per configurare la replica di tipo merge e il log shipping**</span><span class="sxs-lookup"><span data-stu-id="a28ba-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="a28ba-182">Configurare il log shipping per il database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="a28ba-183">Per altre informazioni, vedere [Configurare il log shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="a28ba-184">In caso di errore del server di pubblicazione, nel server secondario rinominare il computer e quindi l'istanza di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] in modo che i nuovi nomi corrispondano al nome del server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="a28ba-185">Per informazioni sulla ridenominazione di un computer, vedere la documentazione di Windows.</span><span class="sxs-lookup"><span data-stu-id="a28ba-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="a28ba-186">Per informazioni sulla ridenominazione del server, vedere [Rinominare un computer che ospita un'istanza autonoma di SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Ridenominare un'istanza del cluster di failover di SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="a28ba-187">Ripristinare l'ultimo log del database nel server secondario mediante l'opzione KEEP_REPLICATION di RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="a28ba-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="a28ba-188">In questo modo vengono mantenute tutte le impostazioni di replica per il database.</span><span class="sxs-lookup"><span data-stu-id="a28ba-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="a28ba-189">Per altre informazioni, vedere [Failover su un database secondario per il log shipping &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="a28ba-190">Ripristinare i database **msdb** e **master** dal server primario al server secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="a28ba-191">Per altre informazioni, vedere [Backup e ripristino di Database di sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="a28ba-192">Se il server primario è anche un server di distribuzione, ripristinare il database di distribuzione dal server primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="a28ba-193">Le impostazioni e la configurazione di replica di questi database devono essere consistenti con quelle del database di pubblicazione nel server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="a28ba-194">Nel server secondario ripristinare la chiave master del servizio di cui è stato eseguito il backup dal server primario.</span><span class="sxs-lookup"><span data-stu-id="a28ba-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="a28ba-195">Per altre informazioni, vedere [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a28ba-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="a28ba-196">Sincronizzare il database di pubblicazione con uno o più database di sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="a28ba-197">In questo modo è possibile caricare le modifiche già apportate nel database di pubblicazione, ma non ancora incluse nella copia di backup ripristinata.</span><span class="sxs-lookup"><span data-stu-id="a28ba-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="a28ba-198">I dati che è possibile caricare dipendono dal modo in cui una pubblicazione è filtrata:</span><span class="sxs-lookup"><span data-stu-id="a28ba-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="a28ba-199">Se la pubblicazione non è filtrata, sarà possibile aggiornare il database di pubblicazione eseguendo la sincronizzazione con il Sottoscrittore più aggiornato.</span><span class="sxs-lookup"><span data-stu-id="a28ba-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="a28ba-200">Se la pubblicazione è filtrata, l'aggiornamento del database di pubblicazione potrebbe non essere possibile.</span><span class="sxs-lookup"><span data-stu-id="a28ba-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="a28ba-201">Considerare una tabella partizionata in modo che ogni sottoscrizione riceva i dati relativi ai clienti solo per una singola area: Nord, Est, Sud e Ovest.</span><span class="sxs-lookup"><span data-stu-id="a28ba-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="a28ba-202">Se per ogni partizione di dati è disponibile almeno un Sottoscrittore, la sincronizzazione con un Sottoscrittore per ogni partizione dovrebbe consentire di aggiornare il database di pubblicazione.</span><span class="sxs-lookup"><span data-stu-id="a28ba-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="a28ba-203">Tuttavia, se ad esempio i dati nella partizione Ovest non sono stati replicati in alcun Sottoscrittore, questi dati nel server di pubblicazione non potranno essere aggiornati.</span><span class="sxs-lookup"><span data-stu-id="a28ba-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="a28ba-204">In questo caso è consigliabile reinizializzare tutte le sottoscrizioni in modo da garantire la convergenza dei dati nel server di pubblicazione e nei Sottoscrittori.</span><span class="sxs-lookup"><span data-stu-id="a28ba-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="a28ba-205">Per altre informazioni, vedere [Reinizializzare le sottoscrizioni](../../relational-databases/replication/reinitialize-subscriptions.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="a28ba-206">Se si esegue la sincronizzazione con un Sottoscrittore che esegue una versione di [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] precedente a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], la sottoscrizione non può essere anonima, ma deve essere una sottoscrizione client o una sottoscrizione server (chiamate sottoscrizioni locali e sottoscrizioni globali nelle versioni precedenti del prodotto).</span><span class="sxs-lookup"><span data-stu-id="a28ba-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="a28ba-207">Per altre informazioni, vedere [Sincronizzare i dati](../../relational-databases/replication/synchronize-data.md).</span><span class="sxs-lookup"><span data-stu-id="a28ba-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="a28ba-208">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="a28ba-208">See Also</span></span>  
 <span data-ttu-id="a28ba-209">[Replica di SQL Server](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="a28ba-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="a28ba-210">[Informazioni sul log shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="a28ba-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="a28ba-211">Mirroring e replica del database &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="a28ba-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
