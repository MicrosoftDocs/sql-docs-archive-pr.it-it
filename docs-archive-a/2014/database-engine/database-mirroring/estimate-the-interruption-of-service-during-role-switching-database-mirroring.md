---
title: Stimare l'interruzione del servizio durante il cambio di ruolo (mirroring del database) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87624909"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="46cdf-102">Stimare l'interruzione del servizio durante il cambio di ruolo (mirroring del database)</span><span class="sxs-lookup"><span data-stu-id="46cdf-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="46cdf-103">Durante un cambio di ruolo, l'intervallo di tempo in cui il mirroring del database sarà fuori servizio dipende dal tipo e dalla causa del cambio di ruolo.</span><span class="sxs-lookup"><span data-stu-id="46cdf-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="46cdf-104">Per il failover automatico, i fattori che contribuiscono alla durata dell'interruzione del servizio sono due: il tempo necessario perché il server mirror individui l'errore del server principale, ovvero il rilevamento dell'errore, e il tempo necessario per eseguire il failover del database, ovvero il tempo di failover.</span><span class="sxs-lookup"><span data-stu-id="46cdf-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="46cdf-105">Per un'operazione di servizio forzato, sebbene si sia verificato un errore, il rilevamento e la risoluzione dell'errore dipendono dalla rapidità dell'intervento umano.</span><span class="sxs-lookup"><span data-stu-id="46cdf-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="46cdf-106">La potenziale interruzione del servizio può tuttavia essere stimata pari al tempo necessario al server mirror per il cambio di ruolo dopo l'esecuzione del comando di servizio forzato.</span><span class="sxs-lookup"><span data-stu-id="46cdf-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="46cdf-107">Per ridurre il tempo necessario al rilevamento di condizioni specifiche, ad esempio alcuni tipi di errori, è possibile definire avvisi per tali condizioni.</span><span class="sxs-lookup"><span data-stu-id="46cdf-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="46cdf-108">Nel caso di un failover manuale, è rilevante solo il tempo richiesto per eseguire il failover del database dopo l'esecuzione del comando di failover.</span><span class="sxs-lookup"><span data-stu-id="46cdf-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="46cdf-109">Rilevamento dell'errore</span><span class="sxs-lookup"><span data-stu-id="46cdf-109">Error detection</span></span>
 <span data-ttu-id="46cdf-110">Il periodo di tempo necessario al sistema per rilevare un errore dipende dal tipo di errore. Ad esempio, un errore di rete viene rilevato quasi istantaneamente, mentre il rilevamento della mancata risposta da parte di un server richiede 10 secondi (con il timeout predefinito).</span><span class="sxs-lookup"><span data-stu-id="46cdf-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="46cdf-111">Per informazioni sugli errori che possono causare un esito negativo durante una sessione di mirroring del database e sul rilevamento di timeout in modalità a sicurezza elevata con failover automatico, vedere [Possibili errori durante il mirroring del database](possible-failures-during-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="46cdf-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="46cdf-112">Tempo di failover</span><span class="sxs-lookup"><span data-stu-id="46cdf-112">Failover time</span></span>
 <span data-ttu-id="46cdf-113">Il tempo di failover è composto principalmente dal tempo necessario al server mirror precedente per eseguire il rollforward di tutti i log rimanenti nella propria coda rollforward, più un breve tempo aggiuntivo. Per altre informazioni sulla modalità usata dal server mirror per elaborare i record dei log, vedere [Mirroring di database &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="46cdf-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="46cdf-114">Per informazioni sulla stima del tempo di failover, vedere la sezione Stima del tempo di rollforward durante il failover, più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="46cdf-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46cdf-115">Se il failover si verifica durante una transazione in cui viene creato e quindi modificato un indice o una tabella, per il failover può essere necessario un tempo superiore al normale.</span><span class="sxs-lookup"><span data-stu-id="46cdf-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="46cdf-116">Ad esempio, il tempo di failover può aumentare se il failover si verifica durante la serie di operazioni seguente: BEGIN TRANSACTION, CREATE INDEX su una tabella e SELECT INTO sulla tabella.</span><span class="sxs-lookup"><span data-stu-id="46cdf-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="46cdf-117">La possibilità di un failover prolungato durante una transazione di questo tipo permane finché la transazione non viene completata con un'istruzione COMMIT TRANSACTION o ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="46cdf-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="46cdf-118">Coda rollforward</span><span class="sxs-lookup"><span data-stu-id="46cdf-118">The Redo Queue</span></span>
 <span data-ttu-id="46cdf-119">Il rollforward del database comporta l'applicazione dei record di log presenti nella coda rollforward sul server mirror.</span><span class="sxs-lookup"><span data-stu-id="46cdf-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="46cdf-120">La *coda rollforward* contiene i record di log che sono stati scritti su disco nel server mirror ma per i quali non è ancora stato eseguito il rollforward nel database mirror.</span><span class="sxs-lookup"><span data-stu-id="46cdf-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="46cdf-121">Il tempo di failover per il database dipende dalla velocità con cui il server mirror è in grado di eseguire il rollforward del log nella coda rollforward, a sua volta determinata principalmente dall'hardware di sistema e dal carico di lavoro attuale.</span><span class="sxs-lookup"><span data-stu-id="46cdf-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="46cdf-122">È possibile che, a causa di un carico di lavoro estremamente elevato in un database principale, la velocità con la quale il server principale invia il log al server mirror sia molto più elevata rispetto a quella con la quale ne esegue il rollforward.</span><span class="sxs-lookup"><span data-stu-id="46cdf-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="46cdf-123">In questo caso, il failover potrebbe richiedere tempi lunghi mentre il server mirror esegue il rollforward del log nella coda rollforward.</span><span class="sxs-lookup"><span data-stu-id="46cdf-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="46cdf-124">Per visualizzare le dimensioni correnti della coda rollforward, usare il contatore **Coda rollforward** nell'oggetto prestazioni del mirroring del database.</span><span class="sxs-lookup"><span data-stu-id="46cdf-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="46cdf-125">Per altre informazioni, vedere [Oggetto Database Mirroring di SQL Server](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="46cdf-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="46cdf-126">Stima del tempo di rollforward durante il failover</span><span class="sxs-lookup"><span data-stu-id="46cdf-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="46cdf-127">È possibile misurare il tempo necessario per eseguire il rollforward dei record del log, definito *tempo di rollforward*, usando una copia di prova del database di produzione.</span><span class="sxs-lookup"><span data-stu-id="46cdf-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="46cdf-128">Il metodo utilizzato per stimare il tempo di rollforward durante il failover dipende dal numero di thread utilizzati dal server mirror durante la fase di rollforward.</span><span class="sxs-lookup"><span data-stu-id="46cdf-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="46cdf-129">Il numero di thread dipende dagli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="46cdf-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="46cdf-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)]nel server mirror viene utilizzato sempre un thread singolo per eseguire il roll forward del database.</span><span class="sxs-lookup"><span data-stu-id="46cdf-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="46cdf-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], anche nei server mirror in computer con meno di cinque CPU viene utilizzato unicamente un thread singolo.</span><span class="sxs-lookup"><span data-stu-id="46cdf-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="46cdf-132">Con cinque o più CPU, un server mirror distribuisce le operazioni di rollforward a più thread durante un failover. Questa operazione viene definita *rollforward parallelo*.</span><span class="sxs-lookup"><span data-stu-id="46cdf-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="46cdf-133">Il rollforward parallelo è ottimizzato per l'utilizzo di un thread ogni quattro CPU.</span><span class="sxs-lookup"><span data-stu-id="46cdf-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="46cdf-134">Stima del tempo di rollforward per il rollforward a thread singolo</span><span class="sxs-lookup"><span data-stu-id="46cdf-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="46cdf-135">Per il rollforward a thread singolo, il tempo richiesto dal rollforward del database mirror durante il failover è all'incirca uguale al tempo necessario al ripristino di un backup del log per eseguire il rollforward di un log delle stesse dimensioni.</span><span class="sxs-lookup"><span data-stu-id="46cdf-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="46cdf-136">Per stimare il tempo di failover, creare un database di prova nell'ambiente in cui si prevede di eseguire il mirroring.</span><span class="sxs-lookup"><span data-stu-id="46cdf-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="46cdf-137">Prelevare quindi un backup del log dal database di produzione.</span><span class="sxs-lookup"><span data-stu-id="46cdf-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="46cdf-138">Per misurare il tempo di rollforward relativo al backup del log, verificare il tempo necessario per ripristinare il backup del log con WITH NORECOVERY nel database di prova.</span><span class="sxs-lookup"><span data-stu-id="46cdf-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="46cdf-139">Dopo avere ottenuto il tempo di rollforward del server mirror, è possibile stimare il tempo necessario per eseguire il failover del database a una temporizzazione specifica dividendo le dimensioni del log attuale per il quale dovrà essere eseguito il rollforward nel server mirror (misurate dal contatore delle prestazioni **Coda rollforward** ) per il tempo di rollforward.</span><span class="sxs-lookup"><span data-stu-id="46cdf-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="46cdf-140">In condizioni normali, se con il server mirror è possibile far fronte al carico derivante dal server principale, il valore di **Coda rollforward** è piccolo o vicino a zero e un failover richiede pochi secondi.</span><span class="sxs-lookup"><span data-stu-id="46cdf-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="46cdf-141">Stima del tempo di rollforward per il rollforward parallelo</span><span class="sxs-lookup"><span data-stu-id="46cdf-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="46cdf-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]il rollforward parallelo è ottimizzato per l'utilizzo di un thread ogni quattro CPU.</span><span class="sxs-lookup"><span data-stu-id="46cdf-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="46cdf-143">Per stimare il tempo di rollforward per il rollforward parallelo, è consigliabile utilizzare un sistema di prova in esecuzione anziché un semplice database di prova.</span><span class="sxs-lookup"><span data-stu-id="46cdf-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="46cdf-144">Durante il monitoraggio della coda rollforward sul server mirror, aumentare il carico del server principale.</span><span class="sxs-lookup"><span data-stu-id="46cdf-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="46cdf-145">In condizioni normali, il valore del contatore Coda rollforward è vicino a zero.</span><span class="sxs-lookup"><span data-stu-id="46cdf-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="46cdf-146">Aumentare il carico del server principale fino a che il valore del contatore Coda rollforward inizia a crescere in modo costante. Il sistema raggiunge quindi il tempo di rollforward massimo e il contatore delle prestazioni **Byte rollforward/sec** a questo punto rappresenta il tempo di rollforward massimo.</span><span class="sxs-lookup"><span data-stu-id="46cdf-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="46cdf-147">Per altre informazioni, vedere [Oggetto Database Mirroring di SQL Server](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="46cdf-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="46cdf-148">Stima dell'interruzione del servizio durante il failover automatico</span><span class="sxs-lookup"><span data-stu-id="46cdf-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="46cdf-149">Nella figura seguente viene illustrato in quale modo il rilevamento dell'errore e il tempo di failover determinano il tempo necessario per il completamento di un failover automatico su **Partner_B**.</span><span class="sxs-lookup"><span data-stu-id="46cdf-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="46cdf-150">Il failover richiede un tempo per il rollforward del database (fase di rollforward) più un breve periodo di tempo per portare online il database.</span><span class="sxs-lookup"><span data-stu-id="46cdf-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="46cdf-151">La fase di rollback, che prevede l'esecuzione del rollback per tutte le transazioni di cui non è stato eseguito il commit, si verifica dopo che il nuovo database principale viene portato online e prosegue dopo il failover.</span><span class="sxs-lookup"><span data-stu-id="46cdf-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="46cdf-152">Durante la fase di rollback, il database è disponibile.</span><span class="sxs-lookup"><span data-stu-id="46cdf-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="46cdf-153">![Rilevamento di errori e tempo di failover](../media/dbm-failovauto-time.gif "Rilevamento di errori e tempo di failover")</span><span class="sxs-lookup"><span data-stu-id="46cdf-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="46cdf-154">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="46cdf-154">See Also</span></span>
 <span data-ttu-id="46cdf-155">Cambio di ruolo delle [modalità operative del mirroring del database](database-mirroring-operating-modes.md) [durante una sessione di mirroring del database &#40;SQL Server&#41;il](role-switching-during-a-database-mirroring-session-sql-server.md) [mirroring del database &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="46cdf-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


