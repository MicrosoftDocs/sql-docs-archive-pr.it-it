---
title: Configurazione di SQL Server backup gestito in Azure per i gruppi di disponibilità | Microsoft Docs
description: Questa esercitazione illustra come configurare SQL Server backup gestito per Microsoft Azure per i database che partecipano a Always On gruppi di disponibilità.
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/04/2020
ms.locfileid: "87623472"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="94d67-103">Configurazione del backup gestito di SQL Server in Azure per i gruppi di disponibilità</span><span class="sxs-lookup"><span data-stu-id="94d67-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="94d67-104">In questo argomento viene fornita un'esercitazione sulla configurazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per i database che partecipano ai gruppi di disponibilità AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="94d67-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="94d67-105">Configurazioni del gruppo di disponibilità</span><span class="sxs-lookup"><span data-stu-id="94d67-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="94d67-106">è supportato per i database del gruppo di disponibilità, se le repliche sono tutte configurate in locale o interamente in Azure o un'implementazione ibrida tra l'ambiente locale e in una o più macchine virtuali di Azure.</span><span class="sxs-lookup"><span data-stu-id="94d67-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="94d67-107">Tuttavia potrebbe essere necessario prendere in considerazione quanto riportato di seguito per una o più implementazioni.</span><span class="sxs-lookup"><span data-stu-id="94d67-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="94d67-108">Frequenza di backup del log: la frequenza di backup del log viene calcolata sia in termini di tempo sia in base all'aumento delle dimensioni del log.</span><span class="sxs-lookup"><span data-stu-id="94d67-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="94d67-109">Ad esempio, il backup del log viene eseguito una volta ogni 2 ore, a meno che lo spazio del log utilizzato entro questo periodo di tempo non sia di almeno 5 MB.</span><span class="sxs-lookup"><span data-stu-id="94d67-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="94d67-110">Questo aspetto riguarda tutte le implementazioni, in locale, nel cloud o in una soluzione ibrida.</span><span class="sxs-lookup"><span data-stu-id="94d67-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="94d67-111">Larghezza di banda di rete: si applica alle implementazioni in cui le repliche si trovano in posizioni fisiche diverse, ad esempio in un cloud ibrido o in aree diverse di Azure in una configurazione solo cloud.</span><span class="sxs-lookup"><span data-stu-id="94d67-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="94d67-112">La larghezza di banda di rete può influire sulla latenza delle repliche secondarie e l'eventuale impostazione di queste ultime sulla replica sincrona può determinare un aumento delle dimensioni del log nella replica primaria.</span><span class="sxs-lookup"><span data-stu-id="94d67-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="94d67-113">Se le repliche secondarie sono impostate sulla replica sincrona, potrebbero non rimanere sincronizzate a causa della latenza di rete che può comportare la perdita di dati in caso di failover sulla replica secondaria.</span><span class="sxs-lookup"><span data-stu-id="94d67-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="94d67-114">Configurazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per i database di disponibilità</span><span class="sxs-lookup"><span data-stu-id="94d67-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="94d67-115">**Autorizzazioni:**</span><span class="sxs-lookup"><span data-stu-id="94d67-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="94d67-116">È richiesta l'appartenenza al ruolo **db_backupoperator** database, con autorizzazioni **ALTER ANY CREDENTIAL** e `EXECUTE` autorizzazioni per **sp_delete_backuphistory**stored procedure.</span><span class="sxs-lookup"><span data-stu-id="94d67-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="94d67-117">Sono richieste le autorizzazioni **Select** per la funzione **smart_admin. fn_get_current_xevent_settings**.</span><span class="sxs-lookup"><span data-stu-id="94d67-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="94d67-118">`EXECUTE`Sono necessarie le autorizzazioni per il stored procedure **smart_admin. sp_get_backup_diagnostics** .</span><span class="sxs-lookup"><span data-stu-id="94d67-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="94d67-119">È inoltre richiesta l'autorizzazione `VIEW SERVER STATE` poiché vengono chiamati internamente altri oggetti di sistema che richiedono tale autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="94d67-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="94d67-120">`EXECUTE`Sono necessarie le autorizzazioni per le `smart_admin.sp_set_instance_backup` `smart_admin.sp_backup_master_switch` stored procedure e.</span><span class="sxs-lookup"><span data-stu-id="94d67-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="94d67-121">Di seguito sono riportati i passaggi da eseguire per la configurazione di un gruppo di disponibilità AlwaysOn con il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="94d67-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="94d67-122">Un'esercitazione dettagliata viene descritta più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="94d67-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="94d67-123">Una volta creato il gruppo di disponibilità, configurare la replica di backup preferita.</span><span class="sxs-lookup"><span data-stu-id="94d67-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="94d67-124">Questa impostazione per il gruppo di disponibilità viene inoltre usata dal [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per determinare la replica da usare per il backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="94d67-125">Per istruzioni dettagliate su come configurare le preferenze di backup, vedere [configurare il backup su repliche di disponibilità &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="94d67-126">Se si sta creando un nuovo gruppo di disponibilità AlwaysOn, vedere [Introduzione con Gruppi di disponibilità AlwaysOn &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="94d67-127">Configurare l'accesso per la connessione in sola lettura alle repliche secondarie.</span><span class="sxs-lookup"><span data-stu-id="94d67-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="94d67-128">Per istruzioni dettagliate su come configurare l'accesso in sola lettura, vedere [configurare l'accesso in sola lettura in una replica di disponibilità &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="94d67-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="94d67-129">Specificare la replica di backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-129">Specify Backup replica.</span></span> <span data-ttu-id="94d67-130">L'impostazione della replica di backup preferita viene utilizzata dal [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per determinare il database da utilizzare per la pianificazione dei backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="94d67-131">Per determinare se la replica corrente è la replica di backup preferita, utilizzare la funzione [sys. fn_hadr_backup_is_preferred_replica &#40;&#41;Transact-SQL](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="94d67-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="94d67-132">In ogni replica eseguire la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurazione per il database usando il stored procedure **Smart-admin. sp_set_db_backup** .</span><span class="sxs-lookup"><span data-stu-id="94d67-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="94d67-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] comportamento dopo un failover:\*\* continuerà [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] a funzionare e a mantenere le copie di backup e la recuperabilità dopo un evento di failover.</span><span class="sxs-lookup"><span data-stu-id="94d67-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="94d67-134">Non è richiesta alcuna azione specifica dopo un failover.</span><span class="sxs-lookup"><span data-stu-id="94d67-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="94d67-135">Considerazioni e requisiti:</span><span class="sxs-lookup"><span data-stu-id="94d67-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="94d67-136">Per la configurazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per database che fanno parte del gruppo di disponibilità AlwaysOn sono necessari determinati requisiti e considerazioni.</span><span class="sxs-lookup"><span data-stu-id="94d67-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="94d67-137">Di seguito è riportato un elenco delle considerazioni e dei requisiti:</span><span class="sxs-lookup"><span data-stu-id="94d67-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="94d67-138">Le impostazioni di configurazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] devono essere identiche per tutti i database in tutti i nodi di [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] che fanno parte dello stesso gruppo di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="94d67-139">È possibile soddisfare questa esigenza impostando le stesse configurazioni del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per la replica primaria e per tutte le repliche a livello di database oppure impostando le stesse impostazioni predefinite del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] in tutti i nodi che fanno parte dei gruppi di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="94d67-140">Si consiglia di impostare [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] a livello di database perché questa configurazione di [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] consente di isolare le impostazioni nei database e le modifiche alle impostazioni predefinite interessano tutti gli altri database nell'istanza.</span><span class="sxs-lookup"><span data-stu-id="94d67-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="94d67-141">Specificare la replica di backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-141">Specify Backup replica.</span></span> <span data-ttu-id="94d67-142">L'impostazione della replica di backup preferita viene usata dal [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per pianificare i backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="94d67-143">Per determinare se la replica corrente è la replica di backup preferita, utilizzare la funzione [sys. fn_hadr_backup_is_preferred_replica &#40;&#41;Transact-SQL](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="94d67-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="94d67-144">Se la replica secondaria è configurata come replica preferita, deve essere configurata in modo da avere almeno l'accesso per la connessione in sola lettura.</span><span class="sxs-lookup"><span data-stu-id="94d67-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="94d67-145">I gruppi di disponibilità privi di accesso per la connessione ai database secondari non sono supportati.</span><span class="sxs-lookup"><span data-stu-id="94d67-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="94d67-146">Per altre informazioni, vedere [Configurare l'accesso in sola lettura in una replica di disponibilità &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="94d67-147">Se si configura il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] dopo aver configurato il gruppo di disponibilità, tramite il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] si tenterà di copiare tutti i backup esistenti nel contenitore di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="94d67-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="94d67-148">Se tramite il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] non sarà possibile trovare i backup esistenti o accedere a questi ultimi, verrà pianificato un backup completo del database.</span><span class="sxs-lookup"><span data-stu-id="94d67-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="94d67-149">Questa operazione viene eseguita in modo particolare per ottimizzare le operazioni di backup per i database del gruppo di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="94d67-150">Potrebbe essere opportuno disabilitare le impostazioni a livello di istanza se si sta creando un nuovo database di disponibilità e non si intende applicare le impostazioni a livello di istanza al database</span><span class="sxs-lookup"><span data-stu-id="94d67-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="94d67-151">Quando si usa la crittografia, usare lo stesso certificato in tutte le repliche.</span><span class="sxs-lookup"><span data-stu-id="94d67-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="94d67-152">In questo modo vengono facilitate le operazioni di backup continue e ininterrotte in caso di failover su una replica diversa o di ripristini in quest'ultima.</span><span class="sxs-lookup"><span data-stu-id="94d67-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="94d67-153">Abilitare e configurare il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per un database di disponibilità</span><span class="sxs-lookup"><span data-stu-id="94d67-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="94d67-154">In questa esercitazione vengono descritti i passaggi per abilitare e configurare il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per un database (AGTestDB) nei computer Node1 e Node2, nonché i passaggi per abilitare il monitoraggio dello stato di integrità del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="94d67-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="94d67-155">**Creare un account di archiviazione di Azure:** I backup vengono archiviati nel servizio di archiviazione BLOB di Azure.</span><span class="sxs-lookup"><span data-stu-id="94d67-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="94d67-156">È necessario creare prima un account di archiviazione di Azure, se non è già presente.</span><span class="sxs-lookup"><span data-stu-id="94d67-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="94d67-157">Per altre informazioni, vedere [creazione di un account di archiviazione di Azure](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span><span class="sxs-lookup"><span data-stu-id="94d67-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="94d67-158">Prendere nota del nome dell'account di archiviazione, delle chiavi di accesso e dell'URL dell'account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="94d67-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="94d67-159">Le informazioni sul nome dell'account di archiviazione e sulla chiave di accesso vengono utilizzate per creare le credenziali SQL.</span><span class="sxs-lookup"><span data-stu-id="94d67-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="94d67-160">Queste credenziali vengono utilizzate dal [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] durante le operazioni di backup per l'autenticazione nell'account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="94d67-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="94d67-161">**Creare credenziali SQL:** Creare credenziali SQL usando il nome dell'account di archiviazione come identità e la chiave di accesso alle archiviazione come password.</span><span class="sxs-lookup"><span data-stu-id="94d67-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="94d67-162">**Assicurarsi che il servizio SQL Server Agent sia avviato e in esecuzione:** se non è in esecuzione, avviare SQL Server Agent.</span><span class="sxs-lookup"><span data-stu-id="94d67-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="94d67-163">è necessaria l'esecuzione di SQL Server Agent nell'istanza per poter eseguire le operazioni di backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="94d67-164">Per assicurarsi che le operazioni in questione vengano eseguite regolarmente, è possibile impostare l'esecuzione automatica di SQL Agent.</span><span class="sxs-lookup"><span data-stu-id="94d67-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="94d67-165">**Determinare il periodo di memorizzazione:** Determinare il periodo di memorizzazione desiderato per i file di backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="94d67-166">Il periodo di memorizzazione viene specificato in giorni in un intervallo compreso tra 1 e 30.</span><span class="sxs-lookup"><span data-stu-id="94d67-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="94d67-167">Il periodo di memorizzazione determina l'intervallo di tempo di recuperabilità del database.</span><span class="sxs-lookup"><span data-stu-id="94d67-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="94d67-168">**Creare un certificato o una chiave asimmetrica da usare per la crittografia durante il backup:** Creare il certificato nel primo nodo NODE1, quindi esportarlo in un file usando il [certificato di BACKUP &#40;&#41;Transact-SQL ](/sql/t-sql/statements/backup-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="94d67-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="94d67-169">Nel nodo 2 creare un certificato utilizzando il file esportato dal nodo 1.</span><span class="sxs-lookup"><span data-stu-id="94d67-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="94d67-170">Per ulteriori informazioni sulla creazione di un certificato da un file, vedere l'esempio in [create certificate &#40;&#41;Transact-SQL ](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="94d67-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="94d67-171">**Abilitare e configurare [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per AGTestDB in Node1:** avviare SQL Server Management Studio e connettersi all'istanza in Node1 in cui è installato il database di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="94d67-172">Nella finestra Query eseguire l'istruzione riportata di seguito dopo aver modificato i valori per il nome del database, l'URL di archiviazione, le credenziali SQL e il periodo di memorizzazione in base alle esigenze:</span><span class="sxs-lookup"><span data-stu-id="94d67-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="94d67-173">Per ulteriori informazioni sulla creazione di un certificato per la crittografia, vedere il passaggio **creare un certificato di backup** in [creare un backup crittografato](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="94d67-174">**Abilitare e configurare [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per AGTestDB in Node2:** avviare SQL Server Management Studio e connettersi all'istanza in node2 in cui è installato il database di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="94d67-175">Nella finestra Query eseguire l'istruzione riportata di seguito dopo aver modificato i valori per il nome del database, l'URL di archiviazione, le credenziali SQL e il periodo di memorizzazione in base alle esigenze:</span><span class="sxs-lookup"><span data-stu-id="94d67-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="94d67-176">ora è abilitato nel database specificato.</span><span class="sxs-lookup"><span data-stu-id="94d67-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="94d67-177">L'inizio delle operazioni di backup nel database può richiedere fino a 15 minuti.</span><span class="sxs-lookup"><span data-stu-id="94d67-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="94d67-178">Il backup verrà eseguito nella replica di backup preferita.</span><span class="sxs-lookup"><span data-stu-id="94d67-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="94d67-179">**Esaminare la configurazione predefinita degli eventi estesi:**  Esaminare la configurazione degli eventi estesi eseguendo l'istruzione Transact-SQL seguente sulla replica [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] utilizzata da per pianificare i backup.</span><span class="sxs-lookup"><span data-stu-id="94d67-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="94d67-180">Si tratta in genere dell'impostazione della replica di backup preferita per il gruppo di disponibilità a cui appartiene il database.</span><span class="sxs-lookup"><span data-stu-id="94d67-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="94d67-181">Verificare che gli eventi dei canali amministrativo, operativo e analitico siano abilitati per impostazione predefinita e che non possano essere disabilitati.</span><span class="sxs-lookup"><span data-stu-id="94d67-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="94d67-182">Questa verifica dovrebbe essere sufficiente per monitorare gli eventi per i quali è richiesto un intervento manuale.</span><span class="sxs-lookup"><span data-stu-id="94d67-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="94d67-183">È possibile abilitare gli eventi di debug, ma in questi canali sono inclusi eventi informativi e di debug usati dal [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per rilevare eventuali problemi e risolverli.</span><span class="sxs-lookup"><span data-stu-id="94d67-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="94d67-184">Per altre informazioni, vedere [monitorare SQL Server backup gestito in Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="94d67-185">**Abilitare e configurare notifiche per lo stato di integrità:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] contiene una stored procedure che consente di creare un processo dell'agente per inviare notifiche via posta elettronica di errori o avvisi che potrebbero richiedere attenzione.</span><span class="sxs-lookup"><span data-stu-id="94d67-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="94d67-186">Per ricevere notifiche di questo tipo, è necessario eseguire la stored procedure per creare un processo di SQL Server Agent.</span><span class="sxs-lookup"><span data-stu-id="94d67-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="94d67-187">Nei passaggi seguenti viene illustrato il processo per abilitare e configurare le notifiche tramite posta elettronica:</span><span class="sxs-lookup"><span data-stu-id="94d67-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="94d67-188">Configurare Posta elettronica database se non è già abilitato nell'istanza.</span><span class="sxs-lookup"><span data-stu-id="94d67-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="94d67-189">Per altre informazioni, vedere [Configurare Posta elettronica database](../relational-databases/database-mail/configure-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="94d67-190">Configurare la notifica di SQL Server Agent per l'uso di Posta elettronica database.</span><span class="sxs-lookup"><span data-stu-id="94d67-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="94d67-191">Per altre informazioni, vedere [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="94d67-192">**Abilitare le notifiche di posta elettronica per ricevere avvisi ed errori di backup:** nella finestra di query eseguire le istruzioni Transact-SQL seguenti:</span><span class="sxs-lookup"><span data-stu-id="94d67-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="94d67-193">Per altre informazioni e per uno script di esempio completo, vedere [monitorare SQL Server backup gestito in Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="94d67-194">**Visualizzare i file di backup nell'account di archiviazione di Azure:** Connettersi all'account di archiviazione da SQL Server Management Studio o da Azure portale di gestione.</span><span class="sxs-lookup"><span data-stu-id="94d67-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="94d67-195">Verrà visualizzato un contenitore per l'istanza di SQL Server in cui viene ospitato il database configurato per utilizzare il [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="94d67-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="94d67-196">È inoltre possibile visualizzare un database e un backup del log entro 15 minuti dall'abilitazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per il database.</span><span class="sxs-lookup"><span data-stu-id="94d67-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="94d67-197">**Monitorare lo stato di integrità:**  è possibile eseguire il monitoraggio attraverso notifiche tramite posta elettronica configurate in precedenza o monitorare attivamente gli eventi registrati.</span><span class="sxs-lookup"><span data-stu-id="94d67-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="94d67-198">Di seguito sono riportate alcune istruzioni Transact-SQL di esempio utilizzate per visualizzare gli eventi:</span><span class="sxs-lookup"><span data-stu-id="94d67-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="94d67-199">I passaggi descritti in questa sezione riguardano in modo specifico la configurazione del [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] per la prima volta nel database.</span><span class="sxs-lookup"><span data-stu-id="94d67-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="94d67-200">È possibile modificare le configurazioni esistenti utilizzando lo stesso sistema stored procedure **smart_admin. sp_set_db_backup** e specificare i nuovi valori.</span><span class="sxs-lookup"><span data-stu-id="94d67-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="94d67-201">Per altre informazioni, vedere [SQL Server backup gestito in Azure-impostazioni di archiviazione e conservazione](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span><span class="sxs-lookup"><span data-stu-id="94d67-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="94d67-202">Considerazioni in caso di rimozione di un database dalla configurazione del gruppo di disponibilità AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="94d67-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="94d67-203">Se un database viene rimosso dalla configurazione del gruppo di disponibilità AlwaysOn ed è ora un database autonomo, è consigliabile eseguire il backup utilizzando [smart_admin. sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="94d67-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="94d67-204">Quando si crea un backup del database in questo modo, si stabilisce una nuova catena di backup e il file verrà inserito nel contenitore specifico dell'istanza anziché nel contenitore Disponibilità in cui sono stati archiviati i backup quando il database faceva parte del gruppo di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="94d67-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="94d67-205">La recuperabilità del database in questo scenario dai backup precedenti alla modifica dello stato del gruppo di disponibilità non è garantita.</span><span class="sxs-lookup"><span data-stu-id="94d67-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
